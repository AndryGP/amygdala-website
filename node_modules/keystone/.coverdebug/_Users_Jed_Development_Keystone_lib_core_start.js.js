
// Instrumentation Header
{
    var fs = require('fs');
    var __statement_lVD2Gj, __expression_QooBlq, __block_QGx1z7;
    var store = require('/Users/Jed/Development/Keystone/node_modules/gulp-coverage/contrib/coverage_store.js');
    
    __statement_lVD2Gj = function(i) {
        var fd = store.register('/Users/Jed/Development/Keystone/lib/core/start.js');
        fs.writeSync(fd, '{"statement": {"node": ' + i + '}},\n');
    }; 
    
    __expression_QooBlq = function(i) {
        var fd = store.register('/Users/Jed/Development/Keystone/lib/core/start.js');
        fs.writeSync(fd, '{"expression": {"node": ' + i + '}},\n');
    }; 
    
    __block_QGx1z7 = function(i) {
        var fd = store.register('/Users/Jed/Development/Keystone/lib/core/start.js');
        fs.writeSync(fd, '{"block": ' + i + '},\n');
    }; 
    __intro_EHGmun = function(id, obj) {
        // console.log('__intro: ', id, ', obj.__instrumented_miss: ', obj.__instrumented_miss, ', obj.length: ', obj.length);
        (typeof obj === 'object' || typeof obj === 'function') &&
            Object.defineProperty && Object.defineProperty(obj, '__instrumented_miss', {enumerable: false, writable: true});
        obj.__instrumented_miss = obj.__instrumented_miss || [];
        if ('undefined' !== typeof obj && null !== obj && 'undefined' !== typeof obj.__instrumented_miss) {
            if (obj.length === 0) {
                // console.log('interim miss: ', id);
                obj.__instrumented_miss[id] = true;
            } else {
                obj.__instrumented_miss[id] = false;
            }
        }
        return obj;
    };
    function isProbablyChainable(obj, id) {
        return obj &&
            obj.__instrumented_miss[id] !== undefined &&
            'number' === typeof obj.length;
    }
    __extro_iktNjm = function(id, obj) {
        var fd = store.register('/Users/Jed/Development/Keystone/lib/core/start.js');
        // console.log('__extro: ', id, ', obj.__instrumented_miss: ', obj.__instrumented_miss, ', obj.length: ', obj.length);
        if ('undefined' !== typeof obj && null !== obj && 'undefined' !== typeof obj.__instrumented_miss) {
            if (isProbablyChainable(obj, id) && obj.length === 0 && obj.__instrumented_miss[id]) {
                // if the call was not a "constructor" - i.e. it did not add things to the chainable
                // and it did not return anything from the chainable, it is a miss
                // console.log('miss: ', id);
            } else {
                fs.writeSync(fd, '{"chain": {"node": ' + id + '}},\n');
            }
            obj.__instrumented_miss[id] = undefined;
        } else {
            fs.writeSync(fd, '{"chain": {"node": ' + id + '}},\n');
        }
        return obj;
    };
};
////////////////////////

// Instrumented Code
{
    __statement_lVD2Gj(0);
    var fs = (__expression_QooBlq(1), require('fs')), http = (__expression_QooBlq(2), require('http')), https = (__expression_QooBlq(3), require('https'));
}
{
    __statement_lVD2Gj(4);
    var dashes = '\n------------------------------------------------\n';
}
function start(events) {
    __block_QGx1z7(0);
    if (__expression_QooBlq(5), 'function' === (__expression_QooBlq(6), typeof events)) {
        __block_QGx1z7(1);
        {
            __statement_lVD2Gj(7);
            events = {
                onStart: events
            };
        }
    }
    if (__expression_QooBlq(8), !(__expression_QooBlq(9), events)) {
        __block_QGx1z7(2);
        {
            __statement_lVD2Gj(10);
            events = {};
        }
    }
    if (__expression_QooBlq(11), !this.app) {
        __block_QGx1z7(3);
        {
            __statement_lVD2Gj(12);
            throw new Error('KeystoneJS Initialisaton Error:\n\napp must be initialised. Call keystone.init() or keystone.connect(new Express()) first.\n\n');
        }
    }
    {
        __statement_lVD2Gj(13);
        var keystone = this, app = this.app;
    }
    {
        __statement_lVD2Gj(14);
        var onMount = events.onMount;
    }
    {
        __statement_lVD2Gj(15);
        events.onMount = function () {
            __block_QGx1z7(4);
            {
                __statement_lVD2Gj(16);
                __expression_QooBlq(17), (__expression_QooBlq(18), onMount) && (__expression_QooBlq(19), onMount());
            }
            {
                __statement_lVD2Gj(20);
                var startupMessages = [
                        'KeystoneJS Started:'
                    ], waitForServers = 2;
            }
            {
                __statement_lVD2Gj(21);
                var serverStarted = function () {
                    __block_QGx1z7(5);
                    {
                        __statement_lVD2Gj(22);
                        __expression_QooBlq(23), waitForServers--;
                    }
                    if (__expression_QooBlq(24), waitForServers) {
                        __block_QGx1z7(6);
                        return __expression_QooBlq(25);
                    }
                    if (__extro_iktNjm(26, __intro_EHGmun(26, keystone).get('logger'))) {
                        __block_QGx1z7(7);
                        {
                            __statement_lVD2Gj(27);
                            __extro_iktNjm(28, __intro_EHGmun(28, console).log((__expression_QooBlq(29), (__expression_QooBlq(30), (__expression_QooBlq(31), dashes) + __extro_iktNjm(32, __intro_EHGmun(32, startupMessages).join('\n'))) + (__expression_QooBlq(33), dashes))));
                        }
                    }
                    {
                        __statement_lVD2Gj(34);
                        __expression_QooBlq(35), events.onStart && __extro_iktNjm(36, __intro_EHGmun(36, events).onStart());
                    }
                };
            }
            {
                __statement_lVD2Gj(37);
                keystone.httpServer = __extro_iktNjm(38, __intro_EHGmun(38, http).createServer(app));
            }
            {
                __statement_lVD2Gj(39);
                __expression_QooBlq(40), events.onHttpServerCreated && __extro_iktNjm(41, __intro_EHGmun(41, events).onHttpServerCreated());
            }
            {
                __statement_lVD2Gj(42);
                var host = __extro_iktNjm(43, __intro_EHGmun(43, keystone).get('host')), port = __extro_iktNjm(44, __intro_EHGmun(44, keystone).get('port')), listen = __extro_iktNjm(45, __intro_EHGmun(45, keystone).get('listen')), ssl = __extro_iktNjm(46, __intro_EHGmun(46, keystone).get('ssl'));
            }
            if (__expression_QooBlq(47), (__expression_QooBlq(48), ssl) !== 'only') {
                __block_QGx1z7(8);
                {
                    __statement_lVD2Gj(49);
                    var httpStarted = function (msg) {
                        __block_QGx1z7(9);
                        return __expression_QooBlq(50), function () {
                            __block_QGx1z7(10);
                            {
                                __statement_lVD2Gj(51);
                                __extro_iktNjm(52, __intro_EHGmun(52, startupMessages).push(msg));
                            }
                            {
                                __statement_lVD2Gj(53);
                                __expression_QooBlq(54), serverStarted();
                            }
                        };
                    };
                }
                if (__expression_QooBlq(55), (__expression_QooBlq(56), port) || (__expression_QooBlq(57), (__expression_QooBlq(58), port) === 0)) {
                    __block_QGx1z7(11);
                    {
                        __statement_lVD2Gj(59);
                        __extro_iktNjm(60, __intro_EHGmun(60, app).set('port', port));
                    }
                    {
                        __statement_lVD2Gj(61);
                        var httpReadyMsg = (__expression_QooBlq(62), __extro_iktNjm(63, __intro_EHGmun(63, keystone).get('name')) + ' is ready');
                    }
                    if (__expression_QooBlq(64), host) {
                        __block_QGx1z7(12);
                        {
                            __statement_lVD2Gj(65);
                            httpReadyMsg += (__expression_QooBlq(66), ' on http://' + (__expression_QooBlq(67), host));
                        }
                        if (__expression_QooBlq(68), port) {
                            __block_QGx1z7(13);
                            {
                                __statement_lVD2Gj(69);
                                httpReadyMsg += (__expression_QooBlq(70), ':' + (__expression_QooBlq(71), port));
                            }
                        }
                        {
                            __statement_lVD2Gj(72);
                            __extro_iktNjm(73, __intro_EHGmun(73, keystone.httpServer).listen(port, host, (__expression_QooBlq(74), httpStarted(httpReadyMsg))));
                        }
                    } else {
                        __block_QGx1z7(14);
                        if (__expression_QooBlq(75), port) {
                            __block_QGx1z7(15);
                            {
                                __statement_lVD2Gj(76);
                                httpReadyMsg += (__expression_QooBlq(77), ' on port ' + (__expression_QooBlq(78), port));
                            }
                        }
                        {
                            __statement_lVD2Gj(79);
                            __extro_iktNjm(80, __intro_EHGmun(80, keystone.httpServer).listen(port, (__expression_QooBlq(81), httpStarted(httpReadyMsg))));
                        }
                    }
                } else if (__expression_QooBlq(82), host) {
                    __block_QGx1z7(16);
                    {
                        __statement_lVD2Gj(83);
                        __extro_iktNjm(84, __intro_EHGmun(84, app).set('port', 3000));
                    }
                    {
                        __statement_lVD2Gj(85);
                        __extro_iktNjm(86, __intro_EHGmun(86, keystone.httpServer).listen(3000, host, (__expression_QooBlq(87), httpStarted((__expression_QooBlq(88), (__expression_QooBlq(89), (__expression_QooBlq(90), __extro_iktNjm(91, __intro_EHGmun(91, keystone).get('name')) + ' is ready on ') + (__expression_QooBlq(92), host)) + ':3000')))));
                    }
                } else if (__expression_QooBlq(93), listen) {
                    __block_QGx1z7(17);
                    {
                        __statement_lVD2Gj(94);
                        __extro_iktNjm(95, __intro_EHGmun(95, keystone.httpServer).listen(listen, (__expression_QooBlq(96), httpStarted((__expression_QooBlq(97), (__expression_QooBlq(98), __extro_iktNjm(99, __intro_EHGmun(99, keystone).get('name')) + ' is ready') + ((__expression_QooBlq(102), 'string' === (__expression_QooBlq(103), typeof listen)) ? (__expression_QooBlq(100), (__expression_QooBlq(104), ' on ' + (__expression_QooBlq(105), listen))) : (__expression_QooBlq(101), '')))))));
                    }
                } else {
                    __block_QGx1z7(18);
                    {
                        __statement_lVD2Gj(106);
                        __extro_iktNjm(107, __intro_EHGmun(107, app).set('port', 3000));
                    }
                    {
                        __statement_lVD2Gj(108);
                        __extro_iktNjm(109, __intro_EHGmun(109, keystone.httpServer).listen(3000, (__expression_QooBlq(110), httpStarted((__expression_QooBlq(111), __extro_iktNjm(112, __intro_EHGmun(112, keystone).get('name')) + ' is ready on default port 3000')))));
                    }
                }
            } else {
                __block_QGx1z7(19);
                {
                    __statement_lVD2Gj(113);
                    __expression_QooBlq(114), waitForServers--;
                }
            }
            if (__expression_QooBlq(115), ssl) {
                __block_QGx1z7(20);
                {
                    __statement_lVD2Gj(116);
                    var sslOpts = {};
                }
                if (__expression_QooBlq(117), __extro_iktNjm(118, __intro_EHGmun(118, keystone).get('ssl cert')) && __extro_iktNjm(119, __intro_EHGmun(119, fs).existsSync(__extro_iktNjm(120, __intro_EHGmun(120, keystone).getPath('ssl cert'))))) {
                    __block_QGx1z7(21);
                    {
                        __statement_lVD2Gj(121);
                        sslOpts.cert = __extro_iktNjm(122, __intro_EHGmun(122, fs).readFileSync(__extro_iktNjm(123, __intro_EHGmun(123, keystone).getPath('ssl cert'))));
                    }
                }
                if (__expression_QooBlq(124), __extro_iktNjm(125, __intro_EHGmun(125, keystone).get('ssl key')) && __extro_iktNjm(126, __intro_EHGmun(126, fs).existsSync(__extro_iktNjm(127, __intro_EHGmun(127, keystone).getPath('ssl key'))))) {
                    __block_QGx1z7(22);
                    {
                        __statement_lVD2Gj(128);
                        sslOpts.key = __extro_iktNjm(129, __intro_EHGmun(129, fs).readFileSync(__extro_iktNjm(130, __intro_EHGmun(130, keystone).getPath('ssl key'))));
                    }
                }
                if (__expression_QooBlq(131), (__expression_QooBlq(132), !sslOpts.key) || (__expression_QooBlq(133), !sslOpts.cert)) {
                    __block_QGx1z7(23);
                    if (__expression_QooBlq(134), (__expression_QooBlq(135), ssl) === 'only') {
                        __block_QGx1z7(24);
                        {
                            __statement_lVD2Gj(136);
                            __extro_iktNjm(137, __intro_EHGmun(137, console).log((__expression_QooBlq(138), __extro_iktNjm(139, __intro_EHGmun(139, keystone).get('name')) + ' failed to start: invalid ssl configuration')));
                        }
                        {
                            __statement_lVD2Gj(140);
                            __extro_iktNjm(141, __intro_EHGmun(141, process).exit());
                        }
                    } else {
                        __block_QGx1z7(25);
                        {
                            __statement_lVD2Gj(142);
                            __extro_iktNjm(143, __intro_EHGmun(143, startupMessages).push('Warning: Invalid SSL Configuration'));
                        }
                        {
                            __statement_lVD2Gj(144);
                            __expression_QooBlq(145), serverStarted();
                        }
                    }
                } else {
                    __block_QGx1z7(26);
                    {
                        __statement_lVD2Gj(146);
                        var httpsStarted = function (msg) {
                            __block_QGx1z7(27);
                            return __expression_QooBlq(147), function () {
                                __block_QGx1z7(28);
                                {
                                    __statement_lVD2Gj(148);
                                    __extro_iktNjm(149, __intro_EHGmun(149, startupMessages).push(msg));
                                }
                                {
                                    __statement_lVD2Gj(150);
                                    __expression_QooBlq(151), serverStarted();
                                }
                            };
                        };
                    }
                    {
                        __statement_lVD2Gj(152);
                        keystone.httpsServer = __extro_iktNjm(153, __intro_EHGmun(153, https).createServer(sslOpts, app));
                    }
                    {
                        __statement_lVD2Gj(154);
                        __expression_QooBlq(155), events.onHttpsServerCreated && __extro_iktNjm(156, __intro_EHGmun(156, events).onHttpsServerCreated());
                    }
                    {
                        __statement_lVD2Gj(157);
                        var sslHost = (__expression_QooBlq(158), __extro_iktNjm(159, __intro_EHGmun(159, keystone).get('ssl host')) || (__expression_QooBlq(160), host)), sslPort = (__expression_QooBlq(161), __extro_iktNjm(162, __intro_EHGmun(162, keystone).get('ssl port')) || 3001);
                    }
                    {
                        __statement_lVD2Gj(163);
                        var httpsReadyMsg = (__expression_QooBlq(166), (__expression_QooBlq(167), ssl) === 'only') ? (__expression_QooBlq(164), (__expression_QooBlq(168), __extro_iktNjm(169, __intro_EHGmun(169, keystone).get('name')) + ' (SSL) is ready on ')) : (__expression_QooBlq(165), 'SSL Server is ready on ');
                    }
                    if (__expression_QooBlq(170), sslHost) {
                        __block_QGx1z7(29);
                        {
                            __statement_lVD2Gj(171);
                            __extro_iktNjm(172, __intro_EHGmun(172, keystone.httpsServer).listen(sslPort, sslHost, (__expression_QooBlq(173), httpsStarted((__expression_QooBlq(174), (__expression_QooBlq(175), (__expression_QooBlq(176), (__expression_QooBlq(177), (__expression_QooBlq(178), httpsReadyMsg) + 'https://') + (__expression_QooBlq(179), sslHost)) + ':') + (__expression_QooBlq(180), sslPort))))));
                        }
                    } else {
                        __block_QGx1z7(30);
                        {
                            __statement_lVD2Gj(181);
                            var httpsPortMsg = __extro_iktNjm(184, __intro_EHGmun(184, keystone).get('ssl port')) ? (__expression_QooBlq(182), (__expression_QooBlq(185), 'port: ' + __extro_iktNjm(186, __intro_EHGmun(186, keystone).get('ssl port')))) : (__expression_QooBlq(183), 'default port 3001');
                        }
                        {
                            __statement_lVD2Gj(187);
                            __extro_iktNjm(188, __intro_EHGmun(188, keystone.httpsServer).listen(sslPort, (__expression_QooBlq(189), httpsStarted((__expression_QooBlq(190), (__expression_QooBlq(191), httpsReadyMsg) + (__expression_QooBlq(192), httpsPortMsg))))));
                        }
                    }
                }
            } else {
                __block_QGx1z7(31);
                {
                    __statement_lVD2Gj(193);
                    __expression_QooBlq(194), waitForServers--;
                }
            }
            {
                __statement_lVD2Gj(195);
                __extro_iktNjm(196, __intro_EHGmun(196, process).on('uncaughtException', function (e) {
                    __block_QGx1z7(32);
                    if (__expression_QooBlq(197), e.code === 'EADDRINUSE') {
                        __block_QGx1z7(33);
                        {
                            __statement_lVD2Gj(198);
                            __extro_iktNjm(199, __intro_EHGmun(199, console).log((__expression_QooBlq(200), (__expression_QooBlq(201), (__expression_QooBlq(202), (__expression_QooBlq(203), dashes) + __extro_iktNjm(204, __intro_EHGmun(204, keystone).get('name'))) + ' failed to start: address already in use\n') + 'Please check you are not already running a server on the specified port.\n')));
                        }
                        {
                            __statement_lVD2Gj(205);
                            __extro_iktNjm(206, __intro_EHGmun(206, process).exit());
                        }
                    } else {
                        __block_QGx1z7(34);
                        {
                            __statement_lVD2Gj(207);
                            __extro_iktNjm(208, __intro_EHGmun(208, console).log((__expression_QooBlq(209), e.stack || (__expression_QooBlq(210), e))));
                        }
                        {
                            __statement_lVD2Gj(211);
                            __extro_iktNjm(212, __intro_EHGmun(212, process).exit(1));
                        }
                    }
                }));
            }
        };
    }
    {
        __statement_lVD2Gj(213);
        __extro_iktNjm(214, __intro_EHGmun(214, this).mount(events));
    }
    return __expression_QooBlq(215), this;
}
{
    __statement_lVD2Gj(216);
    module.exports = start;
}