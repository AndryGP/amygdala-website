<!DOCTYPE html><html><head><title>Coverage</title><script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script>

headings = [];

onload = function(){
  headings = document.querySelectorAll('h2');
};

onscroll = function(e){
  var heading = find(window.scrollY);
  if (!heading) return;
  var links = document.querySelectorAll('#menu a')
    , link;

  for (var i = 0, len = links.length; i < len; ++i) {
    link = links[i];
    link.className = link.getAttribute('href') == '#' + heading.id
      ? 'active'
      : '';
  }
};

function find(y) {
  var i = headings.length
    , heading;

  while (i--) {
    heading = headings[i];
    if (y >= heading.offsetTop) {
      return heading;
    }
  }
}
jQuery(document).ready(function() {
  jQuery(['partial', 'miss']).each(function(i, clss) {
    var $els = jQuery('.'+clss);
    $els.each(function(index, item) {
      var $this = jQuery(item).attr('id', clss + index);
      if (index < $els.length - 1) {
        $this.find('.action').append(
          jQuery('<a>').attr('href', '#' + clss + (index + 1))
            .text('next')
        );
      }
    });
  });
  jQuery(window).on('hashchange', function (e) {
    if (!jQuery(window.location.hash).attr('tabindex')) {
      jQuery(window.location.hash).attr('tabindex', '-1').focus();
    }
  })
});
</script>
<style>

body {
  font: 14px/1.6 "Helvetica Neue", Helvetica, Arial, sans-serif;
  margin: 0;
  color: #2C2C2C;
  border-top: 2px solid #ddd;
}

#coverage {
  padding: 60px;
}

h1 a {
  color: inherit;
  font-weight: inherit;
}

h1 a:hover {
  text-decoration: none;
}

.onload h1 {
  opacity: 1;
}

h2 {
  width: 80%;
  margin-top: 12px;
  margin-bottom: 0;
  font-weight: 200;
  letter-spacing: 1px;
}

a {
  color: #8A6343;
  font-weight: bold;
}

ul {
  margin-top: 20px;
  padding: 0 15px;
  width: 100%;
}

ul li {
  float: left;
  width: 40%;
  margin-top: 5px;
  margin-right: 60px;
  list-style: none;
  border-bottom: 1px solid #eee;
  padding: 5px 0;
  font-size: 12px;
}

ul::after {
  content: '.';
  height: 0;
  display: block;
  visibility: hidden;
  clear: both;
}

code {
  font: 12px monaco, monospace;
}

pre {
  margin: 30px;
  padding: 30px;
  border: 1px solid #eee;
  border-bottom-color: #ddd;
  -webkit-border-radius: 2px;
  -moz-border-radius: 2px;
  border-radius: 2px;
  -webkit-box-shadow: inset 0 0 10px #eee;
  -moz-box-shadow: inset 0 0 10px #eee;
  box-shadow: inset 0 0 10px #eee;
  overflow-x: auto;
}

img {
  margin: 30px;
  padding: 1px;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  border-radius: 3px;
  -webkit-box-shadow: 0 3px 10px #dedede, 0 1px 5px #888;
  -moz-box-shadow: 0 3px 10px #dedede, 0 1px 5px #888;
  box-shadow: 0 3px 10px #dedede, 0 1px 5px #888;
  max-width: 100%;
}

footer {
  background: #eee;
  width: 100%;
  padding: 50px 0;
  text-align: right;
  border-top: 1px solid #ddd;
}

footer span {
  display: block;
  margin-right: 30px;
  color: #888;
  font-size: 12px;
}

#menu {
  position: fixed;
  font-size: 12px;
  overflow-y: auto;
  top: 0;
  right: 0;
  margin: 0;
  height: 100%;
  padding: 60px 0;
  text-align: right;
  border-left: 1px solid #eee;
  -moz-box-shadow: 0 0 2px #888
     , inset 5px 0 20px rgba(0,0,0,.5)
     , inset 5px 0 3px rgba(0,0,0,.3);
  -webkit-box-shadow: 0 0 2px #888
     , inset 5px 0 20px rgba(0,0,0,.5)
     , inset 5px 0 3px rgba(0,0,0,.3);
  box-shadow: 0 0 2px #888
     , inset 5px 0 20px rgba(0,0,0,.5)
     , inset 5px 0 3px rgba(0,0,0,.3);
  -webkit-font-smoothing: antialiased;
  background: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGYAAABmCAMAAAAOARRQAAABelBMVEUjJSU6OzshIyM5OjoqKy02NjgsLS01NTYjJCUzNTUgISMlJSc0NTUvMDA6PDwlJyg1NjYoKis2NjYrLS02ODkpKyw0NDYrLC04ODovLzA4Ojo0NDUtLy86OjwjIyU4OTosLS82ODgtLS8hIyQvMTEnKCooKSsrKy0qLCwkJSUnKCkrLCwpKiwwMjIxMzMqLC0tLS0pKissLC00NTYwMDIwMTQpKysoKSovMDEtLzA2OTkxMzUrKywvLy8qKyszNTY5OzsqKiw6OjswMDExNDUoKiozNDUvMDIyNDY1Njg2Njk5OTozMzU0NjY4ODkiIyUiIyQ4OTkuMDEmKCowMjQwMTErLS4qKywwMTMhIiMpKiopKy0tLjAkJScxNDQvLzExNDYyNDQmKCk5OTslJig5OjskJSYxMzQrLS8gISIwMTIoKCk1NTUlJSUnJygwMDA4ODgiIiMhISI8PDw6Ojo5OTkpKSojIyQ7OzsyMjIpKSssLCw6Ozw1NjlrfLakAAAg2UlEQVR42jR6i3ea6rYvPgANIAhVXh8WvkQlioUiFlFcBtAmoiRNdzxqu9p0J7vrdK29zuPeex77nnvO/35n1r1ndHRktI0jTOacv/l7lCBK5UqVpOha/YxmWK7BC4TQFKVXrbYsnimqxuuMVlOQ0XltWjUdCwRJ1M+tC1KudOs9q6+da2adUewG0SC0SwELfHtgDds93VEuydEbl3QMWeNoYkR7b/0x1ZRobGI3mLwzAhePqTAwhg6aogjNsGy7/jwQ4rkdqe7CWLxF8k9LfMVFyRS7VJqtkrW8Vt/bkR8FZJao16ipknbC3Yw2lM7laO6HBEOadEZ2tpf65c4v8e3u7FyU6qbiNNyCuzXZ6pawgnwgmrpTT/Q7w2EZmiIJ0dzWDI7mhQ80IfRnMu2kzA5r5r1pIFoia+/d93HRYp1GV8TbrkWoU/+jdI0Ff6yGwTjT1Hn8J+8m1rKpGiYPuNiHnMtNMIv+zpsk84MYTNW1/+DpwXLvckdOCMYowVNPREe0QlM8xRHXXFhcNDzupwsSmb5pH+0t0RP2Qk+QtI7F1Qm6JRC6ZPBtPq/dq/kH+jxtCljn9TIpW6rQIgmSVyj6lPICIw4N/taka41PFUInth0je9+jO6Kt1G4/a7V2LEgG02B0pHVuCZrgltSKMuIl5SyufUv9mYuQi+mFgzbBEtFo2g+Dh4sSTrLNu8JPh00sQydpb00tqXBvqRN7Q7kqzcnIxCGnvZt/WmJacoOEO6Dcn8Qre03pOCSQxbMOXUuDNx9SxuLz4W1I18gvjViQ67zV0rxdWL8Te/TQkuo8STS41DR48W7L6YP2uWIqiUV8rd6Gbf/rnegKZeG8TpAM6afhGze9JAOxbLjsnUXEbrZ9vLYd7MT32cPF5mKKxmjy7huaoD9n62GOxni3iIJwv0IzZAZjdZkUtolCNLVfYZNaquFjGszVVf+J0vrz4CawoKdHnOzb0NMH7CDBOybfYNJ4rfeMyFNjkFYVTzMFs87rnPGXLUOeNKRVc0LnU7/UIgelzsy3CMuth0YfvnY0wsD3vODUL3eJcKqHQpm8yM3XZQWJxO6Un9iYloyyLpOwN2obHy6W6gbpcb44XmyC+mg+itAcaprGcrwZCqMj/GmtKn0zPvpTz/Cv1dw21XwP3cRupg3H3MF/S71eTKj1YrdwKdc2Mw0fRmb2sFf8lW3aU6JbIZSEPqvXvjM7G/aApyXlXeqKfMq0g/Su3rUGJPSPrtGElgknrZM3xUXqsAP6zMCNVn5u8aJnSNpJv2uru7t2jfRziW2+GuhqfldUNbPk71olwo+46ePUo1U3WKk/e5YK07F/wGRgcpODmQnIlVeHCWBE4puBi2jq28UKpqiN1/4UOrGz59TNYrrQHtd+11sG40BGD+pXdelNqGOg4NXe8W4eacJV/NS9/2Umtym6WQqveqR9xdCMElpxnbkalM4Vf9uaEcWZaKdyibEIjWKxJZPN95niCL3GiaXyssIrHxoLkqkzLCXULN46/f2h3tQJgyip+Tk9EAjJ9aJshq7t8X45aowSKspMSvPf7r9R8yxNptIaHS5ozuEm6luPDApugyNP8OaqiQ4BjaequXA54SLC83eHIY2r+CZp4409Xqw8Aa2oI7XkCrQi+in0w5AqF/kLNrcUz+qkl/lAobY1jSnx5OJNhyXIz3qfNFlXc0TKaglNwdWkWYt9QQ1Kr6W8zue21iNrdJk+N5oCr2O9nEtWKC7IS5J/zdDEYrmnAYfg6agCy+qcgz7ZofeDc4PbUWSvkshWuAc7OjiUyLkj+RAtdlwXJcjxdpkTTHDhK8lBCi8+JtvDVL1W6elmOM++YS0LuSlaP1oUvAeiW3cFnvTr8EbTz1tsSMYdGeZe40sRWu5uAfj7q+ZoKv2FNQ0p5XY1lmlcigHZqTPpabufEVrNuNPi165w3uCVQJHyJqmSJ7ZHnguqwtCmwViIJijj04ba2JNYtB+yORf5gg1/9t9iw4vUpeqiunSAbf+IBdj/b+iG2qrHvuNP0Vd/+ThVZT/lrvHYjjgDbbyxaqgHNM2uhxa1GW3UedZYhMMwM4mQhltouK+IV4NdbIQNM+8Yv311RZk9kT4tiYR4LkyFcuPpdcjuhUuFqBAWRZa11lcZ3gEBlXywsNhrt+plISZP5DlsV9l4EgY6J3yZPTUcMrgaWAT3oI79eSbGEbcJpr6BD8kyDiVt+G0/hXosQN4NFXKlfWIfsIs0BHODVok1/IGnKFHJYIquh8Xo+2+bkQNTGgWmN/fZ0Y33LSj6lr1GyV7mWIKg7ZTRZPGuhF/zjRNcQ1UPtSYgnWQxSs0yrVhwNDcdGMNSNe2JT3WuzbAM3HykyAajS3Uphf6STKEqxLas9EnmnhA/lyj9Uj+JoY7SVgVmGLl46Rm2u98sbkap2lzAdKBG4r6LgulQOSSjQv1GWdQ0jtDUK/mAaqM1Uqjpu4k3Rvfvxv7YTxLSK+wN3E5jVIzmF23uZ7hiH/sVP49D7tvoKp4S8b1LuvRlivVB/algbhcFITYVXvDpLzpDfplR2uD5V4XJFxpjmIpLc9Y5sB2TpBRix7Bme6GZIq+06v3XzNeTcA4obQIKxrnT4C2JpOqD92dbmSX8MGazly5EsZVMvSU1f4RZwyu8iQXbVdeLlZrjuTT1jrY1uk5c7iZ7RsvhhluqAkq4JpVQAg7RJFtSu+xgJ8Pv6O1j5DkLxT8mkbfyRW5DrQmG7hiDIjCgBsADbjuof6YHLGeV6a5Q1Smx9joUXPpdaaDx97A/Wq00oJkdR7ZYuQRfS533JtxO1erduqWOYIt3wh0wpbLuCNIYkwxbswbikCUu2CDCS+Q+7rgVtfRcm+SOcdKPRlZ/rE7wNVUEE39KTS5uvUKN1PUnkloPkyzhyGQ8qkouEjJ3H/VXdqG6asSRiw3ecMlBvDDt8dDhBHXMwZ2Cajzjr7/76T+IavqPYvz6r7//E/3X3+N//h/0QozbjPgPiir69P/8X3/9F/yv8b/827/++98WItPu5/Hvwd8YPf5bp/2/lX/T/+Of/0MJ/lYTa+L/Ef+d9vN/3/2T6P/+jyTzu/evf6U7vxN7B6pJkRtAF6jUr8I+P8RsP/ptGhfqFk+pQ/DgAy6NJtRYJdXmp4gK7WLqLKJ+MaKhGjOojvL+SnIWrkpy0SLHDe4QuyNzaEA15mLMCcmE8Em+4HdOihW4/ZWuppJEmzeAwcDtv7MuLc9y2V5atvxXNe3S4DUMt5/Qy2LM9kSYKiVWBuKlfp4nxTntpuW03JbIlkiRvBXmT23g1I2OYe6IizUHPIq6zm6mbfsbteKmi/sg9J+ocQBMctGFO7iljo8TPN+z3jxw4do+ZwfqoR9dkNTKHyM305GpTkfhcHexVkPVGEbUOjuo9f0UMPHBFlGEx0SLvJvVRKTwW7PSew5oPme+E42+frJa9cGt2njS3dK5kIif2eYbhuSEQXEqMVfUjhGIuin0G0/W5ezJyJQy3SpMLai4M0JUWb5u1k9tny5bd1pPwYBpQuDCXZl62xg4CdVEAtflXHs6JKmP/pH6mOl796Lgopj0o8d5kKh00hxG3OSdEE/QBo9Hgr8JJqAeLDwJohG5j/DGh61Rc/+tf22/8kEnxHNCEjo0ElvvGfESZkqmz2BDcKV1H1buSkhkdg7p1IMGs2s17nYjpblrWuE2K9WEO/hcRp5e9oOF/QBmOaDtgil+oaU6szPrdwW65fOB0KUTsVUn7LFU7J8e6cxJIl9+FHw5MQMzuQJ+4oxMH3iW/5GK+hWuG0T+gTLs+fAjdtUd58TmIUq04EeyRCYCjkldow234aIgR5bqwrtZosZ+6YEqAmDqatJ9lWasz4IquKALPtd92hGI3Z2BdzzZue+REl1Om4DIWD+RrtUTOJLI+S0jHowXXdAxsGLSd40zYNuEUlOGhrwL6c7tcOtUOvpJCP7QBQS19H+GvZn05ewjlVLz+IGKoC9TyfQjLMBNmXCuqqtTdOSukZW48B0HqgSTCBrBnlFvF4CG2Su7yFzqmJFURK3UmTT3ru050r0ptUpMilYnBJWfl2Bv6kPlUuE1kxxpdzui9AubsR2N2boVSu81OulAwBqoSr1LZ0LLYOomyZHmjqnXlP72s8LnDouEJjtodBvdHaG1jMySYO7crWd90MpCRyCG14vb5IE7Arupw/y/RcCm/Tm3zK6zYj8PYNaGldiUfkB/LHWcmf2lVM+mwyU27a0qq2tscrQ/vzBjN26DnntIrOyGizzXK35yKQdYnUABkyN4saz3WD/viF+eCcsXnIajdWYJWaYHRstIis9CS+tqnFGmz2j5uzfr3Z4prqgK4XOT/PyftvjZqIm8lhkfxJ7Ol3CJF1piYBGAG8wtAk56Drw1YwmOpcz+NdfkSpSLplRXLXHL0Rquj6YW/gabqgK7Dgr6NwtH0B/AN7XrN+MVJ6AmXmUuqmQulrNNYPmH0RoDogydOKLo/QbfYNARSQQKISRCzRXU+q9WWJFL3LZW6u34CkeG97xC0NNGaJ0bvK6SnZS3zPskr5EtuCgjMWR5o2x5BqhKmDWJPRe7JMEOyRb5uUKlHaGVtq5ivSOaSliSXp9SQm2qk8MRJh10MAp9QQ2H5t59J8rjiwSZtoIfMGjlLPVNdYl/LBR0AO6WLGDmkLkIPRE45Y9MftdAK/yNu1Hn6tzOQTesgQ+8fSzB19wO91vCnO23vOWQdwJ63SJrYjdfKFW6W281PKs2k8iT9ai1cgJ4sa3xqdvmtxR8/+D1B8AKc2u+6JftryRhMWSQtoSBgIyyQGyxcnELuAasXN12oSriU4RMz1DD6RL0TSV+om7i1Yt+jEE/jnawM8cX/UhN4nkiv/w9eALrzNhXuQfOzFL0Fi6SjF7/4Qn8rLYBoa85cvgAnkCEBP+HPbEnquVXCZsMS/yzYw2Vru60P/+nJPYKkzZFjmbykzUoEqV836T5q3fP/L383dF82tx18/AZgZczMAgyeWYKmSZIqtHL+e+O4ZRcq9VI3g/qPeCoiK4pcgEqdbS0S/Be54sbVQOuJVPNBblIghzeasNu7h/g+Sz1IdhI5lCwq1nUb3Ji4OCIcqQZqtqJ5w7rXrg/DA9IgVmEGhDgGecEwnCTHffXcXs0V3OCEVzYDKS1vp/oX+ng+6XVU86UjA6FMO2RXOOOrqY1GgPvrAk9HV/BXtCu5RuwF8qgdGDLsBcui4E33ymdBip1X8uKyhIWT8qNRDsXz+gvO9UiEC0d8RG4Tf2x8H4slljgHtCBcxHLTWOYJm5H/fCPCzOgf9qgOUxTRZ0Pc6ha5yLuLVT9ntvIa6gacE99mCovdUumTQdRP4RPsS9129eEe2uSvvGh0bV4Y3QPPhPZMqhZWSMa5R0Hc1SGO4IVOQc0FrirlibTVfKRrYkD8kz3b+X65/QkUNaZdrdl3mCap0Hf3YcCw/LiouJYNbqz88UqeDYv93yO7vvXtgl4XCyAO4ODkY6W+83+LZU//p3/zXNGGrUKClCiOnL27iJZbNWDF02XXAOeFlB7IaADoMH1Yqr+UP9biyZDEa/iJt4MDeIz6GKTdLVBfWGVtRN4fdT2rgReX8UXwF2zOrradm4J0nyTgdPnai3RvzpZvCKDUqjOwD/QA6EDaMCLewX6QWYVnHY1sx1bd8ovYnPm1ZvPH+rE20lWjOCnZ66/xDt0QAl15FjfBcZp+i9OU0RNPQ0t3x2pSNWo8eiYudwsnuP1Hq6iH1LJCJynkYsfgJ0p3pF6SoQk2l+jqE8CPk+ziGJRSKjs+W5AO185umPdkYzlK4wl7TC9NxyyDP7ZoyYVoXiuS6SjnInlLWrwz1i8bGTKXX0AVQWkSfIlglW3zRJRJ8bg5VgE6ZEnqNu9B++0GNQvDQJvFize4ESNKBJP+8vA3LM4AX5SIBq08Mob+7QMTCZx4nwP/64+4BnlZC+8WtlP/CXw6t1PwMwkJ3jhP1FiXLhDF/3I6FGUzO2DSi9ABxKyyL9paZxSEz40ZCPQToDAJu1959k7QdbVxgB4icsu2s4zsTPJhcEDo+N1GX4zSk/wriRh8AqwL62972i9HJHd1ydaLXVzvKvOfGGw5RVcUVMiKXFH4APdkQU/dc5BX0YfKTNZYXCW9mb8bc8mufoQP6BbdQmT99ZjoYfr/go4TgQX9IDgztim7wyFeGMfbNaeqj8Dzs38pgcqwSv2hbqB3oSGKWKy+sesY7p57wAHldqE6NDudk/W7s/zjrK4rZFlFvaGxnSZdHbc1y47qDN6xkoK8O3bfr2j41dlJZ71rB4dlDqapPFa8N6xBrprUdtenUCHwxKNhw1uuTBh+9uU45k4REpQABN2bAO9DSLqoIL26gNroWgup5pUMxHUNSq4Gyz47vBPvilpo5f9OYI2ddAqTqmnxXERxQJ3UK8fHbVE9HagHi3+tqNRoNsArdmAxHA5LwtQo9ZAaNKUTljnokljo2x8scqVpEEIPc01fPCdHOCg0DeWBz8D5TVAAfx8aRH5X2ZYNI3ebKDZdeJ+oBDAxmRqJ30Eh2/DaeAy5diVNMpEDmXiPDsGTzBLXy8eVDdJoIafgx/gxMyQi454QrW56nCyeELgSuNNEmYkflF+t3CZQOVRWjKhIuCclmQSlAXT3+4JGG75B4t/5hQ+ldMP4LsAW6z3XmU6IJJwpnGVnsgUZhoY1fZlwTR8wSU7xRejf2uCx9Z5trVTRRJP9KnEb134dEieil6eCOGWgboI7xsqsqM99jfJLTePjygKlH2CVxxsse9QRzTBFjD/Kjqitr/CCTBt/SJ6nLxz7cKP9pFqBpp0lN5y+adKNsZjrPuroemZauH9aTTFD3EKHW8S55XBLFQAt1jgxTQCTwxmx/JyfsZDN1RroN3VaxpSenpIX7K+ZbL8VdlQDcI4Cbzg3QJLa9yVqNxUelu+EtxLVqeekaAvSJkO6sSVqbUajxqhKshNpvZqoeApF0k/0P0ikkwUcbdwc4A1ejN7Oo0O15kG7hTMoK3hZRBCX7YYeLW0wvcXx/18n/u37yLgzBYVBUvORGli+sfRcX/74uD6P4hq+7xu54TlWJLFzT63uwUDwuEDdOjJQqx7JV+ZjaEAPi7t0MMrR4Q8Rkf18uxD6RK0RKh0hL8YU+DeL97i4pa5ZSyAfXKwZRS/8gXcxdZXm62RBDj8U3sN8x95b5PpPs/mCBKYvpaA50pN5Ct/499AFTtwQ5vgeSh+NHrKIi4NVpwM/XzRaNfJD856lPE6M21zWPguFsH7jbLVyEDfRmt4VwrhCJ5VTYmcSPfGgO5clfN+vbaDZ7sakU5+2vZ2WCDY031NxJarVytfDDVtiafcTGO2rJ/taoL3zChN2qmjxofczTOYQPPVQPh0JVtYgdUQINcSiNEEy58UdYXX1MpWUCEBx7LbcGtAm8XWRQTVOaoV3ySri4RShhs/B/0m4jX6OAwXOvcA09bNSG4czEGv/Wey6V/jbTCNTW6awXdNTcA1GsPe1E9fZdGl7R0vyoVpIdJtfC6d32NNErrvq/R+d65VG+YOwRXppXxOCYyGNSf1K3x6VxAW/vtz4EC1SgCOSPdN62sLsoIzuDfg8GwZAbquVO8HIuFP/ToVoeUB7nnwMF35a1wK1tI6fkrqFKhQdeJpwyls0pIy8AZde3/6LUUbFaYJthyUJSU/kqDXTLQElnn0Jr4B2RVghNrmNmoEn7pXIeshPguXVsvwoTdmClq49JJU3LWhHyWTrJL9bRP6VKv3tZoA/th77p5Jw++OEENvyvWy/pNeExiDUVQaXIRGh8xySZTI36yueFaSXo1uJY0RnXYgEOoWWOJHeaVuX/bGNhHsh2yinznl/++NJcE9j6fBPRcBdq9hb8awNw8U7Bl6GM7x69EDOIIbX/npZ++amlHR9L/35mE/2Ss4gb0xCcY4VyTFLRE796vHysLAamqcyO+aFQyJIDBNslbH2/MrAvZiSEIedc/cqjmv4fbda2pXbv+F5a2szSsdkm9noiNURXt8edUhGUF6fSZWd1IJaXKFwD+49R6eCXD4Bkef7j9tRtNMVgW8BhRz/Qpy1TmeYk0doyjZoJSbePOReVHgkFsCFuQJ+Lgc4BxeAsK/cOiNDRmdNw0ctYhn/nQ498dYI5znzGLoJi1rav7Cn88rL3wLePVtDK5gl77Tki3gHEsIAQ2+IKgarj7Y8W1IQzV5V9N+0TjLqbg68WfKcOmBCOj3JkwJhVIkwDhc+JorXuZEPMEh0vvH3x7iqf+VAwXgd4diZiaJD1zHL9Snx6Wfg4IugreyhabQkcir+y5XgDtdx3Avs7lkeeCBwDvZoTUCXx5QrZkcEqWfYEiEYRs/EphmRALSNGR1Iclgdr5VFoELpzF4++f35w3/j0t5ucW3n2ch4PQCLuUXupsPRR7UA5FjSKrMtPcKAZJfagO4lGE7FH3YKMjorpK0ZxAv+i2JkJhtAMWWWFej4RhPR/cJ3DxwocCvXDi4SGZU4cu+K32XndiFWgopAl+0GApcwf1XvymJcFs39jExIBO4yUjU9MExBLQYc9H+W7+IgdESPRpciT+rKZPebVtaVq+1GYO/5xTAL3HASjNTGIgMvdjWbgc7JvdE1zIFpuC0U9ESiZyzBixzxWxj4Kwh8My34q+FK3KNLtmsA1qyrmKSNQOXCPUZd+ONelBTvFoUI/CYsqa/RhtKiyMf2CgSFqEPk59Y3uqnlZ8gFpswfSYyko23yVZYxzKGxGm49Zqxg1l8oz5Ra9XaRwHkuxepmgyhm0SoNy2KlbcEqK+9QqS9PNx9Ihm9U7gsR55SSJ1FBDNnkuWKxIZ0SDpXuOGwZdoUbOMDPHP4vBAgz2VlSEJAHZGJVbYIg7l/FO5KfIVvxC8pPPxMGcNMoevFDeStt2iqztE10n2TA4dgJH76YS9HDhKHD3iCx6ieFX84BAI3QQnngh76f5ruPQVbr5qZmck/5UjDc26lfrOvUBWy0Ogl8bCoOkMOns81TnC3cuUS9KW8+9A+fe3XYZOFUPG1u5epSSmDLw0s5s2F0W30ANeo+zJkJQz9SPZgzwYpEoktofhGVfmLOAB20boCbW1QWq/NpET/hnMecw/uSyAH4NJc3ECOU4nnkK1fj3S/i5dwb3R7k00AqQQUwt7Ie1qV0aY/VQX0J8hLPy7eBNXMHYZYDNxHZ2Qh6AuXJxq+AeRec/Q+JLhZV6hpXwQEzw7bf5v9uUf2vpq3qlhmy0IIGTkwYdCfSAFmqbdo+3XvDTDjFJde0mbeQLcn2n31xaAqJ0ixO/CLsT4I4G4DoncVTgRGNBtsCcjISWT+oeXZ4Iedw/8OsJI1aPnNKLX/60VvcZb94uasRxCkqlPQ11u1Sa2hHvB80WQENxVyzjns0/PiEByyil21Te6oisk3mNCEMrhouCFO3yEZTHHOCMy9eb/4Tmi8cVf3Lf7P53SY2hX3PSN033As3ETIMLHWumWEO9JXHA2y2SIBlIPpLGG2qvNsCIlIr+B1SWAqRKm2w6Blf7U+zCSBwJrfHG5i8J5Gax/cVonMlon7aHJX/gSvucIncRP93XCqkv7D8IFKFsLiBgHqUpXhE3pYjEcV1dk/JD9zFVCfEaQIVX8Jmfz7IIofcBKQ4OaG+C3xC2veX9CD+iAFXDNaGg9eTVxvkbJRJlW4Nk9Wk13kn696jWppRDe/8pDrYMO9ZyxZ98ReKSz9kWKLLyk2zCZgAniCkLJVX3n1M9DYbomyahWiv/KixRIV9hj/oFz87I+HLznbPTjpa+D+bZQnMuRsljTpv90vQUt/pK7jCFnA30B/jtroSF2/m/gpWn1aQs5WeA6ghzF8SdqWI20fghdSeDOCSCmLgTkfaGgGDmw7nHFkRzGtag57IHS2na06I+gzEphXo1w/Zx2BM/jKL2nZoFjHggtFQjYi8nSVRSXIE58RPbBObXk7uuIL9+rs/5Zo7suJInEUxgsiZZAWS25iBtpEiZeBgDtghEoAE0sjcayNq85M4tbu/LF5h51335PsGzQ09O875+vUS89lkWMyNOFoip2PuyWyMP/iU2XIZdfCCJNDjebDoBLQdpy7QQZC7s9c0wjHJervQNDu2jWzBW5MSAJMr7bP+Iv92BkS/GGgzjEn7MF1IRKFwwzbjbS4/slGOmhx9cZrFu7HSEefojNv3r0UaKfKOWzXsq1zEugbzlMDFsacRJJI/iJlK3vtkZ+PLZIVMFlKA32wbq2Kd5T0uCLZ1CPkAfCdzkz2EYscjDcZq2AWfziN2covN4kXE1lQXPPLTNM1xx3tbiepcO/t3SWm4w87qfh99SL0ZnY+LKFPLPeXVM2mIIoVWt+9Nk0I7nY4O79iGYqxZ8RVz289an6NVdJWnSKZvJQCAuHNiVaDxPAFoH392t9wot5t0/qmU95eEWNbU2udUW5sN9JVqcYlvAIfLeYC33oUzzxZgSktsv21mA7Uly1FA5VnoJFh6N244Wmv3YJGFv/TCPryaw+ZORlpZjQdq/2DYXr3EZskfed0G61P09ipTKmlTQ1067Rg5+PAk5FlQ9e0SWbGf2B/08kqymOTMVOznsALHHNFH4LFRKl2F/NOiYFl9khNHnSu9Ak5sq26Ynl/i2fdTle29Y1ugqmR5Yj4YT9pvslFyYCbw0mNFr5rVQm1LvkG27QMq9ph3t8fmn6r6SQ4oSbr5tz+J1kIawGzDxb6VYOvvWhobDTXfBeNv3b4aNm5XUinsCGqG2q/45m3+LoCOsddFceYhRx1Tsss9PLdPfJdErFMjYd3gddjiP0+XQjcRadZP6bwNLySvunFf20Czy6JqdEW2a96KxdYdOryBv1BjbuUq2yCHeh+6sk7fGmmPi50pe/1l5TyPe5oHW9oPnhPswLyf2TFDdCyYlhwBCstv5C1HwlW7xWoGT9XZt4qVj5WryLPLLD6h/5cMLEjWzgCeAIKNsLak92aBqBsHl4AJwl2N4jfvbSkBExGimv0nFvv09uDScQbjx+w4kPQjgjlW+g9ws9VEJvI2k8N6XxVu0uIwovgTFdunG24gBtaDi+y1YLQwZ8mwbip5fVlO3k0n0AEr/ETbtu8Vjkm+nNSiEb7X/3fMjBL5A8PdgG+/FnbexbFFExmEfetXAnisEKy5z44WVPpQZjSy/jzeGn4yDRsFGqhh87QPaDBWhlo37IFbe/C0xynS91d2tP/AJoJS0sVF6iwAAAAAElFTkSuQmCC");
}

#menu::after {
  display: block;
  content: '';
  padding-top: 80px;
}

#logo {
  position: fixed;
  bottom: 10px;
  right: 10px;
  background: rgba(255,255,255,.1);
  font-size: 11px;
  display: block;
  width: 20px;
  height: 20px;
  line-height: 20px;
  text-align: center;
  -webkit-border-radius: 20px;
  -moz-border-radius: 20px;
  border-radius: 20px;
  -webkit-box-shadow: 0 0 3px rgba(0,0,0,.2);
  -moz-box-shadow: 0 0 3px rgba(0,0,0,.2);
  box-shadow: 0 0 3px rgba(0,0,0,.2);
  color: inherit;
}

#menu li a {
  display: block;
  color: white;
  padding: 0 35px 0 25px;
  -webkit-transition: background 300ms;
  -moz-transition: background 300ms;
}

#menu li {
  position: relative;
  list-style: none;
}

#menu a:hover,
#menu a.active {
  text-decoration: none;
  background: rgba(255,255,255,.1);
}

#menu li:hover .cov {
  opacity: 1;
}

#menu li .dirname {
  opacity: .9;
  padding-right: 2px;
  font-weight: normal;
}

#menu li .basename {
  opacity: 1;
  font-weight: bold;
}

#menu .cov {
  background: rgba(0,0,0,.4);
  position: absolute;
  top: 0;
  right: 8px;
  font-size: 9px;
  text-align: left;
  width: 17px;
  -webkit-border-radius: 10px;
  -moz-border-radius: 10px;
  border-radius: 10px;
  padding: 2px 3px;
  text-align: center;
}

#stats {
  font-size: 1.3em;
}

.stats:nth-child(2n) {
  display: inline-block;
  margin-top: 15px;
  border: 1px solid #eee;
  padding: 10px;
  -webkit-box-shadow: inset 0 0 2px #eee;
  -moz-box-shadow: inset 0 0 2px #eee;
  box-shadow: inset 0 0 2px #eee;
  -webkit-border-radius: 5px;
  -moz-border-radius: 5px;
  border-radius: 5px;
}

.stats div {
  float: left;
  padding: 0 5px;
}

.stats::after {
  display: block;
  content: '';
  clear: both;
}

.stats .sloc::after {
  color: #b6b6b6;
}

.stats .percentage::after {
  color: #b6b6b6;
}

.stats .hits,
.stats .misses {
  display: none;
}

.high {
  color: #3375B6;
}
#menu .high {
  color: #FFF;
}
.medium {
  color: #e87d0d;
}
.low {
  color: #d4081a;
}
.terrible {
  color: #d4081a;
  font-weight: bold;
}

.file {
    margin-top: 15px;
    width:80%;
    padding-left:1%;
    padding-right:1%;
    border: 1px solid #eee;
    border-radius:3px;
}

table {
  width:100%;
  margin-top: 0px;
  border-collapse: collapse;
  color: #363636;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  border-radius: 3px;
}

div.table {
  border: 1px solid #cbcbcb;
  margin-top: 10px;
  width: 100%;
  -webkit-border-radius: 7px;
  -moz-border-radius: 7px;
  border-radius: 7px;
  overflow:hidden;
}

table th {
  border-bottom: #a3a3a3 1px solid;
  border-right: #a3a3a3 1px solid;
  border-collapse: separate;
  font-size: 12px;
}

table th:last-child {
  border-right:none;
}

table td.line,
table td.hits,
table td.statements {
  color: rgb(0,0,0);
  width: 20px;
  background: #eaeaea;
  text-align: center;
  font-size: 11px;
  padding: 0 10px;
  border-left: #a3a3a3 1px solid;
  border-right: #a3a3a3 1px solid;
  border-collapse: separate;
}

table td.hits,
table td.statements {
  width: 10px;
  padding: 2px 5px;
}

table td.hits {
  background: #f0f0f0;  
}

tr.miss td.line,
tr.miss td.hits,
tr.miss td.statements {
  background: rgba(107, 0 ,1, 0.75);
}

tr.miss td {
  background: rgba(107, 0 ,1, 0.75);
  color: #fff;
}
tr.partial td.line,
tr.partial td.hits,
tr.partial td.statements {
  background: #fcf8e9;
}

tr.partial td {
  background: #fcf8e9;
  color: #000;
}

tr.partial td.source span.statement.notok {
  padding: 3px;
  margin: 3px;
  background: rgba(107, 0 ,1, 0.75);
  color: #fff;
}

td.source {
  padding-left: 15px;
  line-height: 15px;
  white-space: pre;
  font: 12px monaco, monospace;
}

.miss .action a {
  color: #fff;
}

code .comment { color: #ddd }
code .init { color: #2F6FAD }
code .string { color: #5890AD }
code .keyword { color: #8A6343 }
code .number { color: #2F6FAD }

.offscreen {
    border: 0;
    clip: rect(0 0 0 0);
    clip: rect(0, 0, 0, 0);
    height: 1px;
    margin: -1px;
    overflow: hidden;
    padding: 0;
    width: 1px;
    position: absolute;
}

</style></head><body><div id="menu" role="navigation"><li><a href="#overview">overview</a></li><li><span class="cov medium">53</span><a href="#index.js"><span class="dirname">/</span><span class="basename">index.js</span></a></li><li><span class="cov low">49</span><a href="#lib/core/options.js"><span class="dirname">lib/core/</span><span class="basename">options.js</span></a></li><li><span class="cov high">100</span><a href="#lib/core/init.js"><span class="dirname">lib/core/</span><span class="basename">init.js</span></a></li><li><span class="cov terrible">8</span><a href="#lib/core/initNav.js"><span class="dirname">lib/core/</span><span class="basename">initNav.js</span></a></li><li><span class="cov medium">71</span><a href="#lib/core/connect.js"><span class="dirname">lib/core/</span><span class="basename">connect.js</span></a></li><li><span class="cov terrible">5</span><a href="#lib/core/start.js"><span class="dirname">lib/core/</span><span class="basename">start.js</span></a></li><li><span class="cov terrible">2</span><a href="#lib/core/mount.js"><span class="dirname">lib/core/</span><span class="basename">mount.js</span></a></li><li><span class="cov terrible">2</span><a href="#lib/core/routes.js"><span class="dirname">lib/core/</span><span class="basename">routes.js</span></a></li><li><span class="cov medium">50</span><a href="#lib/core/static.js"><span class="dirname">lib/core/</span><span class="basename">static.js</span></a></li><li><span class="cov terrible">15</span><a href="#lib/core/importer.js"><span class="dirname">lib/core/</span><span class="basename">importer.js</span></a></li><li><span class="cov terrible">2</span><a href="#lib/core/createItems.js"><span class="dirname">lib/core/</span><span class="basename">createItems.js</span></a></li><li><span class="cov low">37</span><a href="#lib/core/redirect.js"><span class="dirname">lib/core/</span><span class="basename">redirect.js</span></a></li><li><span class="cov high">83</span><a href="#lib/core/list.js"><span class="dirname">lib/core/</span><span class="basename">list.js</span></a></li><li><span class="cov low">25</span><a href="#lib/core/getOrphanedLists.js"><span class="dirname">lib/core/</span><span class="basename">getOrphanedLists.js</span></a></li><li><span class="cov terrible">8</span><a href="#lib/core/bindEmailTestRoutes.js"><span class="dirname">lib/core/</span><span class="basename">bindEmailTestRoutes.js</span></a></li><li><span class="cov terrible">20</span><a href="#lib/core/wrapHTMLError.js"><span class="dirname">lib/core/</span><span class="basename">wrapHTMLError.js</span></a></li><li><span class="cov terrible">20</span><a href="#lib/middleware/initAPI.js"><span class="dirname">lib/middleware/</span><span class="basename">initAPI.js</span></a></li><li><span class="cov terrible">20</span><a href="#lib/content/index.js"><span class="dirname">lib/content/</span><span class="basename">index.js</span></a></li><li><span class="cov low">34</span><a href="#lib/content/page.js"><span class="dirname">lib/content/</span><span class="basename">page.js</span></a></li><li><span class="cov high">100</span><a href="#lib/content/type.js"><span class="dirname">lib/content/</span><span class="basename">type.js</span></a></li><li><span class="cov high">100</span><a href="#lib/content/types/index.js"><span class="dirname">lib/content/types/</span><span class="basename">index.js</span></a></li><li><span class="cov high">80</span><a href="#lib/content/types/text.js"><span class="dirname">lib/content/types/</span><span class="basename">text.js</span></a></li><li><span class="cov high">80</span><a href="#lib/content/types/html.js"><span class="dirname">lib/content/types/</span><span class="basename">html.js</span></a></li><li><span class="cov low">34</span><a href="#lib/list.js"><span class="dirname">lib/</span><span class="basename">list.js</span></a></li><li><span class="cov low">34</span><a href="#lib/schemaPlugins.js"><span class="dirname">lib/</span><span class="basename">schemaPlugins.js</span></a></li><li><span class="cov high">100</span><a href="#lib/fieldTypes/index.js"><span class="dirname">lib/fieldTypes/</span><span class="basename">index.js</span></a></li><li><span class="cov terrible">20</span><a href="#lib/fieldTypes/azurefile.js"><span class="dirname">lib/fieldTypes/</span><span class="basename">azurefile.js</span></a></li><li><span class="cov medium">55</span><a href="#lib/field.js"><span class="dirname">lib/</span><span class="basename">field.js</span></a></li><li><span class="cov high">93</span><a href="#lib/path.js"><span class="dirname">lib/</span><span class="basename">path.js</span></a></li><li><span class="cov high">85</span><a href="#lib/fieldTypes/boolean.js"><span class="dirname">lib/fieldTypes/</span><span class="basename">boolean.js</span></a></li><li><span class="cov terrible">12</span><a href="#lib/fieldTypes/cloudinaryimage.js"><span class="dirname">lib/fieldTypes/</span><span class="basename">cloudinaryimage.js</span></a></li><li><span class="cov terrible">14</span><a href="#lib/fieldTypes/cloudinaryimages.js"><span class="dirname">lib/fieldTypes/</span><span class="basename">cloudinaryimages.js</span></a></li><li><span class="cov terrible">10</span><a href="#lib/fieldTypes/code.js"><span class="dirname">lib/fieldTypes/</span><span class="basename">code.js</span></a></li><li><span class="cov medium">57</span><a href="#lib/fieldTypes/color.js"><span class="dirname">lib/fieldTypes/</span><span class="basename">color.js</span></a></li><li><span class="cov medium">60</span><a href="#lib/fieldTypes/date.js"><span class="dirname">lib/fieldTypes/</span><span class="basename">date.js</span></a></li><li><span class="cov medium">68</span><a href="#lib/fieldTypes/datetime.js"><span class="dirname">lib/fieldTypes/</span><span class="basename">datetime.js</span></a></li><li><span class="cov low">37</span><a href="#lib/fieldTypes/email.js"><span class="dirname">lib/fieldTypes/</span><span class="basename">email.js</span></a></li><li><span class="cov terrible">20</span><a href="#lib/fieldTypes/embedly.js"><span class="dirname">lib/fieldTypes/</span><span class="basename">embedly.js</span></a></li><li><span class="cov low">44</span><a href="#lib/fieldTypes/html.js"><span class="dirname">lib/fieldTypes/</span><span class="basename">html.js</span></a></li><li><span class="cov low">47</span><a href="#lib/fieldTypes/key.js"><span class="dirname">lib/fieldTypes/</span><span class="basename">key.js</span></a></li><li><span class="cov terrible">21</span><a href="#lib/fieldTypes/localfile.js"><span class="dirname">lib/fieldTypes/</span><span class="basename">localfile.js</span></a></li><li><span class="cov low">47</span><a href="#lib/fieldTypes/location.js"><span class="dirname">lib/fieldTypes/</span><span class="basename">location.js</span></a></li><li><span class="cov low">34</span><a href="#lib/fieldTypes/markdown.js"><span class="dirname">lib/fieldTypes/</span><span class="basename">markdown.js</span></a></li><li><span class="cov low">36</span><a href="#lib/fieldTypes/money.js"><span class="dirname">lib/fieldTypes/</span><span class="basename">money.js</span></a></li><li><span class="cov terrible">23</span><a href="#lib/fieldTypes/name.js"><span class="dirname">lib/fieldTypes/</span><span class="basename">name.js</span></a></li><li><span class="cov low">36</span><a href="#lib/fieldTypes/number.js"><span class="dirname">lib/fieldTypes/</span><span class="basename">number.js</span></a></li><li><span class="cov terrible">23</span><a href="#lib/fieldTypes/password.js"><span class="dirname">lib/fieldTypes/</span><span class="basename">password.js</span></a></li><li><span class="cov low">46</span><a href="#lib/fieldTypes/relationship.js"><span class="dirname">lib/fieldTypes/</span><span class="basename">relationship.js</span></a></li><li><span class="cov terrible">22</span><a href="#lib/fieldTypes/s3file.js"><span class="dirname">lib/fieldTypes/</span><span class="basename">s3file.js</span></a></li><li><span class="cov terrible">22</span><a href="#lib/fieldTypes/select.js"><span class="dirname">lib/fieldTypes/</span><span class="basename">select.js</span></a></li><li><span class="cov high">90</span><a href="#lib/fieldTypes/text.js"><span class="dirname">lib/fieldTypes/</span><span class="basename">text.js</span></a></li><li><span class="cov medium">60</span><a href="#lib/fieldTypes/textarea.js"><span class="dirname">lib/fieldTypes/</span><span class="basename">textarea.js</span></a></li><li><span class="cov medium">60</span><a href="#lib/fieldTypes/url.js"><span class="dirname">lib/fieldTypes/</span><span class="basename">url.js</span></a></li><li><span class="cov terrible">18</span><a href="#lib/fieldTypes/localfiles.js"><span class="dirname">lib/fieldTypes/</span><span class="basename">localfiles.js</span></a></li><li><span class="cov medium">51</span><a href="#lib/updateHandler.js"><span class="dirname">lib/</span><span class="basename">updateHandler.js</span></a></li><li><span class="cov medium">58</span><a href="#lib/view.js"><span class="dirname">lib/</span><span class="basename">view.js</span></a></li><li><span class="cov terrible">20</span><a href="#lib/email.js"><span class="dirname">lib/</span><span class="basename">email.js</span></a></li><li><span class="cov high">97</span><a href="#lib/security/csrf.js"><span class="dirname">lib/security/</span><span class="basename">csrf.js</span></a></li><li><span class="cov terrible">17</span><a href="#lib/session.js"><span class="dirname">lib/</span><span class="basename">session.js</span></a></li><li><span class="cov medium">57</span><a href="#lib/asyncdi.js"><span class="dirname">lib/</span><span class="basename">asyncdi.js</span></a></li></div><div id="coverage" role="main"><h1 id="overview">Coverage</h1><div id="stats" class="stats low"><div class="percentage">32% line coverage</div><div class="statements">25% statement coverage</div><div class="blocks">12% block coverage</div><div class="sloc">4601 SLOC</div><div class="hits"></div><div class="misses"></div></div><div id="files"><div class="file"><h2 id="index.js">index.js</h2><div class="stats medium"><div class="percentage">53% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">52% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">16% block coverage</div><div class="sloc">184 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr class="hit "><td class="line">1</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var fs = require('fs'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">2</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	path = require('path'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">3</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	_ = require('underscore'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">4</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	express = require('express'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">5</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	async = require('async'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">6</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	jade = require('jade'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">7</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	moment = require('moment'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">8</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	numeral = require('numeral'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">9</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	cloudinary = require('cloudinary'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">10</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	utils = require('keystone-utils');</span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">12</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var templateCache = {};</span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Don't use process.cwd() as it breaks module encapsulation</span></td><td class="action"></td></tr><tr><td class="line">16</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Instead, let's use module.parent if it's present, or the module itself if there is no parent (probably testing keystone directly if that's the case)</span></td><td class="action"></td></tr><tr><td class="line">17</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * This way, the consuming app/module can be an embedded node_module and path resolutions will still work</span></td><td class="action"></td></tr><tr><td class="line">18</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * (process.cwd() breaks module encapsulation if the consuming app/module is itself a node_module)</span></td><td class="action"></td></tr><tr><td class="line">19</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr class="hit "><td class="line">20</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var moduleRoot = (function(_rootPath) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">21</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	var parts = _rootPath.split(path.sep);</span></td><td class="action"></td></tr><tr class="hit "><td class="line">22</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	parts.pop(); //get rid of /node_modules from the end of the path</span></td><td class="action"></td></tr><tr class="hit "><td class="line">23</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	return parts.join(path.sep);</span></td><td class="action"></td></tr><tr class="hit partial"><td class="line">24</td><td class="hits">1</td><td class="statements">50%</td><td class="source"><span class="statement ">})(module.parent ? module.parent.paths[0] :</span><span class="statement notok"><span class="offscreen"> not covered </span>module.paths[0]</span><span class="statement ">;</span></td><td class="action"></td></tr><tr><td class="line">25</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">26</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">28</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Keystone Class</span></td><td class="action"></td></tr><tr><td class="line">29</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">30</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">31</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">32</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">33</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var Keystone = function() {
	</span></td><td class="action"></td></tr><tr class="hit "><td class="line">34</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.lists = {};</span></td><td class="action"></td></tr><tr class="hit "><td class="line">35</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.paths = {};</span></td><td class="action"></td></tr><tr class="hit "><td class="line">36</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	this._options = {
		'name': 'Keystone',
		'brand': 'Keystone',
		'compress': true,
		'headless': false,
		'logger': 'dev',
		'auto update': false,
		'model prefix': null
	};</span></td><td class="action"></td></tr><tr><td class="line">37</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		'name': 'Keystone',</span></td><td class="action"></td></tr><tr class="hit "><td class="line">38</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	this._pre = {
		routes: [],
		render: []
	};</span></td><td class="action"></td></tr><tr class="hit "><td class="line">39</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	this._redirects = {};</span></td><td class="action"></td></tr><tr><td class="line">40</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="hit "><td class="line">41</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.express = express;</span></td><td class="action"></td></tr><tr><td class="line">42</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="hit "><td class="line">43</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.set('env', process.env.NODE_ENV || 'development');</span></td><td class="action"></td></tr><tr><td class="line">44</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="hit "><td class="line">45</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.set('port', process.env.PORT || process.env.OPENSHIFT_NODEJS_PORT);</span></td><td class="action"></td></tr><tr class="hit "><td class="line">46</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.set('host', process.env.HOST || process.env.IP || process.env.OPENSHIFT_NODEJS_IP);</span></td><td class="action"></td></tr><tr class="hit "><td class="line">47</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.set('listen', process.env.LISTEN);</span></td><td class="action"></td></tr><tr><td class="line">48</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="hit "><td class="line">49</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.set('ssl', process.env.SSL);</span></td><td class="action"></td></tr><tr class="hit "><td class="line">50</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.set('ssl port', process.env.SSL_PORT);</span></td><td class="action"></td></tr><tr class="hit "><td class="line">51</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.set('ssl host', process.env.SSL_HOST || process.env.SSL_IP);</span></td><td class="action"></td></tr><tr class="hit "><td class="line">52</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.set('ssl key', process.env.SSL_KEY);</span></td><td class="action"></td></tr><tr class="hit "><td class="line">53</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.set('ssl cert', process.env.SSL_CERT);</span></td><td class="action"></td></tr><tr><td class="line">54</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="hit "><td class="line">55</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.set('cookie secret', process.env.COOKIE_SECRET);</span></td><td class="action"></td></tr><tr class="hit partial"><td class="line">56</td><td class="hits">1</td><td class="statements">83%</td><td class="source"><span class="statement ">	this.set('cookie signin', (this.get('env') === 'development') ? true :</span><span class="statement notok"><span class="offscreen"> not covered </span>false</span><span class="statement ">;</span></td><td class="action"></td></tr><tr><td class="line">57</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="hit "><td class="line">58</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.set('embedly api key', process.env.EMBEDLY_API_KEY || process.env.EMBEDLY_APIKEY);</span></td><td class="action"></td></tr><tr class="hit "><td class="line">59</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.set('mandrill api key', process.env.MANDRILL_API_KEY || process.env.MANDRILL_APIKEY);</span></td><td class="action"></td></tr><tr class="hit "><td class="line">60</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.set('mandrill username', process.env.MANDRILL_USERNAME);</span></td><td class="action"></td></tr><tr class="hit "><td class="line">61</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.set('google api key', process.env.GOOGLE_BROWSER_KEY);</span></td><td class="action"></td></tr><tr class="hit "><td class="line">62</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.set('google server api key', process.env.GOOGLE_SERVER_KEY);</span></td><td class="action"></td></tr><tr class="hit "><td class="line">63</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.set('ga property', process.env.GA_PROPERTY);</span></td><td class="action"></td></tr><tr class="hit "><td class="line">64</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.set('ga domain', process.env.GA_DOMAIN);</span></td><td class="action"></td></tr><tr class="hit "><td class="line">65</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.set('chartbeat property', process.env.CHARTBEAT_PROPERTY);</span></td><td class="action"></td></tr><tr class="hit "><td class="line">66</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.set('chartbeat domain', process.env.CHARTBEAT_DOMAIN);</span></td><td class="action"></td></tr><tr class="hit "><td class="line">67</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.set('allowed ip ranges', process.env.ALLOWED_IP_RANGES);</span></td><td class="action"></td></tr><tr><td class="line">68</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="hit "><td class="line">69</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (process.env.S3_BUCKET &amp;&amp; process.env.S3_KEY &amp;&amp; process.env.S3_SECRET) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">70</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		this.set('s3 config', { bucket: process.env.S3_BUCKET, key: process.env.S3_KEY, secret: process.env.S3_SECRET, region: process.env.S3_REGION });</span></td><td class="action"></td></tr><tr><td class="line">71</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">72</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (process.env.AZURE_STORAGE_ACCOUNT &amp;&amp; process.env.AZURE_STORAGE_ACCESS_KEY) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">73</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		this.set('azurefile config', { account: process.env.AZURE_STORAGE_ACCOUNT, key: process.env.AZURE_STORAGE_ACCESS_KEY });</span></td><td class="action"></td></tr><tr><td class="line">74</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">75</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		this.set('cloudinary config', true);</span></td><td class="action"></td></tr><tr><td class="line">76</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">77</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.initAPI = require('./lib/middleware/initAPI')(this);</span></td><td class="action"></td></tr><tr><td class="line">78</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">79</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">80</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">_.extend(Keystone.prototype, require('./lib/core/options')(moduleRoot));</span></td><td class="action"></td></tr><tr><td class="line">81</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">82</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">83</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">84</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Registers a pre-event handler.</span></td><td class="action"></td></tr><tr><td class="line">85</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">86</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Valid events include:</span></td><td class="action"></td></tr><tr><td class="line">87</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * - `routes` - calls the function before any routes are matched, after all other middleware</span></td><td class="action"></td></tr><tr><td class="line">88</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">89</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {String} event</span></td><td class="action"></td></tr><tr><td class="line">90</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Function} function to call</span></td><td class="action"></td></tr><tr><td class="line">91</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">92</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">93</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">94</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Keystone.prototype.pre = function(event, fn) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">95</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!this._pre[event]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">96</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('keystone.pre() Error: event ' + event + ' does not exist.');</span></td><td class="action"></td></tr><tr><td class="line">97</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">98</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._pre[event].push(fn);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">99</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return this;</span></td><td class="action"></td></tr><tr><td class="line">100</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">101</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">102</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">103</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Keystone.prototype.prefixModel = function (key) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">104</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">	var modelPrefix = this.get('model prefix');</span></td><td class="action"></td></tr><tr><td class="line">105</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="hit "><td class="line">106</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (modelPrefix)</span></td><td class="action"></td></tr><tr class="miss"><td class="line">107</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		key = modelPrefix + '_' + key;</span></td><td class="action"></td></tr><tr><td class="line">108</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="hit "><td class="line">109</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">	return require('mongoose/lib/utils').toCollectionName(key);</span></td><td class="action"></td></tr><tr><td class="line">110</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">111</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">112</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/* Attach core functionality to Keystone.prototype */</span></td><td class="action"></td></tr><tr class="hit "><td class="line">113</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Keystone.prototype.init = require('./lib/core/init');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">114</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Keystone.prototype.initNav = require('./lib/core/initNav');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">115</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Keystone.prototype.connect = require('./lib/core/connect');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">116</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Keystone.prototype.start = require('./lib/core/start');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">117</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Keystone.prototype.mount = require('./lib/core/mount');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">118</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Keystone.prototype.routes = require('./lib/core/routes');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">119</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Keystone.prototype.static = require('./lib/core/static');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">120</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Keystone.prototype.importer = require('./lib/core/importer');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">121</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Keystone.prototype.createItems = require('./lib/core/createItems');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">122</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Keystone.prototype.redirect = require('./lib/core/redirect');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">123</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Keystone.prototype.list = require('./lib/core/list');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">124</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Keystone.prototype.getOrphanedLists = require('./lib/core/getOrphanedLists');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">125</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Keystone.prototype.bindEmailTestRoutes = require('./lib/core/bindEmailTestRoutes');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">126</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Keystone.prototype.wrapHTMLError = require('./lib/core/wrapHTMLError');</span></td><td class="action"></td></tr><tr><td class="line">127</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">128</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">129</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">130</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * The exports object is an instance of Keystone.</span></td><td class="action"></td></tr><tr><td class="line">131</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">132</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">133</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">134</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">135</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var keystone = module.exports = exports = new Keystone();</span></td><td class="action"></td></tr><tr><td class="line">136</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">137</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>// Expose modules and Classes</span></td><td class="action"></td></tr><tr class="hit "><td class="line">138</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">keystone.utils = utils;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">139</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">keystone.content = require('./lib/content');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">140</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">keystone.List = require('./lib/list');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">141</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">keystone.Field = require('./lib/field');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">142</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">keystone.Field.Types = require('./lib/fieldTypes');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">143</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">keystone.View = require('./lib/view');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">144</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">keystone.Email = require('./lib/email');</span></td><td class="action"></td></tr><tr><td class="line">145</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">146</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">keystone.security = {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">147</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	csrf: require('./lib/security/csrf')</span></td><td class="action"></td></tr><tr><td class="line">148</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">149</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">150</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">151</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">152</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * returns all .js modules (recursively) in the path specified, relative</span></td><td class="action"></td></tr><tr><td class="line">153</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * to the module root (where the keystone project is being consumed from).</span></td><td class="action"></td></tr><tr><td class="line">154</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">155</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * ####Example:</span></td><td class="action"></td></tr><tr><td class="line">156</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">157</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *     var models = keystone.import('models');</span></td><td class="action"></td></tr><tr><td class="line">158</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">159</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {String} dirname</span></td><td class="action"></td></tr><tr><td class="line">160</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">161</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">162</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">163</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Keystone.prototype.import = function(dirname) {
	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">164</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var initialPath = path.join(moduleRoot, dirname);</span></td><td class="action"></td></tr><tr><td class="line">165</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">166</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var doImport = function(fromPath) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">167</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var imported = {};</span></td><td class="action"></td></tr><tr><td class="line">168</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">169</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		fs.readdirSync(fromPath).forEach(function(name) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">170</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var fsPath = path.join(fromPath, name),</span></td><td class="action"></td></tr><tr><td class="line">171</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			</span></td><td class="action"></td></tr><tr><td class="line">172</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			// recur</span></td><td class="action"></td></tr><tr class="miss"><td class="line">173</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (info.isDirectory()) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">174</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				imported[name] = doImport(fsPath);</span></td><td class="action"></td></tr><tr><td class="line">175</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">176</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				var parts = name.split('.');</span></td><td class="action"></td></tr><tr class="miss"><td class="line">177</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				var ext = parts.pop();</span></td><td class="action"></td></tr><tr class="miss"><td class="line">178</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (ext === 'js' || ext === 'coffee') {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">179</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					imported[parts.join('-')] = require(fsPath);</span></td><td class="action"></td></tr><tr><td class="line">180</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr><td class="line">181</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">182</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return imported;</span></td><td class="action"></td></tr><tr><td class="line">183</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">184</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">185</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return doImport(initialPath);</span></td><td class="action"></td></tr><tr><td class="line">186</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">187</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">188</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">189</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">190</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Applies Application updates</span></td><td class="action"></td></tr><tr><td class="line">191</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">192</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">193</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Keystone.prototype.applyUpdates = function(callback) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">194</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	require('./lib/updates').apply(callback);</span></td><td class="action"></td></tr><tr><td class="line">195</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">196</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">197</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">198</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">199</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Renders a Keystone View</span></td><td class="action"></td></tr><tr><td class="line">200</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">201</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api private</span></td><td class="action"></td></tr><tr><td class="line">202</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">203</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">204</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Keystone.prototype.render = function(req, res, view, ext) {
	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">205</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var keystone = this;</span></td><td class="action"></td></tr><tr><td class="line">206</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">207</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var templatePath = __dirname + '/templates/views/' + view + '.jade';</span></td><td class="action"></td></tr><tr><td class="line">208</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">209</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var jadeOptions = {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">210</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		pretty: keystone.get('env') !== 'production'</span></td><td class="action"></td></tr><tr><td class="line">211</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">212</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">213</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var compileTemplate = function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">214</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return jade.compile(fs.readFileSync(templatePath, 'utf8'), jadeOptions);</span></td><td class="action"></td></tr><tr><td class="line">215</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">216</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">217</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var template = this.get('viewCache')</span></td><td class="action"></td></tr><tr class="miss"><td class="line">218</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		? templateCache[view] || (templateCache[view] = compileTemplate())</span></td><td class="action"></td></tr><tr class="miss"><td class="line">219</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		: compileTemplate();</span></td><td class="action"></td></tr><tr><td class="line">220</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">221</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var flashMessages = {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">222</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		info: res.req.flash('info'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">223</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		success: res.req.flash('success'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">224</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		warning: res.req.flash('warning'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">225</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		error: res.req.flash('error'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">226</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		hilight: res.req.flash('hilight')</span></td><td class="action"></td></tr><tr><td class="line">227</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">228</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">229</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var locals = {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">230</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		env: this.get('env'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">231</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		brand: keystone.get('brand'),</span></td><td class="action"></td></tr><tr><td class="line">232</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		nav: keystone.nav,</span></td><td class="action"></td></tr><tr class="miss"><td class="line">233</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		messages: _.any(flashMessages, function(msgs) { return msgs.length; }) ? flashMessages : false,</span></td><td class="action"></td></tr><tr><td class="line">234</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		lists: keystone.lists,</span></td><td class="action"></td></tr><tr class="miss"><td class="line">235</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		signout: this.get('signout url'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">236</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		backUrl: this.get('back url') || '/',</span></td><td class="action"></td></tr><tr><td class="line">237</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		section: {},</span></td><td class="action"></td></tr><tr class="miss"><td class="line">238</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		csrf_token_value: keystone.security.csrf.getToken(req, res),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">239</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		csrf_query: '&amp;' + keystone.security.csrf.TOKEN_KEY + '=' + keystone.security.csrf.getToken(req, res),</span></td><td class="action"></td></tr><tr><td class="line">240</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		ga: {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">241</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			property: this.get('ga property'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">242</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			domain: this.get('ga domain')</span></td><td class="action"></td></tr><tr><td class="line">243</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		},</span></td><td class="action"></td></tr><tr class="miss"><td class="line">244</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			enableImages: keystone.get('wysiwyg images') ? true : false,</span></td><td class="action"></td></tr><tr class="miss"><td class="line">245</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			enableCloudinaryUploads: keystone.get('wysiwyg cloudinary images') ? true : false,</span></td><td class="action"></td></tr><tr class="miss"><td class="line">246</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			additionalButtons: keystone.get('wysiwyg additional buttons') || '',</span></td><td class="action"></td></tr><tr class="miss"><td class="line">247</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			additionalPlugins: keystone.get('wysiwyg additional plugins') || '',</span></td><td class="action"></td></tr><tr class="miss"><td class="line">248</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			additionalOptions: keystone.get('wysiwyg additional options') || {},</span></td><td class="action"></td></tr><tr class="miss"><td class="line">249</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			overrideToolbar: keystone.get('wysiwyg override toolbar'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">250</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			skin: keystone.get('wysiwyg skin') || 'keystone',</span></td><td class="action"></td></tr><tr class="miss"><td class="line">251</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			menubar: keystone.get('wysiwyg menubar')</span></td><td class="action"></td></tr><tr><td class="line">252</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">253</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">254</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	_.extend(locals, ext);</span></td><td class="action"></td></tr><tr><td class="line">255</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">256</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (keystone.get('cloudinary config')) {</span></td><td class="action"></td></tr><tr><td class="line">257</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		try {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">258</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var cloudinaryUpload = cloudinary.uploader.direct_upload();</span></td><td class="action"></td></tr><tr class="miss"><td class="line">259</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			locals.cloudinary = {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">260</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				cloud_name: keystone.get('cloudinary config').cloud_name,</span></td><td class="action"></td></tr><tr class="miss"><td class="line">261</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				api_key: keystone.get('cloudinary config').api_key,</span></td><td class="action"></td></tr><tr><td class="line">262</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				timestamp: cloudinaryUpload.hidden_fields.timestamp,</span></td><td class="action"></td></tr><tr><td class="line">263</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				signature: cloudinaryUpload.hidden_fields.signature,</span></td><td class="action"></td></tr><tr class="miss"><td class="line">264</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				prefix: keystone.get('cloudinary prefix') || '',</span></td><td class="action"></td></tr><tr><td class="line">265</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				uploader: cloudinary.uploader</span></td><td class="action"></td></tr><tr class="miss"><td class="line">266</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			locals.cloudinary_js_config = cloudinary.cloudinary_js_config();</span></td><td class="action"></td></tr><tr><td class="line">267</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		} catch(e) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">268</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (e === 'Must supply api_key') {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">269</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				throw new Error('Invalid Cloudinary Config Provided\n\n' +</span></td><td class="action"></td></tr><tr><td class="line">270</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">271</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				throw e;</span></td><td class="action"></td></tr><tr><td class="line">272</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">273</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	locals.fieldLocals = _.pick(locals, '_', 'moment', 'numeral', 'env', 'js', 'utils', 'user', 'cloudinary');</span></td><td class="action"></td></tr><tr><td class="line">274</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">275</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var html = template(_.extend(locals, ext));</span></td><td class="action"></td></tr><tr><td class="line">276</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">277</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	res.send(html);</span></td><td class="action"></td></tr><tr><td class="line">278</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">279</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">280</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">281</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Populates relationships on a document or array of documents</span></td><td class="action"></td></tr><tr><td class="line">282</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">283</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * WARNING: This is currently highly inefficient and should only be used in development, or for</span></td><td class="action"></td></tr><tr><td class="line">284</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * small data sets. There are lots of things that can be done to improve performance... later.</span></td><td class="action"></td></tr><tr><td class="line">285</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">286</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">287</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">288</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">289</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Keystone.prototype.populateRelated = function(docs, relationships, callback) {
	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">290</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (Array.isArray(docs)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">291</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		async.each(docs, function(doc, done) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">292</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			doc.populateRelated(relationships, done);</span></td><td class="action"></td></tr><tr><td class="line">293</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}, callback);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">294</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else if (docs &amp;&amp; docs.populateRelated) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">295</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		docs.populateRelated(relationships, callback);</span></td><td class="action"></td></tr><tr><td class="line">296</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">297</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		callback();</span></td><td class="action"></td></tr><tr><td class="line">298</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">299</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">300</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">301</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Logs a configuration error to the console</span></td><td class="action"></td></tr><tr><td class="line">302</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">303</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">304</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">305</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">306</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Keystone.prototype.console = {};</span></td><td class="action"></td></tr><tr class="hit "><td class="line">307</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Keystone.prototype.console.err = function(type, msg) {
	</span></td><td class="action"></td></tr><tr class="hit "><td class="line">308</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (keystone.get('logger')) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">309</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		var dashes = '\n------------------------------------------------\n';</span></td><td class="action"></td></tr><tr class="hit "><td class="line">310</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		console.log(dashes + 'KeystoneJS: ' + type + ':\n\n' + msg + dashes);</span></td><td class="action"></td></tr><tr><td class="line">311</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">312</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">313</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">314</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Keystone version</span></td><td class="action"></td></tr><tr><td class="line">315</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">316</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">317</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">318</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">319</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">keystone.version = require('./package.json').version;</span></td><td class="action"></td></tr><tr><td class="line">320</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">321</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">322</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>// Expose Modules</span></td><td class="action"></td></tr><tr class="hit "><td class="line">323</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">keystone.session = require('./lib/session');</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/core/options.js">lib/core/options.js</h2><div class="stats low"><div class="percentage">49% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">25% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">22% block coverage</div><div class="sloc">57 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr class="hit "><td class="line">1</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var path = require('path'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">2</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	_ = require('underscore'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">3</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	cloudinary = require('cloudinary'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">4</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	mandrillapi = require('mandrill-api'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">5</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	utils = require('keystone-utils');</span></td><td class="action"></td></tr><tr><td class="line">6</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">7</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function options(moduleRoot) {</span></td><td class="action"></td></tr><tr><td class="line">8</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="hit "><td class="line">9</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	var exports = {};</span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	/**</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 * This file contains methods specific to dealing with Keystone's options.</span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 * All exports are added to the Keystone.prototype</span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 */</span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">16</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Deprecated options that have been mapped to new keys</span></td><td class="action"></td></tr><tr class="hit "><td class="line">17</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	var remappedOptions = {
		'signin success': 'signin redirect',
		'signout': 'signout url'
	};</span></td><td class="action"></td></tr><tr><td class="line">18</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">19</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	/**</span></td><td class="action"></td></tr><tr><td class="line">20</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 * Sets keystone options</span></td><td class="action"></td></tr><tr><td class="line">21</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 *</span></td><td class="action"></td></tr><tr><td class="line">22</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 * ####Example:</span></td><td class="action"></td></tr><tr><td class="line">23</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 *</span></td><td class="action"></td></tr><tr><td class="line">24</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 *     keystone.set('user model', 'User') // sets the 'user model' option to `User`</span></td><td class="action"></td></tr><tr><td class="line">25</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 *</span></td><td class="action"></td></tr><tr><td class="line">26</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 * @param {String} key</span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 * @param {String} value</span></td><td class="action"></td></tr><tr><td class="line">28</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 * @api public</span></td><td class="action"></td></tr><tr><td class="line">29</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 */</span></td><td class="action"></td></tr><tr class="hit "><td class="line">30</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	exports.set = function(key, value) {
	 	</span></td><td class="action"></td></tr><tr class="hit "><td class="line">31</td><td class="hits">54</td><td class="statements">100%</td><td class="source"><span class="statement ">		if (arguments.length === 1) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">32</td><td class="hits">32</td><td class="statements">100%</td><td class="source"><span class="statement ">			return this._options[key];</span></td><td class="action"></td></tr><tr><td class="line">33</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">34</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (this.get('logger')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				console.log('\nWarning: the `' + key + '` option has been deprecated. Please use `' + remappedOptions[key] + '` instead.\n\n' +</span></td><td class="action"></td></tr><tr><td class="line">36</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			key = remappedOptions[key];</span></td><td class="action"></td></tr><tr><td class="line">38</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">39</td><td class="hits">22</td><td class="statements">100%</td><td class="source"><span class="statement ">		switch (key) {</span></td><td class="action"></td></tr><tr><td class="line">40</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			case 'cloudinary config':</span></td><td class="action"></td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (_.isObject(value)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">42</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					cloudinary.config(value);</span></td><td class="action"></td></tr><tr><td class="line">43</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">44</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				value = cloudinary.config();</span></td><td class="action"></td></tr><tr><td class="line">45</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			break;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">46</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">				if (value) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">47</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					this.mandrillAPI = new mandrillapi.Mandrill(value);</span></td><td class="action"></td></tr><tr><td class="line">48</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">49</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (value === true &amp;&amp; !this.get('session')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">50</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					this.set('session', true);</span></td><td class="action"></td></tr><tr><td class="line">51</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">52</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				this.nav = this.initNav(value);</span></td><td class="action"></td></tr><tr><td class="line">53</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			break;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">54</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if ('string' !== typeof value) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">55</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					if (Array.isArray(value) &amp;&amp; (value.length === 2 || value.length === 3)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">56</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						console.log('\nWarning: using an array for the `mongo` option has been deprecated.\nPlease use a mongodb connection string, e.g. mongodb://localhost/db_name instead.\n\n' +</span></td><td class="action"></td></tr><tr class="miss"><td class="line">57</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						value = (value.length === 2) ? 'mongodb://' + value[0] + '/' + value[1] : 'mongodb://' + value[0] + ':' + value[2] + '/' + value[1];</span></td><td class="action"></td></tr><tr><td class="line">58</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">59</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						console.error('\nInvalid Configuration:\nThe `mongo` option must be a mongodb connection string, e.g. mongodb://localhost/db_name\n');</span></td><td class="action"></td></tr><tr class="miss"><td class="line">60</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						process.exit(1);</span></td><td class="action"></td></tr><tr><td class="line">61</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">62</td><td class="hits">22</td><td class="statements">100%</td><td class="source"><span class="statement ">		this._options[key] = value;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">63</td><td class="hits">22</td><td class="statements">100%</td><td class="source"><span class="statement ">		return this;</span></td><td class="action"></td></tr><tr><td class="line">64</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">65</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">66</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">67</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	/**</span></td><td class="action"></td></tr><tr><td class="line">68</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 * Sets multiple keystone options.</span></td><td class="action"></td></tr><tr><td class="line">69</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 *</span></td><td class="action"></td></tr><tr><td class="line">70</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 * ####Example:</span></td><td class="action"></td></tr><tr><td class="line">71</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 *</span></td><td class="action"></td></tr><tr><td class="line">72</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 *     keystone.set({test: value}) // sets the 'test' option to `value`</span></td><td class="action"></td></tr><tr><td class="line">73</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 *</span></td><td class="action"></td></tr><tr><td class="line">74</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 * @param {Object} options</span></td><td class="action"></td></tr><tr><td class="line">75</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 * @api public</span></td><td class="action"></td></tr><tr><td class="line">76</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 */</span></td><td class="action"></td></tr><tr><td class="line">77</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">78</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	exports.options = function(options) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">79</td><td class="hits">3</td><td class="statements">100%</td><td class="source"><span class="statement ">		if (!arguments.length)</span></td><td class="action"></td></tr><tr class="miss"><td class="line">80</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return this._options;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">81</td><td class="hits">3</td><td class="statements">100%</td><td class="source"><span class="statement ">		if (utils.isObject(options)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">82</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var keys = Object.keys(options),</span></td><td class="action"></td></tr><tr><td class="line">83</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				i = keys.length,</span></td><td class="action"></td></tr><tr class="miss"><td class="line">84</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			while (i--) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">85</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				k = keys[i];</span></td><td class="action"></td></tr><tr class="miss"><td class="line">86</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				this.set(k, options[k]);</span></td><td class="action"></td></tr><tr><td class="line">87</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">88</td><td class="hits">3</td><td class="statements">100%</td><td class="source"><span class="statement ">		return this._options;</span></td><td class="action"></td></tr><tr><td class="line">89</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">90</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">91</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">92</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	/**</span></td><td class="action"></td></tr><tr><td class="line">93</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 * Gets keystone options</span></td><td class="action"></td></tr><tr><td class="line">94</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 *</span></td><td class="action"></td></tr><tr><td class="line">95</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 * ####Example:</span></td><td class="action"></td></tr><tr><td class="line">96</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 *</span></td><td class="action"></td></tr><tr><td class="line">97</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 *     keystone.get('test') // returns the 'test' value</span></td><td class="action"></td></tr><tr><td class="line">98</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 *</span></td><td class="action"></td></tr><tr><td class="line">99</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 * @param {String} key</span></td><td class="action"></td></tr><tr><td class="line">100</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 * @api public</span></td><td class="action"></td></tr><tr><td class="line">101</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 */</span></td><td class="action"></td></tr><tr><td class="line">102</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">103</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	exports.get = exports.set;</span></td><td class="action"></td></tr><tr><td class="line">104</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">105</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	/**</span></td><td class="action"></td></tr><tr><td class="line">106</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 * Gets an expanded path option, expanded to include moduleRoot if it is relative</span></td><td class="action"></td></tr><tr><td class="line">107</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 *</span></td><td class="action"></td></tr><tr><td class="line">108</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 * ####Example:</span></td><td class="action"></td></tr><tr><td class="line">109</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 *</span></td><td class="action"></td></tr><tr><td class="line">110</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 *     keystone.get('pathOption', 'defaultValue')</span></td><td class="action"></td></tr><tr><td class="line">111</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 *</span></td><td class="action"></td></tr><tr><td class="line">112</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 * @param {String} key</span></td><td class="action"></td></tr><tr><td class="line">113</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 * @param {String} defaultValue</span></td><td class="action"></td></tr><tr><td class="line">114</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 * @api public</span></td><td class="action"></td></tr><tr><td class="line">115</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 */</span></td><td class="action"></td></tr><tr><td class="line">116</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">117</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	exports.getPath = function(key, defaultValue) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">118</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return this.expandPath(this.get(key) || defaultValue);</span></td><td class="action"></td></tr><tr><td class="line">119</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">120</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">121</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	/**</span></td><td class="action"></td></tr><tr><td class="line">122</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 * Expands a path to include moduleRoot if it is relative</span></td><td class="action"></td></tr><tr><td class="line">123</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 *</span></td><td class="action"></td></tr><tr><td class="line">124</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 * @param {String} pathValue</span></td><td class="action"></td></tr><tr><td class="line">125</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 * @api public</span></td><td class="action"></td></tr><tr><td class="line">126</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	 */</span></td><td class="action"></td></tr><tr><td class="line">127</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">128</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	exports.expandPath = function(pathValue) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">129</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		pathValue = ('string' === typeof pathValue &amp;&amp; pathValue.substr(0,1) !== path.sep &amp;&amp; pathValue.substr(1,2) !== ':\\')</span></td><td class="action"></td></tr><tr class="miss"><td class="line">130</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			? path.join(moduleRoot, pathValue)</span></td><td class="action"></td></tr><tr class="miss"><td class="line">131</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			: pathValue;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">132</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return pathValue;</span></td><td class="action"></td></tr><tr><td class="line">133</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">134</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="hit "><td class="line">135</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	return exports;</span></td><td class="action"></td></tr><tr><td class="line">136</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">137</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">138</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">139</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">module.exports = options;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/core/init.js">lib/core/init.js</h2><div class="stats high"><div class="percentage">100% line coverage</div><div class="statements">100% statement coverage</div><div class="blocks">100% block coverage</div><div class="sloc">8 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Initialises Keystone in encapsulated mode.</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Creates an Express app and configures it if none has been connected.</span></td><td class="action"></td></tr><tr><td class="line">5</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">6</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Also connects to the default mongoose instance if none has been connected.</span></td><td class="action"></td></tr><tr><td class="line">7</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">8</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Accepts an options argument.</span></td><td class="action"></td></tr><tr><td class="line">9</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Returns `this` to allow chaining.</span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Object} options</span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">16</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var express = require('express');</span></td><td class="action"></td></tr><tr><td class="line">17</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">18</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function init(options) {</span></td><td class="action"></td></tr><tr><td class="line">19</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="hit "><td class="line">20</td><td class="hits">3</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.options(options);</span></td><td class="action"></td></tr><tr><td class="line">21</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="hit "><td class="line">22</td><td class="hits">3</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (!this.app) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">23</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">		this.app = express();</span></td><td class="action"></td></tr><tr><td class="line">24</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">25</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="hit "><td class="line">26</td><td class="hits">3</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (!this.mongoose) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">27</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">		this.connect(require('mongoose'));</span></td><td class="action"></td></tr><tr><td class="line">28</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">29</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="hit "><td class="line">30</td><td class="hits">3</td><td class="statements">100%</td><td class="source"><span class="statement ">	return this;</span></td><td class="action"></td></tr><tr><td class="line">31</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">32</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">33</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">34</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">module.exports = init;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/core/initNav.js">lib/core/initNav.js</h2><div class="stats terrible"><div class="percentage">8% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">8% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">0% block coverage</div><div class="sloc">35 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Initialises Keystone's internal nav config</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Object} nav</span></td><td class="action"></td></tr><tr><td class="line">5</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api private</span></td><td class="action"></td></tr><tr><td class="line">6</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">7</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">8</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var _ = require('underscore'),
	utils = require('keystone-utils');</span></td><td class="action"></td></tr><tr><td class="line">9</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function initNav(sections) {</span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">12</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var keystone = this;</span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">14</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var nav = {</span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">16</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!sections) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">17</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		sections = {};</span></td><td class="action"></td></tr><tr class="miss"><td class="line">18</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		nav.flat = true;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">19</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		_.each(this.lists, function(list) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">20</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (list.get('hidden')) return;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			sections[list.path] = [list.path];</span></td><td class="action"></td></tr><tr><td class="line">22</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		});</span></td><td class="action"></td></tr><tr><td class="line">23</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">24</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">25</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	_.each(sections, function(section, key) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">26</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if ('string' === typeof section) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">27</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			section = [section];</span></td><td class="action"></td></tr><tr><td class="line">28</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">29</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		section = {</span></td><td class="action"></td></tr><tr><td class="line">30</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			lists: section,</span></td><td class="action"></td></tr><tr class="miss"><td class="line">31</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			label: nav.flat ? keystone.list(section[0]).label : utils.keyToLabel(key)</span></td><td class="action"></td></tr><tr><td class="line">32</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		};</span></td><td class="action"></td></tr><tr class="miss"><td class="line">33</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		section.key = key;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">34</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		section.lists = _.map(section.lists, function(i) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var msg, list = keystone.list(i);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (!list) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				msg = 'Invalid Keystone Option (nav): list ' + i + ' has not been defined.\n';</span></td><td class="action"></td></tr><tr class="miss"><td class="line">38</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				throw new Error(msg);</span></td><td class="action"></td></tr><tr><td class="line">39</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">40</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (list.get('hidden')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				msg = 'Invalid Keystone Option (nav): list ' + i + ' is hidden.\n';</span></td><td class="action"></td></tr><tr class="miss"><td class="line">42</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				throw new Error(msg);</span></td><td class="action"></td></tr><tr><td class="line">43</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">44</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			nav.by.list[list.key] = section;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">45</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return list;</span></td><td class="action"></td></tr><tr><td class="line">46</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		});</span></td><td class="action"></td></tr><tr><td class="line">47</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (section.lists.length) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">48</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			nav.sections.push(section);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">49</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			nav.by.section[section.key] = section;</span></td><td class="action"></td></tr><tr><td class="line">50</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">51</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">52</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return nav;</span></td><td class="action"></td></tr><tr><td class="line">53</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">54</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">55</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">module.exports = initNav;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/core/connect.js">lib/core/connect.js</h2><div class="stats medium"><div class="percentage">71% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">77% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">75% block coverage</div><div class="sloc">7 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Connects keystone to the application's mongoose instance.</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * ####Example:</span></td><td class="action"></td></tr><tr><td class="line">5</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">6</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *     var mongoose = require('mongoose');</span></td><td class="action"></td></tr><tr><td class="line">7</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">8</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *     keystone.connect(mongoose);</span></td><td class="action"></td></tr><tr><td class="line">9</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Object} connections</span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function connect() {</span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// detect type of each argument</span></td><td class="action"></td></tr><tr class="hit "><td class="line">16</td><td class="hits">6</td><td class="statements">100%</td><td class="source"><span class="statement ">	for (var i = 0; i &lt; arguments.length; i++) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">17</td><td class="hits">3</td><td class="statements">100%</td><td class="source"><span class="statement ">		if (arguments[i].constructor.name === 'Mongoose') {</span></td><td class="action"></td></tr><tr><td class="line">18</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			// detected Mongoose</span></td><td class="action"></td></tr><tr class="hit "><td class="line">19</td><td class="hits">3</td><td class="statements">100%</td><td class="source"><span class="statement ">			this.mongoose = arguments[i];</span></td><td class="action"></td></tr><tr class="miss"><td class="line">20</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		} else if (arguments[i].name === 'app') {</span></td><td class="action"></td></tr><tr><td class="line">21</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			// detected Express app</span></td><td class="action"></td></tr><tr class="miss"><td class="line">22</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			this.app = arguments[i];</span></td><td class="action"></td></tr><tr><td class="line">23</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">24</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">25</td><td class="hits">3</td><td class="statements">100%</td><td class="source"><span class="statement ">	return this;</span></td><td class="action"></td></tr><tr><td class="line">26</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">28</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">module.exports = connect;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/core/start.js">lib/core/start.js</h2><div class="stats terrible"><div class="percentage">5% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">3% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">0% block coverage</div><div class="sloc">96 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Configures and starts a Keystone app in encapsulated mode.</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Connects to the database, runs updates and listens for incoming requests.</span></td><td class="action"></td></tr><tr><td class="line">5</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">6</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Events are fired during initialisation to allow customisation, including:</span></td><td class="action"></td></tr><tr><td class="line">7</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">8</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - onMount</span></td><td class="action"></td></tr><tr><td class="line">9</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - onStart</span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - onHttpServerCreated</span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - onHttpsServerCreated</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * If the events argument is a function, it is assumed to be the started event.</span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">16</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * ####Options:</span></td><td class="action"></td></tr><tr><td class="line">17</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">18</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Keystone supports the following options specifically for running in encapsulated mode:</span></td><td class="action"></td></tr><tr><td class="line">19</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">20</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - name</span></td><td class="action"></td></tr><tr><td class="line">21</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - port</span></td><td class="action"></td></tr><tr><td class="line">22</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - views</span></td><td class="action"></td></tr><tr><td class="line">23</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - view engine</span></td><td class="action"></td></tr><tr><td class="line">24</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - compress</span></td><td class="action"></td></tr><tr><td class="line">25</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - favico</span></td><td class="action"></td></tr><tr><td class="line">26</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - less</span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - static</span></td><td class="action"></td></tr><tr><td class="line">28</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - headless</span></td><td class="action"></td></tr><tr><td class="line">29</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - logger</span></td><td class="action"></td></tr><tr><td class="line">30</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - cookie secret</span></td><td class="action"></td></tr><tr><td class="line">31</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - session</span></td><td class="action"></td></tr><tr><td class="line">32</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - 404</span></td><td class="action"></td></tr><tr><td class="line">33</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - 500</span></td><td class="action"></td></tr><tr><td class="line">34</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - routes</span></td><td class="action"></td></tr><tr><td class="line">35</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - locals</span></td><td class="action"></td></tr><tr><td class="line">36</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - auto update</span></td><td class="action"></td></tr><tr><td class="line">37</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - ssl</span></td><td class="action"></td></tr><tr><td class="line">38</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - sslport</span></td><td class="action"></td></tr><tr><td class="line">39</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - sslkey</span></td><td class="action"></td></tr><tr><td class="line">40</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - sslcert</span></td><td class="action"></td></tr><tr><td class="line">41</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">42</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">43</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">44</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">45</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">46</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var fs = require('fs'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">47</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	http = require('http'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">48</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	https = require('https');</span></td><td class="action"></td></tr><tr><td class="line">49</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">50</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var dashes = '\n------------------------------------------------\n';</span></td><td class="action"></td></tr><tr><td class="line">51</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">52</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function start(events) {</span></td><td class="action"></td></tr><tr><td class="line">53</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">54</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Validate arguments</span></td><td class="action"></td></tr><tr><td class="line">55</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">56</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if ('function' === typeof events) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">57</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		events = { onStart: events };</span></td><td class="action"></td></tr><tr><td class="line">58</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">59</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">60</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!events) events = {};</span></td><td class="action"></td></tr><tr><td class="line">61</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">62</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Ensure Keystone has been initialised</span></td><td class="action"></td></tr><tr><td class="line">63</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">64</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!this.app) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">65</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('KeystoneJS Initialisaton Error:\n\napp must be initialised. Call keystone.init() or keystone.connect(new Express()) first.\n\n');</span></td><td class="action"></td></tr><tr><td class="line">66</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">67</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">68</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Localise references to this for closures</span></td><td class="action"></td></tr><tr><td class="line">69</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">70</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var keystone = this,</span></td><td class="action"></td></tr><tr><td class="line">71</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr><td class="line">72</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Maintain passed in onMount binding but override to start http servers</span></td><td class="action"></td></tr><tr><td class="line">73</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// (call user-defined onMount first if present)</span></td><td class="action"></td></tr><tr><td class="line">74</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">75</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var onMount = events.onMount;</span></td><td class="action"></td></tr><tr><td class="line">76</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">77</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	events.onMount = function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">78</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		onMount &amp;&amp; onMount();</span></td><td class="action"></td></tr><tr><td class="line">79</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">80</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var startupMessages = ['KeystoneJS Started:'],</span></td><td class="action"></td></tr><tr><td class="line">81</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			</span></td><td class="action"></td></tr><tr class="miss"><td class="line">82</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var serverStarted = function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">83</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			waitForServers--;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">84</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (waitForServers) return;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">85</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (keystone.get('logger')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">86</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				console.log(dashes + startupMessages.join('\n') + dashes);</span></td><td class="action"></td></tr><tr><td class="line">87</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">88</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			events.onStart &amp;&amp; events.onStart();</span></td><td class="action"></td></tr><tr><td class="line">89</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		};</span></td><td class="action"></td></tr><tr><td class="line">90</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">91</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		keystone.httpServer = http.createServer(app);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">92</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		events.onHttpServerCreated &amp;&amp; events.onHttpServerCreated();</span></td><td class="action"></td></tr><tr><td class="line">93</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">94</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var host = keystone.get('host'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">95</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			port = keystone.get('port'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">96</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			listen = keystone.get('listen'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">97</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			ssl = keystone.get('ssl');</span></td><td class="action"></td></tr><tr><td class="line">98</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			</span></td><td class="action"></td></tr><tr class="miss"><td class="line">99</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (ssl !== 'only') {</span></td><td class="action"></td></tr><tr><td class="line">100</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			</span></td><td class="action"></td></tr><tr class="miss"><td class="line">101</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var httpStarted = function(msg) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">102</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				return function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">103</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					startupMessages.push(msg);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">104</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					serverStarted();</span></td><td class="action"></td></tr><tr><td class="line">105</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				};</span></td><td class="action"></td></tr><tr><td class="line">106</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			};</span></td><td class="action"></td></tr><tr><td class="line">107</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				</span></td><td class="action"></td></tr><tr class="miss"><td class="line">108</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (port || port === 0) {</span></td><td class="action"></td></tr><tr><td class="line">109</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				</span></td><td class="action"></td></tr><tr class="miss"><td class="line">110</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				app.set('port', port);</span></td><td class="action"></td></tr><tr><td class="line">111</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				</span></td><td class="action"></td></tr><tr class="miss"><td class="line">112</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				var httpReadyMsg = keystone.get('name') + ' is ready';</span></td><td class="action"></td></tr><tr><td class="line">113</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				</span></td><td class="action"></td></tr><tr class="miss"><td class="line">114</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (host) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">115</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					httpReadyMsg += ' on http://' + host;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">116</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					if (port) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">117</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						httpReadyMsg += ':' + port;</span></td><td class="action"></td></tr><tr><td class="line">118</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">119</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					keystone.httpServer.listen(port, host, httpStarted(httpReadyMsg));</span></td><td class="action"></td></tr><tr><td class="line">120</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">121</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					if (port) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">122</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						httpReadyMsg += ' on port ' + port;</span></td><td class="action"></td></tr><tr><td class="line">123</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">124</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					keystone.httpServer.listen(port, httpStarted(httpReadyMsg));</span></td><td class="action"></td></tr><tr><td class="line">125</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">126</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			} else if (host) {</span></td><td class="action"></td></tr><tr><td class="line">127</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				// start listening on a specific host address and default port 3000</span></td><td class="action"></td></tr><tr class="miss"><td class="line">128</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				app.set('port', 3000);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">129</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				keystone.httpServer.listen(3000, host, httpStarted(keystone.get('name') + ' is ready on ' + host + ':3000'));</span></td><td class="action"></td></tr><tr class="miss"><td class="line">130</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			} else if (listen) {</span></td><td class="action"></td></tr><tr><td class="line">131</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				// start listening to a unix socket</span></td><td class="action"></td></tr><tr class="miss"><td class="line">132</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				keystone.httpServer.listen(listen, httpStarted(keystone.get('name') + ' is ready' + (('string' === typeof listen) ? ' on ' + listen : '')));</span></td><td class="action"></td></tr><tr><td class="line">133</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">134</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				app.set('port', 3000);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">135</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				keystone.httpServer.listen(3000, httpStarted(keystone.get('name') + ' is ready on default port 3000'));</span></td><td class="action"></td></tr><tr><td class="line">136</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">137</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			waitForServers--;</span></td><td class="action"></td></tr><tr><td class="line">138</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">139</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (ssl) {</span></td><td class="action"></td></tr><tr><td class="line">140</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			</span></td><td class="action"></td></tr><tr class="miss"><td class="line">141</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var sslOpts = {};</span></td><td class="action"></td></tr><tr><td class="line">142</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			</span></td><td class="action"></td></tr><tr class="miss"><td class="line">143</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (keystone.get('ssl cert') &amp;&amp; fs.existsSync(keystone.getPath('ssl cert'))) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">144</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				sslOpts.cert = fs.readFileSync(keystone.getPath('ssl cert'));</span></td><td class="action"></td></tr><tr><td class="line">145</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">146</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (keystone.get('ssl key') &amp;&amp; fs.existsSync(keystone.getPath('ssl key'))) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">147</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				sslOpts.key = fs.readFileSync(keystone.getPath('ssl key'));</span></td><td class="action"></td></tr><tr><td class="line">148</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">149</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (!sslOpts.key || !sslOpts.cert) {</span></td><td class="action"></td></tr><tr><td class="line">150</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				</span></td><td class="action"></td></tr><tr class="miss"><td class="line">151</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (ssl === 'only') {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">152</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					console.log(keystone.get('name') + ' failed to start: invalid ssl configuration');</span></td><td class="action"></td></tr><tr class="miss"><td class="line">153</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					process.exit();</span></td><td class="action"></td></tr><tr><td class="line">154</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">155</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					startupMessages.push('Warning: Invalid SSL Configuration');</span></td><td class="action"></td></tr><tr class="miss"><td class="line">156</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					serverStarted();</span></td><td class="action"></td></tr><tr><td class="line">157</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">158</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				var httpsStarted = function(msg) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">159</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					return function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">160</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						startupMessages.push(msg);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">161</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						serverStarted();</span></td><td class="action"></td></tr><tr><td class="line">162</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						};</span></td><td class="action"></td></tr><tr><td class="line">163</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					};</span></td><td class="action"></td></tr><tr><td class="line">164</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					</span></td><td class="action"></td></tr><tr class="miss"><td class="line">165</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				keystone.httpsServer = https.createServer(sslOpts, app);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">166</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				events.onHttpsServerCreated &amp;&amp; events.onHttpsServerCreated();</span></td><td class="action"></td></tr><tr><td class="line">167</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				</span></td><td class="action"></td></tr><tr class="miss"><td class="line">168</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				var sslHost = keystone.get('ssl host') || host,</span></td><td class="action"></td></tr><tr><td class="line">169</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					</span></td><td class="action"></td></tr><tr class="miss"><td class="line">170</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				var httpsReadyMsg = (ssl === 'only') ? keystone.get('name') + ' (SSL) is ready on ' : 'SSL Server is ready on ';</span></td><td class="action"></td></tr><tr><td class="line">171</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				</span></td><td class="action"></td></tr><tr class="miss"><td class="line">172</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (sslHost) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">173</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					keystone.httpsServer.listen(sslPort, sslHost, httpsStarted(httpsReadyMsg + 'https://' + sslHost + ':' + sslPort));</span></td><td class="action"></td></tr><tr><td class="line">174</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">175</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					var httpsPortMsg = (keystone.get('ssl port')) ? 'port: ' + keystone.get('ssl port') : 'default port 3001';</span></td><td class="action"></td></tr><tr class="miss"><td class="line">176</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					keystone.httpsServer.listen(sslPort, httpsStarted(httpsReadyMsg + httpsPortMsg));</span></td><td class="action"></td></tr><tr><td class="line">177</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">178</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			waitForServers--;</span></td><td class="action"></td></tr><tr><td class="line">179</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">180</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		process.on('uncaughtException', function(e) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">181</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (e.code === 'EADDRINUSE') {</span></td><td class="action"></td></tr><tr><td class="line">182</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				console.log(dashes +</span></td><td class="action"></td></tr><tr class="miss"><td class="line">183</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					keystone.get('name') + ' failed to start: address already in use\n' +</span></td><td class="action"></td></tr><tr class="miss"><td class="line">184</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					'Please check you are not already running a server on the specified port.\n');</span></td><td class="action"></td></tr><tr class="miss"><td class="line">185</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				process.exit();</span></td><td class="action"></td></tr><tr><td class="line">186</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}/* else if (e.code === 'ECONNRESET') {</span></td><td class="action"></td></tr><tr><td class="line">187</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				// Connection reset by peer, ignore it instead of exiting server with a throw.</span></td><td class="action"></td></tr><tr class="miss"><td class="line">188</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				console.log(e.stack || e);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">189</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				process.exit(1);</span></td><td class="action"></td></tr><tr><td class="line">190</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr><td class="line">191</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr><td class="line">192</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">193</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	//mount the express app</span></td><td class="action"></td></tr><tr class="miss"><td class="line">194</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.mount(events);</span></td><td class="action"></td></tr><tr><td class="line">195</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">196</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return this;</span></td><td class="action"></td></tr><tr><td class="line">197</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">198</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">199</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">200</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">module.exports = start;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/core/mount.js">lib/core/mount.js</h2><div class="stats terrible"><div class="percentage">2% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">1% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">0% block coverage</div><div class="sloc">244 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Configures a Keystone app in encapsulated mode, but does not start it.</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Connects to the database and runs updates and then calls back.</span></td><td class="action"></td></tr><tr><td class="line">5</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">6</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * This is the code-path to use if you'd like to mount the keystone app as a sub-app in another express application.</span></td><td class="action"></td></tr><tr><td class="line">7</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">8</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   var app = express();</span></td><td class="action"></td></tr><tr><td class="line">9</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   //...do your normal express setup stuff, add middleware and routes (but not static content or error handling middleware yet)</span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   keystone.mount('/content', app, function() {</span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *	 //put your app's static content and error handling middleware here and start your server</span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   });</span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">16</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Events are fired during initialisation to allow customisation, including:</span></td><td class="action"></td></tr><tr><td class="line">17</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">18</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - onMount</span></td><td class="action"></td></tr><tr><td class="line">19</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">20</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * If the events argument is a function, it is assumed to be the mounted event.</span></td><td class="action"></td></tr><tr><td class="line">21</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">22</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">23</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * ####Options:</span></td><td class="action"></td></tr><tr><td class="line">24</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">25</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Keystone supports the following options specifically for running in encapsulated mode (with no embedded server):</span></td><td class="action"></td></tr><tr><td class="line">26</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - name</span></td><td class="action"></td></tr><tr><td class="line">28</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - port</span></td><td class="action"></td></tr><tr><td class="line">29</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - views</span></td><td class="action"></td></tr><tr><td class="line">30</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - view engine</span></td><td class="action"></td></tr><tr><td class="line">31</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - compress</span></td><td class="action"></td></tr><tr><td class="line">32</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - favico</span></td><td class="action"></td></tr><tr><td class="line">33</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - less</span></td><td class="action"></td></tr><tr><td class="line">34</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - static</span></td><td class="action"></td></tr><tr><td class="line">35</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - headless</span></td><td class="action"></td></tr><tr><td class="line">36</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - logger</span></td><td class="action"></td></tr><tr><td class="line">37</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - cookie secret</span></td><td class="action"></td></tr><tr><td class="line">38</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - session</span></td><td class="action"></td></tr><tr><td class="line">39</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - 404</span></td><td class="action"></td></tr><tr><td class="line">40</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - 500</span></td><td class="action"></td></tr><tr><td class="line">41</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - routes</span></td><td class="action"></td></tr><tr><td class="line">42</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - locals</span></td><td class="action"></td></tr><tr><td class="line">43</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   - auto update</span></td><td class="action"></td></tr><tr><td class="line">44</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">45</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">46</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">47</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">48</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">49</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var _ = require('underscore'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">50</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	express = require('express'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">51</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	path = require('path'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">52</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	utils = require('keystone-utils');</span></td><td class="action"></td></tr><tr><td class="line">53</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">54</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var dashes = '\n------------------------------------------------\n';</span></td><td class="action"></td></tr><tr><td class="line">55</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">56</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function mount(mountPath, parentApp, events) {</span></td><td class="action"></td></tr><tr><td class="line">57</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">58</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Validate the express app instance</span></td><td class="action"></td></tr><tr><td class="line">59</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">60</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!this.app) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">61</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		console.error('\nKeystoneJS Initialisaton Error:\n\napp must be initialised. Call keystone.init() or keystone.connect(new Express()) first.\n');</span></td><td class="action"></td></tr><tr class="miss"><td class="line">62</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		process.exit(1);</span></td><td class="action"></td></tr><tr><td class="line">63</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">64</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">65</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Localise references to this for closures</span></td><td class="action"></td></tr><tr><td class="line">66</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">67</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var keystone = this,</span></td><td class="action"></td></tr><tr><td class="line">68</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">69</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// this.nativeApp indicates keystone has been mounted natively</span></td><td class="action"></td></tr><tr><td class="line">70</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// (not as part of a custom middleware stack)</span></td><td class="action"></td></tr><tr><td class="line">71</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// </span></td><td class="action"></td></tr><tr class="miss"><td class="line">72</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.nativeApp = true;</span></td><td class="action"></td></tr><tr><td class="line">73</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">74</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Initialise the mongo connection url</span></td><td class="action"></td></tr><tr><td class="line">75</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">76</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!this.get('mongo')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">77</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var dbName = this.get('db name') || utils.slug(this.get('name'));</span></td><td class="action"></td></tr><tr class="miss"><td class="line">78</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var dbUrl = process.env.MONGO_URI || process.env.MONGO_URL || process.env.MONGOLAB_URI || process.env.MONGOLAB_URL || (process.env.OPENSHIFT_MONGODB_DB_URL || 'mongodb://localhost/') + dbName;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">79</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		this.set('mongo', dbUrl);</span></td><td class="action"></td></tr><tr><td class="line">80</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">81</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">82</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Initialise and validate session options</span></td><td class="action"></td></tr><tr><td class="line">83</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">84</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!this.get('cookie secret')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">85</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		console.error('\nKeystoneJS Configuration Error:\n\nPlease provide a `cookie secret` value for session encryption.\n');</span></td><td class="action"></td></tr><tr class="miss"><td class="line">86</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		process.exit(1);</span></td><td class="action"></td></tr><tr><td class="line">87</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">88</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">89</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var sessionOptions = this.get('session options');</span></td><td class="action"></td></tr><tr><td class="line">90</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">91</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!_.isObject(sessionOptions)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">92</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		sessionOptions = {};</span></td><td class="action"></td></tr><tr><td class="line">93</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">94</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">95</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!sessionOptions.key) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">96</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		sessionOptions.key = 'keystone.sid';</span></td><td class="action"></td></tr><tr><td class="line">97</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">98</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">99</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	sessionOptions.cookieParser = express.cookieParser(this.get('cookie secret'));</span></td><td class="action"></td></tr><tr><td class="line">100</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">101</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var sessionStore = this.get('session store');</span></td><td class="action"></td></tr><tr><td class="line">102</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">103</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (sessionStore) {</span></td><td class="action"></td></tr><tr><td class="line">104</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">105</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var sessionStoreOptions = this.get('session store options') || {};</span></td><td class="action"></td></tr><tr><td class="line">106</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">107</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		// Perform any session store specific configuration or exit on an unsupported session store</span></td><td class="action"></td></tr><tr><td class="line">108</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">109</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		switch (sessionStore) {</span></td><td class="action"></td></tr><tr><td class="line">110</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			</span></td><td class="action"></td></tr><tr><td class="line">111</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			case 'mongo':</span></td><td class="action"></td></tr><tr><td class="line">112</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				// default session store for using MongoDB</span></td><td class="action"></td></tr><tr class="miss"><td class="line">113</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				sessionStore = 'connect-mongo';</span></td><td class="action"></td></tr><tr><td class="line">114</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			case 'connect-mongo':</span></td><td class="action"></td></tr><tr class="miss"><td class="line">115</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				_.defaults(sessionStoreOptions, {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">116</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					url: this.get('mongo')</span></td><td class="action"></td></tr><tr><td class="line">117</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				});</span></td><td class="action"></td></tr><tr><td class="line">118</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				break;</span></td><td class="action"></td></tr><tr><td class="line">119</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">120</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			case 'connect-mongostore':</span></td><td class="action"></td></tr><tr class="miss"><td class="line">121</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				_.defaults(sessionStoreOptions, {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">122</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (!sessionStoreOptions.db) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">123</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					console.error(</span></td><td class="action"></td></tr><tr><td class="line">124</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						'\nERROR: ' + sessionStore + ' requires `session store options` to be set.' +</span></td><td class="action"></td></tr><tr class="miss"><td class="line">125</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						'\n' +</span></td><td class="action"></td></tr><tr class="miss"><td class="line">126</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						'\nSee http://localhost:8080/docs/configuration#options-database for details.' +</span></td><td class="action"></td></tr><tr class="miss"><td class="line">127</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					'\n');</span></td><td class="action"></td></tr><tr class="miss"><td class="line">128</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					process.exit(1);</span></td><td class="action"></td></tr><tr><td class="line">129</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr><td class="line">130</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				break;</span></td><td class="action"></td></tr><tr><td class="line">131</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			</span></td><td class="action"></td></tr><tr><td class="line">132</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			case 'redis':</span></td><td class="action"></td></tr><tr><td class="line">133</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				// default session store for using Redis</span></td><td class="action"></td></tr><tr class="miss"><td class="line">134</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				sessionStore = 'connect-redis';</span></td><td class="action"></td></tr><tr><td class="line">135</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			case 'connect-redis':</span></td><td class="action"></td></tr><tr><td class="line">136</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				break;</span></td><td class="action"></td></tr><tr><td class="line">137</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">138</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			default:</span></td><td class="action"></td></tr><tr class="miss"><td class="line">139</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				console.error(</span></td><td class="action"></td></tr><tr><td class="line">140</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						'\nERROR: unsupported session store ' + sessionStore + '.' +</span></td><td class="action"></td></tr><tr class="miss"><td class="line">141</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						'\n' +</span></td><td class="action"></td></tr><tr class="miss"><td class="line">142</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						'\nSee http://localhost:8080/docs/configuration#options-database for details.' +</span></td><td class="action"></td></tr><tr class="miss"><td class="line">143</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					'\n');</span></td><td class="action"></td></tr><tr class="miss"><td class="line">144</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				process.exit(1);</span></td><td class="action"></td></tr><tr><td class="line">145</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				break;</span></td><td class="action"></td></tr><tr><td class="line">146</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">147</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">148</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		// Initialize the session store</span></td><td class="action"></td></tr><tr><td class="line">149</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		try {</span></td><td class="action"></td></tr><tr><td class="line">150</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			</span></td><td class="action"></td></tr><tr class="miss"><td class="line">151</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var _SessionStore = require(sessionStore)(express);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">152</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			sessionOptions.store = new _SessionStore(sessionStoreOptions);</span></td><td class="action"></td></tr><tr><td class="line">153</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			</span></td><td class="action"></td></tr><tr><td class="line">154</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		} catch(e) {</span></td><td class="action"></td></tr><tr><td class="line">155</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			</span></td><td class="action"></td></tr><tr class="miss"><td class="line">156</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (e.code === 'MODULE_NOT_FOUND') {</span></td><td class="action"></td></tr><tr><td class="line">157</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				</span></td><td class="action"></td></tr><tr><td class="line">158</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				// connect-redis must be explicitly installed @1.4.7, so we special-case it here</span></td><td class="action"></td></tr><tr class="miss"><td class="line">159</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				var installName = (sessionStore === 'connect-redis') ? sessionStore + '@1.4.7' : sessionStore;</span></td><td class="action"></td></tr><tr><td class="line">160</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				</span></td><td class="action"></td></tr><tr class="miss"><td class="line">161</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				console.error(</span></td><td class="action"></td></tr><tr><td class="line">162</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					'\nERROR: ' + sessionStore + ' not found.\n' +</span></td><td class="action"></td></tr><tr class="miss"><td class="line">163</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					'\nPlease install ' + sessionStore + ' from npm to use it as a `session store` option.' +</span></td><td class="action"></td></tr><tr class="miss"><td class="line">164</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					'\nYou can do this by running &quot;npm install ' + installName + ' --save&quot;.' +</span></td><td class="action"></td></tr><tr class="miss"><td class="line">165</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				'\n');</span></td><td class="action"></td></tr><tr class="miss"><td class="line">166</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				process.exit(1);</span></td><td class="action"></td></tr><tr><td class="line">167</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				</span></td><td class="action"></td></tr><tr><td class="line">168</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">169</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				throw e;</span></td><td class="action"></td></tr><tr><td class="line">170</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr><td class="line">171</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">172</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">173</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">174</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// expose initialised session options</span></td><td class="action"></td></tr><tr><td class="line">175</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">176</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.set('session options', sessionOptions);</span></td><td class="action"></td></tr><tr><td class="line">177</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">178</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// wrangle arguments</span></td><td class="action"></td></tr><tr><td class="line">179</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">180</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (arguments.length === 1) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">181</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		events = arguments[0];</span></td><td class="action"></td></tr><tr class="miss"><td class="line">182</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		mountPath = null;</span></td><td class="action"></td></tr><tr><td class="line">183</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">184</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">185</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if ('function' === typeof events) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">186</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		events = { onMount: events };</span></td><td class="action"></td></tr><tr><td class="line">187</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">188</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">189</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!events) events = {};</span></td><td class="action"></td></tr><tr><td class="line">190</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">191</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	/* Express sub-app mounting to external app at a mount point (if specified) */</span></td><td class="action"></td></tr><tr><td class="line">192</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">193</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (mountPath) {</span></td><td class="action"></td></tr><tr><td class="line">194</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		//fix root-relative keystone urls for assets (gets around having to re-write all the keystone templates)</span></td><td class="action"></td></tr><tr class="miss"><td class="line">195</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		parentApp.all(/^\/keystone($|\/*)/, function(req, res, next) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">196</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			req.url = mountPath + req.url;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">197</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			next();</span></td><td class="action"></td></tr><tr><td class="line">198</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		});</span></td><td class="action"></td></tr><tr><td class="line">199</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">200</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		parentApp.use(mountPath, app);</span></td><td class="action"></td></tr><tr><td class="line">201</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">202</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">203</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	/* Keystone's encapsulated Express App Setup */</span></td><td class="action"></td></tr><tr><td class="line">204</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">205</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Allow usage of custom view engines</span></td><td class="action"></td></tr><tr><td class="line">206</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">207</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (this.get('custom engine')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">208</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		app.engine(this.get('view engine'), this.get('custom engine'));</span></td><td class="action"></td></tr><tr><td class="line">209</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">210</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">211</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Set location of view templates and view engine</span></td><td class="action"></td></tr><tr><td class="line">212</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">213</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	app.set('views', this.getPath('views') || path.sep + 'views');</span></td><td class="action"></td></tr><tr class="miss"><td class="line">214</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	app.set('view engine', this.get('view engine'));</span></td><td class="action"></td></tr><tr><td class="line">215</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">216</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Apply locals</span></td><td class="action"></td></tr><tr><td class="line">217</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">218</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (utils.isObject(this.get('locals'))) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">219</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		_.extend(app.locals, this.get('locals'));</span></td><td class="action"></td></tr><tr><td class="line">220</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">221</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">222</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Indent HTML everywhere, except production</span></td><td class="action"></td></tr><tr><td class="line">223</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">224</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (this.get('env') !== 'production') {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">225</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		app.locals.pretty = true;</span></td><td class="action"></td></tr><tr><td class="line">226</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">227</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">228</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Default view caching logic</span></td><td class="action"></td></tr><tr><td class="line">229</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">230</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	app.set('view cache', this.get('env') === 'production' ? true : false);</span></td><td class="action"></td></tr><tr><td class="line">231</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">232</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Setup view caching from app settings</span></td><td class="action"></td></tr><tr><td class="line">233</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">234</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (this.get('view cache') !== undefined) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">235</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		app.set('view cache', this.get('view cache'));</span></td><td class="action"></td></tr><tr><td class="line">236</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">237</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">238</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Serve static assets</span></td><td class="action"></td></tr><tr><td class="line">239</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">240</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (this.get('compress')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">241</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		app.use(express.compress());</span></td><td class="action"></td></tr><tr><td class="line">242</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">243</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">244</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (this.get('favico')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">245</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		app.use(express.favicon(this.getPath('favico')));</span></td><td class="action"></td></tr><tr><td class="line">246</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">247</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">248</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (this.get('less')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">249</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		app.use(require('less-middleware')(this.getPath('less')));</span></td><td class="action"></td></tr><tr><td class="line">250</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">251</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">252</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (this.get('sass')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">253</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var sass;</span></td><td class="action"></td></tr><tr><td class="line">254</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		try {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">255</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			sass = require('node-sass');</span></td><td class="action"></td></tr><tr><td class="line">256</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		} catch(e) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">257</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (e.code === 'MODULE_NOT_FOUND') {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">258</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				console.error(</span></td><td class="action"></td></tr><tr><td class="line">259</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					'\nERROR: node-sass not found.\n' +</span></td><td class="action"></td></tr><tr class="miss"><td class="line">260</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					'\nPlease install the node-sass from npm to use the `sass` option.' +</span></td><td class="action"></td></tr><tr class="miss"><td class="line">261</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					'\nYou can do this by running &quot;npm install node-sass --save&quot;.\n'</span></td><td class="action"></td></tr><tr><td class="line">262</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">263</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				process.exit(1);</span></td><td class="action"></td></tr><tr><td class="line">264</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">265</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				throw e;</span></td><td class="action"></td></tr><tr><td class="line">266</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr><td class="line">267</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">268</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		app.use(sass.middleware({</span></td><td class="action"></td></tr><tr class="miss"><td class="line">269</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			src: this.getPath('sass'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">270</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			dest: this.getPath('sass'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">271</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			outputStyle: this.get('env') === 'production' ? 'compressed' : 'nested'</span></td><td class="action"></td></tr><tr><td class="line">272</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}));</span></td><td class="action"></td></tr><tr><td class="line">273</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">274</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">275</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// the static option can be a single path, or array of paths</span></td><td class="action"></td></tr><tr><td class="line">276</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">277</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var staticPaths = this.get('static');</span></td><td class="action"></td></tr><tr><td class="line">278</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">279</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (_.isString(staticPaths)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">280</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		staticPaths = [staticPaths];</span></td><td class="action"></td></tr><tr><td class="line">281</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">282</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">283</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (_.isArray(staticPaths)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">284</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		_.each(staticPaths, function(value) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">285</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			app.use(express.static(this.expandPath(value)));</span></td><td class="action"></td></tr><tr><td class="line">286</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}, this);</span></td><td class="action"></td></tr><tr><td class="line">287</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">288</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">289</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// unless the headless option is set (which disables the Admin UI),</span></td><td class="action"></td></tr><tr><td class="line">290</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// bind the static handler for the Admin UI public resources</span></td><td class="action"></td></tr><tr class="miss"><td class="line">291</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!this.get('headless')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">292</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		this.static(app);</span></td><td class="action"></td></tr><tr><td class="line">293</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">294</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">295</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Handle dynamic requests</span></td><td class="action"></td></tr><tr><td class="line">296</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">297</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (this.get('logger')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">298</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		app.use(express.logger(this.get('logger')));</span></td><td class="action"></td></tr><tr><td class="line">299</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">300</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">301</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (this.get('file limit')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">302</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		app.use(express.limit(this.get('file limit')));</span></td><td class="action"></td></tr><tr><td class="line">303</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">304</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">305</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	app.use(express.bodyParser());</span></td><td class="action"></td></tr><tr class="miss"><td class="line">306</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	app.use(express.methodOverride());</span></td><td class="action"></td></tr><tr class="miss"><td class="line">307</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	app.use(sessionOptions.cookieParser);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">308</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	app.use(express.session(sessionOptions));</span></td><td class="action"></td></tr><tr class="miss"><td class="line">309</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	app.use(require('connect-flash')());</span></td><td class="action"></td></tr><tr><td class="line">310</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">311</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (this.get('session') === true) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">312</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		app.use(this.session.persist);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">313</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else if ('function' === typeof this.get('session')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">314</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		app.use(this.get('session'));</span></td><td class="action"></td></tr><tr><td class="line">315</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">316</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">317</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Process 'X-Forwarded-For' request header</span></td><td class="action"></td></tr><tr><td class="line">318</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">319</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (this.get('trust proxy') === true) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">320</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		app.enable('trust proxy');</span></td><td class="action"></td></tr><tr><td class="line">321</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">322</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		app.disable('trust proxy');</span></td><td class="action"></td></tr><tr><td class="line">323</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">324</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">325</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Check for IP range restrictions</span></td><td class="action"></td></tr><tr><td class="line">326</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">327</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (this.get('allowed ip ranges')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">328</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (!app.get('trust proxy')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">329</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			console.log(</span></td><td class="action"></td></tr><tr class="miss"><td class="line">330</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				'KeystoneJS Initialisaton Error:\n\n' +</span></td><td class="action"></td></tr><tr><td class="line">331</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">332</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			process.exit(1);</span></td><td class="action"></td></tr><tr><td class="line">333</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">334</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var ipRangeMiddleware = require('./lib/security/ipRangeRestrict')(</span></td><td class="action"></td></tr><tr class="miss"><td class="line">335</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			this.get('allowed ip ranges'),</span></td><td class="action"></td></tr><tr><td class="line">336</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			this.wrapHTMLError</span></td><td class="action"></td></tr><tr class="miss"><td class="line">337</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		this.pre('routes', ipRangeMiddleware);</span></td><td class="action"></td></tr><tr><td class="line">338</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">339</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">340</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Pre-route middleware</span></td><td class="action"></td></tr><tr><td class="line">341</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">342</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._pre.routes.forEach(function(fn) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">343</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			app.use(fn);</span></td><td class="action"></td></tr><tr><td class="line">344</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">345</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		catch(e) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">346</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (keystone.get('logger')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">347</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				console.log('Invalid pre-route middleware provided');</span></td><td class="action"></td></tr><tr><td class="line">348</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">349</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			throw e;</span></td><td class="action"></td></tr><tr><td class="line">350</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">351</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">352</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Route requests</span></td><td class="action"></td></tr><tr><td class="line">353</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">354</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	app.use(app.router);</span></td><td class="action"></td></tr><tr><td class="line">355</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">356</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Headless mode means don't bind the Keystone routes</span></td><td class="action"></td></tr><tr><td class="line">357</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">358</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!this.get('headless')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">359</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		this.routes(app);</span></td><td class="action"></td></tr><tr><td class="line">360</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">361</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">362</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">363</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Configure application routes</span></td><td class="action"></td></tr><tr class="miss"><td class="line">364</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if ('function' === typeof this.get('routes')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">365</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		this.get('routes')(app);</span></td><td class="action"></td></tr><tr><td class="line">366</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">367</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">368</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	//prepare the error handlers; they should be called last</span></td><td class="action"></td></tr><tr class="miss"><td class="line">369</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var setHandlers = function () {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">370</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (Object.keys(keystone._redirects).length) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">371</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			app.use(function(req, res, next) {</span></td><td class="action"></td></tr><tr><td class="line">372</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (keystone._redirects[req.path]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">373</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					res.redirect(keystone._redirects[req.path]);</span></td><td class="action"></td></tr><tr><td class="line">374</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">375</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					next();</span></td><td class="action"></td></tr><tr><td class="line">376</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr><td class="line">377</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			});</span></td><td class="action"></td></tr><tr class="miss"><td class="line">378</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var default404Handler = function(req, res, next) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">379</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			res.status(404).send(keystone.wrapHTMLError('Sorry, no page could be found at this address (404)'));</span></td><td class="action"></td></tr><tr><td class="line">380</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		};</span></td><td class="action"></td></tr><tr><td class="line">381</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">382</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		app.use(function(req, res, next) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">383</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var err404 = keystone.get('404');</span></td><td class="action"></td></tr><tr><td class="line">384</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			</span></td><td class="action"></td></tr><tr class="miss"><td class="line">385</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (err404) {</span></td><td class="action"></td></tr><tr><td class="line">386</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				try {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">387</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					if ('function' === typeof err404) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">388</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						err404(req, res, next);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">389</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					} else if ('string' === typeof err404) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">390</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						res.status(404).render(err404);</span></td><td class="action"></td></tr><tr><td class="line">391</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">392</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						if (keystone.get('logger')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">393</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							console.log(dashes + 'Error handling 404 (not found): Invalid type (' + (typeof err404) + ') for 404 setting.' + dashes);</span></td><td class="action"></td></tr><tr><td class="line">394</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">395</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						default404Handler(req, res, next);</span></td><td class="action"></td></tr><tr><td class="line">396</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					}</span></td><td class="action"></td></tr><tr><td class="line">397</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				} catch(e) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">398</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					if (keystone.get('logger')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">399</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						console.log(dashes + 'Error handling 404 (not found):');</span></td><td class="action"></td></tr><tr class="miss"><td class="line">400</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						console.log(e);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">401</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						console.log(dashes);</span></td><td class="action"></td></tr><tr><td class="line">402</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">403</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					default404Handler(req, res, next);</span></td><td class="action"></td></tr><tr><td class="line">404</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">405</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				default404Handler(req, res, next);</span></td><td class="action"></td></tr><tr><td class="line">406</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr><td class="line">407</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">408</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var default500Handler = function(err, req, res, next) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">409</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (keystone.get('logger')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">410</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (err instanceof Error) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">411</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					console.log((err.type ? err.type + ' ' : '') + 'Error thrown for request: ' + req.url);</span></td><td class="action"></td></tr><tr><td class="line">412</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">413</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					console.log('Error thrown for request: ' + req.url);</span></td><td class="action"></td></tr><tr><td class="line">414</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">415</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				console.log(err.stack || err);</span></td><td class="action"></td></tr><tr><td class="line">416</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">417</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var msg = '';</span></td><td class="action"></td></tr><tr><td class="line">418</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			</span></td><td class="action"></td></tr><tr class="miss"><td class="line">419</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (keystone.get('env') === 'development') {</span></td><td class="action"></td></tr><tr><td class="line">420</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				</span></td><td class="action"></td></tr><tr class="miss"><td class="line">421</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (err instanceof Error) {</span></td><td class="action"></td></tr><tr><td class="line">422</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					if (err.type) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">423</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						msg += '&lt;h2&gt;' + err.type + '&lt;/h2&gt;';</span></td><td class="action"></td></tr><tr><td class="line">424</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">425</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					msg += utils.textToHTML(err.message);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">426</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				} else if ('object' === typeof err) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">427</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					msg += '&lt;code&gt;' + JSON.stringify(err) + '&lt;/code&gt;';</span></td><td class="action"></td></tr><tr class="miss"><td class="line">428</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				} else if (err) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">429</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					msg += err;</span></td><td class="action"></td></tr><tr><td class="line">430</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">431</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			res.status(500).send(keystone.wrapHTMLError('Sorry, an error occurred loading the page (500)', msg));</span></td><td class="action"></td></tr><tr><td class="line">432</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		};</span></td><td class="action"></td></tr><tr><td class="line">433</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">434</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		app.use(function(err, req, res, next) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">435</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var err500 = keystone.get('500');</span></td><td class="action"></td></tr><tr><td class="line">436</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			</span></td><td class="action"></td></tr><tr class="miss"><td class="line">437</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (err500) {</span></td><td class="action"></td></tr><tr><td class="line">438</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				try {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">439</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					if ('function' === typeof err500) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">440</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						err500(err, req, res, next);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">441</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					} else if ('string' === typeof err500) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">442</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						res.locals.err = err;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">443</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						res.status(500).render(err500);</span></td><td class="action"></td></tr><tr><td class="line">444</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">445</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						if (keystone.get('logger')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">446</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							console.log(dashes + 'Error handling 500 (error): Invalid type (' + (typeof err500) + ') for 500 setting.' + dashes);</span></td><td class="action"></td></tr><tr><td class="line">447</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">448</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						default500Handler(err, req, res, next);</span></td><td class="action"></td></tr><tr><td class="line">449</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					}</span></td><td class="action"></td></tr><tr><td class="line">450</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				} catch(e) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">451</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					if (keystone.get('logger')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">452</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						console.log(dashes + 'Error handling 500 (error):');</span></td><td class="action"></td></tr><tr class="miss"><td class="line">453</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						console.log(e);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">454</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						console.log(dashes);</span></td><td class="action"></td></tr><tr><td class="line">455</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">456</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					default500Handler(err, req, res, next);</span></td><td class="action"></td></tr><tr><td class="line">457</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">458</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				default500Handler(err, req, res, next);</span></td><td class="action"></td></tr><tr><td class="line">459</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr><td class="line">460</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">461</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var mongoConnectionOpen = false;</span></td><td class="action"></td></tr><tr><td class="line">462</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">463</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// support replica sets for mongoose</span></td><td class="action"></td></tr><tr class="miss"><td class="line">464</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (this.get('mongo replica set')){</span></td><td class="action"></td></tr><tr><td class="line">465</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">466</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var replicaData = this.get('mongo replica set');</span></td><td class="action"></td></tr><tr class="miss"><td class="line">467</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var replica = &quot;&quot;;</span></td><td class="action"></td></tr><tr><td class="line">468</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">469</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var credentials = (replicaData.username &amp;&amp; replicaData.password) ? replicaData.username +&quot;:&quot;+replicaData.password+&quot;@&quot; : '';</span></td><td class="action"></td></tr><tr><td class="line">470</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">471</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		replicaData.db.servers.forEach(function (server) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">472</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			replica += &quot;mongodb://&quot;+credentials+server[&quot;host&quot;]+&quot;:&quot;+server[&quot;port&quot;]+&quot;/&quot;+replicaData.db.name+&quot;,&quot;;</span></td><td class="action"></td></tr><tr><td class="line">473</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		});</span></td><td class="action"></td></tr><tr><td class="line">474</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">475</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var options = {</span></td><td class="action"></td></tr><tr><td class="line">476</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">477</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		this.mongoose.connect(replica, options);</span></td><td class="action"></td></tr><tr><td class="line">478</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr><td class="line">479</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else {</span></td><td class="action"></td></tr><tr><td class="line">480</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">481</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		this.mongoose.connect(this.get('mongo'));</span></td><td class="action"></td></tr><tr><td class="line">482</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr><td class="line">483</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">484</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">485</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.mongoose.connection.on('error', function(err) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">486</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (keystone.get('logger')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">487</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			console.log('------------------------------------------------');</span></td><td class="action"></td></tr><tr class="miss"><td class="line">488</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			console.log('Mongo Error:\n');</span></td><td class="action"></td></tr><tr class="miss"><td class="line">489</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			console.log(err);</span></td><td class="action"></td></tr><tr><td class="line">490</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">491</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">492</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (mongoConnectionOpen) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">493</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			throw new Error('Mongo Error');</span></td><td class="action"></td></tr><tr><td class="line">494</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">495</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			throw new Error('KeystoneJS (' + keystone.get('name') + ') failed to start');</span></td><td class="action"></td></tr><tr><td class="line">496</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">497</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr><td class="line">498</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">499</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		mongoConnectionOpen = true;</span></td><td class="action"></td></tr><tr><td class="line">500</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">501</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (keystone.get('auto update')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">502</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var mounted = function () {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">503</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				events.onMount();</span></td><td class="action"></td></tr><tr class="miss"><td class="line">504</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				setHandlers();</span></td><td class="action"></td></tr><tr><td class="line">505</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">506</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			keystone.applyUpdates(mounted);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">507</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			events.onMount &amp;&amp; events.onMount();</span></td><td class="action"></td></tr><tr class="miss"><td class="line">508</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			setHandlers();</span></td><td class="action"></td></tr><tr><td class="line">509</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">510</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">511</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">512</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">module.exports = mount;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/core/routes.js">lib/core/routes.js</h2><div class="stats terrible"><div class="percentage">2% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">1% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">0% block coverage</div><div class="sloc">42 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Adds bindings for the keystone routes</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * ####Example:</span></td><td class="action"></td></tr><tr><td class="line">5</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">6</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *     var app = express();</span></td><td class="action"></td></tr><tr><td class="line">7</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *     app.configure(...); // configuration settings</span></td><td class="action"></td></tr><tr><td class="line">8</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *     app.use(...); // middleware, routes, etc. should come before keystone is initialised</span></td><td class="action"></td></tr><tr><td class="line">9</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *     keystone.routes(app);</span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Express()} app</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function routes(app) {</span></td><td class="action"></td></tr><tr><td class="line">16</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">17</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.app = app;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">18</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var keystone = this;</span></td><td class="action"></td></tr><tr><td class="line">19</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">20</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// ensure keystone nav has been initialised</span></td><td class="action"></td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!this.nav) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">22</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		this.nav = this.initNav();</span></td><td class="action"></td></tr><tr><td class="line">23</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">24</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">25</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Cache compiled view templates if we are in Production mode</span></td><td class="action"></td></tr><tr class="miss"><td class="line">26</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.set('view cache', this.get('env') === 'production');</span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">28</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Bind auth middleware (generic or custom) to /keystone* routes, allowing</span></td><td class="action"></td></tr><tr><td class="line">29</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// access to the generic signin page if generic auth is used</span></td><td class="action"></td></tr><tr><td class="line">30</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">31</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (this.get('auth') === true) {</span></td><td class="action"></td></tr><tr><td class="line">32</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">33</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (!this.get('signout url')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">34</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			this.set('signout url', '/keystone/signout');</span></td><td class="action"></td></tr><tr><td class="line">35</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (!this.get('signin url')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			this.set('signin url', '/keystone/signin');</span></td><td class="action"></td></tr><tr><td class="line">38</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">39</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">40</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (!this.nativeApp || !this.get('session')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			app.all('/keystone*', this.session.persist);</span></td><td class="action"></td></tr><tr><td class="line">42</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">43</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">44</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		app.all('/keystone/signin', require('../../routes/views/signin'));</span></td><td class="action"></td></tr><tr class="miss"><td class="line">45</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		app.all('/keystone/signout', require('../../routes/views/signout'));</span></td><td class="action"></td></tr><tr class="miss"><td class="line">46</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		app.all('/keystone*', this.session.keystoneAuth);</span></td><td class="action"></td></tr><tr><td class="line">47</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">48</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else if ('function' === typeof this.get('auth')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">49</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		app.all('/keystone*', this.get('auth'));</span></td><td class="action"></td></tr><tr><td class="line">50</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">51</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">52</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var initList = function(protect) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">53</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return function(req, res, next) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">54</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			req.list = keystone.list(req.params.list);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">55</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (!req.list || (protect &amp;&amp; req.list.get('hidden'))) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">56</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				req.flash('error', 'List ' + req.params.list + ' could not be found.');</span></td><td class="action"></td></tr><tr class="miss"><td class="line">57</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				return res.redirect('/keystone');</span></td><td class="action"></td></tr><tr><td class="line">58</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">59</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			next();</span></td><td class="action"></td></tr><tr><td class="line">60</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		};</span></td><td class="action"></td></tr><tr><td class="line">61</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">62</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">63</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Keystone Admin Route</span></td><td class="action"></td></tr><tr class="miss"><td class="line">64</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	app.all('/keystone', require('../../routes/views/home'));</span></td><td class="action"></td></tr><tr><td class="line">65</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">66</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Email test routes</span></td><td class="action"></td></tr><tr class="miss"><td class="line">67</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (this.get('email tests')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">68</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		this.bindEmailTestRoutes(app, this.get('email tests'));</span></td><td class="action"></td></tr><tr><td class="line">69</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">70</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">71</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Cloudinary API for image uploading (only if Cloudinary is configured)</span></td><td class="action"></td></tr><tr class="miss"><td class="line">72</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (keystone.get('wysiwyg cloudinary images')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">73</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (!keystone.get('cloudinary config')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">74</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			throw new Error('KeystoneJS Initialisaton Error:\n\nTo use wysiwyg cloudinary images, the \'cloudinary config\' setting must be configured.\n\n');</span></td><td class="action"></td></tr><tr><td class="line">75</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">76</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		app.post('/keystone/api/cloudinary/upload', require('../../routes/api/cloudinary').upload);</span></td><td class="action"></td></tr><tr><td class="line">77</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">78</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">79</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Cloudinary API for selecting an existing image from the cloud</span></td><td class="action"></td></tr><tr class="miss"><td class="line">80</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (keystone.get('cloudinary config')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">81</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		app.get('/keystone/api/cloudinary/get', require('../../routes/api/cloudinary').get);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">82</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		app.get('/keystone/api/cloudinary/autocomplete', require('../../routes/api/cloudinary').autocomplete);</span></td><td class="action"></td></tr><tr><td class="line">83</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">84</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">85</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Generic Lists API</span></td><td class="action"></td></tr><tr class="miss"><td class="line">86</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	app.all('/keystone/api/:list/:action', initList(), require('../../routes/api/list'));</span></td><td class="action"></td></tr><tr><td class="line">87</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">88</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Generic Lists Download Route</span></td><td class="action"></td></tr><tr class="miss"><td class="line">89</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	app.all('/keystone/download/:list', initList(), require('../../routes/download/list'));</span></td><td class="action"></td></tr><tr><td class="line">90</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">91</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// List and Item Details Admin Routes</span></td><td class="action"></td></tr><tr class="miss"><td class="line">92</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	app.all('/keystone/:list/:page([0-9]{1,5})?', initList(true), require('../../routes/views/list'));</span></td><td class="action"></td></tr><tr class="miss"><td class="line">93</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	app.all('/keystone/:list/:item', initList(true), require('../../routes/views/item'));</span></td><td class="action"></td></tr><tr><td class="line">94</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">95</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return this;</span></td><td class="action"></td></tr><tr><td class="line">96</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">97</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">98</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">99</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">module.exports = routes;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/core/static.js">lib/core/static.js</h2><div class="stats medium"><div class="percentage">50% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">18% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">0% block coverage</div><div class="sloc">6 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr class="hit "><td class="line">1</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var path = require('path'),
	express = require('express');</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Adds bindings for keystone static resources</span></td><td class="action"></td></tr><tr><td class="line">5</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Can be included before other middleware (e.g. session management, logging, etc) for</span></td><td class="action"></td></tr><tr><td class="line">6</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * reduced overhead</span></td><td class="action"></td></tr><tr><td class="line">7</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">8</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Express()} app</span></td><td class="action"></td></tr><tr><td class="line">9</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function static(app) {</span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">14</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	app.use('/keystone', require('less-middleware')(__dirname + path.sep + '..' + path.sep + '..' + path.sep + 'public'));</span></td><td class="action"></td></tr><tr class="miss"><td class="line">15</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	app.use('/keystone', express.static(__dirname + path.sep + '..' + path.sep + '..' + path.sep + 'public'));</span></td><td class="action"></td></tr><tr><td class="line">16</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">17</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return this;</span></td><td class="action"></td></tr><tr><td class="line">18</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">19</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">20</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">21</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">module.exports = static;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/core/importer.js">lib/core/importer.js</h2><div class="stats terrible"><div class="percentage">15% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">11% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">0% block coverage</div><div class="sloc">20 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr class="hit "><td class="line">1</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var fs = require('fs'),
	path = require('path');</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Returns a function that looks in a specified path relative to the current</span></td><td class="action"></td></tr><tr><td class="line">5</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * directory, and returns all .js modules it (recursively).</span></td><td class="action"></td></tr><tr><td class="line">6</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">7</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * ####Example:</span></td><td class="action"></td></tr><tr><td class="line">8</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">9</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *     var importRoutes = keystone.importer(__dirname);</span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *     var routes = {</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *         site: importRoutes('./site'),</span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *         api: importRoutes('./api')</span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *     };</span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">16</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {String} rel__dirname</span></td><td class="action"></td></tr><tr><td class="line">17</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">18</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">19</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">20</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function dispatchImporter(rel__dirname) {</span></td><td class="action"></td></tr><tr><td class="line">21</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">22</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	function importer(from) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var imported = {};</span></td><td class="action"></td></tr><tr class="miss"><td class="line">24</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var joinPath = function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">25</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return '.' + path.sep + path.join.apply(path, arguments);</span></td><td class="action"></td></tr><tr><td class="line">26</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		};</span></td><td class="action"></td></tr><tr class="miss"><td class="line">27</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var fsPath = joinPath(path.relative(process.cwd(), rel__dirname), from);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">28</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		fs.readdirSync(fsPath).forEach(function(name) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">29</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var info = fs.statSync(path.join(fsPath, name));</span></td><td class="action"></td></tr><tr><td class="line">30</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			// recur</span></td><td class="action"></td></tr><tr class="miss"><td class="line">31</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (info.isDirectory()) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				imported[name] = importer(joinPath(from, name));</span></td><td class="action"></td></tr><tr><td class="line">33</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			} else {</span></td><td class="action"></td></tr><tr><td class="line">34</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				// only import .js files</span></td><td class="action"></td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				var parts = name.split('.');</span></td><td class="action"></td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				var ext = parts.pop();</span></td><td class="action"></td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (ext === 'js' || ext === 'coffee') {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">38</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					imported[parts.join('-')] = require(path.join(rel__dirname, from, name));</span></td><td class="action"></td></tr><tr><td class="line">39</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">40</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return imported;</span></td><td class="action"></td></tr><tr><td class="line">41</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		});</span></td><td class="action"></td></tr><tr class="miss"><td class="line">42</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return imported;</span></td><td class="action"></td></tr><tr><td class="line">43</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">44</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">45</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return importer;</span></td><td class="action"></td></tr><tr><td class="line">46</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">47</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">48</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">49</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">module.exports = dispatchImporter;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/core/createItems.js">lib/core/createItems.js</h2><div class="stats terrible"><div class="percentage">2% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">1% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">0% block coverage</div><div class="sloc">150 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>* Creates multiple items in one or more Lists</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>*/</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">5</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var _ = require('underscore'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">6</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	async = require('async'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">7</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	utils = require('keystone-utils');</span></td><td class="action"></td></tr><tr><td class="line">8</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">9</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function createItems(data, ops, callback) {</span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">11</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var keystone = this;</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">13</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var options = {</span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">15</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var dashes = '------------------------------------------------';</span></td><td class="action"></td></tr><tr><td class="line">16</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">17</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!_.isObject(data)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">18</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('keystone.createItems() requires a data object as the first argument.');</span></td><td class="action"></td></tr><tr><td class="line">19</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">20</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (_.isObject(ops)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">22</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		_.extend(options, ops);</span></td><td class="action"></td></tr><tr><td class="line">23</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">24</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">25</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (_.isFunction(ops)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">26</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		callback = ops;</span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">28</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">29</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var lists = _.keys(data),</span></td><td class="action"></td></tr><tr><td class="line">30</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">31</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// logger function</span></td><td class="action"></td></tr><tr><td class="line">32</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	function writeLog(data) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">33</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		console.log(keystone.get('name') + &quot;: &quot; + data);</span></td><td class="action"></td></tr><tr><td class="line">34</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">35</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	async.waterfall([</span></td><td class="action"></td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			async.eachSeries(lists, function(key, doneList) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">38</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				var list = keystone.list(key),</span></td><td class="action"></td></tr><tr><td class="line">39</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				</span></td><td class="action"></td></tr><tr class="miss"><td class="line">40</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (!list) {</span></td><td class="action"></td></tr><tr><td class="line">41</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					if (options.strict) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">42</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						return doneList({</span></td><td class="action"></td></tr><tr><td class="line">43</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							type: 'invalid list',</span></td><td class="action"></td></tr><tr class="miss"><td class="line">44</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							message: 'List key ' + key + ' is invalid.'</span></td><td class="action"></td></tr><tr><td class="line">45</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						});</span></td><td class="action"></td></tr><tr><td class="line">46</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">47</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						writeLog('Skipping invalid list: ' + key);</span></td><td class="action"></td></tr><tr><td class="line">48</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">49</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					return doneList();</span></td><td class="action"></td></tr><tr><td class="line">50</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">51</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				refs[list.key] = {};</span></td><td class="action"></td></tr><tr class="miss"><td class="line">52</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				stats[list.key] = {</span></td><td class="action"></td></tr><tr><td class="line">53</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					singular: list.singular,</span></td><td class="action"></td></tr><tr class="miss"><td class="line">54</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				var itemsProcessed = 0,</span></td><td class="action"></td></tr><tr><td class="line">55</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				</span></td><td class="action"></td></tr><tr class="miss"><td class="line">56</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					writeLog(dashes);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">57</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					writeLog('Processing list: ' + key);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">58</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					writeLog('Items to create: ' + totalItems);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">59</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					writeLog(dashes);</span></td><td class="action"></td></tr><tr><td class="line">60</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">61</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				async.eachSeries(data[key], function(data, doneItem) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">62</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					itemsProcessed++;</span></td><td class="action"></td></tr><tr><td class="line">63</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					</span></td><td class="action"></td></tr><tr><td class="line">64</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					// Evaluate function properties to allow generated values (excluding relationships)</span></td><td class="action"></td></tr><tr class="miss"><td class="line">65</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					_.keys(data).forEach(function(i) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">66</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						if (_.isFunction(data[i]) &amp;&amp; relationshipPaths.indexOf(i) === -1) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">67</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							data[i] = data[i]();</span></td><td class="action"></td></tr><tr><td class="line">68</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							if (options.verbose) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">69</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>								writeLog('Generated dynamic value for [' + i + ']: ' + data[i]);</span></td><td class="action"></td></tr><tr><td class="line">70</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							}</span></td><td class="action"></td></tr><tr><td class="line">71</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						}</span></td><td class="action"></td></tr><tr><td class="line">72</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					</span></td><td class="action"></td></tr><tr class="miss"><td class="line">73</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					var doc = data.__doc = new list.model();</span></td><td class="action"></td></tr><tr><td class="line">74</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					</span></td><td class="action"></td></tr><tr class="miss"><td class="line">75</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						refs[list.key][data.__ref] = doc;</span></td><td class="action"></td></tr><tr><td class="line">76</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">77</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					_.each(list.fields, function(field) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">78</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						if (field.type !== 'relationship') {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">79</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							field.updateItem(doc, data);</span></td><td class="action"></td></tr><tr><td class="line">80</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						}</span></td><td class="action"></td></tr><tr><td class="line">81</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					</span></td><td class="action"></td></tr><tr class="miss"><td class="line">82</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						var documentName = list.getDocumentName(doc);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">83</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						writeLog('Creating item [' + itemsProcessed + ' of ' + totalItems + '] - ' + documentName);</span></td><td class="action"></td></tr><tr><td class="line">84</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">85</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					doc.save(doneItem);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">86</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					stats[list.key].created++;</span></td><td class="action"></td></tr><tr><td class="line">87</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					</span></td><td class="action"></td></tr><tr><td class="line">88</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				</span></td><td class="action"></td></tr><tr><td class="line">89</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		},</span></td><td class="action"></td></tr><tr><td class="line">90</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">91</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			async.each(lists, function(key, doneList) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">92</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				var list = keystone.list(key),</span></td><td class="action"></td></tr><tr><td class="line">93</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				</span></td><td class="action"></td></tr><tr class="miss"><td class="line">94</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (!list || !relationships.length) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">95</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					return doneList();</span></td><td class="action"></td></tr><tr><td class="line">96</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr><td class="line">97</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				</span></td><td class="action"></td></tr><tr class="miss"><td class="line">98</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				var itemsProcessed = 0,</span></td><td class="action"></td></tr><tr><td class="line">99</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				</span></td><td class="action"></td></tr><tr class="miss"><td class="line">100</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					writeLog(dashes);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">101</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					writeLog('Processing relationships for: ' + key);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">102</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					writeLog('Items to process: ' + totalItems);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">103</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					writeLog(dashes);</span></td><td class="action"></td></tr><tr><td class="line">104</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">105</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				async.each(data[key], function(srcData, doneItem) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">106</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					var doc = srcData.__doc,</span></td><td class="action"></td></tr><tr><td class="line">107</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					</span></td><td class="action"></td></tr><tr class="miss"><td class="line">108</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					itemsProcessed++;</span></td><td class="action"></td></tr><tr><td class="line">109</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					</span></td><td class="action"></td></tr><tr><td class="line">110</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					if (options.verbose) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">111</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						var documentName = list.getDocumentName(doc);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">112</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						writeLog('Processing item [' + itemsProcessed + ' of ' + totalItems + '] - ' + documentName);</span></td><td class="action"></td></tr><tr><td class="line">113</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">114</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					async.each(relationships, function(field, doneField) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">115</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						var fieldValue = null,</span></td><td class="action"></td></tr><tr><td class="line">116</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						</span></td><td class="action"></td></tr><tr class="miss"><td class="line">117</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						if ( !field.path )  {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">118</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							writeLog(&quot;WARNING:  Invalid relationship (undefined list path) [List: &quot;+key+&quot;]&quot;);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">119</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							stats[list.key].warnings++;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">120</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							return doneField();</span></td><td class="action"></td></tr><tr><td class="line">121</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						}</span></td><td class="action"></td></tr><tr><td class="line">122</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						else</span></td><td class="action"></td></tr><tr class="miss"><td class="line">123</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							fieldValue = srcData[field.path];</span></td><td class="action"></td></tr><tr><td class="line">124</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						</span></td><td class="action"></td></tr><tr class="miss"><td class="line">125</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						if ( !field.refList )  {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">126</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							if ( fieldValue )</span></td><td class="action"></td></tr><tr><td class="line">127</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							{</span></td><td class="action"></td></tr><tr class="miss"><td class="line">128</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>								writeLog(&quot;WARNING:  Invalid relationship (undefined reference list) [list: &quot;+key+&quot;] [path: &quot;+fieldValue+&quot;]&quot;);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">129</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>								stats[list.key].warnings++;</span></td><td class="action"></td></tr><tr><td class="line">130</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">131</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							return doneField();</span></td><td class="action"></td></tr><tr><td class="line">132</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">133</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						if ( !field.refList.key )  {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">134</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							writeLog(&quot;WARNING:  Invalid relationship (undefined ref list key) [list: &quot;+key+&quot;] [field.refList: &quot;+field.refList+&quot;] [fieldValue: &quot;+fieldValue+&quot;]&quot;);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">135</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							stats[list.key].warnings++;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">136</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							return doneField();</span></td><td class="action"></td></tr><tr><td class="line">137</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">138</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							refsLookup = refs[field.refList.key];</span></td><td class="action"></td></tr><tr><td class="line">139</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						</span></td><td class="action"></td></tr><tr class="miss"><td class="line">140</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						if (!fieldValue) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">141</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							return doneField();</span></td><td class="action"></td></tr><tr><td class="line">142</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">143</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						if (_.isFunction(fieldValue)) {</span></td><td class="action"></td></tr><tr><td class="line">144</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							</span></td><td class="action"></td></tr><tr class="miss"><td class="line">145</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							relationshipsUpdated++;</span></td><td class="action"></td></tr><tr><td class="line">146</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							</span></td><td class="action"></td></tr><tr class="miss"><td class="line">147</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							var fn = fieldValue,</span></td><td class="action"></td></tr><tr class="miss"><td class="line">148</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>								lists = fn.toString().match(argsRegExp)[1].split(',').map(function(i) { return i.trim(); }),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">149</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>								args = lists.map(function(i) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">150</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>									return keystone.list(i);</span></td><td class="action"></td></tr><tr><td class="line">151</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>								}),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">152</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>								query = fn.apply(keystone, args);</span></td><td class="action"></td></tr><tr><td class="line">153</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							</span></td><td class="action"></td></tr><tr class="miss"><td class="line">154</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							query.exec(function(err, results) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">155</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>									doc.set(field.path, results || []);</span></td><td class="action"></td></tr><tr><td class="line">156</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>								} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">157</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>									doc.set(field.path, (results &amp;&amp; results.length) ? results[0] : undefined);</span></td><td class="action"></td></tr><tr><td class="line">158</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>								}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">159</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>								doneField(err);</span></td><td class="action"></td></tr><tr><td class="line">160</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							});</span></td><td class="action"></td></tr><tr><td class="line">161</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							</span></td><td class="action"></td></tr><tr class="miss"><td class="line">162</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						} else if (_.isArray(fieldValue)) {</span></td><td class="action"></td></tr><tr><td class="line">163</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							</span></td><td class="action"></td></tr><tr class="miss"><td class="line">164</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>								var refsArr = _.compact(fieldValue.map(function(ref) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">165</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>									return refsLookup[ref] ? refsLookup[ref].id : undefined;</span></td><td class="action"></td></tr><tr><td class="line">166</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>								}));</span></td><td class="action"></td></tr><tr><td class="line">167</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>								</span></td><td class="action"></td></tr><tr class="miss"><td class="line">168</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>								if (options.strict &amp;&amp; refsArr.length !== fieldValue.length) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">169</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>									return doneField({</span></td><td class="action"></td></tr><tr><td class="line">170</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>										type: 'invalid ref',</span></td><td class="action"></td></tr><tr class="miss"><td class="line">171</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>										message: 'Relationship ' + list.key + '.' + field.path + ' contains an invalid reference.'</span></td><td class="action"></td></tr><tr><td class="line">172</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>									});</span></td><td class="action"></td></tr><tr class="miss"><td class="line">173</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>								relationshipsUpdated++;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">174</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>								doc.set(field.path, refsArr);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">175</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>								doneField();</span></td><td class="action"></td></tr><tr><td class="line">176</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>								</span></td><td class="action"></td></tr><tr class="miss"><td class="line">177</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>								return doneField({</span></td><td class="action"></td></tr><tr class="miss"><td class="line">178</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>									message: 'Single-value relationship ' + list.key + '.' + field.path + ' provided as an array.'</span></td><td class="action"></td></tr><tr><td class="line">179</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>								});</span></td><td class="action"></td></tr><tr><td class="line">180</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">181</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						} else if (_.isString(fieldValue)) {</span></td><td class="action"></td></tr><tr><td class="line">182</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							</span></td><td class="action"></td></tr><tr class="miss"><td class="line">183</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							var refItem = refsLookup[fieldValue];</span></td><td class="action"></td></tr><tr><td class="line">184</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							</span></td><td class="action"></td></tr><tr class="miss"><td class="line">185</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							if (!refItem) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">186</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>								return options.strict ? doneField({</span></td><td class="action"></td></tr><tr><td class="line">187</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>									type: 'invalid ref',</span></td><td class="action"></td></tr><tr class="miss"><td class="line">188</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>									message: 'Relationship ' + list.key + '.' + field.path + ' contains an invalid reference: &quot;' + fieldValue + '&quot;.'</span></td><td class="action"></td></tr><tr class="miss"><td class="line">189</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>								}) : doneField();</span></td><td class="action"></td></tr><tr><td class="line">190</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">191</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							relationshipsUpdated++;</span></td><td class="action"></td></tr><tr><td class="line">192</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							</span></td><td class="action"></td></tr><tr class="miss"><td class="line">193</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							doc.set(field.path, field.many ? [refItem.id] : refItem.id);</span></td><td class="action"></td></tr><tr><td class="line">194</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							</span></td><td class="action"></td></tr><tr class="miss"><td class="line">195</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							doneField();</span></td><td class="action"></td></tr><tr><td class="line">196</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							</span></td><td class="action"></td></tr><tr class="miss"><td class="line">197</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							return doneField({</span></td><td class="action"></td></tr><tr class="miss"><td class="line">198</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>								message: 'Relationship ' + list.key + '.' + field.path + ' contains an invalid data type.'</span></td><td class="action"></td></tr><tr><td class="line">199</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							});</span></td><td class="action"></td></tr><tr><td class="line">200</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">201</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						if (err) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">202</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							return doneItem(err);</span></td><td class="action"></td></tr><tr><td class="line">203</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">204</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							writeLog('Populated ' + utils.plural(relationshipsUpdated, '* relationship',  '* relationships') + '.');</span></td><td class="action"></td></tr><tr><td class="line">205</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">206</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						if (relationshipsUpdated) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">207</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							doc.save(doneItem);</span></td><td class="action"></td></tr><tr><td class="line">208</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">209</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							doneItem();</span></td><td class="action"></td></tr><tr><td class="line">210</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						}</span></td><td class="action"></td></tr><tr><td class="line">211</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					</span></td><td class="action"></td></tr><tr><td class="line">212</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				</span></td><td class="action"></td></tr><tr><td class="line">213</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">214</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (err) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">215</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return callback &amp;&amp; callback(err);</span></td><td class="action"></td></tr><tr><td class="line">216</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">217</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var msg = '\nSuccessfully created:\n';</span></td><td class="action"></td></tr><tr class="miss"><td class="line">218</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		_.each(stats, function(list) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">219</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			msg += '\n*   ' + utils.plural(list.created, '* ' + list.singular, '* ' + list.plural);</span></td><td class="action"></td></tr><tr><td class="line">220</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (list.warnings) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">221</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				msg += '\n    ' + utils.plural(list.warnings, '* warning', '* warnings');</span></td><td class="action"></td></tr><tr><td class="line">222</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr><td class="line">223</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		});</span></td><td class="action"></td></tr><tr class="miss"><td class="line">224</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		stats.message = msg + '\n';</span></td><td class="action"></td></tr><tr><td class="line">225</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">226</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		callback(null, stats);</span></td><td class="action"></td></tr><tr><td class="line">227</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr><td class="line">228</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">229</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">230</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">231</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">module.exports = createItems;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/core/redirect.js">lib/core/redirect.js</h2><div class="stats low"><div class="percentage">37% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">26% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">0% block coverage</div><div class="sloc">8 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr class="hit "><td class="line">1</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var _ = require('underscore'),
	utils = require('keystone-utils');</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Adds one or more redirections (urls that are redirected when no matching</span></td><td class="action"></td></tr><tr><td class="line">5</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * routes are found, before treating the request as a 404)</span></td><td class="action"></td></tr><tr><td class="line">6</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">7</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * #### Example:</span></td><td class="action"></td></tr><tr><td class="line">8</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * 		keystone.redirect('/old-route', 'new-route');</span></td><td class="action"></td></tr><tr><td class="line">9</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * 		// or</span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * 		keystone.redirect({</span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * 			'old-route': 'new-route'</span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * 		});</span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">16</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">17</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function redirect() {</span></td><td class="action"></td></tr><tr><td class="line">18</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">19</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (arguments.length === 1 &amp;&amp; utils.isObject(arguments[0])) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">20</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		_.extend(this._redirects, arguments[0]);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else if (arguments.length === 2 &amp;&amp; 'string' === typeof arguments[0] &amp;&amp; 'string' === typeof arguments[1]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">22</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		this._redirects[arguments[0]] = arguments[1];</span></td><td class="action"></td></tr><tr><td class="line">23</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">24</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">25</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return this;</span></td><td class="action"></td></tr><tr><td class="line">26</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">28</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">29</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">module.exports = redirect;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/core/list.js">lib/core/list.js</h2><div class="stats high"><div class="percentage">83% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">77% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">100% block coverage</div><div class="sloc">6 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Registers or retrieves a list</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">5</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function list(arg) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">6</td><td class="hits">12</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (arg &amp;&amp; arg.constructor === this.List) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">7</td><td class="hits">12</td><td class="statements">100%</td><td class="source"><span class="statement ">		this.lists[arg.key] = arg;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">8</td><td class="hits">12</td><td class="statements">100%</td><td class="source"><span class="statement ">		this.paths[arg.path] = arg.key;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">9</td><td class="hits">12</td><td class="statements">100%</td><td class="source"><span class="statement ">		return arg;</span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">11</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return this.lists[arg] || this.lists[this.paths[arg]];</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">14</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">module.exports = list;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/core/getOrphanedLists.js">lib/core/getOrphanedLists.js</h2><div class="stats low"><div class="percentage">25% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">17% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">0% block coverage</div><div class="sloc">8 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr class="hit "><td class="line">1</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var _ = require('underscore');</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Retrieves orphaned lists (those not in a nav section)</span></td><td class="action"></td></tr><tr><td class="line">5</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">6</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">7</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function getOrphanedLists() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">8</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!this.nav) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">9</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return [];</span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">11</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return _.filter(this.lists, function(list, key) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">12</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (list.get('hidden')) return false;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">13</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return (!this.nav.by.list[key]) ? list : false;</span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}.bind(this));</span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">16</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">17</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">module.exports = getOrphanedLists;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/core/bindEmailTestRoutes.js">lib/core/bindEmailTestRoutes.js</h2><div class="stats terrible"><div class="percentage">8% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">6% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">0% block coverage</div><div class="sloc">24 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr class="hit "><td class="line">1</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var _ = require('underscore');</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function bindEmailTestRoutes(app, emails) {</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">5</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var keystone = this;</span></td><td class="action"></td></tr><tr><td class="line">6</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">7</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var handleError = function(req, res, err) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">8</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			res.err(err);</span></td><td class="action"></td></tr><tr><td class="line">9</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">10</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			res.status(500).send(JSON.stringify(err));</span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// TODO: Index of email tests, and custom email test 404's (currently bounces to list 404)</span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">15</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	_.each(emails, function(vars, key) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">16</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var render = function(err, req, res, locals) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">17</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			new keystone.Email(key).render(locals, function(err, email) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">18</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (err) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">19</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					handleError(req, res, err);</span></td><td class="action"></td></tr><tr><td class="line">20</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					res.send(email.html);</span></td><td class="action"></td></tr><tr><td class="line">22</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr><td class="line">23</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			});</span></td><td class="action"></td></tr><tr><td class="line">24</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		};</span></td><td class="action"></td></tr><tr><td class="line">25</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">26</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		app.get('/keystone/test-email/' + key, function(req, res) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">27</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if ('function' === typeof vars) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">28</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				vars(req, res, function(err, locals) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">29</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					render(err, req, res, locals);</span></td><td class="action"></td></tr><tr><td class="line">30</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				});</span></td><td class="action"></td></tr><tr><td class="line">31</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				render(null, req, res, vars);</span></td><td class="action"></td></tr><tr><td class="line">33</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr><td class="line">34</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		});</span></td><td class="action"></td></tr><tr><td class="line">35</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr><td class="line">36</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return this;</span></td><td class="action"></td></tr><tr><td class="line">38</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">39</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">40</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">41</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">module.exports = bindEmailTestRoutes;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/core/wrapHTMLError.js">lib/core/wrapHTMLError.js</h2><div class="stats terrible"><div class="percentage">20% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">5% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">0% block coverage</div><div class="sloc">5 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Wraps an error in simple HTML to be sent as a response to the browser</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">5</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">6</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">7</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function wrapHTMLError(title, err) {</span></td><td class="action"></td></tr><tr><td class="line">8</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return '&lt;html&gt;&lt;head&gt;&lt;meta charset=\'utf-8\'&gt;&lt;title&gt;Error&lt;/title&gt;' +</span></td><td class="action"></td></tr><tr class="miss"><td class="line">9</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	'&lt;link rel=\'stylesheet\' href=\'/keystone/styles/error.css\'&gt;' +</span></td><td class="action"></td></tr><tr class="miss"><td class="line">10</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	'&lt;/head&gt;&lt;body&gt;&lt;div class=\'error\'&gt;&lt;h1 class=\'error-title\'&gt;' + title + '&lt;/h1&gt;' +</span></td><td class="action"></td></tr><tr class="miss"><td class="line">11</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	'&lt;div class=&quot;error-message&quot;&gt;' + (err || '') + '&lt;/div&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;';</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">14</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">module.exports = wrapHTMLError;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/middleware/initAPI.js">lib/middleware/initAPI.js</h2><div class="stats terrible"><div class="percentage">20% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">9% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">12% block coverage</div><div class="sloc">20 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Middleware to initialise a standard API response.</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Adds `res.apiResonse` and `res.apiError` methods.</span></td><td class="action"></td></tr><tr><td class="line">5</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">6</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * ####Example:</span></td><td class="action"></td></tr><tr><td class="line">7</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">8</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *     app.all('/api*', initAPI);</span></td><td class="action"></td></tr><tr><td class="line">9</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {app.request} req</span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {app.response} res</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {function} next</span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">16</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>// The exported function returns a closure that retains</span></td><td class="action"></td></tr><tr><td class="line">17</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>// a reference to the keystone instance, so it can be</span></td><td class="action"></td></tr><tr><td class="line">18</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>// passed as middeware to the express app.</span></td><td class="action"></td></tr><tr><td class="line">19</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">20</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports = module.exports = function(keystone) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">21</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	return function initAPI(req, res, next) {
		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">22</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		res.apiResponse = function(status) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				res.jsonp(status);</span></td><td class="action"></td></tr><tr><td class="line">24</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			else</span></td><td class="action"></td></tr><tr class="miss"><td class="line">25</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				res.json(status);</span></td><td class="action"></td></tr><tr><td class="line">26</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		};</span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">28</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		res.apiError = function(key, err, msg, code) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">29</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			msg = msg || 'Error';</span></td><td class="action"></td></tr><tr class="miss"><td class="line">30</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			key = key || 'unknown error';</span></td><td class="action"></td></tr><tr class="miss"><td class="line">31</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			msg += ' (' + key + ')';</span></td><td class="action"></td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (keystone.get('logger')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">33</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				console.log(msg + (err ? ':' : ''));</span></td><td class="action"></td></tr><tr class="miss"><td class="line">34</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (err) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					console.log(err);</span></td><td class="action"></td></tr><tr><td class="line">36</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			res.status(code || 500);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">38</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			res.apiResponse({ error: key || 'error', detail: err });</span></td><td class="action"></td></tr><tr><td class="line">39</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		};</span></td><td class="action"></td></tr><tr><td class="line">40</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		next();</span></td><td class="action"></td></tr><tr><td class="line">42</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">43</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/content/index.js">lib/content/index.js</h2><div class="stats terrible"><div class="percentage">20% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">14% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">2% block coverage</div><div class="sloc">81 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr class="hit "><td class="line">1</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var _ = require('underscore'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">2</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	keystone = require('../../'),</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	utils = keystone.utils;</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">5</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">6</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Content Class</span></td><td class="action"></td></tr><tr><td class="line">7</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">8</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Accessed via `Keystone.content`</span></td><td class="action"></td></tr><tr><td class="line">9</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">13</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var Content = function() {};</span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">16</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Loads page content by page key (optional).</span></td><td class="action"></td></tr><tr><td class="line">17</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">18</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * If page key is not provided, returns a hash of all page contents in the database.</span></td><td class="action"></td></tr><tr><td class="line">19</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">20</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * ####Example:</span></td><td class="action"></td></tr><tr><td class="line">21</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">22</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *     keystone.content.fetch('home', function(err, content) { ... });</span></td><td class="action"></td></tr><tr><td class="line">23</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">24</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {String} key (optional)</span></td><td class="action"></td></tr><tr><td class="line">25</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Function} callback</span></td><td class="action"></td></tr><tr><td class="line">26</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">28</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">29</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Content.prototype.fetch = function(page, callback) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">30</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (utils.isFunction(page)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">31</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		callback = page;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		page = null;</span></td><td class="action"></td></tr><tr><td class="line">33</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">34</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var content = this;</span></td><td class="action"></td></tr><tr><td class="line">35</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!this.AppContent) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return callback({ error: 'invalid page', message: 'No pages have been registered.' });</span></td><td class="action"></td></tr><tr><td class="line">38</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">39</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (page) {</span></td><td class="action"></td></tr><tr><td class="line">40</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (!this.pages[page]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">42</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return callback({ error: 'invalid page', message: 'The page ' + page + ' does not exist.' });</span></td><td class="action"></td></tr><tr><td class="line">43</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">44</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		this.AppContent.findOne({ key: page }, function(err, result) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">45</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (err) return callback(err);</span></td><td class="action"></td></tr><tr><td class="line">46</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">47</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return callback(null, content.pages[page].populate(result ? result.content.data : {}));</span></td><td class="action"></td></tr><tr><td class="line">48</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">49</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		});</span></td><td class="action"></td></tr><tr><td class="line">50</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">51</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else {</span></td><td class="action"></td></tr><tr><td class="line">52</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">53</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		this.AppContent.find(function(err, results) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">54</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (err) return callback(err);</span></td><td class="action"></td></tr><tr><td class="line">55</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">56</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var data = {};</span></td><td class="action"></td></tr><tr><td class="line">57</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">58</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			results.forEach(function(i) {</span></td><td class="action"></td></tr><tr><td class="line">59</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (content.pages[i.key]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">60</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					data[i.key] = content.pages[i.key].populate(i.content.data);</span></td><td class="action"></td></tr><tr><td class="line">61</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr><td class="line">62</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			});</span></td><td class="action"></td></tr><tr><td class="line">63</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">64</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			_.each(content.pages, function(i) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">65</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (!data[i.key]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">66</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					data[i.key] = i.populate();</span></td><td class="action"></td></tr><tr><td class="line">67</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr><td class="line">68</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">69</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return data;</span></td><td class="action"></td></tr><tr><td class="line">70</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">71</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">72</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">73</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">74</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Sets page content by page key.</span></td><td class="action"></td></tr><tr><td class="line">75</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">76</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Merges content with existing content.</span></td><td class="action"></td></tr><tr><td class="line">77</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">78</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * ####Example:</span></td><td class="action"></td></tr><tr><td class="line">79</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">80</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *     keystone.content.store('home', { title: 'Welcome' }, function(err) { ... });</span></td><td class="action"></td></tr><tr><td class="line">81</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">82</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {String} key</span></td><td class="action"></td></tr><tr><td class="line">83</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Object} content</span></td><td class="action"></td></tr><tr><td class="line">84</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Function} callback</span></td><td class="action"></td></tr><tr><td class="line">85</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">86</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">87</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">88</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Content.prototype.store = function(page, content, callback) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">89</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!this.pages[page]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">90</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return callback({ error: 'invalid page', message: 'The page ' + page + ' does not exist.' });</span></td><td class="action"></td></tr><tr><td class="line">91</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">92</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	content = this.pages[page].validate(content);</span></td><td class="action"></td></tr><tr><td class="line">93</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">94</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// TODO: Handle validation errors</span></td><td class="action"></td></tr><tr><td class="line">95</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">96</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.AppContent.findOne({ key: page }, function(err, doc) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">97</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (err) return callback(err);</span></td><td class="action"></td></tr><tr><td class="line">98</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">99</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (doc) {</span></td><td class="action"></td></tr><tr><td class="line">100</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (doc.content) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">101</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				doc.history.push(doc.content);</span></td><td class="action"></td></tr><tr><td class="line">102</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">103</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			_.defaults(content, doc.content);</span></td><td class="action"></td></tr><tr><td class="line">104</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">105</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			doc = new content.AppContent({ key: page });</span></td><td class="action"></td></tr><tr><td class="line">106</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">107</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">108</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		doc.content = { data: this.pages[page].clean(content) };</span></td><td class="action"></td></tr><tr class="miss"><td class="line">109</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		doc.lastChangeDate = Date.now();</span></td><td class="action"></td></tr><tr><td class="line">110</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">111</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		doc.save(callback);</span></td><td class="action"></td></tr><tr><td class="line">112</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">113</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">114</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">115</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">116</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Registers a page. Should not be called directly, use Page.register() instead.</span></td><td class="action"></td></tr><tr><td class="line">117</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">118</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Page} page</span></td><td class="action"></td></tr><tr><td class="line">119</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api private</span></td><td class="action"></td></tr><tr><td class="line">120</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">121</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">122</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Content.prototype.page = function(key, page) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">123</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!this.pages) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">124</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		this.pages = {};</span></td><td class="action"></td></tr><tr><td class="line">125</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">126</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (arguments.length === 1) {</span></td><td class="action"></td></tr><tr><td class="line">127</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">128</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (!this.pages[key]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">129</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			throw new Error('keystone.content.page() Error: page ' + key + ' cannot be registered more than once.');</span></td><td class="action"></td></tr><tr><td class="line">130</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">131</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return this.pages[key];</span></td><td class="action"></td></tr><tr><td class="line">132</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">133</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">134</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">135</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.initModel();</span></td><td class="action"></td></tr><tr><td class="line">136</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">137</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (this.pages[key]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">138</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('keystone.content.page() Error: page ' + key + ' cannot be registered more than once.');</span></td><td class="action"></td></tr><tr><td class="line">139</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">140</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.pages[key] = page;</span></td><td class="action"></td></tr><tr><td class="line">141</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">142</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return page;</span></td><td class="action"></td></tr><tr><td class="line">143</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">144</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">145</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">146</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Ensures the Mongoose model for storing content is initialised.</span></td><td class="action"></td></tr><tr><td class="line">147</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">148</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Called automatically when pages are added.</span></td><td class="action"></td></tr><tr><td class="line">149</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">150</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api private</span></td><td class="action"></td></tr><tr><td class="line">151</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">152</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">153</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Content.prototype.initModel = function() {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">154</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (this.AppContent) return;</span></td><td class="action"></td></tr><tr><td class="line">155</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">156</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var contentSchemaDef = {</span></td><td class="action"></td></tr><tr><td class="line">157</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">158</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var ContentSchema = new keystone.mongoose.Schema(contentSchemaDef);</span></td><td class="action"></td></tr><tr><td class="line">159</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">160</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var PageSchema = new keystone.mongoose.Schema({</span></td><td class="action"></td></tr><tr><td class="line">161</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">162</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.AppContent = keystone.mongoose.model('App_Content', PageSchema);</span></td><td class="action"></td></tr><tr><td class="line">163</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">164</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">165</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">166</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Outputs client-side editable data for content management</span></td><td class="action"></td></tr><tr><td class="line">167</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">168</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Called automatically when pages are added.</span></td><td class="action"></td></tr><tr><td class="line">169</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">170</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api private</span></td><td class="action"></td></tr><tr><td class="line">171</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">172</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">173</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Content.prototype.editable = function(user, options) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">174</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!user || !user.canAccessKeystone) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">175</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return undefined;</span></td><td class="action"></td></tr><tr><td class="line">176</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">177</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var list = keystone.list(options.list);</span></td><td class="action"></td></tr><tr><td class="line">178</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">179</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (!list) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">180</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return JSON.stringify({ type: 'error', err: 'list not found' });</span></td><td class="action"></td></tr><tr><td class="line">181</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">182</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var data = {</span></td><td class="action"></td></tr><tr><td class="line">183</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">184</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (options.id) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">185</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			data.id = options.id;</span></td><td class="action"></td></tr><tr><td class="line">186</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">187</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return JSON.stringify(data);</span></td><td class="action"></td></tr><tr><td class="line">188</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">189</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">190</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">191</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">192</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * The exports object is an instance of Content.</span></td><td class="action"></td></tr><tr><td class="line">193</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">194</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">195</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">196</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">197</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">module.exports = exports = new Content();</span></td><td class="action"></td></tr><tr><td class="line">198</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">199</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>// Expose Classes</span></td><td class="action"></td></tr><tr class="hit "><td class="line">200</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.Page = require('./page');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">201</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.Types = require('./types');</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/content/page.js">lib/content/page.js</h2><div class="stats low"><div class="percentage">34% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">29% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">0% block coverage</div><div class="sloc">55 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr class="hit "><td class="line">1</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var _ = require('underscore'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">2</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	keystone = require('../../'),</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	utils = keystone.utils,</span></td><td class="action"></td></tr><tr class="hit "><td class="line">4</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	Type = require('./type');</span></td><td class="action"></td></tr><tr><td class="line">5</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">6</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">7</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Page Class</span></td><td class="action"></td></tr><tr><td class="line">8</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">9</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {String} key</span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Object} options</span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function Page(key, options) {</span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">16</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!(this instanceof Page))</span></td><td class="action"></td></tr><tr class="miss"><td class="line">17</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return new Page(key, options);</span></td><td class="action"></td></tr><tr><td class="line">18</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">19</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var page = this;</span></td><td class="action"></td></tr><tr><td class="line">20</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.options = utils.options({</span></td><td class="action"></td></tr><tr><td class="line">22</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.key = key;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">24</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.fields = {};</span></td><td class="action"></td></tr><tr><td class="line">25</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">26</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">28</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Object.defineProperty(Page.prototype, 'name', { get: function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">29</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return this.get('name') || this.set('name', utils.keyToLabel(this.key));</span></td><td class="action"></td></tr><tr><td class="line">30</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}});</span></td><td class="action"></td></tr><tr><td class="line">31</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">32</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">33</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Sets page options</span></td><td class="action"></td></tr><tr><td class="line">34</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">35</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * ####Example:</span></td><td class="action"></td></tr><tr><td class="line">36</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">37</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *     page.set('test', value) // sets the 'test' option to `value`</span></td><td class="action"></td></tr><tr><td class="line">38</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">39</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {String} key</span></td><td class="action"></td></tr><tr><td class="line">40</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {String} value</span></td><td class="action"></td></tr><tr><td class="line">41</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">42</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">43</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">44</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Page.prototype.set = function(key, value) {
	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">45</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (arguments.length === 1) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">46</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return this.options[key];</span></td><td class="action"></td></tr><tr><td class="line">47</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">48</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.options[key] = value;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">49</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return value;</span></td><td class="action"></td></tr><tr><td class="line">50</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">51</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">52</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">53</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">54</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Gets page options</span></td><td class="action"></td></tr><tr><td class="line">55</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">56</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * ####Example:</span></td><td class="action"></td></tr><tr><td class="line">57</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">58</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *     page.get('test') // returns the 'test' value</span></td><td class="action"></td></tr><tr><td class="line">59</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">60</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {String} key</span></td><td class="action"></td></tr><tr><td class="line">61</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @method get</span></td><td class="action"></td></tr><tr><td class="line">62</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">63</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">64</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">65</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Page.prototype.get = Page.prototype.set;</span></td><td class="action"></td></tr><tr><td class="line">66</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">67</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">68</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Adds one or more fields to the page</span></td><td class="action"></td></tr><tr><td class="line">69</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * </span></td><td class="action"></td></tr><tr><td class="line">70</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">71</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">72</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">73</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Page.prototype.add = function(fields) {
	
	// TODO: nested paths</span></td><td class="action"></td></tr><tr class="miss"><td class="line">74</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!utils.isObject(fields)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">75</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('keystone.content.Page.add() Error: fields must be an object.');</span></td><td class="action"></td></tr><tr><td class="line">76</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">77</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	_.each(fields, function(options, path) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">78</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if ('function' === typeof options) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">79</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			options = { type: options };</span></td><td class="action"></td></tr><tr><td class="line">80</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">81</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">82</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if ('function' !== typeof options.type) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">83</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			throw new Error('Page fields must be specified with a type function');</span></td><td class="action"></td></tr><tr><td class="line">84</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">85</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (options.type.prototype.__proto__ !== Type.prototype) {</span></td><td class="action"></td></tr><tr><td class="line">86</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			</span></td><td class="action"></td></tr><tr class="miss"><td class="line">87</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (options.type === String)</span></td><td class="action"></td></tr><tr class="miss"><td class="line">88</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				options.type = keystone.content.Types.Text;</span></td><td class="action"></td></tr><tr><td class="line">89</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			</span></td><td class="action"></td></tr><tr class="miss"><td class="line">90</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				throw new Error('Unrecognised field constructor: ' + options.type);</span></td><td class="action"></td></tr><tr><td class="line">91</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			</span></td><td class="action"></td></tr><tr class="miss"><td class="line">92</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		this.fields[path] = new options.type(path, options);</span></td><td class="action"></td></tr><tr><td class="line">93</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr><td class="line">94</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">95</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return this;</span></td><td class="action"></td></tr><tr><td class="line">96</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">97</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">98</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">99</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Registers the page with Keystone.</span></td><td class="action"></td></tr><tr><td class="line">100</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * </span></td><td class="action"></td></tr><tr><td class="line">101</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * ####Example:</span></td><td class="action"></td></tr><tr><td class="line">102</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * 		</span></td><td class="action"></td></tr><tr><td class="line">103</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * 		var homePage = new keystone.content.Page('home');</span></td><td class="action"></td></tr><tr><td class="line">104</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * 		// ...</span></td><td class="action"></td></tr><tr><td class="line">105</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * 		homePage.register();</span></td><td class="action"></td></tr><tr><td class="line">106</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * 		</span></td><td class="action"></td></tr><tr><td class="line">107</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * 		// later...</span></td><td class="action"></td></tr><tr><td class="line">108</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * 		var homePage = keystone.content.page('home');</span></td><td class="action"></td></tr><tr><td class="line">109</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * </span></td><td class="action"></td></tr><tr><td class="line">110</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">111</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">112</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">113</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Page.prototype.register = function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">114</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return keystone.content.page(this.key, this);</span></td><td class="action"></td></tr><tr><td class="line">115</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">116</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">117</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">118</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Populates a data structure based on defined fields</span></td><td class="action"></td></tr><tr><td class="line">119</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * </span></td><td class="action"></td></tr><tr><td class="line">120</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">121</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">122</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">123</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Page.prototype.populate = function(data) {
	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">124</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!utils.isObject(data)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">125</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		data = {};</span></td><td class="action"></td></tr><tr><td class="line">126</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">127</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return data;</span></td><td class="action"></td></tr><tr><td class="line">128</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">129</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">130</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">131</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Validates a data structure based on defined fields</span></td><td class="action"></td></tr><tr><td class="line">132</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * </span></td><td class="action"></td></tr><tr><td class="line">133</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">134</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">135</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">136</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Page.prototype.validate = function(data) {
	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">137</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!_.isObject(data)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">138</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		data = {};</span></td><td class="action"></td></tr><tr><td class="line">139</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">140</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return data;</span></td><td class="action"></td></tr><tr><td class="line">141</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">142</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">143</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">144</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Cleans a data structure so only the defined fields are present</span></td><td class="action"></td></tr><tr><td class="line">145</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * </span></td><td class="action"></td></tr><tr><td class="line">146</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">147</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">148</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">149</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Page.prototype.clean = function(data) {
	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">150</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!_.isObject(data)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">151</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		data = {};</span></td><td class="action"></td></tr><tr><td class="line">152</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">153</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return data;</span></td><td class="action"></td></tr><tr><td class="line">154</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">155</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">156</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">157</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">158</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Export class</span></td><td class="action"></td></tr><tr><td class="line">159</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">160</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">161</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports = module.exports = Page;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/content/type.js">lib/content/type.js</h2><div class="stats high"><div class="percentage">100% line coverage</div><div class="statements">100% statement coverage</div><div class="blocks">0% block coverage</div><div class="sloc">6 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Module dependencies.</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">5</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var _ = require('underscore'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">6</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	keystone = require('../../'),</span></td><td class="action"></td></tr><tr><td class="line">7</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	utils = keystone.utils;</span></td><td class="action"></td></tr><tr><td class="line">8</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">9</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Type Class</span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api private</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">14</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var Type = function(path, options) {
	// TODO
};</span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">16</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">17</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">18</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Export class</span></td><td class="action"></td></tr><tr><td class="line">19</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">20</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">21</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">module.exports = exports = Type;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/content/types/index.js">lib/content/types/index.js</h2><div class="stats high"><div class="percentage">100% line coverage</div><div class="statements">100% statement coverage</div><div class="blocks">0% block coverage</div><div class="sloc">2 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr class="hit "><td class="line">1</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.Text = require('./text');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">2</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.Html = require('./html');</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/content/types/text.js">lib/content/types/text.js</h2><div class="stats high"><div class="percentage">80% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">77% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">0% block coverage</div><div class="sloc">5 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Module dependencies.</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">5</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var util = require('util'),
	super_ = require('../type');</span></td><td class="action"></td></tr><tr><td class="line">6</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">7</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">8</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Text ContentType Constructor</span></td><td class="action"></td></tr><tr><td class="line">9</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @extends Field</span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function text(path, options) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">14</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	text.super_.call(path, options);</span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">16</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">17</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">18</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Inherit from Type</span></td><td class="action"></td></tr><tr><td class="line">19</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">20</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">21</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">util.inherits(text, super_);</span></td><td class="action"></td></tr><tr><td class="line">22</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">23</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">24</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">25</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Export class</span></td><td class="action"></td></tr><tr><td class="line">26</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">28</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">module.exports = exports = text;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/content/types/html.js">lib/content/types/html.js</h2><div class="stats high"><div class="percentage">80% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">77% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">0% block coverage</div><div class="sloc">5 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Module dependencies.</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">5</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var util = require('util'),
	super_ = require('../type');</span></td><td class="action"></td></tr><tr><td class="line">6</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">7</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">8</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * HTML ContentType Constructor</span></td><td class="action"></td></tr><tr><td class="line">9</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @extends Field</span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function html(path, options) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">14</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	html.super_.call(path, options);</span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">16</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">17</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">18</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Inherit from Type</span></td><td class="action"></td></tr><tr><td class="line">19</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">20</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">21</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">util.inherits(html, super_);</span></td><td class="action"></td></tr><tr><td class="line">22</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">23</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">24</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">25</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Export class</span></td><td class="action"></td></tr><tr><td class="line">26</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">28</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">module.exports = exports = html;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/list.js">lib/list.js</h2><div class="stats low"><div class="percentage">34% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">30% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">18% block coverage</div><div class="sloc">504 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr class="hit "><td class="line">1</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var _ = require('underscore'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">2</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	async = require('async'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">3</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	moment = require('moment'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">4</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	keystone = require('../'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">5</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	schemaPlugins = require('./schemaPlugins'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">6</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	utils = require('keystone-utils'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">7</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	Field = require('./field'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">8</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	UpdateHandler = require('./updateHandler'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">9</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	queryfilterlib = require('queryfilter');</span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * List Class</span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {String} key</span></td><td class="action"></td></tr><tr><td class="line">16</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Object} options</span></td><td class="action"></td></tr><tr><td class="line">17</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">18</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">19</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">20</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function List(key, options) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">21</td><td class="hits">30</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (!(this instanceof List)) return new List(key, options);</span></td><td class="action"></td></tr><tr><td class="line">22</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">23</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.options = utils.options({
		schema: {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">24</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">			collection: keystone.prefixModel(key)</span></td><td class="action"></td></tr><tr><td class="line">25</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		},</span></td><td class="action"></td></tr><tr><td class="line">26</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		noedit: false,</span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">28</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.key = key;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">29</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.path = this.get('path') || utils.keyToPath(key, true);</span></td><td class="action"></td></tr><tr class="hit "><td class="line">30</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.schema = new keystone.mongoose.Schema({}, this.options.schema);</span></td><td class="action"></td></tr><tr class="hit "><td class="line">31</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.uiElements = [];</span></td><td class="action"></td></tr><tr class="hit "><td class="line">32</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.underscoreMethods = {};</span></td><td class="action"></td></tr><tr class="hit "><td class="line">33</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.fields = {};</span></td><td class="action"></td></tr><tr class="hit "><td class="line">34</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.fieldTypes = {};</span></td><td class="action"></td></tr><tr class="hit "><td class="line">35</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.relationships = {};</span></td><td class="action"></td></tr><tr><td class="line">36</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">37</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.mappings = {
		name: null,
		createdBy: null,
		createdOn: null,
		modifiedBy: null,
		modifiedOn: null
	};</span></td><td class="action"></td></tr><tr><td class="line">38</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">39</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// set mappings</span></td><td class="action"></td></tr><tr class="hit partial"><td class="line">40</td><td class="hits">15</td><td class="statements">50%</td><td class="source"><span class="statement ">	_.each(this.options.map, function(val, key) {</span><span class="statement notok"><span class="offscreen"> not covered </span>this.map(key, val);</span><span class="statement ">}, this);</span></td><td class="action"></td></tr><tr><td class="line">41</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">42</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">	Object.defineProperty(this, 'label', { get: function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">43</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return this.get('label') || this.set('label', utils.plural(utils.keyToLabel(key)));</span></td><td class="action"></td></tr><tr><td class="line">44</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}});</span></td><td class="action"></td></tr><tr><td class="line">45</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">46</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">	Object.defineProperty(this, 'singular', { get: function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">47</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return this.get('singular') || this.set('singular', utils.singular(this.label));</span></td><td class="action"></td></tr><tr><td class="line">48</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}});</span></td><td class="action"></td></tr><tr><td class="line">49</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">50</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">	Object.defineProperty(this, 'plural', { get: function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">51</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return this.get('plural') || this.set('plural', utils.plural(this.singular));</span></td><td class="action"></td></tr><tr><td class="line">52</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}});</span></td><td class="action"></td></tr><tr><td class="line">53</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">54</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">	Object.defineProperty(this, 'namePath', { get: function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">55</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return this.mappings.name || '_id';</span></td><td class="action"></td></tr><tr><td class="line">56</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}});</span></td><td class="action"></td></tr><tr><td class="line">57</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">58</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">	Object.defineProperty(this, 'nameField', { get: function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">59</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return this.fields[this.mappings.name];</span></td><td class="action"></td></tr><tr><td class="line">60</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}});</span></td><td class="action"></td></tr><tr><td class="line">61</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">62</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">	Object.defineProperty(this, 'nameIsVirtual', { get: function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">63</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return this.model.schema.virtuals[this.mappings.name] ? true : false;</span></td><td class="action"></td></tr><tr><td class="line">64</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}});</span></td><td class="action"></td></tr><tr><td class="line">65</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">66</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">	Object.defineProperty(this, 'nameIsEditable', { get: function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">67</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return (this.fields[this.mappings.name] &amp;&amp; this.fields[this.mappings.name].type === 'text') ? !this.fields[this.mappings.name].noedit : false;</span></td><td class="action"></td></tr><tr><td class="line">68</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}});</span></td><td class="action"></td></tr><tr><td class="line">69</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">70</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">	Object.defineProperty(this, 'nameIsInitial', { get: function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">71</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return (this.fields[this.mappings.name] &amp;&amp; this.fields[this.mappings.name].options.initial === undefined);</span></td><td class="action"></td></tr><tr><td class="line">72</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}});</span></td><td class="action"></td></tr><tr><td class="line">73</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">74</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">	var initialFields; // initialFields values are initialised once, on demand</span></td><td class="action"></td></tr><tr class="hit "><td class="line">75</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">	Object.defineProperty(this, 'initialFields', { get: function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">76</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return initialFields || (initialFields = _.filter(this.fields, function(i) { return i.initial; }));</span></td><td class="action"></td></tr><tr><td class="line">77</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}});</span></td><td class="action"></td></tr><tr><td class="line">78</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">79</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">80</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">81</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">82</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">83</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Sets list options</span></td><td class="action"></td></tr><tr><td class="line">84</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">85</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * ####Example:</span></td><td class="action"></td></tr><tr><td class="line">86</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">87</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *     list.set('test', value) // sets the 'test' option to `value`</span></td><td class="action"></td></tr><tr><td class="line">88</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">89</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {String} key</span></td><td class="action"></td></tr><tr><td class="line">90</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {String} value</span></td><td class="action"></td></tr><tr><td class="line">91</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">92</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">93</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">94</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">List.prototype.set = function(key, value) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">95</td><td class="hits">198</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (arguments.length === 1) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">96</td><td class="hits">194</td><td class="statements">100%</td><td class="source"><span class="statement ">		return this.options[key];</span></td><td class="action"></td></tr><tr><td class="line">97</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">98</td><td class="hits">4</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.options[key] = value;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">99</td><td class="hits">4</td><td class="statements">100%</td><td class="source"><span class="statement ">	return value;</span></td><td class="action"></td></tr><tr><td class="line">100</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">101</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">102</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">103</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">104</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Gets list options</span></td><td class="action"></td></tr><tr><td class="line">105</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">106</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * ####Example:</span></td><td class="action"></td></tr><tr><td class="line">107</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">108</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *     list.get('test') // returns the 'test' value</span></td><td class="action"></td></tr><tr><td class="line">109</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">110</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {String} key</span></td><td class="action"></td></tr><tr><td class="line">111</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @method get</span></td><td class="action"></td></tr><tr><td class="line">112</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">113</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">114</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">115</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">List.prototype.get = List.prototype.set;</span></td><td class="action"></td></tr><tr><td class="line">116</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">117</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">118</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">119</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Maps a built-in field (e.g. name) to a specific path</span></td><td class="action"></td></tr><tr><td class="line">120</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">121</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">122</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">123</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">124</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">List.prototype.map = function(field, path) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">125</td><td class="hits">26</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (path) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">126</td><td class="hits">22</td><td class="statements">100%</td><td class="source"><span class="statement ">		this.mappings[field] = path;</span></td><td class="action"></td></tr><tr><td class="line">127</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">128</td><td class="hits">26</td><td class="statements">100%</td><td class="source"><span class="statement ">	return this.mappings[field];</span></td><td class="action"></td></tr><tr><td class="line">129</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">130</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">131</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">132</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">133</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Checks to see if a field path matches a currently unmapped path, and</span></td><td class="action"></td></tr><tr><td class="line">134</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * if so, adds a mapping for it.</span></td><td class="action"></td></tr><tr><td class="line">135</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">136</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api private</span></td><td class="action"></td></tr><tr><td class="line">137</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">138</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">139</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">List.prototype.automap = function(field) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">140</td><td class="hits">50</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (_.has(this.mappings, field.path) &amp;&amp; !this.mappings[field.path]) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">141</td><td class="hits">18</td><td class="statements">100%</td><td class="source"><span class="statement ">		this.map(field.path, field.path);</span></td><td class="action"></td></tr><tr><td class="line">142</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">143</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">144</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">145</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">146</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Adds one or more fields to the List</span></td><td class="action"></td></tr><tr><td class="line">147</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Based on Mongoose's Schema.add</span></td><td class="action"></td></tr><tr><td class="line">148</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">149</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">150</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">151</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">152</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">List.prototype.add = function() {
</span></td><td class="action"></td></tr><tr class="hit "><td class="line">153</td><td class="hits">23</td><td class="statements">100%</td><td class="source"><span class="statement ">	var add = function(obj, prefix) {
</span></td><td class="action"></td></tr><tr class="hit "><td class="line">154</td><td class="hits">25</td><td class="statements">100%</td><td class="source"><span class="statement ">		prefix = prefix || '';</span></td><td class="action"></td></tr><tr class="hit "><td class="line">155</td><td class="hits">25</td><td class="statements">100%</td><td class="source"><span class="statement ">		var keys = Object.keys(obj);</span></td><td class="action"></td></tr><tr><td class="line">156</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">157</td><td class="hits">77</td><td class="statements">100%</td><td class="source"><span class="statement ">		for (var i = 0; i &lt; keys.length; ++i) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">158</td><td class="hits">52</td><td class="statements">100%</td><td class="source"><span class="statement ">			var key = keys[i];</span></td><td class="action"></td></tr><tr><td class="line">159</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">160</td><td class="hits">52</td><td class="statements">100%</td><td class="source"><span class="statement ">			if (null === obj[key]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">161</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				throw new Error('Invalid value for schema path `'+ prefix + key +'`');</span></td><td class="action"></td></tr><tr><td class="line">162</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr><td class="line">163</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">164</td><td class="hits">52</td><td class="statements">100%</td><td class="source"><span class="statement ">			if (utils.isObject(obj[key]) &amp;&amp; (!obj[key].constructor || 'Object' === obj[key].constructor.name) &amp;&amp; (!obj[key].type || obj[key].type.type)) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">165</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">				if (Object.keys(obj[key]).length) {</span></td><td class="action"></td></tr><tr><td class="line">166</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					// nested object, e.g. { last: { name: String }}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">167</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">					this.schema.nested[this.path] = true;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">168</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">					add(obj[key], prefix + key + '.');</span></td><td class="action"></td></tr><tr><td class="line">169</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">170</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					addField(prefix + key, obj[key]); // mixed type field</span></td><td class="action"></td></tr><tr><td class="line">171</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">172</td><td class="hits">50</td><td class="statements">100%</td><td class="source"><span class="statement ">				addField(prefix + key, obj[key]);</span></td><td class="action"></td></tr><tr><td class="line">173</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr><td class="line">174</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">175</td><td class="hits">23</td><td class="statements">100%</td><td class="source"><span class="statement ">	var addField = function(path, options) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">176</td><td class="hits">50</td><td class="statements">100%</td><td class="source"><span class="statement ">		this.uiElements.push({
			type: 'field',</span></td><td class="action"></td></tr><tr class="hit "><td class="line">177</td><td class="hits">50</td><td class="statements">100%</td><td class="source"><span class="statement ">			field: this.field(path, options)</span></td><td class="action"></td></tr><tr><td class="line">178</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		});</span></td><td class="action"></td></tr><tr><td class="line">179</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}.bind(this);</span></td><td class="action"></td></tr><tr><td class="line">180</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">181</td><td class="hits">23</td><td class="statements">100%</td><td class="source"><span class="statement ">	_.each(arguments, function(def) {
</span></td><td class="action"></td></tr><tr class="hit "><td class="line">182</td><td class="hits">23</td><td class="statements">100%</td><td class="source"><span class="statement ">		if ('string' === typeof def) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">183</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (def === '&gt;&gt;&gt;') {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">184</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				this.uiElements.push({</span></td><td class="action"></td></tr><tr><td class="line">185</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					type: 'indent'</span></td><td class="action"></td></tr><tr class="miss"><td class="line">186</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			} else if (def === '&lt;&lt;&lt;') {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">187</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				this.uiElements.push({</span></td><td class="action"></td></tr><tr><td class="line">188</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					type: 'outdent'</span></td><td class="action"></td></tr><tr><td class="line">189</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">190</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				this.uiElements.push({</span></td><td class="action"></td></tr><tr><td class="line">191</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="hit partial"><td class="line">192</td><td class="hits">23</td><td class="statements">33%</td><td class="source"><span class="statement ">			if (def.heading &amp;&amp;</span><span class="statement notok"><span class="offscreen"> not covered </span>'string' === typeof def.heading</span><span class="statement "> {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">193</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				this.uiElements.push({</span></td><td class="action"></td></tr><tr><td class="line">194</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					type: 'heading',</span></td><td class="action"></td></tr><tr class="hit "><td class="line">195</td><td class="hits">23</td><td class="statements">100%</td><td class="source"><span class="statement ">				add(def);</span></td><td class="action"></td></tr><tr><td class="line">196</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr><td class="line">197</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">198</td><td class="hits">23</td><td class="statements">100%</td><td class="source"><span class="statement ">	return this;</span></td><td class="action"></td></tr><tr><td class="line">199</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">200</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">201</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">202</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">203</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Adds preset patterns of fields and behaviours to the Schema</span></td><td class="action"></td></tr><tr><td class="line">204</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">205</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">206</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">207</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">208</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">List.prototype.addPattern = function(pattern) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">209</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">	var warningMsg = </span></td><td class="action"></td></tr><tr><td class="line">210</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		'Use of List.addPattern(&quot;standard meta&quot;) is now deprecated and will be removed\n' +</span></td><td class="action"></td></tr><tr class="hit "><td class="line">211</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		'in future versions of KeystoneJS. It has been replaced with the List &quot;track&quot; option.\n\n' +</span></td><td class="action"></td></tr><tr class="hit "><td class="line">212</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		'See http://keystonejs.com/docs/database/#lists-options for more information.';</span></td><td class="action"></td></tr><tr><td class="line">213</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">214</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">	switch (pattern) {</span></td><td class="action"></td></tr><tr><td class="line">215</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">216</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		case 'standard meta':</span></td><td class="action"></td></tr><tr><td class="line">217</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			// enable track options if it's not already enabled</span></td><td class="action"></td></tr><tr class="hit "><td class="line">218</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">			if (!this.get('track')) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">219</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">				this.set('track', true);</span></td><td class="action"></td></tr><tr><td class="line">220</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">221</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">			this.set('track simulate standard meta', true);</span></td><td class="action"></td></tr><tr class="hit "><td class="line">222</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">			keystone.console.err('Deprecation Warning', warningMsg);</span></td><td class="action"></td></tr><tr><td class="line">223</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		break;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">224</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">	return this;</span></td><td class="action"></td></tr><tr><td class="line">225</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">226</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">227</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">228</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">229</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Creates a new field at the specified path, with the provided options.</span></td><td class="action"></td></tr><tr><td class="line">230</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * If no options are provides, returns the field at the specified path.</span></td><td class="action"></td></tr><tr><td class="line">231</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">232</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">233</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">234</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">235</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">List.prototype.field = function(path, options) {
</span></td><td class="action"></td></tr><tr class="hit "><td class="line">236</td><td class="hits">196</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (arguments.length === 1) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">237</td><td class="hits">146</td><td class="statements">100%</td><td class="source"><span class="statement ">		return this.fields[path];</span></td><td class="action"></td></tr><tr><td class="line">238</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">239</td><td class="hits">50</td><td class="statements">100%</td><td class="source"><span class="statement ">	if ('function' === typeof options) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">240</td><td class="hits">7</td><td class="statements">100%</td><td class="source"><span class="statement ">		options = { type: options };</span></td><td class="action"></td></tr><tr><td class="line">241</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">242</td><td class="hits">50</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (this.get('noedit')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">243</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		options.noedit = true;</span></td><td class="action"></td></tr><tr><td class="line">244</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">245</td><td class="hits">50</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (!options.note &amp;&amp; this.get('notes')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">246</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		options.note = this.get('notes')[path];</span></td><td class="action"></td></tr><tr><td class="line">247</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">248</td><td class="hits">50</td><td class="statements">100%</td><td class="source"><span class="statement ">	if ('function' !== typeof options.type) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">249</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('Fields must be specified with a type function');</span></td><td class="action"></td></tr><tr><td class="line">250</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">251</td><td class="hits">50</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (options.type.prototype.__proto__ !== Field.prototype) {</span></td><td class="action"></td></tr><tr><td class="line">252</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">253</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		// Convert native field types to their default Keystone counterpart</span></td><td class="action"></td></tr><tr><td class="line">254</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">255</td><td class="hits">30</td><td class="statements">100%</td><td class="source"><span class="statement ">		if (options.type === String)</span></td><td class="action"></td></tr><tr class="hit "><td class="line">256</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">			options.type = Field.Types.Text;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">257</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">		else if (options.type === Number)</span></td><td class="action"></td></tr><tr class="miss"><td class="line">258</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			options.type = Field.Types.Number;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">259</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">		else if (options.type === Boolean)</span></td><td class="action"></td></tr><tr class="hit "><td class="line">260</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">			options.type = Field.Types.Boolean;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">261</td><td class="hits">14</td><td class="statements">100%</td><td class="source"><span class="statement ">		else if (options.type === Date)</span></td><td class="action"></td></tr><tr class="hit "><td class="line">262</td><td class="hits">14</td><td class="statements">100%</td><td class="source"><span class="statement ">			options.type = Field.Types.Datetime;</span></td><td class="action"></td></tr><tr><td class="line">263</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		else</span></td><td class="action"></td></tr><tr class="miss"><td class="line">264</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			throw new Error('Unrecognised field constructor: ' + options.type);</span></td><td class="action"></td></tr><tr><td class="line">265</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">266</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">267</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">268</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Note the presence of this field type for client-side script optimisation</span></td><td class="action"></td></tr><tr class="hit "><td class="line">269</td><td class="hits">50</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.fieldTypes[options.type.name] = true;</span></td><td class="action"></td></tr><tr><td class="line">270</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">271</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Wysiwyg HTML fields are handled as a special case so we can include TinyMCE as required</span></td><td class="action"></td></tr><tr class="hit "><td class="line">272</td><td class="hits">50</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (options.type.name === 'html' &amp;&amp; options.wysiwyg) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">273</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		this.fieldTypes.wysiwyg = true;</span></td><td class="action"></td></tr><tr><td class="line">274</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">275</td><td class="hits">50</td><td class="statements">100%</td><td class="source"><span class="statement ">	var field = new options.type(this, path, options);</span></td><td class="action"></td></tr><tr><td class="line">276</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">277</td><td class="hits">50</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.fields[path] = field;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">278</td><td class="hits">50</td><td class="statements">100%</td><td class="source"><span class="statement ">	return field;</span></td><td class="action"></td></tr><tr><td class="line">279</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">280</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">281</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">282</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">283</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Adds a method to the underscoreMethods collection on the list, which is then</span></td><td class="action"></td></tr><tr><td class="line">284</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * added to the schema before the list is registered with mongoose.</span></td><td class="action"></td></tr><tr><td class="line">285</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">286</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">287</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">288</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">289</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">List.prototype.underscoreMethod = function(path, fn) {
</span></td><td class="action"></td></tr><tr class="hit "><td class="line">290</td><td class="hits">136</td><td class="statements">100%</td><td class="source"><span class="statement ">	var target = this.underscoreMethods;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">291</td><td class="hits">136</td><td class="statements">100%</td><td class="source"><span class="statement ">	path = path.split('.');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">292</td><td class="hits">136</td><td class="statements">100%</td><td class="source"><span class="statement ">	var last = path.pop();</span></td><td class="action"></td></tr><tr><td class="line">293</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">294</td><td class="hits">136</td><td class="statements">100%</td><td class="source"><span class="statement ">	path.forEach(function(part) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">295</td><td class="hits">149</td><td class="statements">100%</td><td class="source"><span class="statement ">		if (!target[part]) target[part] = {};</span></td><td class="action"></td></tr><tr class="hit "><td class="line">296</td><td class="hits">149</td><td class="statements">100%</td><td class="source"><span class="statement ">		target = target[part];</span></td><td class="action"></td></tr><tr><td class="line">297</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">298</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">299</td><td class="hits">136</td><td class="statements">100%</td><td class="source"><span class="statement ">	target[last] = fn;</span></td><td class="action"></td></tr><tr><td class="line">300</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">301</td><td class="hits">136</td><td class="statements">100%</td><td class="source"><span class="statement ">	return this;</span></td><td class="action"></td></tr><tr><td class="line">302</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">303</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">304</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">305</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">306</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Default Sort Field</span></td><td class="action"></td></tr><tr><td class="line">307</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">308</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">309</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">310</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">311</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Object.defineProperty(List.prototype, 'defaultSort', {

	get: function() {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">312</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var ds = this.get('defaultSort');</span></td><td class="action"></td></tr><tr><td class="line">313</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">314</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return (ds === '__default__') ? (this.get('sortable') ? 'sortOrder' : this.namePath) : ds;</span></td><td class="action"></td></tr><tr><td class="line">315</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">316</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}, set: function(value) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">317</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		this.set('defaultSort', value);</span></td><td class="action"></td></tr><tr><td class="line">318</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">319</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">320</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">321</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">322</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Expands a comma-separated string or array of columns into valid column objects.</span></td><td class="action"></td></tr><tr><td class="line">323</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">324</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Columns can be:</span></td><td class="action"></td></tr><tr><td class="line">325</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *    - A Field, in the format &quot;field|width&quot;</span></td><td class="action"></td></tr><tr><td class="line">326</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *    - A Field in a single related List, in the format &quot;list:field|width&quot;</span></td><td class="action"></td></tr><tr><td class="line">327</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *    - Any valid path in the Schema, in the format &quot;path|width&quot;</span></td><td class="action"></td></tr><tr><td class="line">328</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">329</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * The width part is optional, and can be in the format &quot;n%&quot; or &quot;npx&quot;.</span></td><td class="action"></td></tr><tr><td class="line">330</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">331</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * The path __name__ is automatically mapped to the namePath of the List.</span></td><td class="action"></td></tr><tr><td class="line">332</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">333</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * The field or path for the name of the item (defaults to ID if not set or detected)</span></td><td class="action"></td></tr><tr><td class="line">334</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * is automatically prepended if not explicitly included.</span></td><td class="action"></td></tr><tr><td class="line">335</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">336</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api private</span></td><td class="action"></td></tr><tr><td class="line">337</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">338</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">339</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">List.prototype.expandColumns = function(cols) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">340</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (typeof cols === 'string') {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">341</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		cols = cols.split(',');</span></td><td class="action"></td></tr><tr><td class="line">342</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">343</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!Array.isArray(cols)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">344</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('List.expandColumns: cols must be an array.');</span></td><td class="action"></td></tr><tr><td class="line">345</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">346</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var list = this,</span></td><td class="action"></td></tr><tr><td class="line">347</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">348</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var getCol = function(def) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">349</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (def.path === '__name__') {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">350</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			def.path = list.namePath;</span></td><td class="action"></td></tr><tr><td class="line">351</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">352</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var field = list.fields[def.path],</span></td><td class="action"></td></tr><tr><td class="line">353</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">354</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (field) {</span></td><td class="action"></td></tr><tr><td class="line">355</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">356</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			col = {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">357</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				label: def.label || field.label</span></td><td class="action"></td></tr><tr><td class="line">358</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			};</span></td><td class="action"></td></tr><tr><td class="line">359</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">360</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (col.type === 'relationship') {</span></td><td class="action"></td></tr><tr><td class="line">361</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">362</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				col.refList = col.field.refList;</span></td><td class="action"></td></tr><tr><td class="line">363</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">364</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (col.refList) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">365</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					col.refPath = def.subpath || col.refList.namePath;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">366</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					col.subField = col.refList.fields[col.refPath];</span></td><td class="action"></td></tr><tr class="miss"><td class="line">367</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					col.populate = { path: col.field.path, subpath: col.refPath };</span></td><td class="action"></td></tr><tr><td class="line">368</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">369</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (!def.label &amp;&amp; def.subpath) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">370</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					col.label = field.label + ': ' + (col.subField ? col.subField.label : utils.keyToLabel(def.subpath));</span></td><td class="action"></td></tr><tr><td class="line">371</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">372</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		} else if (list.model.schema.paths[def.path] || list.model.schema.virtuals[def.path]) {</span></td><td class="action"></td></tr><tr><td class="line">373</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			// column refers to a path in the schema</span></td><td class="action"></td></tr><tr class="miss"><td class="line">374</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			col = {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">375</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				label: def.label || utils.keyToLabel(def.path)</span></td><td class="action"></td></tr><tr><td class="line">376</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			};</span></td><td class="action"></td></tr><tr><td class="line">377</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">378</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (col) {</span></td><td class="action"></td></tr><tr><td class="line">379</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">380</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			col.width = def.width;</span></td><td class="action"></td></tr><tr><td class="line">381</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">382</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (col.path === list.namePath) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">383</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				col.isName = true;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">384</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				nameCol = col;</span></td><td class="action"></td></tr><tr><td class="line">385</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">386</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (field &amp;&amp; field.col) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">387</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				_.extend(col, field.col);</span></td><td class="action"></td></tr><tr><td class="line">388</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">389</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return col;</span></td><td class="action"></td></tr><tr><td class="line">390</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">391</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">392</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	for (var i = 0; i &lt; cols.length; i++) {</span></td><td class="action"></td></tr><tr><td class="line">393</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">394</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var def = {};</span></td><td class="action"></td></tr><tr><td class="line">395</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">396</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (typeof cols[i] === 'string') {</span></td><td class="action"></td></tr><tr><td class="line">397</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">398</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var parts = cols[i].trim().split('|');</span></td><td class="action"></td></tr><tr><td class="line">399</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">400</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			def.width = parts[1] || false;</span></td><td class="action"></td></tr><tr><td class="line">401</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">402</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			parts = parts[0].split(':');</span></td><td class="action"></td></tr><tr><td class="line">403</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">404</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			def.path = parts[0];</span></td><td class="action"></td></tr><tr class="miss"><td class="line">405</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			def.subpath = parts[1];</span></td><td class="action"></td></tr><tr><td class="line">406</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">407</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">408</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">409</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (!utils.isObject(def) || !def.path) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">410</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			throw new Error('List.expandColumns: column definition must contain a path.');</span></td><td class="action"></td></tr><tr><td class="line">411</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">412</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var col = getCol(def);</span></td><td class="action"></td></tr><tr><td class="line">413</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">414</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (col) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">415</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			expanded.push(col);</span></td><td class="action"></td></tr><tr><td class="line">416</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">417</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!nameCol) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">418</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		nameCol = getCol({ path: list.namePath });</span></td><td class="action"></td></tr><tr class="miss"><td class="line">419</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (nameCol) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">420</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			expanded.unshift(nameCol);</span></td><td class="action"></td></tr><tr><td class="line">421</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">422</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return expanded;</span></td><td class="action"></td></tr><tr><td class="line">423</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">424</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">425</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">426</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">427</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Specified select and populate options for a query based the provided columns.</span></td><td class="action"></td></tr><tr><td class="line">428</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">429</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Query} query</span></td><td class="action"></td></tr><tr><td class="line">430</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Array} columns</span></td><td class="action"></td></tr><tr><td class="line">431</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api private</span></td><td class="action"></td></tr><tr><td class="line">432</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">433</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">434</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">List.prototype.selectColumns = function(q, cols) {

	// Populate relationship columns
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">435</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var select = [],</span></td><td class="action"></td></tr><tr><td class="line">436</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">437</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	cols.forEach(function(col) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">438</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		select.push(col.path);</span></td><td class="action"></td></tr><tr><td class="line">439</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (col.populate) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">440</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (!populate[col.populate.path]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">441</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				populate[col.populate.path] = [];</span></td><td class="action"></td></tr><tr><td class="line">442</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">443</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			populate[col.populate.path].push(col.populate.subpath);</span></td><td class="action"></td></tr><tr><td class="line">444</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">445</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">446</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">447</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	q.select(select.join(' '));</span></td><td class="action"></td></tr><tr><td class="line">448</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">449</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	for (path in populate) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">450</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if ( populate.hasOwnProperty(path) ) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">451</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			q.populate(path, populate[path].join(' '));</span></td><td class="action"></td></tr><tr><td class="line">452</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">453</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">454</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">455</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">456</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Default Column Fields</span></td><td class="action"></td></tr><tr><td class="line">457</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">458</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">459</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">460</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">461</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Object.defineProperty(List.prototype, 'defaultColumns', {

	get: function() {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">462</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (!this._defaultColumns) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">463</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			this._defaultColumns = this.expandColumns(this.get('defaultColumns'));</span></td><td class="action"></td></tr><tr><td class="line">464</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">465</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">466</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return this._defaultColumns;</span></td><td class="action"></td></tr><tr><td class="line">467</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">468</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}, set: function(value) {</span></td><td class="action"></td></tr><tr><td class="line">469</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">470</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		this.set('defaultColumns', value);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">471</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		delete this._defaultColumns;</span></td><td class="action"></td></tr><tr><td class="line">472</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">473</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">474</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">475</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">476</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Registers relationships to this list defined on others</span></td><td class="action"></td></tr><tr><td class="line">477</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">478</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">479</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">480</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">481</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">List.prototype.relationship = function(def) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">482</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (arguments.length &gt; 1) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">483</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		_.map(arguments, function(def) { this.relationship(def); }, this);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">484</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return this;</span></td><td class="action"></td></tr><tr><td class="line">485</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">486</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if ('string' === typeof def) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">487</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		def = { ref: def };</span></td><td class="action"></td></tr><tr><td class="line">488</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">489</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!def.ref) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">490</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('List Relationships must be specified with an object containing ref (' + this.key + ')');</span></td><td class="action"></td></tr><tr><td class="line">491</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">492</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!def.refPath) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">493</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		def.refPath = utils.downcase(this.key);</span></td><td class="action"></td></tr><tr><td class="line">494</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">495</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!def.path) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">496</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		def.path = utils.keyToProperty(def.ref, true);</span></td><td class="action"></td></tr><tr><td class="line">497</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">498</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	Object.defineProperty(def, 'refList', {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">499</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return keystone.list(def.ref);</span></td><td class="action"></td></tr><tr><td class="line">500</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">501</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">502</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	Object.defineProperty(def, 'isValid', {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">503</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return keystone.list(def.ref) ? true : false;</span></td><td class="action"></td></tr><tr><td class="line">504</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">505</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">506</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.relationships[def.path] = def;</span></td><td class="action"></td></tr><tr><td class="line">507</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">508</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return this;</span></td><td class="action"></td></tr><tr><td class="line">509</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">510</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">511</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">512</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">513</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Registers the Schema with Mongoose, and the List with Keystone</span></td><td class="action"></td></tr><tr><td class="line">514</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">515</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Also adds default fields and virtuals to the schema for the list</span></td><td class="action"></td></tr><tr><td class="line">516</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">517</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">518</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">519</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">520</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">List.prototype.register = function() {
</span></td><td class="action"></td></tr><tr class="hit "><td class="line">521</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">	var list = this;</span></td><td class="action"></td></tr><tr><td class="line">522</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">523</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.schema.virtual('list').get(function () {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">524</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return list;</span></td><td class="action"></td></tr><tr><td class="line">525</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">526</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">527</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (this.get('sortable')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">528</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		schemaPlugins.sortable.apply(this);</span></td><td class="action"></td></tr><tr><td class="line">529</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">530</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (this.get('autokey')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">531</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		schemaPlugins.autokey.apply(this);</span></td><td class="action"></td></tr><tr><td class="line">532</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">533</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (this.get('track')) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">534</td><td class="hits">12</td><td class="statements">100%</td><td class="source"><span class="statement ">		schemaPlugins.track.apply(this);</span></td><td class="action"></td></tr><tr><td class="line">535</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">536</td><td class="hits">12</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (!_.isEmpty(this.relationships)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">537</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		this.schema.methods.getRelated = schemaPlugins.methods.getRelated;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">538</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		this.schema.methods.populateRelated = schemaPlugins.methods.populateRelated;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">539</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (!this.schema.options.toObject) this.schema.options.toObject = {};</span></td><td class="action"></td></tr><tr class="miss"><td class="line">540</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		this.schema.options.toObject.transform = schemaPlugins.options.transform;</span></td><td class="action"></td></tr><tr><td class="line">541</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">542</td><td class="hits">12</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.schema.virtual('_').get(function() {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">543</td><td class="hits">4</td><td class="statements">100%</td><td class="source"><span class="statement ">		if (!this.__methods) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">544</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">			this.__methods = utils.bindMethods(list.underscoreMethods, this);</span></td><td class="action"></td></tr><tr><td class="line">545</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">546</td><td class="hits">4</td><td class="statements">100%</td><td class="source"><span class="statement ">		return this.__methods;</span></td><td class="action"></td></tr><tr><td class="line">547</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">548</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">549</td><td class="hits">12</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.schema.method('getUpdateHandler', function(req, res, ops) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">550</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">		return new UpdateHandler(list, this, req, res, ops);</span></td><td class="action"></td></tr><tr><td class="line">551</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">552</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">553</td><td class="hits">12</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.model = keystone.mongoose.model(this.key, this.schema);</span></td><td class="action"></td></tr><tr><td class="line">554</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">555</td><td class="hits">12</td><td class="statements">100%</td><td class="source"><span class="statement ">	require('../').list(this);</span></td><td class="action"></td></tr><tr><td class="line">556</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">557</td><td class="hits">12</td><td class="statements">100%</td><td class="source"><span class="statement ">	return this;</span></td><td class="action"></td></tr><tr><td class="line">558</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">559</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">560</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">561</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">562</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Gets the name of the provided document from the correct path</span></td><td class="action"></td></tr><tr><td class="line">563</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">564</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * ####Example:</span></td><td class="action"></td></tr><tr><td class="line">565</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">566</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *     var name = list.getDocumentName(item)</span></td><td class="action"></td></tr><tr><td class="line">567</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">568</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Object} item</span></td><td class="action"></td></tr><tr><td class="line">569</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Boolean} escape - causes HTML entities to be encoded</span></td><td class="action"></td></tr><tr><td class="line">570</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">571</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">572</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">573</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">List.prototype.getDocumentName = function(doc, escape) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">574</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var name = String(this.nameField ? this.nameField.format(doc) : doc.get(this.namePath));</span></td><td class="action"></td></tr><tr class="miss"><td class="line">575</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return (escape) ? utils.encodeHTMLEntities(name) : name;</span></td><td class="action"></td></tr><tr><td class="line">576</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">577</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">578</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">579</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">580</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Processes a filter string into a filters object</span></td><td class="action"></td></tr><tr><td class="line">581</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">582</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {String} filters</span></td><td class="action"></td></tr><tr><td class="line">583</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api private</span></td><td class="action"></td></tr><tr><td class="line">584</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">585</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">586</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">List.prototype.processFilters = function(q) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">587</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var me = this;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">588</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var filters = {};</span></td><td class="action"></td></tr><tr class="miss"><td class="line">589</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	queryfilterlib.QueryFilters.create(q).getFilters().forEach(function(filter){</span></td><td class="action"></td></tr><tr class="miss"><td class="line">590</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		filter.path = filter.key; // alias for b/c</span></td><td class="action"></td></tr><tr class="miss"><td class="line">591</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		filter.field = me.fields[filter.key];</span></td><td class="action"></td></tr><tr class="miss"><td class="line">592</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		filters[filter.path] = filter;</span></td><td class="action"></td></tr><tr><td class="line">593</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr class="miss"><td class="line">594</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return filters;</span></td><td class="action"></td></tr><tr><td class="line">595</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">596</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">597</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">598</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">599</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Gets filters for a Mongoose query that will search for the provided string,</span></td><td class="action"></td></tr><tr><td class="line">600</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * based on the searchFields List option.</span></td><td class="action"></td></tr><tr><td class="line">601</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">602</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Also accepts a filters object from `processFilters()`, any of which may</span></td><td class="action"></td></tr><tr><td class="line">603</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * override the search string.</span></td><td class="action"></td></tr><tr><td class="line">604</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">605</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * ####Example:</span></td><td class="action"></td></tr><tr><td class="line">606</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">607</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *     list.getSearchFilters('jed') // returns { name: /jed/i }</span></td><td class="action"></td></tr><tr><td class="line">608</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">609</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {String} query</span></td><td class="action"></td></tr><tr><td class="line">610</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Object} additional filters</span></td><td class="action"></td></tr><tr><td class="line">611</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">612</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">613</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">614</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">List.prototype.getSearchFilters = function(search, add) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">615</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var filters = {},</span></td><td class="action"></td></tr><tr><td class="line">616</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">617</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	search = String(search || '').trim();</span></td><td class="action"></td></tr><tr><td class="line">618</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">619</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (search.length) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">620</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var searchFilter,</span></td><td class="action"></td></tr><tr class="miss"><td class="line">621</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			searchParts = search.split(' '),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">622</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			searchRx = new RegExp(utils.escapeRegExp(search), 'i'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">623</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			splitSearchRx = new RegExp((searchParts.length &gt; 1) ? _.map(searchParts, utils.escapeRegExp).join('|') : search, 'i'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">624</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			searchFields = this.get('searchFields'),</span></td><td class="action"></td></tr><tr><td class="line">625</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			searchFilters = [],</span></td><td class="action"></td></tr><tr class="miss"><td class="line">626</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			searchIdField = utils.isValidObjectId(search);</span></td><td class="action"></td></tr><tr><td class="line">627</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">628</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if ('string' === typeof searchFields) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">629</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			searchFields = searchFields.split(',');</span></td><td class="action"></td></tr><tr><td class="line">630</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">631</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		searchFields.forEach(function(path) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">632</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			path = path.trim();</span></td><td class="action"></td></tr><tr><td class="line">633</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">634</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (path === '__name__') {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">635</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				path = list.mappings.name;</span></td><td class="action"></td></tr><tr><td class="line">636</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr><td class="line">637</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">638</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var field = list.fields[path];</span></td><td class="action"></td></tr><tr><td class="line">639</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">640</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (field &amp;&amp; field.type === 'name') {</span></td><td class="action"></td></tr><tr><td class="line">641</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">642</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				var first = {};</span></td><td class="action"></td></tr><tr class="miss"><td class="line">643</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				first[field.paths.first] = splitSearchRx;</span></td><td class="action"></td></tr><tr><td class="line">644</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">645</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				var last = {};</span></td><td class="action"></td></tr><tr class="miss"><td class="line">646</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				last[field.paths.last] = splitSearchRx;</span></td><td class="action"></td></tr><tr><td class="line">647</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">648</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				searchFilter = {};</span></td><td class="action"></td></tr><tr class="miss"><td class="line">649</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				searchFilter.$or = [first, last];</span></td><td class="action"></td></tr><tr class="miss"><td class="line">650</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				searchFilters.push(searchFilter);</span></td><td class="action"></td></tr><tr><td class="line">651</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">652</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			} else {</span></td><td class="action"></td></tr><tr><td class="line">653</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">654</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				searchFilter = {};</span></td><td class="action"></td></tr><tr class="miss"><td class="line">655</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				searchFilter[path] = searchRx;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">656</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				searchFilters.push(searchFilter);</span></td><td class="action"></td></tr><tr><td class="line">657</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr><td class="line">658</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">659</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (list.autokey) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">660</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			searchFilter = {};</span></td><td class="action"></td></tr><tr class="miss"><td class="line">661</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			searchFilter[list.autokey.path] = searchRx;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">662</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			searchFilters.push(searchFilter);</span></td><td class="action"></td></tr><tr><td class="line">663</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">664</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (searchIdField) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">665</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			searchFilter = {};</span></td><td class="action"></td></tr><tr class="miss"><td class="line">666</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			searchFilter._id = search;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">667</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			searchFilters.push(searchFilter);</span></td><td class="action"></td></tr><tr><td class="line">668</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">669</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (searchFilters.length &gt; 1) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">670</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			filters.$or = searchFilters;</span></td><td class="action"></td></tr><tr><td class="line">671</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		} else if (searchFilters.length) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">672</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			filters = searchFilters[0];</span></td><td class="action"></td></tr><tr><td class="line">673</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">674</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (add) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">675</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		_.each(add, function(filter) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">676</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var cond, path = filter.key, value = filter.value;</span></td><td class="action"></td></tr><tr><td class="line">677</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">678</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			switch (filter.field.type) {</span></td><td class="action"></td></tr><tr><td class="line">679</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">680</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				case 'boolean':</span></td><td class="action"></td></tr><tr class="miss"><td class="line">681</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					if (value) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">682</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						filters[path] = true;</span></td><td class="action"></td></tr><tr><td class="line">683</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">684</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						filters[path] = { $ne: true };</span></td><td class="action"></td></tr><tr><td class="line">685</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">686</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					_.each({address:'street1', suburb:'suburb', state:'state', postcode:'postcode', country:'country'}, function(pathKey, valueKey){</span></td><td class="action"></td></tr><tr class="miss"><td class="line">687</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						var value = filter[valueKey];</span></td><td class="action"></td></tr><tr class="miss"><td class="line">688</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						if ( value ) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">689</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							filters[filter.field.paths[pathKey]] = new RegExp(utils.escapeRegExp(value), 'i');</span></td><td class="action"></td></tr><tr><td class="line">690</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						}</span></td><td class="action"></td></tr><tr><td class="line">691</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					break;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">692</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					if (value) {</span></td><td class="action"></td></tr><tr><td class="line">693</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						if (filter.field.many) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">694</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							filters[path] = (filter.inverse) ? { $nin: [value] } : { $in: [value] };</span></td><td class="action"></td></tr><tr><td class="line">695</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">696</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							filters[path] = (filter.inverse) ? { $ne: value } : value;</span></td><td class="action"></td></tr><tr><td class="line">697</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">698</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							filters[path] = (filter.inverse) ? { $not: { $size: 0 } } : { $size: 0 };</span></td><td class="action"></td></tr><tr><td class="line">699</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">700</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							filters[path] = (filter.inverse) ? { $ne: null } : null;</span></td><td class="action"></td></tr><tr><td class="line">701</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">702</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						filters[path] = (filter.inverse) ? { $ne: value } : value;</span></td><td class="action"></td></tr><tr><td class="line">703</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">704</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						filters[path] = (filter.inverse) ? { $nin: ['', null] } : { $in: ['', null] };</span></td><td class="action"></td></tr><tr><td class="line">705</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">706</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					if (filter.operator === 'bt') {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">707</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						value = [</span></td><td class="action"></td></tr><tr class="miss"><td class="line">708</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							utils.number(value[0]),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">709</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							utils.number(value[1])</span></td><td class="action"></td></tr><tr><td class="line">710</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						];</span></td><td class="action"></td></tr><tr class="miss"><td class="line">711</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						if ( !isNaN(value[0]) &amp;&amp; !isNaN(value[1]) ) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">712</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							filters[path] = {</span></td><td class="action"></td></tr><tr><td class="line">713</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>								$gte: value[0],</span></td><td class="action"></td></tr><tr class="miss"><td class="line">714</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							filters[path] = null;</span></td><td class="action"></td></tr><tr><td class="line">715</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">716</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						value = utils.number(value);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">717</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						if ( !isNaN(value) ) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">718</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							if (filter.operator === 'gt') {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">719</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>								filters[path] = { $gt: value};</span></td><td class="action"></td></tr><tr><td class="line">720</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">721</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							else if (filter.operator === 'lt') {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">722</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>								filters[path] = { $lt: value};</span></td><td class="action"></td></tr><tr><td class="line">723</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">724</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>								filters[path] = value;</span></td><td class="action"></td></tr><tr><td class="line">725</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">726</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							filters[path] = null;</span></td><td class="action"></td></tr><tr><td class="line">727</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">728</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					if (filter.operator === 'bt') {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">729</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						value = [</span></td><td class="action"></td></tr><tr class="miss"><td class="line">730</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							moment(value[0]),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">731</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							moment(value[1])</span></td><td class="action"></td></tr><tr><td class="line">732</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						];</span></td><td class="action"></td></tr><tr class="miss"><td class="line">733</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						if ( (value[0] &amp;&amp; value[0].isValid()) &amp;&amp; (value[1] &amp;&amp; value[0].isValid()) ) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">734</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							filters[path] = {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">735</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>								$gte: moment(value[0]).startOf('day').toDate(),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">736</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>								$lte: moment(value[1]).endOf('day').toDate()</span></td><td class="action"></td></tr><tr><td class="line">737</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							};</span></td><td class="action"></td></tr><tr><td class="line">738</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">739</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						value = moment(value);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">740</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						if (value &amp;&amp; value.isValid()) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">741</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							var start = moment(value).startOf('day').toDate();</span></td><td class="action"></td></tr><tr class="miss"><td class="line">742</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							var end = moment(value).endOf('day').toDate();</span></td><td class="action"></td></tr><tr class="miss"><td class="line">743</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							if (filter.operator === 'gt') {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">744</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>								filters[path] = { $gt: end };</span></td><td class="action"></td></tr><tr class="miss"><td class="line">745</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							} else if (filter.operator === 'lt') {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">746</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>								filters[path] = { $lt: start };</span></td><td class="action"></td></tr><tr><td class="line">747</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">748</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>								filters[path] = { $lte: end, $gte: start };</span></td><td class="action"></td></tr><tr><td class="line">749</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">750</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						if (value) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">751</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							cond = new RegExp('^' + utils.escapeRegExp(value) + '$', 'i');</span></td><td class="action"></td></tr><tr class="miss"><td class="line">752</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							filters[path] = filter.inverse ? { $not: cond } : cond;</span></td><td class="action"></td></tr><tr><td class="line">753</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">754</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>								filters[path] = { $nin: ['', null] };</span></td><td class="action"></td></tr><tr><td class="line">755</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">756</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>								filters[path] = { $in: ['', null] };</span></td><td class="action"></td></tr><tr><td class="line">757</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">758</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					} else if (value) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">759</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						cond = new RegExp(utils.escapeRegExp(value), 'i');</span></td><td class="action"></td></tr><tr class="miss"><td class="line">760</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						filters[path] = filter.inverse ? { $not: cond } : cond;</span></td><td class="action"></td></tr><tr><td class="line">761</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					}</span></td><td class="action"></td></tr><tr><td class="line">762</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">763</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return filters;</span></td><td class="action"></td></tr><tr><td class="line">764</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">765</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">766</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">767</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">768</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Updates every document in a List,</span></td><td class="action"></td></tr><tr><td class="line">769</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * setting the provided data on each.</span></td><td class="action"></td></tr><tr><td class="line">770</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">771</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Object} data</span></td><td class="action"></td></tr><tr><td class="line">772</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Function} callback (optional)</span></td><td class="action"></td></tr><tr><td class="line">773</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">774</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">775</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">776</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">List.prototype.updateAll = function(data, callback) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">777</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if ('function' === typeof data) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">778</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		callback = data;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">779</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		data = null;</span></td><td class="action"></td></tr><tr><td class="line">780</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">781</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	callback = callback || function() {};</span></td><td class="action"></td></tr><tr><td class="line">782</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">783</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.model.find(function(err, results) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">784</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (err) return callback(err);</span></td><td class="action"></td></tr><tr><td class="line">785</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">786</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		async.eachSeries(results, function(doc, next) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">787</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (data) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">788</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				doc.set(data);</span></td><td class="action"></td></tr><tr><td class="line">789</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr><td class="line">790</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">791</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			doc.save(next);</span></td><td class="action"></td></tr><tr><td class="line">792</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">793</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}, function(err) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">794</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			callback(err);</span></td><td class="action"></td></tr><tr><td class="line">795</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		});</span></td><td class="action"></td></tr><tr><td class="line">796</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">797</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">798</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">799</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">800</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">801</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">802</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Gets a unique value from a generator method by checking for documents with the same value.</span></td><td class="action"></td></tr><tr><td class="line">803</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">804</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * To avoid infinite loops when a unique value cannot be found, it will bail and pass back an</span></td><td class="action"></td></tr><tr><td class="line">805</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * undefined value after 10 attemptes.</span></td><td class="action"></td></tr><tr><td class="line">806</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">807</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * WARNING: Because there will always be a small amount of time between checking for an</span></td><td class="action"></td></tr><tr><td class="line">808</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * existing value and saving a document, race conditions can occur and it is possible that</span></td><td class="action"></td></tr><tr><td class="line">809</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * another document has the 'unique' value assigned at the same time.</span></td><td class="action"></td></tr><tr><td class="line">810</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">811</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Because of this, if true uniqueness is required, you should also create a unique index on</span></td><td class="action"></td></tr><tr><td class="line">812</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * the database path, and handle duplicate errors thrown on save.</span></td><td class="action"></td></tr><tr><td class="line">813</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">814</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {String} path to check for uniqueness</span></td><td class="action"></td></tr><tr><td class="line">815</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Function} generator method to call to generate a new value</span></td><td class="action"></td></tr><tr><td class="line">816</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Number} the maximum number of attempts (optional, defaults to 10)</span></td><td class="action"></td></tr><tr><td class="line">817</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Function} callback(err, uniqueValue)</span></td><td class="action"></td></tr><tr><td class="line">818</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">819</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">820</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">821</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">List.prototype.getUniqueValue = function(path, generator, limit, callback) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">822</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var model = this.model,</span></td><td class="action"></td></tr><tr><td class="line">823</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">824</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (utils.isFunction(limit)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">825</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		callback = limit;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">826</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		limit = 10;</span></td><td class="action"></td></tr><tr><td class="line">827</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">828</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (utils.isArray(generator)) {</span></td><td class="action"></td></tr><tr><td class="line">829</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">830</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var fn = generator[0],</span></td><td class="action"></td></tr><tr><td class="line">831</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">832</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		generator = function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">833</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return fn.apply(this, args);</span></td><td class="action"></td></tr><tr><td class="line">834</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		};</span></td><td class="action"></td></tr><tr><td class="line">835</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">836</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">837</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">838</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var check = function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">839</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (count++ &gt; 10) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">840</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return callback(undefined, undefined);</span></td><td class="action"></td></tr><tr><td class="line">841</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">842</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		value = generator();</span></td><td class="action"></td></tr><tr><td class="line">843</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">844</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		model.count().where(path, value).exec(function(err, matches) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">845</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (err) return callback(err);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">846</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (matches) return check();</span></td><td class="action"></td></tr><tr class="miss"><td class="line">847</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			callback(undefined, value);</span></td><td class="action"></td></tr><tr><td class="line">848</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		});</span></td><td class="action"></td></tr><tr><td class="line">849</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">850</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">851</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	check();</span></td><td class="action"></td></tr><tr><td class="line">852</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">853</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">854</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">855</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Generate page array for pagination</span></td><td class="action"></td></tr><tr><td class="line">856</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">857</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Number} the maximum number pages to display in the pagination</span></td><td class="action"></td></tr><tr><td class="line">858</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Object} page options</span></td><td class="action"></td></tr><tr><td class="line">859</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">860</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr class="hit "><td class="line">861</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">List.prototype.getPages = function(options, maxPages) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">862</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var surround = Math.floor(maxPages / 2),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">863</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			firstPage = maxPages ? Math.max(1, options.currentPage - surround) : 1,</span></td><td class="action"></td></tr><tr class="miss"><td class="line">864</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			padRight = Math.max(((options.currentPage - surround) - 1) * -1, 0),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">865</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			lastPage = maxPages ? Math.min(options.totalPages, options.currentPage + surround + padRight) : options.totalPages,</span></td><td class="action"></td></tr><tr class="miss"><td class="line">866</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			padLeft = Math.max(((options.currentPage + surround) - lastPage), 0);</span></td><td class="action"></td></tr><tr><td class="line">867</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">868</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		options.pages = [];</span></td><td class="action"></td></tr><tr><td class="line">869</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">870</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		firstPage = Math.max(Math.min(firstPage, firstPage - padLeft), 1);</span></td><td class="action"></td></tr><tr><td class="line">871</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">872</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		for (var i = firstPage; i &lt;= lastPage; i++) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">873</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			options.pages.push(i);</span></td><td class="action"></td></tr><tr><td class="line">874</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">875</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (firstPage !== 1) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">876</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			options.pages.shift();</span></td><td class="action"></td></tr><tr class="miss"><td class="line">877</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			options.pages.unshift('...');</span></td><td class="action"></td></tr><tr><td class="line">878</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">879</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (lastPage !== Number(options.totalPages)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">880</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			options.pages.pop();</span></td><td class="action"></td></tr><tr class="miss"><td class="line">881</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			options.pages.push('...');</span></td><td class="action"></td></tr><tr><td class="line">882</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">883</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">884</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">885</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Gets a special Query object that will paginate documents in the list</span></td><td class="action"></td></tr><tr><td class="line">886</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">887</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * ####Example:</span></td><td class="action"></td></tr><tr><td class="line">888</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">889</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *     list.paginate({</span></td><td class="action"></td></tr><tr><td class="line">890</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *         page: 1,</span></td><td class="action"></td></tr><tr><td class="line">891</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *         perPage: 100,</span></td><td class="action"></td></tr><tr><td class="line">892</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *         maxPages: 10</span></td><td class="action"></td></tr><tr><td class="line">893</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *     }).exec(function(err, results) {</span></td><td class="action"></td></tr><tr><td class="line">894</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *         // do something</span></td><td class="action"></td></tr><tr><td class="line">895</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *     });</span></td><td class="action"></td></tr><tr><td class="line">896</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">897</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Object} options</span></td><td class="action"></td></tr><tr><td class="line">898</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Function} callback (optional)</span></td><td class="action"></td></tr><tr><td class="line">899</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">900</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">901</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">902</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">List.prototype.paginate = function(options, callback) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">903</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var list = this, model = this.model;</span></td><td class="action"></td></tr><tr><td class="line">904</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">905</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	options = options || {};</span></td><td class="action"></td></tr><tr><td class="line">906</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">907</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var query = model.find(options.filters);</span></td><td class="action"></td></tr><tr><td class="line">908</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">909</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	query._original_exec = query.exec;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">910</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	query._original_sort = query.sort;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">911</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	query._original_select = query.select;</span></td><td class="action"></td></tr><tr><td class="line">912</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">913</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var currentPage = Number(options.page) || 1,</span></td><td class="action"></td></tr><tr class="miss"><td class="line">914</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		resultsPerPage = Number(options.perPage) || 50,</span></td><td class="action"></td></tr><tr class="miss"><td class="line">915</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		maxPages = Number(options.maxPages) || 10,</span></td><td class="action"></td></tr><tr class="miss"><td class="line">916</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		skip = (currentPage - 1) * resultsPerPage;</span></td><td class="action"></td></tr><tr><td class="line">917</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">918</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	list.pagination = { maxPages: maxPages };</span></td><td class="action"></td></tr><tr><td class="line">919</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">920</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// as of mongoose 3.7.x, we need to defer sorting and field selection</span></td><td class="action"></td></tr><tr><td class="line">921</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// until after the count has been executed</span></td><td class="action"></td></tr><tr><td class="line">922</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">923</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	query.select = function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">924</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		options.select = arguments[0];</span></td><td class="action"></td></tr><tr class="miss"><td class="line">925</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return query;</span></td><td class="action"></td></tr><tr><td class="line">926</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">927</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">928</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	query.sort = function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">929</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		options.sort = arguments[0];</span></td><td class="action"></td></tr><tr class="miss"><td class="line">930</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return query;</span></td><td class="action"></td></tr><tr><td class="line">931</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">932</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">933</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	query.exec = function(callback) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">934</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		query.count(function(err, count) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">935</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (err) return callback(err);</span></td><td class="action"></td></tr><tr><td class="line">936</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">937</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			query.find().limit(resultsPerPage).skip(skip);</span></td><td class="action"></td></tr><tr><td class="line">938</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">939</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			// apply the select and sort options before calling exec</span></td><td class="action"></td></tr><tr class="miss"><td class="line">940</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				query._original_select(options.select);</span></td><td class="action"></td></tr><tr><td class="line">941</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">942</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				query._original_sort(options.sort);</span></td><td class="action"></td></tr><tr><td class="line">943</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">944</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			query._original_exec(function(err, results) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">945</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (err) return callback(err);</span></td><td class="action"></td></tr><tr><td class="line">946</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">947</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				var totalPages = Math.ceil(count / resultsPerPage);</span></td><td class="action"></td></tr><tr><td class="line">948</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">949</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				var rtn = {</span></td><td class="action"></td></tr><tr><td class="line">950</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					total: count,</span></td><td class="action"></td></tr><tr class="miss"><td class="line">951</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					previous: (currentPage &gt; 1) ? (currentPage - 1) : false,</span></td><td class="action"></td></tr><tr class="miss"><td class="line">952</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					next: (currentPage &lt; totalPages) ? (currentPage + 1) : false,</span></td><td class="action"></td></tr><tr class="miss"><td class="line">953</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					first: skip + 1,</span></td><td class="action"></td></tr><tr class="miss"><td class="line">954</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					last: skip + results.length</span></td><td class="action"></td></tr><tr><td class="line">955</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				};</span></td><td class="action"></td></tr><tr><td class="line">956</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">957</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				list.getPages(rtn, maxPages);</span></td><td class="action"></td></tr><tr><td class="line">958</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">959</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				callback(err, rtn);</span></td><td class="action"></td></tr><tr><td class="line">960</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">961</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		});</span></td><td class="action"></td></tr><tr><td class="line">962</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">963</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">964</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (callback) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">965</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return query(callback);</span></td><td class="action"></td></tr><tr><td class="line">966</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">967</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return query;</span></td><td class="action"></td></tr><tr><td class="line">968</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">969</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">970</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">971</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">972</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Export class</span></td><td class="action"></td></tr><tr><td class="line">973</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">974</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">975</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports = module.exports = List;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/schemaPlugins.js">lib/schemaPlugins.js</h2><div class="stats low"><div class="percentage">34% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">30% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">24% block coverage</div><div class="sloc">222 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr class="hit "><td class="line">1</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var keystone = require('../'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">2</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	Types = require('./fieldTypes'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">3</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	_ = require('underscore'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">4</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	async = require('async'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">5</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	utils = require('keystone-utils');</span></td><td class="action"></td></tr><tr><td class="line">6</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">7</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var methods = module.exports.methods = {};</span></td><td class="action"></td></tr><tr class="hit "><td class="line">8</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var options = module.exports.options = {};</span></td><td class="action"></td></tr><tr><td class="line">9</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">10</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.sortable = function() {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">11</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var list = this;</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">13</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.schema.add({</span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">15</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.schema.pre('save', function(next) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">16</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (typeof this.sortOrder === 'number') {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">17</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return next();</span></td><td class="action"></td></tr><tr><td class="line">18</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">19</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">20</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var item = this;</span></td><td class="action"></td></tr><tr><td class="line">21</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">22</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		list.model.findOne().sort('-sortOrder').exec(function(err, max) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			item.sortOrder = (max &amp;&amp; max.sortOrder) ? max.sortOrder + 1 : 0;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">24</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			next();</span></td><td class="action"></td></tr><tr><td class="line">25</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		});</span></td><td class="action"></td></tr><tr><td class="line">26</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">28</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">29</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.autokey = function() {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">30</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var autokey = this.autokey = this.get('autokey'),</span></td><td class="action"></td></tr><tr><td class="line">31</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!autokey.from) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">33</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var fromMsg = 'Invalid List Option (autokey) for ' + list.key + ' (from is required)\n';</span></td><td class="action"></td></tr><tr class="miss"><td class="line">34</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error(fromMsg);</span></td><td class="action"></td></tr><tr><td class="line">35</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!autokey.path) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var pathMsg = 'Invalid List Option (autokey) for ' + list.key + ' (path is required)\n';</span></td><td class="action"></td></tr><tr class="miss"><td class="line">38</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error(pathMsg);</span></td><td class="action"></td></tr><tr><td class="line">39</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">40</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if ('string' === typeof autokey.from) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		autokey.from = autokey.from.split(' ');</span></td><td class="action"></td></tr><tr><td class="line">42</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">43</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	autokey.from = autokey.from.map(function(i) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">44</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		i = i.split(':');</span></td><td class="action"></td></tr><tr class="miss"><td class="line">45</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return { path: i[0], format: i[1] };</span></td><td class="action"></td></tr><tr><td class="line">46</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">47</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">48</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	def[autokey.path] = {</span></td><td class="action"></td></tr><tr><td class="line">49</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">50</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		def[autokey.path].index = { unique: true };</span></td><td class="action"></td></tr><tr><td class="line">51</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">52</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.schema.add(def);</span></td><td class="action"></td></tr><tr><td class="line">53</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">54</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var getUniqueKey = function(doc, src, callback) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">55</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var q = list.model.find().where(autokey.path, src);</span></td><td class="action"></td></tr><tr><td class="line">56</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">57</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (_.isObject(autokey.unique)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">58</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			_.each(autokey.unique, function(k, v) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">59</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (_.isString(v) &amp;&amp; v.charAt(0) === ':') {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">60</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					q.where(k, doc.get(v.substr(1)));</span></td><td class="action"></td></tr><tr><td class="line">61</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">62</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					q.where(k, v);</span></td><td class="action"></td></tr><tr><td class="line">63</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr><td class="line">64</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			});</span></td><td class="action"></td></tr><tr class="miss"><td class="line">65</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		q.exec(function(err, results) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">66</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (err) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">67</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				callback(err);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">68</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			} else if (results.length &amp;&amp; (results.length &gt; 1 || results[0].id != doc.id)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">69</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				var inc = src.match(/^(.+)\-(\d+)$/);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">70</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (inc &amp;&amp; inc.length === 3) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">71</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					src = inc[1];</span></td><td class="action"></td></tr><tr class="miss"><td class="line">72</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					inc = '-' + ((inc[2] * 1) + 1);</span></td><td class="action"></td></tr><tr><td class="line">73</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">74</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					inc = '-1';</span></td><td class="action"></td></tr><tr><td class="line">75</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">76</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				return getUniqueKey(doc, src + inc, callback);</span></td><td class="action"></td></tr><tr><td class="line">77</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">78</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				doc.set(autokey.path, src);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">79</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				return callback();</span></td><td class="action"></td></tr><tr><td class="line">80</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr><td class="line">81</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		});</span></td><td class="action"></td></tr><tr><td class="line">82</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">83</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">84</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.schema.pre('save', function(next) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">85</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var modified = false,</span></td><td class="action"></td></tr><tr><td class="line">86</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">87</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		autokey.from.forEach(function(ops) {</span></td><td class="action"></td></tr><tr><td class="line">88</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (list.fields[ops.path]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">89</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				values.push(list.fields[ops.path].format(this, ops.format));</span></td><td class="action"></td></tr><tr class="miss"><td class="line">90</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (list.fields[ops.path].isModified(this)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">91</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					modified = true;</span></td><td class="action"></td></tr><tr><td class="line">92</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr><td class="line">93</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">94</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				values.push(this.get(ops.path));</span></td><td class="action"></td></tr><tr><td class="line">95</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				// virtual paths are always assumed to have changed, except 'id'</span></td><td class="action"></td></tr><tr class="miss"><td class="line">96</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (ops.path !== 'id' &amp;&amp; list.schema.pathType(ops.path) === 'virtual' || this.isModified(ops.path)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">97</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					modified = true;</span></td><td class="action"></td></tr><tr><td class="line">98</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr><td class="line">99</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr><td class="line">100</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">101</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		// if has a value and is unmodified or fixed, don't update it</span></td><td class="action"></td></tr><tr class="miss"><td class="line">102</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if ((!modified || autokey.fixed) &amp;&amp; this.get(autokey.path)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">103</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return next();</span></td><td class="action"></td></tr><tr><td class="line">104</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">105</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var newKey = utils.slug(values.join(' ') || this.id);</span></td><td class="action"></td></tr><tr><td class="line">106</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">107</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (autokey.unique) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">108</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return getUniqueKey(this, newKey, next);</span></td><td class="action"></td></tr><tr><td class="line">109</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">110</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			this.set(autokey.path, newKey);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">111</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return next();</span></td><td class="action"></td></tr><tr><td class="line">112</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">113</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">114</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">115</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">116</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * List track option</span></td><td class="action"></td></tr><tr><td class="line">117</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">118</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * When enabled, it tracks when a document are created/updated, </span></td><td class="action"></td></tr><tr><td class="line">119</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * as well as the user who created/updated it.</span></td><td class="action"></td></tr><tr><td class="line">120</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr class="hit "><td class="line">121</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.track = function() {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">122</td><td class="hits">12</td><td class="statements">100%</td><td class="source"><span class="statement ">	var list = this,</span></td><td class="action"></td></tr><tr class="hit "><td class="line">123</td><td class="hits">12</td><td class="statements">100%</td><td class="source"><span class="statement ">		options = list.get('track'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">124</td><td class="hits">12</td><td class="statements">100%</td><td class="source"><span class="statement ">		userModel = keystone.get('user model'),</span></td><td class="action"></td></tr><tr><td class="line">125</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		defaultOptions = { </span></td><td class="action"></td></tr><tr><td class="line">126</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">127</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// ensure track is a boolean or an object</span></td><td class="action"></td></tr><tr class="hit "><td class="line">128</td><td class="hits">12</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (!_.isBoolean(options) &amp;&amp; !_.isObject(options) ) {</span></td><td class="action"></td></tr><tr><td class="line">129</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('Invalid List &quot;track&quot; option for ' + list.key + '\n' +</span></td><td class="action"></td></tr><tr class="hit "><td class="line">130</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">			'&quot;track&quot; must be a boolean or an object.\n\n' +</span></td><td class="action"></td></tr><tr class="hit "><td class="line">131</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">			'See http://keystonejs.com/docs/database/#lists-options for more information.');				</span></td><td class="action"></td></tr><tr><td class="line">132</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">133</td><td class="hits">11</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (_.isBoolean(options)) {</span></td><td class="action"></td></tr><tr><td class="line">134</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		// if { track: true } set all track fields to true</span></td><td class="action"></td></tr><tr class="hit "><td class="line">135</td><td class="hits">4</td><td class="statements">100%</td><td class="source"><span class="statement ">		if (options) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">136</td><td class="hits">4</td><td class="statements">100%</td><td class="source"><span class="statement ">			options = { 
				createdAt: true, 
				createdBy: true,
				updatedAt: true,
				updatedBy: true
			};</span></td><td class="action"></td></tr><tr><td class="line">137</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				createdAt: true, </span></td><td class="action"></td></tr><tr class="miss"><td class="line">138</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return;</span></td><td class="action"></td></tr><tr><td class="line">139</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">140</td><td class="hits">11</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (!options.createdAt &amp;&amp; !options.createdBy &amp;&amp; !options.updatedAt &amp;&amp; !options.updatedBy) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">141</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">		return;</span></td><td class="action"></td></tr><tr><td class="line">142</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">143</td><td class="hits">10</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (list.get('track simulate standard meta')) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">144</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		if (!options.createdAt) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">145</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			options.createdAt = true;</span></td><td class="action"></td></tr><tr><td class="line">146</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">147</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		if (!options.updatedAt) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">148</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			options.updatedAt = true;</span></td><td class="action"></td></tr><tr><td class="line">149</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">150</td><td class="hits">10</td><td class="statements">100%</td><td class="source"><span class="statement ">	options = _.extend({}, defaultOptions, options);</span></td><td class="action"></td></tr><tr><td class="line">151</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">152</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// validate option fields</span></td><td class="action"></td></tr><tr class="hit "><td class="line">153</td><td class="hits">10</td><td class="statements">100%</td><td class="source"><span class="statement ">	_.each(options, function(value, key) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">154</td><td class="hits">39</td><td class="statements">100%</td><td class="source"><span class="statement ">		var fieldName;</span></td><td class="action"></td></tr><tr><td class="line">155</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">156</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		// make sure it's a valid track option field</span></td><td class="action"></td></tr><tr class="hit "><td class="line">157</td><td class="hits">39</td><td class="statements">100%</td><td class="source"><span class="statement ">		if (_.has(defaultOptions, key)) {</span></td><td class="action"></td></tr><tr><td class="line">158</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			// make sure the option field value is either a boolean or a string</span></td><td class="action"></td></tr><tr class="hit "><td class="line">159</td><td class="hits">38</td><td class="statements">100%</td><td class="source"><span class="statement ">			if (!_.isBoolean(value) &amp;&amp; !_.isString(value)) {</span></td><td class="action"></td></tr><tr><td class="line">160</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				throw new Error('Invalid List &quot;track&quot; option for ' + list.key + '\n' +</span></td><td class="action"></td></tr><tr class="hit "><td class="line">161</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">					'&quot;' + key + '&quot; must be a boolean or a string.\n\n' +</span></td><td class="action"></td></tr><tr class="hit "><td class="line">162</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">					'See http://keystonejs.com/docs/database/#lists-options for more information.');				</span></td><td class="action"></td></tr><tr><td class="line">163</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">164</td><td class="hits">37</td><td class="statements">100%</td><td class="source"><span class="statement ">			if (value) {</span></td><td class="action"></td></tr><tr><td class="line">165</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				// determine </span></td><td class="action"></td></tr><tr class="hit "><td class="line">166</td><td class="hits">29</td><td class="statements">100%</td><td class="source"><span class="statement ">				fieldName = value === true ? key : value;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">167</td><td class="hits">29</td><td class="statements">100%</td><td class="source"><span class="statement ">				options[key] = fieldName;</span></td><td class="action"></td></tr><tr><td class="line">168</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">169</td><td class="hits">29</td><td class="statements">100%</td><td class="source"><span class="statement ">				switch(key) {</span></td><td class="action"></td></tr><tr><td class="line">170</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					case 'createdAt':</span></td><td class="action"></td></tr><tr class="hit "><td class="line">171</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">						fields[fieldName] = { type: Date, hidden: true, index: true };</span></td><td class="action"></td></tr><tr><td class="line">172</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					break;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">173</td><td class="hits">14</td><td class="statements">100%</td><td class="source"><span class="statement ">						fields[fieldName] = { type: Types.Relationship, ref: userModel, hidden: true, index: true };</span></td><td class="action"></td></tr><tr><td class="line">174</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					break;</span></td><td class="action"></td></tr><tr><td class="line">175</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			throw new Error('Invalid List &quot;track&quot; option for ' + list.key + '\n' +</span></td><td class="action"></td></tr><tr class="hit "><td class="line">176</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">				'valid field options are &quot;createdAt&quot;, &quot;createdBy&quot;, &quot;updatedAt&quot;, an &quot;updatedBy&quot;.\n\n' +</span></td><td class="action"></td></tr><tr class="hit "><td class="line">177</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">				'See http://keystonejs.com/docs/database/#lists-options for more information.');				</span></td><td class="action"></td></tr><tr><td class="line">178</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">179</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">180</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// simulate standard meta by mapping to existing createdAt/updatedAt fields</span></td><td class="action"></td></tr><tr class="hit "><td class="line">181</td><td class="hits">8</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (list.get('track simulate standard meta')) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">182</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		list.map('createdOn', options.createdAt);</span></td><td class="action"></td></tr><tr class="hit "><td class="line">183</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		list.schema.virtual('createdOn')
			.get(function () {</span></td><td class="action"></td></tr><tr><td class="line">184</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			.get(function () {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">185</td><td class="hits">4</td><td class="statements">100%</td><td class="source"><span class="statement ">				return this.get('createdAt');</span></td><td class="action"></td></tr><tr><td class="line">186</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			});</span></td><td class="action"></td></tr><tr class="hit "><td class="line">187</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		list.map('updatedOn', options.updatedAt);</span></td><td class="action"></td></tr><tr class="hit "><td class="line">188</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		list.schema.virtual('updatedOn')
			.get(function () {</span></td><td class="action"></td></tr><tr><td class="line">189</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			.get(function () {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">190</td><td class="hits">4</td><td class="statements">100%</td><td class="source"><span class="statement ">				return this.get('updatedAt');</span></td><td class="action"></td></tr><tr><td class="line">191</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			});</span></td><td class="action"></td></tr><tr class="hit "><td class="line">192</td><td class="hits">8</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (_.isEmpty(fields)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">193</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return;</span></td><td class="action"></td></tr><tr><td class="line">194</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">195</td><td class="hits">8</td><td class="statements">100%</td><td class="source"><span class="statement ">	list.add(fields);</span></td><td class="action"></td></tr><tr><td class="line">196</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">197</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// add the pre-save schema plugin</span></td><td class="action"></td></tr><tr class="hit "><td class="line">198</td><td class="hits">8</td><td class="statements">100%</td><td class="source"><span class="statement ">	list.schema.pre('save', function (next) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">199</td><td class="hits">16</td><td class="statements">100%</td><td class="source"><span class="statement ">		var now = new Date();</span></td><td class="action"></td></tr><tr><td class="line">200</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">201</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		// set createdAt/createdBy on new docs</span></td><td class="action"></td></tr><tr class="hit "><td class="line">202</td><td class="hits">6</td><td class="statements">100%</td><td class="source"><span class="statement ">				this.set(options.createdAt, now);</span></td><td class="action"></td></tr><tr><td class="line">203</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">204</td><td class="hits">8</td><td class="statements">100%</td><td class="source"><span class="statement ">			if (options.createdBy &amp;&amp; this._req_user) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">205</td><td class="hits">6</td><td class="statements">100%</td><td class="source"><span class="statement ">				this.set(options.createdBy, this._req_user._id);</span></td><td class="action"></td></tr><tr><td class="line">206</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">207</td><td class="hits">16</td><td class="statements">100%</td><td class="source"><span class="statement ">		if (this.isNew || this.isModified()) {</span></td><td class="action"></td></tr><tr><td class="line">208</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (options.updatedAt) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">209</td><td class="hits">16</td><td class="statements">100%</td><td class="source"><span class="statement ">				this.set(options.updatedAt, now);</span></td><td class="action"></td></tr><tr><td class="line">210</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">211</td><td class="hits">16</td><td class="statements">100%</td><td class="source"><span class="statement ">			if (options.updatedBy &amp;&amp; this._req_user) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">212</td><td class="hits">16</td><td class="statements">100%</td><td class="source"><span class="statement ">				this.set(options.updatedBy, this._req_user._id);</span></td><td class="action"></td></tr><tr><td class="line">213</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">214</td><td class="hits">16</td><td class="statements">100%</td><td class="source"><span class="statement ">		next();</span></td><td class="action"></td></tr><tr><td class="line">215</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">216</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">217</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">218</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">methods.getRelated = function(paths, callback, nocollapse) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">219</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var item = this,</span></td><td class="action"></td></tr><tr><td class="line">220</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">221</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if ('function' !== typeof callback) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">222</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('List.getRelated(paths, callback, nocollapse) requires a callback function.');</span></td><td class="action"></td></tr><tr><td class="line">223</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">224</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if ('string' === typeof paths) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">225</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var pathsArr = paths.split(' ');</span></td><td class="action"></td></tr><tr class="miss"><td class="line">226</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var lastPath = '';</span></td><td class="action"></td></tr><tr class="miss"><td class="line">227</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		paths = [];</span></td><td class="action"></td></tr><tr class="miss"><td class="line">228</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		for (var i = 0; i &lt; pathsArr.length; i++) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">229</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			lastPath += (lastPath.length ? ' ' : '') + pathsArr[i];</span></td><td class="action"></td></tr><tr class="miss"><td class="line">230</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (lastPath.indexOf('[') &lt; 0 || lastPath.charAt(lastPath.length - 1) === ']') {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">231</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				paths.push(lastPath);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">232</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				lastPath = '';</span></td><td class="action"></td></tr><tr><td class="line">233</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">234</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	_.each(paths, function(options) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">235</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var populateString = '';</span></td><td class="action"></td></tr><tr><td class="line">236</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">237</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if ('string' === typeof options) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">238</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (options.indexOf('[') &gt; 0) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">239</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				populateString = options.substring(options.indexOf('[') + 1, options.indexOf(']'));</span></td><td class="action"></td></tr><tr class="miss"><td class="line">240</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				options = options.substr(0,options.indexOf('['));</span></td><td class="action"></td></tr><tr><td class="line">241</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">242</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			options = { path: options };</span></td><td class="action"></td></tr><tr><td class="line">243</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">244</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		options.populate = options.populate || [];</span></td><td class="action"></td></tr><tr class="miss"><td class="line">245</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		options.related = options.related || [];</span></td><td class="action"></td></tr><tr><td class="line">246</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">247</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var relationship = list.relationships[options.path];</span></td><td class="action"></td></tr><tr class="miss"><td class="line">248</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (!relationship) throw new Error('List.getRelated: list ' + list.key + ' does not have a relationship ' + options.path + '.');</span></td><td class="action"></td></tr><tr><td class="line">249</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">250</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var refList = keystone.list(relationship.ref);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">251</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (!refList) throw new Error('List.getRelated: list ' + relationship.ref + ' does not exist.');</span></td><td class="action"></td></tr><tr><td class="line">252</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">253</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var relField = refList.fields[relationship.refPath];</span></td><td class="action"></td></tr><tr class="miss"><td class="line">254</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (!relField || relField.type !== 'relationship') throw new Error('List.getRelated: relationship ' + relationship.ref + ' on list ' + list.key + ' refers to a path (' + relationship.refPath + ') which is not a relationship field.');</span></td><td class="action"></td></tr><tr><td class="line">255</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">256</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (populateString.length) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">257</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			_.each(populateString.split(' '), function(key) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">258</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					options.related.push(key);</span></td><td class="action"></td></tr><tr><td class="line">259</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				else</span></td><td class="action"></td></tr><tr class="miss"><td class="line">260</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					options.populate.push(key);</span></td><td class="action"></td></tr><tr><td class="line">261</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			});</span></td><td class="action"></td></tr><tr><td class="line">262</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">263</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">264</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">265</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		queue[relationship.path] = function(done) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">266</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var query = refList.model.find().where(relField.path);</span></td><td class="action"></td></tr><tr><td class="line">267</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">268</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (options.populate)</span></td><td class="action"></td></tr><tr class="miss"><td class="line">269</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				query.populate(options.populate);</span></td><td class="action"></td></tr><tr><td class="line">270</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">271</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (relField.many) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">272</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				query.in([item.id]);</span></td><td class="action"></td></tr><tr><td class="line">273</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">274</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				query.equals(item.id);</span></td><td class="action"></td></tr><tr><td class="line">275</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">276</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			query.sort(options.sort || relationship.sort || refList.defaultSort);</span></td><td class="action"></td></tr><tr><td class="line">277</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">278</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (options.related.length) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">279</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				query.exec(function(err, results) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">280</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					if (err || !results.length) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">281</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						return done(err, results);</span></td><td class="action"></td></tr><tr><td class="line">282</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">283</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					async.parallel(results.map(function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">284</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							return function(done) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">285</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>								item.populateRelated(options.related, done);</span></td><td class="action"></td></tr><tr><td class="line">286</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							};</span></td><td class="action"></td></tr><tr><td class="line">287</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						}),</span></td><td class="action"></td></tr><tr><td class="line">288</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						function(err) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">289</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							done(err, results);</span></td><td class="action"></td></tr><tr><td class="line">290</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						}</span></td><td class="action"></td></tr><tr><td class="line">291</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					);</span></td><td class="action"></td></tr><tr><td class="line">292</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				});</span></td><td class="action"></td></tr><tr><td class="line">293</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">294</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				query.exec(done);</span></td><td class="action"></td></tr><tr><td class="line">295</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr><td class="line">296</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">297</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (!item._populatedRelationships) item._populatedRelationships = {};</span></td><td class="action"></td></tr><tr class="miss"><td class="line">298</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		item._populatedRelationships[relationship.path] = true;</span></td><td class="action"></td></tr><tr><td class="line">299</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">300</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">301</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	async.parallel(queue, function(err, results) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">302</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (!nocollapse &amp;&amp; results &amp;&amp; paths.length === 1) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">303</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			results = results[paths[0]];</span></td><td class="action"></td></tr><tr><td class="line">304</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">305</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		callback(err, results);</span></td><td class="action"></td></tr><tr><td class="line">306</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">307</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">308</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">309</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">methods.populateRelated = function(rel, callback) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">310</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var item = this;</span></td><td class="action"></td></tr><tr><td class="line">311</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">312</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if ('function' !== typeof callback) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">313</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('List.populateRelated(rel, callback) requires a callback function.');</span></td><td class="action"></td></tr><tr><td class="line">314</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">315</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.getRelated(rel, function(err, results) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">316</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		_.each(results, function(data, key) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">317</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			item[key] = data;</span></td><td class="action"></td></tr><tr><td class="line">318</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		});</span></td><td class="action"></td></tr><tr class="miss"><td class="line">319</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		callback(err, results);</span></td><td class="action"></td></tr><tr><td class="line">320</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}, true);</span></td><td class="action"></td></tr><tr><td class="line">321</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">322</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">323</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">options.transform = function(doc, ret) {
	if (doc._populatedRelationships) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">324</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		_.each(doc._populatedRelationships, function(on, key) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">325</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (!on) return;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">326</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			ret[key] = doc[key];</span></td><td class="action"></td></tr><tr><td class="line">327</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		});</span></td><td class="action"></td></tr><tr><td class="line">328</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/fieldTypes/index.js">lib/fieldTypes/index.js</h2><div class="stats high"><div class="percentage">100% line coverage</div><div class="statements">100% statement coverage</div><div class="blocks">0% block coverage</div><div class="sloc">26 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr class="hit "><td class="line">1</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.AzureFile = require('./azurefile');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">2</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.Boolean = require('./boolean');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">3</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.CloudinaryImage = require('./cloudinaryimage');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">4</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.CloudinaryImages = require('./cloudinaryimages');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">5</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.Code = require('./code');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">6</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.Color = require('./color');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">7</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.Date = require('./date');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">8</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.Datetime = require('./datetime');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">9</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.Email = require('./email');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">10</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.Embedly = require('./embedly');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">11</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.Html = require('./html');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">12</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.Key = require('./key');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">13</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.LocalFile = require('./localfile');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">14</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.Location = require('./location');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">15</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.Markdown = require('./markdown');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">16</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.Money = require('./money');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">17</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.Name = require('./name');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">18</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.Number = require('./number');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">19</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.Password = require('./password');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">20</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.Relationship = require('./relationship');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">21</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.S3File = require('./s3file');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">22</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.Select = require('./select');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">23</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.Text = require('./text');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">24</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.Textarea = require('./textarea');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">25</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.Url = require('./url');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">26</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.LocalFiles = require('./localfiles');</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/fieldTypes/azurefile.js">lib/fieldTypes/azurefile.js</h2><div class="stats terrible"><div class="percentage">20% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">13% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">0% block coverage</div><div class="sloc">149 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Module dependencies.</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">5</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var _ = require('underscore'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">6</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	moment = require('moment'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">7</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	keystone = require('../../'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">8</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	async = require('async'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">9</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	util = require('util'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">10</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	azure = require('azure'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">11</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	utils = require('keystone-utils'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">12</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	super_ = require('../field');</span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">16</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * AzureFile FieldType Constructor</span></td><td class="action"></td></tr><tr><td class="line">17</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @extends Field</span></td><td class="action"></td></tr><tr><td class="line">18</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">19</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">20</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">21</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function azurefile(list, path, options) {</span></td><td class="action"></td></tr><tr><td class="line">22</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._underscoreMethods = ['format', 'uploadFile'];</span></td><td class="action"></td></tr><tr><td class="line">24</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">25</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// event queues</span></td><td class="action"></td></tr><tr class="miss"><td class="line">26</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._pre = {</span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">28</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// TODO: implement filtering, usage disabled for now</span></td><td class="action"></td></tr><tr class="miss"><td class="line">29</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	options.nofilter = true;</span></td><td class="action"></td></tr><tr><td class="line">30</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">31</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// TODO: implement initial form, usage disabled for now</span></td><td class="action"></td></tr><tr><td class="line">32</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (options.initial) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">33</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('Invalid Configuration\n\nAzureFile fields (' + list.key + '.' + path + ') do not currently support being used as initial fields.\n');</span></td><td class="action"></td></tr><tr><td class="line">34</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">35</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	azurefile.super_.call(this, list, path, options);</span></td><td class="action"></td></tr><tr><td class="line">37</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">38</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// validate azurefile config (has to happen after super_.call)</span></td><td class="action"></td></tr><tr class="miss"><td class="line">39</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!this.azurefileconfig) {</span></td><td class="action"></td></tr><tr><td class="line">40</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('Invalid Configuration\n\n' +</span></td><td class="action"></td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			'AzureFile fields (' + list.key + '.' + path + ') require the &quot;azurefile config&quot; option to be set.\n\n' +</span></td><td class="action"></td></tr><tr class="miss"><td class="line">42</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			'See http://keystonejs.com/docs/configuration#services-azure for more information.\n');</span></td><td class="action"></td></tr><tr><td class="line">43</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">44</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">45</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	process.env.AZURE_STORAGE_ACCOUNT = this.azurefileconfig.account;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">46</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	process.env.AZURE_STORAGE_ACCESS_KEY = this.azurefileconfig.key;</span></td><td class="action"></td></tr><tr><td class="line">47</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">48</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.azurefileconfig.container = this.azurefileconfig.container || 'keystone';</span></td><td class="action"></td></tr><tr><td class="line">49</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">50</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var self = this;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">51</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	options.filenameFormatter = options.filenameFormatter || function(item, filename) { return filename; };</span></td><td class="action"></td></tr><tr class="miss"><td class="line">52</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	options.containerFormatter = options.containerFormatter || function(item, filename) { return self.azurefileconfig.container; };</span></td><td class="action"></td></tr><tr><td class="line">53</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">54</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Could be more pre- hooks, just upload for now</span></td><td class="action"></td></tr><tr class="miss"><td class="line">55</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (options.pre &amp;&amp; options.pre.upload) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">56</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		this._pre.upload = this._pre.upload.concat(options.pre.upload);</span></td><td class="action"></td></tr><tr><td class="line">57</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">58</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">59</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">60</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">61</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">62</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Inherit from Field</span></td><td class="action"></td></tr><tr><td class="line">63</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">64</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">65</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">util.inherits(azurefile, super_);</span></td><td class="action"></td></tr><tr><td class="line">66</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">67</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">68</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Exposes the custom or keystone s3 config settings</span></td><td class="action"></td></tr><tr><td class="line">69</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">70</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">71</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Object.defineProperty(azurefile.prototype, 'azurefileconfig', { get: function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">72</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return this.options.azurefileconfig || keystone.get('azurefile config');</span></td><td class="action"></td></tr><tr><td class="line">73</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}});</span></td><td class="action"></td></tr><tr><td class="line">74</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">75</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">76</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">77</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Allows you to add pre middleware after the field has been initialised</span></td><td class="action"></td></tr><tr><td class="line">78</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">79</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">80</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">81</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">82</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">azurefile.prototype.pre = function(event, fn) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">83</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!this._pre[event]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">84</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('AzureFile (' + this.list.key + '.' + this.path + ') error: azurefile.pre()\n\n' +</span></td><td class="action"></td></tr><tr><td class="line">85</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">86</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._pre[event].push(fn);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">87</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return this;</span></td><td class="action"></td></tr><tr><td class="line">88</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">89</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">90</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">91</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">92</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Registers the field on the List's Mongoose Schema.</span></td><td class="action"></td></tr><tr><td class="line">93</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">94</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">95</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">96</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">97</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">azurefile.prototype.addToSchema = function() {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">98</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var field = this,</span></td><td class="action"></td></tr><tr><td class="line">99</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">100</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var paths = this.paths = {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">101</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		filename:		this._path.append('.filename'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">102</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		path:			this._path.append('.path'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">103</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		size:			this._path.append('.size'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">104</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		filetype:		this._path.append('.filetype'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">105</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		url:			this._path.append('.url'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">106</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		etag:			this._path.append('.etag'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">107</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		container:		this._path.append('.container'),</span></td><td class="action"></td></tr><tr><td class="line">108</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		// virtuals</span></td><td class="action"></td></tr><tr class="miss"><td class="line">109</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		exists:			this._path.append('.exists'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">110</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		upload:			this._path.append('_upload'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">111</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		action:			this._path.append('_action')</span></td><td class="action"></td></tr><tr><td class="line">112</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">113</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">114</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var schemaPaths = this._path.addTo({}, {</span></td><td class="action"></td></tr><tr><td class="line">115</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">116</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	schema.add(schemaPaths);</span></td><td class="action"></td></tr><tr><td class="line">117</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">118</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var exists = function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">119</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return (item.get(paths.url) ? true : false);</span></td><td class="action"></td></tr><tr><td class="line">120</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">121</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">122</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// The .exists virtual indicates whether a file is stored</span></td><td class="action"></td></tr><tr class="miss"><td class="line">123</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	schema.virtual(paths.exists).get(function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">124</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return schemaMethods.exists.apply(this);</span></td><td class="action"></td></tr><tr><td class="line">125</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">126</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">127</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var reset = function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">128</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		item.set(field.path, {</span></td><td class="action"></td></tr><tr><td class="line">129</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">130</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">131</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var schemaMethods = {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">132</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return exists(this);</span></td><td class="action"></td></tr><tr><td class="line">133</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		},</span></td><td class="action"></td></tr><tr class="miss"><td class="line">134</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var self = this;</span></td><td class="action"></td></tr><tr><td class="line">135</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">136</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			try {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">137</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				azure.createBlobService().deleteBlob(this.get(paths.container), this.get(paths.filename), function(error) {});</span></td><td class="action"></td></tr><tr><td class="line">138</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			} catch(e) {}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">139</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			reset(self);</span></td><td class="action"></td></tr><tr><td class="line">140</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		},</span></td><td class="action"></td></tr><tr class="miss"><td class="line">141</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var self = this;</span></td><td class="action"></td></tr><tr><td class="line">142</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			try {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">143</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				azure.createBlobService().blobService.deleteBlob(this.get(paths.container), this.get(paths.filename), function(error) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">144</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					if(!error){}</span></td><td class="action"></td></tr><tr><td class="line">145</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				});</span></td><td class="action"></td></tr><tr><td class="line">146</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			} catch(e) {}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">147</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			reset(self);</span></td><td class="action"></td></tr><tr><td class="line">148</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">149</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">150</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	_.each(schemaMethods, function(fn, key) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">151</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		field.underscoreMethod(key, fn);</span></td><td class="action"></td></tr><tr><td class="line">152</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">153</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">154</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// expose a method on the field to call schema methods</span></td><td class="action"></td></tr><tr class="miss"><td class="line">155</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.apply = function(item, method) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">156</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return schemaMethods[method].apply(item, Array.prototype.slice.call(arguments, 2));</span></td><td class="action"></td></tr><tr><td class="line">157</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">158</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">159</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.bindUnderscoreMethods();</span></td><td class="action"></td></tr><tr><td class="line">160</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">161</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">162</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">163</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">164</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Formats the field value</span></td><td class="action"></td></tr><tr><td class="line">165</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">166</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">167</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">168</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">169</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">azurefile.prototype.format = function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">170</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return item.get(this.paths.url);</span></td><td class="action"></td></tr><tr><td class="line">171</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">172</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">173</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">174</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">175</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Detects whether the field has been modified</span></td><td class="action"></td></tr><tr><td class="line">176</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">177</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">178</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">179</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">180</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">azurefile.prototype.isModified = function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">181</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return item.isModified(this.paths.url);</span></td><td class="action"></td></tr><tr><td class="line">182</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">183</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">184</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">185</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">186</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Validates that a value for this field has been provided in a data object</span></td><td class="action"></td></tr><tr><td class="line">187</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">188</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">189</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">190</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">191</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">azurefile.prototype.validateInput = function(data) {
	// TODO - how should file field input be validated?</span></td><td class="action"></td></tr><tr class="miss"><td class="line">192</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return true;</span></td><td class="action"></td></tr><tr><td class="line">193</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">194</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">195</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">196</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">197</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Updates the value for this field in the item from a data object</span></td><td class="action"></td></tr><tr><td class="line">198</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">199</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">200</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">201</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">202</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">azurefile.prototype.updateItem = function(item, data) {
	// TODO - direct updating of data (not via upload)
};</span></td><td class="action"></td></tr><tr><td class="line">203</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">204</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">205</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">206</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Uploads the file for this field</span></td><td class="action"></td></tr><tr><td class="line">207</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">208</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">209</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">210</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">211</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">azurefile.prototype.uploadFile = function(item, file, update, callback) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">212</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var field = this,</span></td><td class="action"></td></tr><tr class="miss"><td class="line">213</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		prefix = field.options.datePrefix ? moment().format(field.options.datePrefix) + '-' : '',</span></td><td class="action"></td></tr><tr class="miss"><td class="line">214</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		name = prefix + file.name;</span></td><td class="action"></td></tr><tr><td class="line">215</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">216</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (field.options.allowedTypes &amp;&amp; !_.contains(field.options.allowedTypes, file.type)){</span></td><td class="action"></td></tr><tr class="miss"><td class="line">217</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return callback(new Error('Unsupported File Type: '+file.type));</span></td><td class="action"></td></tr><tr><td class="line">218</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">219</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if ('function' == typeof update) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">220</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		callback = update;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">221</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		update = false;</span></td><td class="action"></td></tr><tr><td class="line">222</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">223</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var doUpload = function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">224</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var blobService = azure.createBlobService();</span></td><td class="action"></td></tr><tr class="miss"><td class="line">225</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var container = field.options.containerFormatter(item, file.name);</span></td><td class="action"></td></tr><tr><td class="line">226</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">227</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		blobService.createContainerIfNotExists(container, {publicAccessLevel : 'blob'}, function(error){</span></td><td class="action"></td></tr><tr class="miss"><td class="line">228</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if(error){</span></td><td class="action"></td></tr><tr class="miss"><td class="line">229</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				return callback(error);</span></td><td class="action"></td></tr><tr><td class="line">230</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr><td class="line">231</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">232</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			blobService.createBlockBlobFromFile(container, field.options.filenameFormatter(item, file.name), file.path, function(error, blob, res){</span></td><td class="action"></td></tr><tr class="miss"><td class="line">233</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if(error){</span></td><td class="action"></td></tr><tr class="miss"><td class="line">234</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					return callback(error);</span></td><td class="action"></td></tr><tr><td class="line">235</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">236</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					var fileData = {</span></td><td class="action"></td></tr><tr><td class="line">237</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						filename: blob.blob,</span></td><td class="action"></td></tr><tr class="miss"><td class="line">238</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						url: 'http://' + field.azurefileconfig.account + '.blob.core.windows.net/' + container + '/' + blob.blob</span></td><td class="action"></td></tr><tr><td class="line">239</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					};</span></td><td class="action"></td></tr><tr><td class="line">240</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">241</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					if (update) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">242</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						item.set(field.path, fileData);</span></td><td class="action"></td></tr><tr><td class="line">243</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">244</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					callback(null, fileData);</span></td><td class="action"></td></tr><tr><td class="line">245</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr><td class="line">246</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		});</span></td><td class="action"></td></tr><tr><td class="line">247</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">248</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">249</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	async.eachSeries(this._pre.upload, function(fn, next) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">250</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		fn(item, file, next);</span></td><td class="action"></td></tr><tr><td class="line">251</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}, function(err) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">252</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (err) return callback(err);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">253</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		doUpload();</span></td><td class="action"></td></tr><tr><td class="line">254</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">255</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">256</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">257</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">258</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">259</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Returns a callback that handles a standard form submission for the field</span></td><td class="action"></td></tr><tr><td class="line">260</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">261</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Expected form parts are</span></td><td class="action"></td></tr><tr><td class="line">262</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * - `field.paths.action` in `req.body` (`clear` or `delete`)</span></td><td class="action"></td></tr><tr><td class="line">263</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * - `field.paths.upload` in `req.files` (uploads the file to s3file)</span></td><td class="action"></td></tr><tr><td class="line">264</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">265</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">266</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">267</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">268</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">azurefile.prototype.getRequestHandler = function(item, req, paths, callback) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">269</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var field = this;</span></td><td class="action"></td></tr><tr><td class="line">270</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">271</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (utils.isFunction(paths)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">272</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		callback = paths;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">273</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		paths = field.paths;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">274</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else if (!paths) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">275</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		paths = field.paths;</span></td><td class="action"></td></tr><tr><td class="line">276</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">277</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	callback = callback || function() {};</span></td><td class="action"></td></tr><tr><td class="line">278</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">279</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">280</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var action = req.body[paths.action];</span></td><td class="action"></td></tr><tr><td class="line">281</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">282</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (/^(delete|reset)$/.test(action))</span></td><td class="action"></td></tr><tr class="miss"><td class="line">283</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				field.apply(item, action);</span></td><td class="action"></td></tr><tr><td class="line">284</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">285</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (req.files &amp;&amp; req.files[paths.upload] &amp;&amp; req.files[paths.upload].size) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">286</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return field.uploadFile(item, req.files[paths.upload], true, callback);</span></td><td class="action"></td></tr><tr><td class="line">287</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">288</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return callback();</span></td><td class="action"></td></tr><tr><td class="line">289</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">290</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">291</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">292</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">293</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">294</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Immediately handles a standard form submission for the field (see `getRequestHandler()`)</span></td><td class="action"></td></tr><tr><td class="line">295</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">296</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">297</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">298</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">299</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">azurefile.prototype.handleRequest = function(item, req, paths, callback) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">300</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.getRequestHandler(item, req, paths, callback)();</span></td><td class="action"></td></tr><tr><td class="line">301</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">302</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">303</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">304</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">305</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Export class</span></td><td class="action"></td></tr><tr><td class="line">306</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">307</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">308</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports = module.exports = azurefile;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/field.js">lib/field.js</h2><div class="stats medium"><div class="percentage">55% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">44% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">25% block coverage</div><div class="sloc">158 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Module dependencies.</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">5</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var _ = require('underscore'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">6</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	marked = require('marked'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">7</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	Path = require('./path'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">8</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	fspath = require('path'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">9</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	jade = require('jade'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">10</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	fs = require('fs'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">11</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	keystone = require('../'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">12</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	utils = require('keystone-utils'),</span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	compiledTemplates = {};</span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">16</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">17</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Field Constructor</span></td><td class="action"></td></tr><tr><td class="line">18</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * =================</span></td><td class="action"></td></tr><tr><td class="line">19</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">20</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Extended by fieldType Classes, should not be used directly.</span></td><td class="action"></td></tr><tr><td class="line">21</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">22</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">23</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">24</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">25</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function Field(list, path, options) {</span></td><td class="action"></td></tr><tr><td class="line">26</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Set field properties and options</span></td><td class="action"></td></tr><tr class="hit "><td class="line">28</td><td class="hits">50</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.list = list;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">29</td><td class="hits">50</td><td class="statements">100%</td><td class="source"><span class="statement ">	this._path = new Path(path);</span></td><td class="action"></td></tr><tr class="hit "><td class="line">30</td><td class="hits">50</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.path = path;</span></td><td class="action"></td></tr><tr><td class="line">31</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">32</td><td class="hits">50</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.type = this.constructor.name;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">33</td><td class="hits">50</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.options = utils.options(this.defaults, options);</span></td><td class="action"></td></tr><tr class="hit "><td class="line">34</td><td class="hits">50</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.label = options.label || utils.keyToLabel(this.path);</span></td><td class="action"></td></tr><tr class="hit "><td class="line">35</td><td class="hits">50</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.typeDescription = options.typeDescription || this.typeDescription || this.type;</span></td><td class="action"></td></tr><tr><td class="line">36</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">37</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Add the field to the schema</span></td><td class="action"></td></tr><tr class="hit "><td class="line">38</td><td class="hits">50</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.list.automap(this);</span></td><td class="action"></td></tr><tr class="hit "><td class="line">39</td><td class="hits">50</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.addToSchema();</span></td><td class="action"></td></tr><tr><td class="line">40</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">41</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Warn on required fields that aren't initial</span></td><td class="action"></td></tr><tr><td class="line">42</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (this.options.required &amp;&amp;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">43</td><td class="hits">50</td><td class="statements">100%</td><td class="source"><span class="statement ">        this.options.initial === undefined &amp;&amp;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">44</td><td class="hits">50</td><td class="statements">100%</td><td class="source"><span class="statement ">        this.options.default === undefined &amp;&amp;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">45</td><td class="hits">50</td><td class="statements">100%</td><td class="source"><span class="statement ">        !this.options.value &amp;&amp;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">46</td><td class="hits">50</td><td class="statements">100%</td><td class="source"><span class="statement ">        !this.list.get('nocreate') &amp;&amp;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">47</td><td class="hits">50</td><td class="statements">100%</td><td class="source"><span class="statement ">        this.path !== this.list.mappings.name</span></td><td class="action"></td></tr><tr><td class="line">48</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	) {</span></td><td class="action"></td></tr><tr><td class="line">49</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		console.error('\nError: Invalid Configuration\n\n' +</span></td><td class="action"></td></tr><tr class="miss"><td class="line">50</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			'Field (' + list.key + '.' + path + ') is required but not initial, and has no default or generated value.\n' +</span></td><td class="action"></td></tr><tr class="miss"><td class="line">51</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			'Please provide a default, remove the required setting, or set initial: false to override this error.\n');</span></td><td class="action"></td></tr><tr class="miss"><td class="line">52</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		process.exit(1);</span></td><td class="action"></td></tr><tr><td class="line">53</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">54</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">55</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Set up templates</span></td><td class="action"></td></tr><tr class="hit "><td class="line">56</td><td class="hits">50</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.templateDir = fspath.normalize(options.templateDir || (__dirname + '../../templates/fields/' + this.type));</span></td><td class="action"></td></tr><tr><td class="line">57</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">58</td><td class="hits">50</td><td class="statements">100%</td><td class="source"><span class="statement ">	var defaultTemplates = {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">59</td><td class="hits">50</td><td class="statements">100%</td><td class="source"><span class="statement ">		form: this.templateDir + '/' + 'form.jade',</span></td><td class="action"></td></tr><tr class="hit "><td class="line">60</td><td class="hits">50</td><td class="statements">100%</td><td class="source"><span class="statement ">		initial: this.templateDir + '/' + 'initial.jade'</span></td><td class="action"></td></tr><tr><td class="line">61</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">62</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">63</td><td class="hits">50</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.templates = utils.options(defaultTemplates, this.options.templates);</span></td><td class="action"></td></tr><tr><td class="line">64</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">65</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Add pre-save handler to the list if this field watches others</span></td><td class="action"></td></tr><tr><td class="line">66</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (this.options.watch) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">67</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		this.list.schema.pre('save', this.getPreSaveWatcher());</span></td><td class="action"></td></tr><tr><td class="line">68</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">69</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">70</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Convert notes from markdown to html</span></td><td class="action"></td></tr><tr class="hit "><td class="line">71</td><td class="hits">50</td><td class="statements">100%</td><td class="source"><span class="statement ">	var note = null;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">72</td><td class="hits">50</td><td class="statements">100%</td><td class="source"><span class="statement ">	Object.defineProperty(this, 'note', { get: function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">73</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return (note === null) ? (note = (this.options.note) ? marked(this.options.note) : '') : note;</span></td><td class="action"></td></tr><tr><td class="line">74</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} });</span></td><td class="action"></td></tr><tr><td class="line">75</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">76</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">77</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">78</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Field.prototype.getPreSaveWatcher = function() {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">79</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var field = this,</span></td><td class="action"></td></tr><tr><td class="line">80</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">81</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (this.options.watch === true) {</span></td><td class="action"></td></tr><tr><td class="line">82</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		// watch == true means always apply the value method</span></td><td class="action"></td></tr><tr class="miss"><td class="line">83</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		applyValue = function() { return true; };</span></td><td class="action"></td></tr><tr><td class="line">84</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">85</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (_.isString(this.options.watch)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">86</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			this.options.watch = this.options.watch.split(' ');</span></td><td class="action"></td></tr><tr><td class="line">87</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">88</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (_.isFunction(this.options.watch)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">89</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			applyValue = this.options.watch;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">90</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		} else if (_.isArray(this.options.watch)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">91</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			applyValue = function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">92</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				var pass = false;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">93</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				field.options.watch.forEach(function(path) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">94</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					if (item.isModified(path)) pass = true;</span></td><td class="action"></td></tr><tr><td class="line">95</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				});</span></td><td class="action"></td></tr><tr class="miss"><td class="line">96</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				return pass;</span></td><td class="action"></td></tr><tr><td class="line">97</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			};</span></td><td class="action"></td></tr><tr class="miss"><td class="line">98</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		} else if (_.isObject(this.options.watch)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">99</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			applyValue = function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">100</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				var pass = false;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">101</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				_.each(field.options.watch, function(value, path) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">102</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					if (item.isModified(path) &amp;&amp; item.get(path) === value) pass = true;</span></td><td class="action"></td></tr><tr><td class="line">103</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				});</span></td><td class="action"></td></tr><tr class="miss"><td class="line">104</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				return pass;</span></td><td class="action"></td></tr><tr><td class="line">105</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			};</span></td><td class="action"></td></tr><tr><td class="line">106</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">107</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!applyValue) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">108</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		console.error('\nError: Invalid Configuration\n\n' +</span></td><td class="action"></td></tr><tr class="miss"><td class="line">109</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		process.exit(1);</span></td><td class="action"></td></tr><tr><td class="line">110</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">111</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!_.isFunction(this.options.value)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">112</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		console.error('\nError: Invalid Configuration\n\n' +</span></td><td class="action"></td></tr><tr class="miss"><td class="line">113</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		process.exit(1);</span></td><td class="action"></td></tr><tr><td class="line">114</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">115</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return function(next) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">116</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (!applyValue(this)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">117</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return next();</span></td><td class="action"></td></tr><tr><td class="line">118</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">119</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		this.set(field.path, field.options.value.call(this));</span></td><td class="action"></td></tr><tr class="miss"><td class="line">120</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		next();</span></td><td class="action"></td></tr><tr><td class="line">121</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">122</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">123</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">124</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports = module.exports = Field;</span></td><td class="action"></td></tr><tr><td class="line">125</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">126</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">127</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/** Getter properties for the Field prototype */</span></td><td class="action"></td></tr><tr><td class="line">128</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit partial"><td class="line">129</td><td class="hits">1</td><td class="statements">50%</td><td class="source"><span class="statement ">Object.defineProperty(Field.prototype, 'width', { get: function() {</span><span class="statement notok"><span class="offscreen"> not covered </span>return this.options.width || 'full';</span><span class="statement ">} }); // !! field width is, for certain types, overridden by css</span></td><td class="action"></td></tr><tr class="hit partial"><td class="line">130</td><td class="hits">1</td><td class="statements">50%</td><td class="source"><span class="statement ">Object.defineProperty(Field.prototype, 'initial', { get: function() {</span><span class="statement notok"><span class="offscreen"> not covered </span>return this.options.initial || false;</span><span class="statement ">} });</span></td><td class="action"></td></tr><tr class="hit "><td class="line">131</td><td class="hits">37</td><td class="statements">100%</td><td class="source"><span class="statement ">Object.defineProperty(Field.prototype, 'required', { get: function() { return this.options.required || false; } })</span></td><td class="action"></td></tr><tr class="hit partial"><td class="line">132</td><td class="hits">1</td><td class="statements">50%</td><td class="source"><span class="statement ">Object.defineProperty(Field.prototype, 'col', { get: function() {</span><span class="statement notok"><span class="offscreen"> not covered </span>return this.options.col || false;</span><span class="statement ">} });</span></td><td class="action"></td></tr><tr class="hit "><td class="line">133</td><td class="hits">37</td><td class="statements">100%</td><td class="source"><span class="statement ">Object.defineProperty(Field.prototype, 'noedit', { get: function() { return this.options.noedit || false; } })</span></td><td class="action"></td></tr><tr class="hit partial"><td class="line">134</td><td class="hits">1</td><td class="statements">50%</td><td class="source"><span class="statement ">Object.defineProperty(Field.prototype, 'nocol', { get: function() {</span><span class="statement notok"><span class="offscreen"> not covered </span>return this.options.nocol || false;</span><span class="statement ">} });</span></td><td class="action"></td></tr><tr class="hit partial"><td class="line">135</td><td class="hits">1</td><td class="statements">50%</td><td class="source"><span class="statement ">Object.defineProperty(Field.prototype, 'nosort', { get: function() {</span><span class="statement notok"><span class="offscreen"> not covered </span>return this.options.nosort || false;</span><span class="statement ">} });</span></td><td class="action"></td></tr><tr class="hit partial"><td class="line">136</td><td class="hits">1</td><td class="statements">50%</td><td class="source"><span class="statement ">Object.defineProperty(Field.prototype, 'nofilter', { get: function() {</span><span class="statement notok"><span class="offscreen"> not covered </span>return this.options.nofilter || false;</span><span class="statement ">} });</span></td><td class="action"></td></tr><tr class="hit partial"><td class="line">137</td><td class="hits">1</td><td class="statements">50%</td><td class="source"><span class="statement ">Object.defineProperty(Field.prototype, 'collapse', { get: function() {</span><span class="statement notok"><span class="offscreen"> not covered </span>return this.options.collapse || false;</span><span class="statement ">} });</span></td><td class="action"></td></tr><tr class="hit partial"><td class="line">138</td><td class="hits">1</td><td class="statements">50%</td><td class="source"><span class="statement ">Object.defineProperty(Field.prototype, 'hidden', { get: function() {</span><span class="statement notok"><span class="offscreen"> not covered </span>return this.options.hidden || false;</span><span class="statement ">} });</span></td><td class="action"></td></tr><tr class="hit partial"><td class="line">139</td><td class="hits">1</td><td class="statements">50%</td><td class="source"><span class="statement ">Object.defineProperty(Field.prototype, 'dependsOn', { get: function() {</span><span class="statement notok"><span class="offscreen"> not covered </span>return this.options.dependsOn || false;</span><span class="statement ">} });</span></td><td class="action"></td></tr><tr><td class="line">140</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">141</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">142</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">143</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">144</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Default method to register the field on the List's Mongoose Schema.</span></td><td class="action"></td></tr><tr><td class="line">145</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Overridden by some fieldType Classes</span></td><td class="action"></td></tr><tr><td class="line">146</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">147</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">148</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">149</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">150</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Field.prototype.addToSchema = function() {
</span></td><td class="action"></td></tr><tr class="hit partial"><td class="line">151</td><td class="hits">34</td><td class="statements">67%</td><td class="source"><span class="statement ">	var ops = (this._nativeType) ? _.defaults({ type: this._nativeType }, this.options) :</span><span class="statement notok"><span class="offscreen"> not covered </span>this.options</span><span class="statement "></span></td><td class="action"></td></tr><tr><td class="line">152</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">153</td><td class="hits">34</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.list.schema.path(this.path, ops);</span></td><td class="action"></td></tr><tr><td class="line">154</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">155</td><td class="hits">34</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.bindUnderscoreMethods();</span></td><td class="action"></td></tr><tr><td class="line">156</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">157</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">158</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Field.prototype.bindUnderscoreMethods = function(methods) {
</span></td><td class="action"></td></tr><tr class="hit "><td class="line">159</td><td class="hits">50</td><td class="statements">100%</td><td class="source"><span class="statement ">	var field = this;</span></td><td class="action"></td></tr><tr><td class="line">160</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">161</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// automatically bind underscore methods specified by the _underscoreMethods property</span></td><td class="action"></td></tr><tr><td class="line">162</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// always include the 'update' method</span></td><td class="action"></td></tr><tr><td class="line">163</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">164</td><td class="hits">50</td><td class="statements">100%</td><td class="source"><span class="statement ">	(this._underscoreMethods || []).concat({ fn: 'updateItem', as: 'update' }, (methods || [])).forEach(function(method) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">165</td><td class="hits">136</td><td class="statements">100%</td><td class="source"><span class="statement ">		if ('string' === typeof method) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">166</td><td class="hits">86</td><td class="statements">100%</td><td class="source"><span class="statement ">			method = { fn: method, as: method };</span></td><td class="action"></td></tr><tr><td class="line">167</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">168</td><td class="hits">136</td><td class="statements">100%</td><td class="source"><span class="statement ">		if ('function' !== typeof field[method.fn]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">169</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			throw new Error('Invalid underscore method (' + method.fn + ') applied to ' + field.list.key + '.' + field.path + ' (' + field.type + ')');</span></td><td class="action"></td></tr><tr><td class="line">170</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">171</td><td class="hits">136</td><td class="statements">100%</td><td class="source"><span class="statement ">		field.underscoreMethod(method.as, function() {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">172</td><td class="hits">4</td><td class="statements">100%</td><td class="source"><span class="statement ">			var args = [this].concat(Array.prototype.slice.call(arguments));</span></td><td class="action"></td></tr><tr class="hit "><td class="line">173</td><td class="hits">4</td><td class="statements">100%</td><td class="source"><span class="statement ">			return field[method.fn].apply(field, args);</span></td><td class="action"></td></tr><tr><td class="line">174</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		});</span></td><td class="action"></td></tr><tr><td class="line">175</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">176</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">177</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">178</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">179</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">180</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Adds a method to the underscoreMethods collection on the field's list,</span></td><td class="action"></td></tr><tr><td class="line">181</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * with a path prefix to match this field's path and bound to the document</span></td><td class="action"></td></tr><tr><td class="line">182</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">183</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">184</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">185</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">186</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Field.prototype.underscoreMethod = function(path, fn) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">187</td><td class="hits">136</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.list.underscoreMethod(this.path + '.' + path, function() {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">188</td><td class="hits">4</td><td class="statements">100%</td><td class="source"><span class="statement ">		return fn.apply(this, arguments);</span></td><td class="action"></td></tr><tr><td class="line">189</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">190</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">191</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">192</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">193</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">194</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Default method to format the field value for display</span></td><td class="action"></td></tr><tr><td class="line">195</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Overridden by some fieldType Classes</span></td><td class="action"></td></tr><tr><td class="line">196</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">197</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">198</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">199</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">200</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Field.prototype.format = function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">201</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return item.get(this.path);</span></td><td class="action"></td></tr><tr><td class="line">202</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">203</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">204</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">205</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">206</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Default method to detect whether the field has been modified in an item</span></td><td class="action"></td></tr><tr><td class="line">207</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Overridden by some fieldType Classes</span></td><td class="action"></td></tr><tr><td class="line">208</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">209</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">210</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">211</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">212</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Field.prototype.isModified = function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">213</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return item.isModified(this.path);</span></td><td class="action"></td></tr><tr><td class="line">214</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">215</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">216</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">217</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">218</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Validates that a value for this field has been provided in a data object</span></td><td class="action"></td></tr><tr><td class="line">219</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Overridden by some fieldType Classes</span></td><td class="action"></td></tr><tr><td class="line">220</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">221</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">222</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">223</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">224</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Field.prototype.validateInput = function(data, required, item) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">225</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (!required) return true;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">226</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!(this.path in data) &amp;&amp; item &amp;&amp; item.get(this.path)) return true;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">227</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if ('string' === typeof data[this.path]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">228</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return (data[this.path].trim()) ? true : false;</span></td><td class="action"></td></tr><tr><td class="line">229</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">230</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return (data[this.path]) ? true : false;</span></td><td class="action"></td></tr><tr><td class="line">231</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">232</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">233</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">234</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">235</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Updates the value for this field in the item from a data object</span></td><td class="action"></td></tr><tr><td class="line">236</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Overridden by some fieldType Classes</span></td><td class="action"></td></tr><tr><td class="line">237</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">238</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">239</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">240</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">241</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Field.prototype.updateItem = function(item, data) {
	</span></td><td class="action"></td></tr><tr class="hit "><td class="line">242</td><td class="hits">12</td><td class="statements">100%</td><td class="source"><span class="statement ">	var value = this.getValueFromData(data);</span></td><td class="action"></td></tr><tr><td class="line">243</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="hit "><td class="line">244</td><td class="hits">12</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (value !== undefined &amp;&amp; value != item.get(this.path)) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">245</td><td class="hits">12</td><td class="statements">100%</td><td class="source"><span class="statement ">		item.set(this.path, value);</span></td><td class="action"></td></tr><tr><td class="line">246</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">247</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">248</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">249</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Retrieves the value from an object, whether the path is nested or flattened</span></td><td class="action"></td></tr><tr><td class="line">250</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * </span></td><td class="action"></td></tr><tr><td class="line">251</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">252</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">253</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">254</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Field.prototype.getValueFromData = function(data) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">255</td><td class="hits">17</td><td class="statements">100%</td><td class="source"><span class="statement ">	return this.path in data ? data[this.path] : this._path.get(data);</span></td><td class="action"></td></tr><tr><td class="line">256</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">257</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">258</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">259</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Compiles a field template and caches it</span></td><td class="action"></td></tr><tr><td class="line">260</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">261</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">262</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">263</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">264</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Field.prototype.compile = function(type, callback) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">265</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var templatePath = this.templates[type];</span></td><td class="action"></td></tr><tr><td class="line">266</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">267</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!compiledTemplates[templatePath]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">268</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		fs.readFile(templatePath, 'utf8', function(err, file) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">269</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (!err){</span></td><td class="action"></td></tr><tr class="miss"><td class="line">270</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				compiledTemplates[templatePath] = jade.compile(file, {</span></td><td class="action"></td></tr><tr><td class="line">271</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					filename: templatePath,</span></td><td class="action"></td></tr><tr class="miss"><td class="line">272</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					pretty: keystone.get('env') !== 'production'</span></td><td class="action"></td></tr><tr><td class="line">273</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				});</span></td><td class="action"></td></tr><tr><td class="line">274</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">275</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (callback) return callback();</span></td><td class="action"></td></tr><tr><td class="line">276</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		});</span></td><td class="action"></td></tr><tr class="miss"><td class="line">277</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else if (callback) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">278</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return callback();</span></td><td class="action"></td></tr><tr><td class="line">279</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">280</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">281</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">282</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Compiles a field template and caches it</span></td><td class="action"></td></tr><tr><td class="line">283</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">284</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">285</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">286</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">287</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Field.prototype.render = function(type, item, locals) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">288</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var templatePath = this.templates[type];</span></td><td class="action"></td></tr><tr><td class="line">289</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">290</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Compile the template synchronously if it hasn't already been compiled</span></td><td class="action"></td></tr><tr class="miss"><td class="line">291</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!compiledTemplates[templatePath]) {</span></td><td class="action"></td></tr><tr><td class="line">292</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">293</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var file = fs.readFileSync(templatePath, 'utf8');</span></td><td class="action"></td></tr><tr><td class="line">294</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">295</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		compiledTemplates[templatePath] = jade.compile(file, {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">296</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			pretty: keystone.get('env') !== 'production'</span></td><td class="action"></td></tr><tr><td class="line">297</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		});</span></td><td class="action"></td></tr><tr><td class="line">298</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">299</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">300</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">301</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return compiledTemplates[templatePath](_.extend(locals || {}, {</span></td><td class="action"></td></tr><tr><td class="line">302</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/path.js">lib/path.js</h2><div class="stats high"><div class="percentage">93% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">81% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">80% block coverage</div><div class="sloc">47 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr class="hit "><td class="line">1</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var utils = require('keystone-utils');</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Path Class</span></td><td class="action"></td></tr><tr><td class="line">5</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">6</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">7</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">8</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">9</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports = module.exports = function Path(str) {
</span></td><td class="action"></td></tr><tr class="hit "><td class="line">10</td><td class="hits">63</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (!(this instanceof Path)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">11</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return new Path(str);</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">13</td><td class="hits">63</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.original = str;</span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">15</td><td class="hits">63</td><td class="statements">100%</td><td class="source"><span class="statement ">	var parts = this.parts = str.split('.');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">16</td><td class="hits">63</td><td class="statements">100%</td><td class="source"><span class="statement ">	var last = this.last = this.parts[this.parts.length-1];</span></td><td class="action"></td></tr><tr class="hit "><td class="line">17</td><td class="hits">63</td><td class="statements">100%</td><td class="source"><span class="statement ">	var exceptLast = [];</span></td><td class="action"></td></tr><tr><td class="line">18</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">19</td><td class="hits">93</td><td class="statements">100%</td><td class="source"><span class="statement ">	for (var i = 0; i &lt; parts.length-1; i++) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">20</td><td class="hits">30</td><td class="statements">100%</td><td class="source"><span class="statement ">		exceptLast.push(parts[i]);</span></td><td class="action"></td></tr><tr><td class="line">21</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">22</td><td class="hits">63</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.exceptLast = exceptLast.join('.');</span></td><td class="action"></td></tr><tr><td class="line">23</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">24</td><td class="hits">63</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.addTo = function(obj, val) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">25</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		var o = obj;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">26</td><td class="hits">8</td><td class="statements">100%</td><td class="source"><span class="statement ">		for (var i = 0; i &lt; parts.length - 1; i++) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">27</td><td class="hits">6</td><td class="statements">100%</td><td class="source"><span class="statement ">			if (!utils.isObject(o[parts[i]]))</span></td><td class="action"></td></tr><tr class="hit "><td class="line">28</td><td class="hits">4</td><td class="statements">100%</td><td class="source"><span class="statement ">				o[parts[i]] = {};</span></td><td class="action"></td></tr><tr class="hit "><td class="line">29</td><td class="hits">6</td><td class="statements">100%</td><td class="source"><span class="statement ">			o = o[parts[i]];</span></td><td class="action"></td></tr><tr><td class="line">30</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">31</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		o[last] = val;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">32</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		return obj;</span></td><td class="action"></td></tr><tr><td class="line">33</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">34</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">35</td><td class="hits">63</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.get = function(obj) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">36</td><td class="hits">14</td><td class="statements">100%</td><td class="source"><span class="statement ">		var o = obj;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">37</td><td class="hits">34</td><td class="statements">100%</td><td class="source"><span class="statement ">		for (var i = 0; i &lt; parts.length; i++) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">38</td><td class="hits">29</td><td class="statements">100%</td><td class="source"><span class="statement ">			if (typeof o !== 'object') return undefined;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">39</td><td class="hits">20</td><td class="statements">100%</td><td class="source"><span class="statement ">			o = o[parts[i]];</span></td><td class="action"></td></tr><tr><td class="line">40</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">41</td><td class="hits">5</td><td class="statements">100%</td><td class="source"><span class="statement ">		return o;</span></td><td class="action"></td></tr><tr><td class="line">42</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">43</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">44</td><td class="hits">63</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.prependToLast = function(prepend, titlecase) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">45</td><td class="hits">3</td><td class="statements">100%</td><td class="source"><span class="statement ">		var rtn = '';</span></td><td class="action"></td></tr><tr class="hit "><td class="line">46</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">		for (var i = 0; i &lt; parts.length - 1; i++) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">47</td><td class="hits">6</td><td class="statements">100%</td><td class="source"><span class="statement ">			rtn += parts[i] + '.';</span></td><td class="action"></td></tr><tr><td class="line">48</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">49</td><td class="hits">3</td><td class="statements">100%</td><td class="source"><span class="statement ">		return rtn + (prepend || '') + (titlecase ? utils.upcase(last) : last);</span></td><td class="action"></td></tr><tr><td class="line">50</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">51</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">52</td><td class="hits">63</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.append = function(append) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">53</td><td class="hits">73</td><td class="statements">100%</td><td class="source"><span class="statement ">		return str + append;</span></td><td class="action"></td></tr><tr><td class="line">54</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">55</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">56</td><td class="hits">63</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.flatten = function(titlecase) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">57</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		return utils.camelcase(parts.join('_'), titlecase ? true : false);</span></td><td class="action"></td></tr><tr><td class="line">58</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">59</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">60</td><td class="hits">63</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.flattenplural = function(titlecase) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">61</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return utils.camelcase([].concat(exceptLast).concat(utils.plural(last)).join('_'), titlecase ? true : false);</span></td><td class="action"></td></tr><tr><td class="line">62</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">63</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">64</td><td class="hits">63</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.flattensingular = function(titlecase) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">65</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return utils.camelcase([].concat(exceptLast).concat(utils.singular(last)).join('_'), titlecase ? true : false);</span></td><td class="action"></td></tr><tr><td class="line">66</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">67</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">68</td><td class="hits">63</td><td class="statements">100%</td><td class="source"><span class="statement ">	return this;</span></td><td class="action"></td></tr><tr><td class="line">69</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/fieldTypes/boolean.js">lib/fieldTypes/boolean.js</h2><div class="stats high"><div class="percentage">85% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">77% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">62% block coverage</div><div class="sloc">20 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Module dependencies.</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">5</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var util = require('util'),
	super_ = require('../field');</span></td><td class="action"></td></tr><tr><td class="line">6</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">7</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">8</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Boolean FieldType Constructor</span></td><td class="action"></td></tr><tr><td class="line">9</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @extends Field</span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function boolean(list, path, options) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">14</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">	this._nativeType = Boolean;</span></td><td class="action"></td></tr><tr class="hit partial"><td class="line">15</td><td class="hits">2</td><td class="statements">67%</td><td class="source"><span class="statement ">	this.indent = (options.indent) ?</span><span class="statement notok"><span class="offscreen"> not covered </span>true</span><span class="statement ">: false;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">16</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">	boolean.super_.call(this, list, path, options);</span></td><td class="action"></td></tr><tr><td class="line">17</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">18</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">19</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">20</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Inherit from Field</span></td><td class="action"></td></tr><tr><td class="line">21</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">22</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">23</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">util.inherits(boolean, super_);</span></td><td class="action"></td></tr><tr><td class="line">24</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">25</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">26</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Validates that a truthy value for this field has been provided in a data object.</span></td><td class="action"></td></tr><tr><td class="line">28</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">29</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Useful for checkboxes that are required to be true (e.g. agreed to terms and cond's)</span></td><td class="action"></td></tr><tr><td class="line">30</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">31</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">32</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">33</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">34</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">boolean.prototype.validateInput = function(data, required) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (required) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return (data[this.path] === true || data[this.path] === 'true') ? true : false;</span></td><td class="action"></td></tr><tr><td class="line">37</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">38</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return true;</span></td><td class="action"></td></tr><tr><td class="line">39</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">40</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">41</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">42</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">43</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Updates the value for this field in the item from a data object.</span></td><td class="action"></td></tr><tr><td class="line">44</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Only updates the value if it has changed.</span></td><td class="action"></td></tr><tr><td class="line">45</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Treats a true boolean or string == 'true' as true, everything else as false.</span></td><td class="action"></td></tr><tr><td class="line">46</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">47</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">48</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">49</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">50</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">boolean.prototype.updateItem = function(item, data) {
	</span></td><td class="action"></td></tr><tr class="hit "><td class="line">51</td><td class="hits">5</td><td class="statements">100%</td><td class="source"><span class="statement ">	var value = this.getValueFromData(data);</span></td><td class="action"></td></tr><tr><td class="line">52</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="hit "><td class="line">53</td><td class="hits">5</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (value === true || value === 'true') {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">54</td><td class="hits">4</td><td class="statements">100%</td><td class="source"><span class="statement ">		if (!item.get(this.path)) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">55</td><td class="hits">4</td><td class="statements">100%</td><td class="source"><span class="statement ">			item.set(this.path, true);</span></td><td class="action"></td></tr><tr><td class="line">56</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">57</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	} else if (item.get(this.path) !== false) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">58</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">		item.set(this.path, false);</span></td><td class="action"></td></tr><tr><td class="line">59</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">60</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">61</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">62</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">63</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Export class</span></td><td class="action"></td></tr><tr><td class="line">64</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">65</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">66</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports = module.exports = boolean;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/fieldTypes/cloudinaryimage.js">lib/fieldTypes/cloudinaryimage.js</h2><div class="stats terrible"><div class="percentage">12% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">7% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">0% block coverage</div><div class="sloc">176 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Module dependencies.</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">5</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var _ = require('underscore'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">6</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	keystone = require('../../'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">7</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	util = require('util'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">8</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	cloudinary = require('cloudinary'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">9</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	utils = require('keystone-utils'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">10</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	super_ = require('../field');</span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * CloudinaryImage FieldType Constructor</span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @extends Field</span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">16</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">17</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">18</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function cloudinaryimage(list, path, options) {</span></td><td class="action"></td></tr><tr><td class="line">19</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">20</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._underscoreMethods = ['format'];</span></td><td class="action"></td></tr><tr><td class="line">21</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">22</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// TODO: implement filtering, usage disabled for now</span></td><td class="action"></td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	options.nofilter = true;</span></td><td class="action"></td></tr><tr><td class="line">24</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">25</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// TODO: implement initial form, usage disabled for now</span></td><td class="action"></td></tr><tr><td class="line">26</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (options.initial) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">27</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error(</span></td><td class="action"></td></tr><tr class="miss"><td class="line">28</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			'Invalid Configuration\n\n' +</span></td><td class="action"></td></tr><tr><td class="line">29</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		);</span></td><td class="action"></td></tr><tr><td class="line">30</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">31</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	cloudinaryimage.super_.call(this, list, path, options);</span></td><td class="action"></td></tr><tr><td class="line">33</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">34</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// validate cloudinary config</span></td><td class="action"></td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!keystone.get('cloudinary config')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error(</span></td><td class="action"></td></tr><tr><td class="line">37</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			'Invalid Configuration\n\n' +</span></td><td class="action"></td></tr><tr class="miss"><td class="line">38</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			'CloudinaryImage fields (' + list.key + '.' + this.path + ') require the &quot;cloudinary config&quot; option to be set.\n\n' +</span></td><td class="action"></td></tr><tr class="miss"><td class="line">39</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			'See http://keystonejs.com/docs/configuration/#cloudinary for more information.\n'</span></td><td class="action"></td></tr><tr><td class="line">40</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		);</span></td><td class="action"></td></tr><tr><td class="line">41</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">42</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">43</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">44</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">45</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">46</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Inherit from Field</span></td><td class="action"></td></tr><tr><td class="line">47</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">48</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">49</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">util.inherits(cloudinaryimage, super_);</span></td><td class="action"></td></tr><tr><td class="line">50</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">51</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">52</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">53</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Registers the field on the List's Mongoose Schema.</span></td><td class="action"></td></tr><tr><td class="line">54</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">55</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">56</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">57</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">58</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">cloudinaryimage.prototype.addToSchema = function() {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">59</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var field = this,</span></td><td class="action"></td></tr><tr><td class="line">60</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">61</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var paths = this.paths = {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">62</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		public_id: 		this._path.append('.public_id'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">63</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		version: 		this._path.append('.version'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">64</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		signature: 		this._path.append('.signature'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">65</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		format: 		this._path.append('.format'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">66</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		resource_type: 	this._path.append('.resource_type'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">67</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		url: 			this._path.append('.url'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">68</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		width: 			this._path.append('.width'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">69</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		height: 		this._path.append('.height'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">70</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		secure_url: 	this._path.append('.secure_url'),</span></td><td class="action"></td></tr><tr><td class="line">71</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		// virtuals</span></td><td class="action"></td></tr><tr class="miss"><td class="line">72</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		exists: 		this._path.append('.exists'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">73</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		folder: 		this._path.append('.folder'),</span></td><td class="action"></td></tr><tr><td class="line">74</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		// form paths</span></td><td class="action"></td></tr><tr class="miss"><td class="line">75</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		upload: 		this._path.append('_upload'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">76</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		action: 		this._path.append('_action'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">77</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		select: 		this._path.append('_select')</span></td><td class="action"></td></tr><tr><td class="line">78</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">79</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">80</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var schemaPaths = this._path.addTo({}, {</span></td><td class="action"></td></tr><tr><td class="line">81</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">82</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	schema.add(schemaPaths);</span></td><td class="action"></td></tr><tr><td class="line">83</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">84</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var exists = function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">85</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return (item.get(paths.public_id) ? true : false);</span></td><td class="action"></td></tr><tr><td class="line">86</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">87</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">88</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// The .exists virtual indicates whether an image is stored</span></td><td class="action"></td></tr><tr class="miss"><td class="line">89</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	schema.virtual(paths.exists).get(function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">90</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return schemaMethods.exists.apply(this);</span></td><td class="action"></td></tr><tr><td class="line">91</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">92</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">93</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var folder = function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">94</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var folderValue = null;</span></td><td class="action"></td></tr><tr><td class="line">95</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">96</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (keystone.get('cloudinary folders')) {</span></td><td class="action"></td></tr><tr><td class="line">97</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (field.options.folder) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">98</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				folderValue = field.options.folder;</span></td><td class="action"></td></tr><tr><td class="line">99</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">100</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				var folderList = keystone.get('cloudinary prefix') ? [keystone.get('cloudinary prefix')] : [];</span></td><td class="action"></td></tr><tr class="miss"><td class="line">101</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				folderList.push(field.list.path);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">102</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				folderList.push(field.path);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">103</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				folderValue = folderList.join('/');</span></td><td class="action"></td></tr><tr><td class="line">104</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">105</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return folderValue;</span></td><td class="action"></td></tr><tr><td class="line">106</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">107</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">108</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// The .folder virtual returns the cloudinary folder used to upload/select images</span></td><td class="action"></td></tr><tr class="miss"><td class="line">109</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	schema.virtual(paths.folder).get(function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">110</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return schemaMethods.folder.apply(this);</span></td><td class="action"></td></tr><tr><td class="line">111</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">112</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">113</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var src = function(item, options) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">114</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (!exists(item)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">115</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return '';</span></td><td class="action"></td></tr><tr><td class="line">116</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">117</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		options = ('object' === typeof options) ? options : {};</span></td><td class="action"></td></tr><tr><td class="line">118</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">119</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (!('fetch_format' in options) &amp;&amp; keystone.get('cloudinary webp') !== false) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">120</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			options.fetch_format = &quot;auto&quot;;</span></td><td class="action"></td></tr><tr><td class="line">121</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">122</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (!('progressive' in options) &amp;&amp; keystone.get('cloudinary progressive') !== false) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">123</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			options.progressive = true;</span></td><td class="action"></td></tr><tr><td class="line">124</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">125</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (!('secure' in options) &amp;&amp; keystone.get('cloudinary secure')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">126</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			options.secure = true;</span></td><td class="action"></td></tr><tr><td class="line">127</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">128</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return cloudinary.url(item.get(paths.public_id) + '.' + item.get(paths.format), options);</span></td><td class="action"></td></tr><tr><td class="line">129</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">130</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">131</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var reset = function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">132</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		item.set(field.path, {</span></td><td class="action"></td></tr><tr><td class="line">133</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">134</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">135</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var addSize = function(options, width, height, other) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">136</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (width) options.width = width;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">137</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (height) options.height = height;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">138</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if ('object' === typeof other) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">139</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			_.extend(options, other);</span></td><td class="action"></td></tr><tr><td class="line">140</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">141</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return options;</span></td><td class="action"></td></tr><tr><td class="line">142</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">143</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">144</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var schemaMethods = {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">145</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return exists(this);</span></td><td class="action"></td></tr><tr><td class="line">146</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		},</span></td><td class="action"></td></tr><tr class="miss"><td class="line">147</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return folder(this);</span></td><td class="action"></td></tr><tr><td class="line">148</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		},</span></td><td class="action"></td></tr><tr class="miss"><td class="line">149</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return src(this, options);</span></td><td class="action"></td></tr><tr><td class="line">150</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		},</span></td><td class="action"></td></tr><tr class="miss"><td class="line">151</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return exists(this) ? cloudinary.image(this.get(field.path), options) : '';</span></td><td class="action"></td></tr><tr><td class="line">152</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		},</span></td><td class="action"></td></tr><tr class="miss"><td class="line">153</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return src(this, addSize({ crop: 'scale' }, width, height, options));</span></td><td class="action"></td></tr><tr><td class="line">154</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		},</span></td><td class="action"></td></tr><tr class="miss"><td class="line">155</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return src(this, addSize({ crop: 'fill', gravity: 'faces' }, width, height, options));</span></td><td class="action"></td></tr><tr><td class="line">156</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		},</span></td><td class="action"></td></tr><tr class="miss"><td class="line">157</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return src(this, addSize({ crop: 'lfill', gravity: 'faces' }, width, height, options));</span></td><td class="action"></td></tr><tr><td class="line">158</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		},</span></td><td class="action"></td></tr><tr class="miss"><td class="line">159</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return src(this, addSize({ crop: 'fit' }, width, height, options));</span></td><td class="action"></td></tr><tr><td class="line">160</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		},</span></td><td class="action"></td></tr><tr class="miss"><td class="line">161</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return src(this, addSize({ crop: 'limit' }, width, height, options));</span></td><td class="action"></td></tr><tr><td class="line">162</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		},</span></td><td class="action"></td></tr><tr class="miss"><td class="line">163</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return src(this, addSize({ crop: 'pad' }, width, height, options));</span></td><td class="action"></td></tr><tr><td class="line">164</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		},</span></td><td class="action"></td></tr><tr class="miss"><td class="line">165</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return src(this, addSize({ crop: 'lpad' }, width, height, options));</span></td><td class="action"></td></tr><tr><td class="line">166</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		},</span></td><td class="action"></td></tr><tr class="miss"><td class="line">167</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return src(this, addSize({ crop: 'crop', gravity: 'faces' }, width, height, options));</span></td><td class="action"></td></tr><tr><td class="line">168</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		},</span></td><td class="action"></td></tr><tr class="miss"><td class="line">169</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return src(this, addSize({ crop: 'thumb', gravity: 'faces' }, width, height, options));</span></td><td class="action"></td></tr><tr><td class="line">170</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		},</span></td><td class="action"></td></tr><tr class="miss"><td class="line">171</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			reset(this);</span></td><td class="action"></td></tr><tr><td class="line">172</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		},</span></td><td class="action"></td></tr><tr class="miss"><td class="line">173</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			cloudinary.uploader.destroy(this.get(paths.public_id), function() {});</span></td><td class="action"></td></tr><tr class="miss"><td class="line">174</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			reset(this);</span></td><td class="action"></td></tr><tr><td class="line">175</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">176</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">177</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	_.each(schemaMethods, function(fn, key) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">178</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		field.underscoreMethod(key, fn);</span></td><td class="action"></td></tr><tr><td class="line">179</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">180</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">181</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// expose a method on the field to call schema methods</span></td><td class="action"></td></tr><tr class="miss"><td class="line">182</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.apply = function(item, method) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">183</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return schemaMethods[method].apply(item, Array.prototype.slice.call(arguments, 2));</span></td><td class="action"></td></tr><tr><td class="line">184</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">185</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">186</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.bindUnderscoreMethods();</span></td><td class="action"></td></tr><tr><td class="line">187</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">188</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">189</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">190</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">191</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Formats the field value</span></td><td class="action"></td></tr><tr><td class="line">192</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">193</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">194</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">195</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">196</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">cloudinaryimage.prototype.format = function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">197</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return item.get(this.paths.url);</span></td><td class="action"></td></tr><tr><td class="line">198</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">199</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">200</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">201</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">202</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Detects whether the field has been modified</span></td><td class="action"></td></tr><tr><td class="line">203</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">204</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">205</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">206</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">207</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">cloudinaryimage.prototype.isModified = function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">208</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return item.isModified(this.paths.url);</span></td><td class="action"></td></tr><tr><td class="line">209</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">210</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">211</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">212</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">213</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Validates that a value for this field has been provided in a data object</span></td><td class="action"></td></tr><tr><td class="line">214</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">215</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">216</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">217</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">218</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">cloudinaryimage.prototype.validateInput = function(data) {
	// TODO - how should image field input be validated?</span></td><td class="action"></td></tr><tr class="miss"><td class="line">219</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return true;</span></td><td class="action"></td></tr><tr><td class="line">220</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">221</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">222</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">223</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">224</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Updates the value for this field in the item from a data object</span></td><td class="action"></td></tr><tr><td class="line">225</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">226</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">227</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">228</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">229</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">cloudinaryimage.prototype.updateItem = function(item, data) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">230</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var paths = this.paths;</span></td><td class="action"></td></tr><tr><td class="line">231</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">232</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var setValue = function(key) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">233</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var index = paths[key].indexOf(&quot;.&quot;);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">234</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var field = paths[key].substr(0, index);</span></td><td class="action"></td></tr><tr><td class="line">235</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			// Note we allow implicit conversion here so that numbers submitted as strings in the data object</span></td><td class="action"></td></tr><tr class="miss"><td class="line">236</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (data[field] &amp;&amp; data[field][key] &amp;&amp; data[field][key] != item.get(paths[key])) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">237</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				item.set(paths[key], data[field][key] || null);</span></td><td class="action"></td></tr><tr><td class="line">238</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr><td class="line">239</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">240</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	_.each(['public_id', 'version', 'signature', 'format', 'resource_type', 'url', 'width', 'height', 'secure_url'], setValue);</span></td><td class="action"></td></tr><tr><td class="line">241</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">242</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">243</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">244</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">245</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Returns a callback that handles a standard form submission for the field</span></td><td class="action"></td></tr><tr><td class="line">246</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">247</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Expected form parts are</span></td><td class="action"></td></tr><tr><td class="line">248</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * - `field.paths.action` in `req.body` (`clear` or `delete`)</span></td><td class="action"></td></tr><tr><td class="line">249</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * - `field.paths.upload` in `req.files` (uploads the image to cloudinary)</span></td><td class="action"></td></tr><tr><td class="line">250</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">251</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">252</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">253</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">254</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">cloudinaryimage.prototype.getRequestHandler = function(item, req, paths, callback) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">255</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var field = this;</span></td><td class="action"></td></tr><tr><td class="line">256</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">257</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (utils.isFunction(paths)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">258</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		callback = paths;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">259</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		paths = field.paths;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">260</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else if (!paths) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">261</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		paths = field.paths;</span></td><td class="action"></td></tr><tr><td class="line">262</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">263</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	callback = callback || function() {};</span></td><td class="action"></td></tr><tr><td class="line">264</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">265</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">266</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var action = req.body[paths.action];</span></td><td class="action"></td></tr><tr><td class="line">267</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">268</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (/^(delete|reset)$/.test(action)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">269</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				field.apply(item, action);</span></td><td class="action"></td></tr><tr><td class="line">270</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">271</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (req.body &amp;&amp; req.body[paths.select]) {</span></td><td class="action"></td></tr><tr><td class="line">272</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">273</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			cloudinary.api.resource(req.body[paths.select], function(result) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">274</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					callback(result.error);</span></td><td class="action"></td></tr><tr><td class="line">275</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">276</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					item.set(field.path, result);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">277</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					callback();</span></td><td class="action"></td></tr><tr><td class="line">278</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr><td class="line">279</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			});</span></td><td class="action"></td></tr><tr><td class="line">280</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">281</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		} else if (req.files &amp;&amp; req.files[paths.upload] &amp;&amp; req.files[paths.upload].size) {</span></td><td class="action"></td></tr><tr><td class="line">282</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">283</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var tp = keystone.get('cloudinary prefix') || '';</span></td><td class="action"></td></tr><tr><td class="line">284</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">285</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (tp.length) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">286</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				tp += '_';</span></td><td class="action"></td></tr><tr><td class="line">287</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">288</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var uploadOptions = {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">289</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				tags: [tp + field.list.path + '_' + field.path, tp + field.list.path + '_' + field.path + '_' + item.id]</span></td><td class="action"></td></tr><tr><td class="line">290</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			};</span></td><td class="action"></td></tr><tr><td class="line">291</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">292</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (item.get(field.paths.folder)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">293</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				uploadOptions.folder = item.get(field.paths.folder);</span></td><td class="action"></td></tr><tr><td class="line">294</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">295</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (keystone.get('cloudinary prefix')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">296</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				uploadOptions.tags.push(keystone.get('cloudinary prefix'));</span></td><td class="action"></td></tr><tr><td class="line">297</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">298</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (keystone.get('env') !== 'production') {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">299</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				uploadOptions.tags.push(tp + 'dev');</span></td><td class="action"></td></tr><tr><td class="line">300</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">301</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				var publicIdValue = item.get(field.options.publicID);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">302</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (publicIdValue) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">303</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					uploadOptions.public_id = publicIdValue;</span></td><td class="action"></td></tr><tr><td class="line">304</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">305</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (field.options.autoCleanup &amp;&amp; item.get(field.paths.exists)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">306</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				field.apply(item, 'delete');</span></td><td class="action"></td></tr><tr><td class="line">307</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">308</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			cloudinary.uploader.upload(req.files[paths.upload].path, function(result) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">309</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					callback(result.error);</span></td><td class="action"></td></tr><tr><td class="line">310</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">311</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					item.set(field.path, result);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">312</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					callback();</span></td><td class="action"></td></tr><tr><td class="line">313</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr><td class="line">314</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}, uploadOptions);</span></td><td class="action"></td></tr><tr><td class="line">315</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">316</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">317</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			callback();</span></td><td class="action"></td></tr><tr><td class="line">318</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">319</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">320</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">321</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">322</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">323</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Immediately handles a standard form submission for the field (see `getRequestHandler()`)</span></td><td class="action"></td></tr><tr><td class="line">324</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">325</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">326</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">327</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">328</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">cloudinaryimage.prototype.handleRequest = function(item, req, paths, callback) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">329</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.getRequestHandler(item, req, paths, callback)();</span></td><td class="action"></td></tr><tr><td class="line">330</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">331</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">332</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">333</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">334</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Export class</span></td><td class="action"></td></tr><tr><td class="line">335</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">336</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">337</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports = module.exports = cloudinaryimage;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/fieldTypes/cloudinaryimages.js">lib/fieldTypes/cloudinaryimages.js</h2><div class="stats terrible"><div class="percentage">14% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">7% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">0% block coverage</div><div class="sloc">162 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Module dependencies.</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">5</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var _ = require('underscore'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">6</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	keystone = require('../../'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">7</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	util = require('util'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">8</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	cloudinary = require('cloudinary'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">9</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	utils = require('keystone-utils'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">10</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	super_ = require('../field'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">11</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	async = require('async');</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * CloudinaryImages FieldType Constructor</span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @extends Field</span></td><td class="action"></td></tr><tr><td class="line">16</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">17</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">18</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">19</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function cloudinaryimages(list, path, options) {</span></td><td class="action"></td></tr><tr><td class="line">20</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._underscoreMethods = ['format'];</span></td><td class="action"></td></tr><tr><td class="line">22</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">23</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// TODO: implement filtering, usage disabled for now</span></td><td class="action"></td></tr><tr class="miss"><td class="line">24</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	options.nofilter = true;</span></td><td class="action"></td></tr><tr><td class="line">25</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// TODO: implement initial form, usage disabled for now</span></td><td class="action"></td></tr><tr><td class="line">26</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (options.initial) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">27</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('Invalid Configuration\n\n' +</span></td><td class="action"></td></tr><tr><td class="line">28</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">29</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">30</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	cloudinaryimages.super_.call(this, list, path, options);</span></td><td class="action"></td></tr><tr><td class="line">31</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">32</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// validate cloudinary config</span></td><td class="action"></td></tr><tr class="miss"><td class="line">33</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!keystone.get('cloudinary config')) {</span></td><td class="action"></td></tr><tr><td class="line">34</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('Invalid Configuration\n\n' +</span></td><td class="action"></td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			'CloudinaryImages fields (' + list.key + '.' + this.path + ') require the &quot;cloudinary config&quot; option to be set.\n\n' +</span></td><td class="action"></td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			'See http://keystonejs.com/docs/configuration/#cloudinary for more information.\n');</span></td><td class="action"></td></tr><tr><td class="line">37</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">38</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">39</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">40</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">41</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">42</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Inherit from Field</span></td><td class="action"></td></tr><tr><td class="line">43</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">44</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">45</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">util.inherits(cloudinaryimages, super_);</span></td><td class="action"></td></tr><tr><td class="line">46</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">47</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">48</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">49</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Registers the field on the List's Mongoose Schema.</span></td><td class="action"></td></tr><tr><td class="line">50</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">51</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">52</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">53</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">54</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">cloudinaryimages.prototype.addToSchema = function() {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">55</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var mongoose = keystone.mongoose;</span></td><td class="action"></td></tr><tr><td class="line">56</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">57</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var field = this,</span></td><td class="action"></td></tr><tr><td class="line">58</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">59</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var paths = this.paths = {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">60</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		upload: 		this._path.append('_upload'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">61</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		uploads: 		this._path.append('_uploads'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">62</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		action: 		this._path.append('_action'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">63</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		order: 			this._path.append('_order')</span></td><td class="action"></td></tr><tr><td class="line">64</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">65</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">66</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var ImageSchema = new mongoose.Schema({</span></td><td class="action"></td></tr><tr><td class="line">67</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">68</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var src = function(img, options) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">69</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (keystone.get('cloudinary secure')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">70</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			options = options || {};</span></td><td class="action"></td></tr><tr class="miss"><td class="line">71</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			options.secure = true;</span></td><td class="action"></td></tr><tr><td class="line">72</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">73</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return img.public_id ? cloudinary.url(img.public_id + '.' + img.format, options) : '';</span></td><td class="action"></td></tr><tr><td class="line">74</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">75</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">76</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var addSize = function(options, width, height) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">77</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (width) options.width = width;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">78</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (height) options.height = height;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">79</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return options;</span></td><td class="action"></td></tr><tr><td class="line">80</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">81</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">82</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	ImageSchema.method('src', function(options) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">83</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return src(this, options);</span></td><td class="action"></td></tr><tr><td class="line">84</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">85</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">86</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	ImageSchema.method('scale', function(width, height) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">87</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return src(this, addSize({ crop: 'scale' }, width, height));</span></td><td class="action"></td></tr><tr><td class="line">88</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">89</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">90</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	ImageSchema.method('fill', function(width, height) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">91</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return src(this, addSize({ crop: 'fill', gravity: 'faces' }, width, height));</span></td><td class="action"></td></tr><tr><td class="line">92</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">93</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">94</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	ImageSchema.method('lfill', function(width, height) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">95</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return src(this, addSize({ crop: 'lfill', gravity: 'faces' }, width, height));</span></td><td class="action"></td></tr><tr><td class="line">96</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">97</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">98</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	ImageSchema.method('fit', function(width, height) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">99</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return src(this, addSize({ crop: 'fit' }, width, height));</span></td><td class="action"></td></tr><tr><td class="line">100</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">101</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">102</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	ImageSchema.method('limit', function(width, height) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">103</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return src(this, addSize({ crop: 'limit' }, width, height));</span></td><td class="action"></td></tr><tr><td class="line">104</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">105</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">106</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	ImageSchema.method('pad', function(width, height) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">107</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return src(this, addSize({ crop: 'pad' }, width, height));</span></td><td class="action"></td></tr><tr><td class="line">108</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">109</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">110</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	ImageSchema.method('lpad', function(width, height) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">111</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return src(this, addSize({ crop: 'lpad' }, width, height));</span></td><td class="action"></td></tr><tr><td class="line">112</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">113</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">114</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	ImageSchema.method('crop', function(width, height) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">115</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return src(this, addSize({ crop: 'crop', gravity: 'faces' }, width, height));</span></td><td class="action"></td></tr><tr><td class="line">116</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">117</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">118</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	ImageSchema.method('thumbnail', function(width, height) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">119</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return src(this, addSize({ crop: 'thumb', gravity: 'faces' }, width, height));</span></td><td class="action"></td></tr><tr><td class="line">120</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">121</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">122</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	schema.add(this._path.addTo({}, [ImageSchema]));</span></td><td class="action"></td></tr><tr><td class="line">123</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">124</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.removeImage = function(item, id, method, callback) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">125</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var images = item.get(field.path);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">126</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if ('number' != typeof id) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">127</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			for (var i = 0; i &lt; images.length; i++) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">128</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (images[i].public_id == id) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">129</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					id = i;</span></td><td class="action"></td></tr><tr><td class="line">130</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					break;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">131</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var img = images[id];</span></td><td class="action"></td></tr><tr class="miss"><td class="line">132</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (!img) return;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">133</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (method == 'delete') {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">134</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			cloudinary.uploader.destroy(img.public_id, function() {});</span></td><td class="action"></td></tr><tr><td class="line">135</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">136</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		images.splice(id, 1);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">137</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (callback) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">138</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			item.save(('function' != typeof callback) ? callback : undefined);</span></td><td class="action"></td></tr><tr><td class="line">139</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">140</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">141</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.underscoreMethod('remove', function(id, callback) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">142</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		field.removeImage(this, id, 'remove', callback);</span></td><td class="action"></td></tr><tr><td class="line">143</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">144</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">145</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.underscoreMethod('delete', function(id, callback) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">146</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		field.removeImage(this, id, 'delete', callback);</span></td><td class="action"></td></tr><tr><td class="line">147</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">148</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">149</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.bindUnderscoreMethods();</span></td><td class="action"></td></tr><tr><td class="line">150</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">151</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">152</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">153</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">154</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Formats the field value</span></td><td class="action"></td></tr><tr><td class="line">155</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">156</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">157</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">158</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">159</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">cloudinaryimages.prototype.format = function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">160</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return _.map(item.get(this.path), function(img) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">161</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return img.src();</span></td><td class="action"></td></tr><tr><td class="line">162</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}).join(', ');</span></td><td class="action"></td></tr><tr><td class="line">163</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">164</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">165</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">166</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">167</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Detects whether the field has been modified</span></td><td class="action"></td></tr><tr><td class="line">168</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">169</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">170</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">171</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">172</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">cloudinaryimages.prototype.isModified = function(item) {
	// TODO - how should this be detected?</span></td><td class="action"></td></tr><tr class="miss"><td class="line">173</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return true;</span></td><td class="action"></td></tr><tr><td class="line">174</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">175</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">176</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">177</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">178</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Validates that a value for this field has been provided in a data object</span></td><td class="action"></td></tr><tr><td class="line">179</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">180</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">181</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">182</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">183</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">cloudinaryimages.prototype.validateInput = function(data) {
	// TODO - how should image field input be validated?</span></td><td class="action"></td></tr><tr class="miss"><td class="line">184</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return true;</span></td><td class="action"></td></tr><tr><td class="line">185</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">186</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">187</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">188</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">189</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Updates the value for this field in the item from a data object</span></td><td class="action"></td></tr><tr><td class="line">190</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">191</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">192</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">193</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">194</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">cloudinaryimages.prototype.updateItem = function(item, data) {
	// TODO - direct updating of data (not via upload)
};</span></td><td class="action"></td></tr><tr><td class="line">195</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">196</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">197</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">198</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Returns a callback that handles a standard form submission for the field</span></td><td class="action"></td></tr><tr><td class="line">199</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">200</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Expected form parts are</span></td><td class="action"></td></tr><tr><td class="line">201</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * - `field.paths.action` in `req.body` in syntax `delete:public_id,public_id|remove:public_id,public_id`</span></td><td class="action"></td></tr><tr><td class="line">202</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * - `field.paths.upload` in `req.files` (uploads the images to cloudinary)</span></td><td class="action"></td></tr><tr><td class="line">203</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">204</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">205</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">206</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">207</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">cloudinaryimages.prototype.getRequestHandler = function(item, req, paths, callback) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">208</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var field = this;</span></td><td class="action"></td></tr><tr><td class="line">209</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">210</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (utils.isFunction(paths)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">211</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		callback = paths;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">212</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		paths = field.paths;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">213</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else if (!paths) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">214</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		paths = field.paths;</span></td><td class="action"></td></tr><tr><td class="line">215</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">216</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	callback = callback || function() {};</span></td><td class="action"></td></tr><tr><td class="line">217</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">218</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">219</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var images = item.get(field.path),</span></td><td class="action"></td></tr><tr><td class="line">220</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">221</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			images.sort(function(a, b) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">222</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				return (newOrder.indexOf(a.public_id) &gt; newOrder.indexOf(b.public_id)) ? 1 : -1;</span></td><td class="action"></td></tr><tr><td class="line">223</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			});</span></td><td class="action"></td></tr><tr><td class="line">224</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">225</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (req.body &amp;&amp; req.body[paths.action]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">226</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var actions = req.body[paths.action].split('|');</span></td><td class="action"></td></tr><tr><td class="line">227</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">228</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			actions.forEach(function(action) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">229</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				action = action.split(':');</span></td><td class="action"></td></tr><tr class="miss"><td class="line">230</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				var method = action[0],</span></td><td class="action"></td></tr><tr><td class="line">231</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">232</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (!method.match(/^(remove|delete)$/) || !ids) return;</span></td><td class="action"></td></tr><tr><td class="line">233</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">234</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				ids.split(',').forEach(function(id) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">235</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					field.removeImage(item, id, method);</span></td><td class="action"></td></tr><tr><td class="line">236</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				});</span></td><td class="action"></td></tr><tr><td class="line">237</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			});</span></td><td class="action"></td></tr><tr><td class="line">238</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">239</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var uploads = JSON.parse(req.body[paths.uploads]);</span></td><td class="action"></td></tr><tr><td class="line">240</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">241</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			uploads.forEach(function(file) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">242</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				item.get(field.path).push(file);</span></td><td class="action"></td></tr><tr><td class="line">243</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			});</span></td><td class="action"></td></tr><tr><td class="line">244</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">245</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (req.files &amp;&amp; req.files[paths.upload]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">246</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var files = _.flatten(req.files[paths.upload]);</span></td><td class="action"></td></tr><tr><td class="line">247</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">248</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var tp = keystone.get('cloudinary prefix') || '';</span></td><td class="action"></td></tr><tr><td class="line">249</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">250</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (tp.length)</span></td><td class="action"></td></tr><tr class="miss"><td class="line">251</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				tp += '_';</span></td><td class="action"></td></tr><tr><td class="line">252</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">253</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var uploadOptions = {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">254</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				tags: [tp + field.list.path + '_' + field.path, tp + field.list.path + '_' + field.path + '_' + item.id]</span></td><td class="action"></td></tr><tr><td class="line">255</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			};</span></td><td class="action"></td></tr><tr><td class="line">256</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">257</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (keystone.get('cloudinary prefix'))</span></td><td class="action"></td></tr><tr class="miss"><td class="line">258</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				uploadOptions.tags.push(keystone.get('cloudinary prefix'));</span></td><td class="action"></td></tr><tr><td class="line">259</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">260</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (keystone.get('env') != 'production')</span></td><td class="action"></td></tr><tr class="miss"><td class="line">261</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				uploadOptions.tags.push(tp + 'dev');</span></td><td class="action"></td></tr><tr><td class="line">262</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">263</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			async.each(files, function(file, next) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">264</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (!file.size) return next();</span></td><td class="action"></td></tr><tr><td class="line">265</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">266</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				cloudinary.uploader.upload(file.path, function(result) {</span></td><td class="action"></td></tr><tr><td class="line">267</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					if (result.error) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">268</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						return next(result.error);</span></td><td class="action"></td></tr><tr><td class="line">269</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">270</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						item.get(field.path).push(result);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">271</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						return next();</span></td><td class="action"></td></tr><tr><td class="line">272</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					}</span></td><td class="action"></td></tr><tr><td class="line">273</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}, uploadOptions);</span></td><td class="action"></td></tr><tr><td class="line">274</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">275</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}, function(err) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">276</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				return callback(err);</span></td><td class="action"></td></tr><tr><td class="line">277</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			});</span></td><td class="action"></td></tr><tr><td class="line">278</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">279</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return callback();</span></td><td class="action"></td></tr><tr><td class="line">280</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">281</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">282</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">283</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">284</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">285</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Immediately handles a standard form submission for the field (see `getRequestHandler()`)</span></td><td class="action"></td></tr><tr><td class="line">286</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">287</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">288</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">289</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">290</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">cloudinaryimages.prototype.handleRequest = function(item, req, paths, callback) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">291</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.getRequestHandler(item, req, paths, callback)();</span></td><td class="action"></td></tr><tr><td class="line">292</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">293</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">294</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">295</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">296</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Export class</span></td><td class="action"></td></tr><tr><td class="line">297</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">298</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">299</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports = module.exports = cloudinaryimages;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/fieldTypes/code.js">lib/fieldTypes/code.js</h2><div class="stats terrible"><div class="percentage">10% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">12% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">0% block coverage</div><div class="sloc">39 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Module dependencies.</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">5</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var util = require('util'),
	super_ = require('../field');</span></td><td class="action"></td></tr><tr><td class="line">6</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">7</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">8</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Code FieldType Constructor</span></td><td class="action"></td></tr><tr><td class="line">9</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @extends Field</span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function code(list, path, options) {</span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">15</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._nativeType = String;</span></td><td class="action"></td></tr><tr><td class="line">16</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">17</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.height = options.height || 180;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">18</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.lang = options.lang;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">19</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.mime = getMime(this.lang);</span></td><td class="action"></td></tr><tr><td class="line">20</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">21</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// TODO: implement initial form, usage disabled for now</span></td><td class="action"></td></tr><tr><td class="line">22</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (options.initial) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('Invalid Configuration\n\n' +</span></td><td class="action"></td></tr><tr><td class="line">24</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">25</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">26</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	code.super_.call(this, list, path, options);</span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">28</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">29</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">30</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">31</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Inherit from Field</span></td><td class="action"></td></tr><tr><td class="line">32</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">33</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">34</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">util.inherits(code, super_);</span></td><td class="action"></td></tr><tr><td class="line">35</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">36</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">37</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">38</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Gets the mime type for the specified language</span></td><td class="action"></td></tr><tr><td class="line">39</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api private</span></td><td class="action"></td></tr><tr><td class="line">40</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">41</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">42</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function getMime(lang) {</span></td><td class="action"></td></tr><tr><td class="line">43</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">44</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var mime;</span></td><td class="action"></td></tr><tr><td class="line">45</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">46</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	switch (lang) {</span></td><td class="action"></td></tr><tr><td class="line">47</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		case 'c':</span></td><td class="action"></td></tr><tr class="miss"><td class="line">48</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			mime = 'text/x-csrc'; break;</span></td><td class="action"></td></tr><tr><td class="line">49</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		case 'c++':</span></td><td class="action"></td></tr><tr><td class="line">50</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		case 'objetivec':</span></td><td class="action"></td></tr><tr class="miss"><td class="line">51</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			mime = 'text/x-c++src'; break;</span></td><td class="action"></td></tr><tr><td class="line">52</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		case 'css':</span></td><td class="action"></td></tr><tr class="miss"><td class="line">53</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			mime = 'text/css'; break;</span></td><td class="action"></td></tr><tr><td class="line">54</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		case 'asp':</span></td><td class="action"></td></tr><tr class="miss"><td class="line">55</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			mime = 'application/x-aspx'; break;</span></td><td class="action"></td></tr><tr><td class="line">56</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		case 'c#':</span></td><td class="action"></td></tr><tr class="miss"><td class="line">57</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			mime = 'text/x-csharp'; break;</span></td><td class="action"></td></tr><tr><td class="line">58</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		case 'vb':</span></td><td class="action"></td></tr><tr class="miss"><td class="line">59</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			mime = 'text/x-vb'; break;</span></td><td class="action"></td></tr><tr><td class="line">60</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		case 'xml':</span></td><td class="action"></td></tr><tr class="miss"><td class="line">61</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			mime = 'text/xml'; break;</span></td><td class="action"></td></tr><tr><td class="line">62</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		case 'php':</span></td><td class="action"></td></tr><tr class="miss"><td class="line">63</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			mime = 'application/x-httpd-php'; break;</span></td><td class="action"></td></tr><tr><td class="line">64</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		case 'html':</span></td><td class="action"></td></tr><tr class="miss"><td class="line">65</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			mime = 'text/html'; break;</span></td><td class="action"></td></tr><tr><td class="line">66</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		case 'ini':</span></td><td class="action"></td></tr><tr class="miss"><td class="line">67</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			mime = 'text/x-properties'; break;</span></td><td class="action"></td></tr><tr><td class="line">68</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		case 'js':</span></td><td class="action"></td></tr><tr class="miss"><td class="line">69</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			mime = 'text/javascript'; break;</span></td><td class="action"></td></tr><tr><td class="line">70</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		case 'java':</span></td><td class="action"></td></tr><tr class="miss"><td class="line">71</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			mime = 'text/x-java'; break;</span></td><td class="action"></td></tr><tr><td class="line">72</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		case 'coffee':</span></td><td class="action"></td></tr><tr class="miss"><td class="line">73</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			mime = 'text/x-coffeescript'; break;</span></td><td class="action"></td></tr><tr><td class="line">74</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		case 'lisp':</span></td><td class="action"></td></tr><tr class="miss"><td class="line">75</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			mime = 'text/x-common-lisp'; break;</span></td><td class="action"></td></tr><tr><td class="line">76</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		case 'perl':</span></td><td class="action"></td></tr><tr class="miss"><td class="line">77</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			mime = 'text/x-perl'; break;</span></td><td class="action"></td></tr><tr><td class="line">78</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		case 'python':</span></td><td class="action"></td></tr><tr class="miss"><td class="line">79</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			mime = 'text/x-python'; break;</span></td><td class="action"></td></tr><tr><td class="line">80</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		case 'sql':</span></td><td class="action"></td></tr><tr class="miss"><td class="line">81</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			mime = 'text/x-sql'; break;</span></td><td class="action"></td></tr><tr><td class="line">82</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		case 'json':</span></td><td class="action"></td></tr><tr class="miss"><td class="line">83</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			mime = 'application/json'; break;</span></td><td class="action"></td></tr><tr><td class="line">84</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		case 'less':</span></td><td class="action"></td></tr><tr class="miss"><td class="line">85</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			mime = 'text/x-less'; break;</span></td><td class="action"></td></tr><tr><td class="line">86</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		case 'sass':</span></td><td class="action"></td></tr><tr class="miss"><td class="line">87</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			mime = 'text/x-sass'; break;</span></td><td class="action"></td></tr><tr><td class="line">88</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		case 'sh':</span></td><td class="action"></td></tr><tr class="miss"><td class="line">89</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			mime = 'text/x-sh'; break;</span></td><td class="action"></td></tr><tr><td class="line">90</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		case 'ruby':</span></td><td class="action"></td></tr><tr class="miss"><td class="line">91</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			mime = 'text/x-ruby'; break;</span></td><td class="action"></td></tr><tr><td class="line">92</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		case 'jsp':</span></td><td class="action"></td></tr><tr class="miss"><td class="line">93</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			mime = 'application/x-jsp'; break;</span></td><td class="action"></td></tr><tr><td class="line">94</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		case 'tpl':</span></td><td class="action"></td></tr><tr class="miss"><td class="line">95</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			mime = 'text/x-smarty'; break;</span></td><td class="action"></td></tr><tr><td class="line">96</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		case 'jade':</span></td><td class="action"></td></tr><tr class="miss"><td class="line">97</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			mime = 'text/x-jade'; break;</span></td><td class="action"></td></tr><tr><td class="line">98</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">99</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">100</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return mime;</span></td><td class="action"></td></tr><tr><td class="line">101</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">102</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">103</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">104</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">105</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">106</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Export class</span></td><td class="action"></td></tr><tr><td class="line">107</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">108</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">109</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports = module.exports = code;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/fieldTypes/color.js">lib/fieldTypes/color.js</h2><div class="stats medium"><div class="percentage">57% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">63% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">0% block coverage</div><div class="sloc">7 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Module dependencies.</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">5</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var util = require('util'),
	super_ = require('../field');</span></td><td class="action"></td></tr><tr><td class="line">6</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">7</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">8</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Color FieldType Constructor</span></td><td class="action"></td></tr><tr><td class="line">9</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @extends Field</span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function color(list, path, options) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">14</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._nativeType = String;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">15</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._underscoreMethods = [];</span></td><td class="action"></td></tr><tr class="miss"><td class="line">16</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	color.super_.call(this, list, path, options);</span></td><td class="action"></td></tr><tr><td class="line">17</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">18</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">19</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">20</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Inherit from Field</span></td><td class="action"></td></tr><tr><td class="line">21</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">22</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">23</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">util.inherits(color, super_);</span></td><td class="action"></td></tr><tr><td class="line">24</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">25</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">26</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Export class</span></td><td class="action"></td></tr><tr><td class="line">28</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">29</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">30</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports = module.exports = color;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/fieldTypes/date.js">lib/fieldTypes/date.js</h2><div class="stats medium"><div class="percentage">60% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">48% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">29% block coverage</div><div class="sloc">43 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Module dependencies.</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">5</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var util = require('util'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">6</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	moment = require('moment'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">7</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	super_ = require('../field');</span></td><td class="action"></td></tr><tr><td class="line">8</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">9</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Date FieldType Constructor</span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @extends Field</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function date(list, path, options) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">16</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	this._nativeType = Date;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">17</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	this._underscoreMethods = ['format', 'moment', 'parse'];</span></td><td class="action"></td></tr><tr><td class="line">18</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit partial"><td class="line">19</td><td class="hits">1</td><td class="statements">75%</td><td class="source"><span class="statement ">	this._formatString = (options.format === false) ?</span><span class="statement notok"><span class="offscreen"> not covered </span>false</span><span class="statement ">: (options.format || 'Do MMM YYYY');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">20</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (this._formatString &amp;&amp; 'string' !== typeof this._formatString) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('FieldType.Date: options.format must be a string.');</span></td><td class="action"></td></tr><tr><td class="line">22</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">23</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">24</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	date.super_.call(this, list, path, options);</span></td><td class="action"></td></tr><tr><td class="line">25</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">26</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">28</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Inherit from Field</span></td><td class="action"></td></tr><tr><td class="line">29</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">30</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">31</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">util.inherits(date, super_);</span></td><td class="action"></td></tr><tr><td class="line">32</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">33</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">34</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">35</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Formats the field value</span></td><td class="action"></td></tr><tr><td class="line">36</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">37</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">38</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">39</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">40</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">date.prototype.format = function(item, format) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">41</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (format || this._formatString) {</span></td><td class="action"></td></tr><tr class="hit partial"><td class="line">42</td><td class="hits">2</td><td class="statements">88%</td><td class="source"><span class="statement ">		return item.get(this.path) ? moment(item.get(this.path)).format(format || this._formatString) :</span><span class="statement notok"><span class="offscreen"> not covered </span>''</span><span class="statement "></span></td><td class="action"></td></tr><tr><td class="line">43</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">44</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return item.get(this.path) || '';</span></td><td class="action"></td></tr><tr><td class="line">45</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">46</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">47</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">48</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">49</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Returns a new `moment` object with the field value</span></td><td class="action"></td></tr><tr><td class="line">50</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">51</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">52</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">53</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">54</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">date.prototype.moment = function(item) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">55</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	return moment(item.get(this.path));</span></td><td class="action"></td></tr><tr><td class="line">56</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">57</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">58</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">59</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">60</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Parses input using moment, sets the value, and returns the moment object.</span></td><td class="action"></td></tr><tr><td class="line">61</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">62</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">63</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">64</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">65</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">date.prototype.parse = function(item) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">66</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	var newValue = moment.apply(moment, Array.prototype.slice.call(arguments, 1));</span></td><td class="action"></td></tr><tr class="hit partial"><td class="line">67</td><td class="hits">1</td><td class="statements">86%</td><td class="source"><span class="statement ">	item.set(this.path, (newValue &amp;&amp; newValue.isValid()) ? newValue.toDate() :</span><span class="statement notok"><span class="offscreen"> not covered </span>null</span><span class="statement ">;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">68</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	return newValue;</span></td><td class="action"></td></tr><tr><td class="line">69</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">70</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">71</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">72</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Checks that a valid date has been provided in a data object</span></td><td class="action"></td></tr><tr><td class="line">73</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">74</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * An empty value clears the stored value and is considered valid</span></td><td class="action"></td></tr><tr><td class="line">75</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">76</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">77</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">78</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">79</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">date.prototype.validateInput = function(data, required, item) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">80</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!(this.path in data) &amp;&amp; item &amp;&amp; item.get(this.path)) return true;</span></td><td class="action"></td></tr><tr><td class="line">81</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">82</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var newValue = moment(data[this.path]);</span></td><td class="action"></td></tr><tr><td class="line">83</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">84</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (required &amp;&amp; (!newValue || !newValue.isValid())) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">85</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return false;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">86</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else if (data[this.path] &amp;&amp; newValue &amp;&amp; !newValue.isValid()) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">87</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return false;</span></td><td class="action"></td></tr><tr><td class="line">88</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">89</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return true;</span></td><td class="action"></td></tr><tr><td class="line">90</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">91</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">92</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">93</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">94</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Updates the value for this field in the item from a data object</span></td><td class="action"></td></tr><tr><td class="line">95</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">96</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">97</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">98</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">99</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">date.prototype.updateItem = function(item, data) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">100</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!(this.path in data))</span></td><td class="action"></td></tr><tr class="miss"><td class="line">101</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return;</span></td><td class="action"></td></tr><tr><td class="line">102</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">103</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var newValue = moment(data[this.path]);</span></td><td class="action"></td></tr><tr><td class="line">104</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">105</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (newValue &amp;&amp; newValue.isValid()) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">106</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (!item.get(this.path) || !newValue.isSame(item.get(this.path))) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">107</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			item.set(this.path, newValue.toDate());</span></td><td class="action"></td></tr><tr><td class="line">108</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">109</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else if (item.get(this.path)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">110</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		item.set(this.path, null);</span></td><td class="action"></td></tr><tr><td class="line">111</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">112</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">113</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">114</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">115</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Export class</span></td><td class="action"></td></tr><tr><td class="line">116</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">117</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">118</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports = module.exports = date;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/fieldTypes/datetime.js">lib/fieldTypes/datetime.js</h2><div class="stats medium"><div class="percentage">68% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">46% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">35% block coverage</div><div class="sloc">54 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Module dependencies.</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">5</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var util = require('util'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">6</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	moment = require('moment'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">7</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	super_ = require('../field');</span></td><td class="action"></td></tr><tr><td class="line">8</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">9</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var parseFormats = ['YYYY-MM-DD', 'YYYY-MM-DD h:m:s a', 'YYYY-MM-DD h:m a', 'YYYY-MM-DD H:m:s', 'YYYY-MM-DD H:m'];</span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * DateTime FieldType Constructor</span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @extends Field</span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">16</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">17</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function datetime(list, path, options) {</span></td><td class="action"></td></tr><tr><td class="line">18</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">19</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">	this._nativeType = Date;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">20</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">	this._underscoreMethods = ['format', 'moment', 'parse'];</span></td><td class="action"></td></tr><tr class="hit "><td class="line">21</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.typeDescription = 'date and time';</span></td><td class="action"></td></tr><tr><td class="line">22</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit partial"><td class="line">23</td><td class="hits">15</td><td class="statements">75%</td><td class="source"><span class="statement ">	this._formatString = (options.format === false) ?</span><span class="statement notok"><span class="offscreen"> not covered </span>false</span><span class="statement ">: (options.format || 'Do MMM YYYY hh:mm:ss a');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">24</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (this._formatString &amp;&amp; 'string' !== typeof this._formatString) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">25</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('FieldType.DateTime: options.format must be a string.');</span></td><td class="action"></td></tr><tr><td class="line">26</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">28</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">	datetime.super_.call(this, list, path, options);</span></td><td class="action"></td></tr><tr><td class="line">29</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">30</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.paths = {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">31</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">		date: this._path.append('_date'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">32</td><td class="hits">15</td><td class="statements">100%</td><td class="source"><span class="statement ">		time: this._path.append('_time')</span></td><td class="action"></td></tr><tr><td class="line">33</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">34</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">35</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">36</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">37</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">38</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Inherit from Field</span></td><td class="action"></td></tr><tr><td class="line">39</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">40</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">41</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">util.inherits(datetime, super_);</span></td><td class="action"></td></tr><tr><td class="line">42</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">43</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">44</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">45</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Formats the field value</span></td><td class="action"></td></tr><tr><td class="line">46</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">47</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">48</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr class="hit "><td class="line">49</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">datetime.prototype.format = function(item, format) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">50</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (format || this._formatString) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">51</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return item.get(this.path) ? moment(item.get(this.path)).format(format || this._formatString) : '';</span></td><td class="action"></td></tr><tr><td class="line">52</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">53</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return item.get(this.path) || '';</span></td><td class="action"></td></tr><tr><td class="line">54</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">55</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">56</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">57</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">58</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Returns a new `moment` object with the field value</span></td><td class="action"></td></tr><tr><td class="line">59</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">60</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">61</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">62</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">63</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">datetime.prototype.moment = function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">64</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return moment(item.get(this.path));</span></td><td class="action"></td></tr><tr><td class="line">65</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">66</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">67</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">68</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">69</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Parses input using moment, sets the value, and returns the moment object.</span></td><td class="action"></td></tr><tr><td class="line">70</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">71</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">72</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">73</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">74</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">datetime.prototype.parse = function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">75</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var newValue = moment.apply(moment, Array.prototype.slice.call(arguments, 1));</span></td><td class="action"></td></tr><tr class="miss"><td class="line">76</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	item.set(this.path, (newValue &amp;&amp; newValue.isValid()) ? newValue.toDate() : null);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">77</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return newValue;</span></td><td class="action"></td></tr><tr><td class="line">78</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">79</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">80</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">81</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">82</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Get the value from a data object; may be simple or a pair of fields</span></td><td class="action"></td></tr><tr><td class="line">83</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">84</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api private</span></td><td class="action"></td></tr><tr><td class="line">85</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">86</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">87</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">datetime.prototype.getInputFromData = function(data) {</span></td><td class="action"></td></tr><tr class="hit partial"><td class="line">88</td><td class="hits">28</td><td class="statements">60%</td><td class="source"><span class="statement ">	if (this.paths.date in data &amp;&amp;</span><span class="statement notok"><span class="offscreen"> not covered </span>this.paths.time in data</span><span class="statement "> {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">89</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return (data[this.paths.date] + ' ' + data[this.paths.time]).trim();</span></td><td class="action"></td></tr><tr><td class="line">90</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">91</td><td class="hits">28</td><td class="statements">100%</td><td class="source"><span class="statement ">		return data[this.path];</span></td><td class="action"></td></tr><tr><td class="line">92</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">93</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">94</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">95</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">96</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Checks that a valid date has been provided in a data object</span></td><td class="action"></td></tr><tr><td class="line">97</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">98</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * An empty value clears the stored value and is considered valid</span></td><td class="action"></td></tr><tr><td class="line">99</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">100</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">101</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">102</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">103</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">datetime.prototype.validateInput = function(data, required, item) {
</span></td><td class="action"></td></tr><tr class="hit partial"><td class="line">104</td><td class="hits">14</td><td class="statements">47%</td><td class="source"><span class="statement ">	if (!(this.path in data &amp;&amp;</span><span class="statement notok"><span class="offscreen"> not covered </span>!(this.paths.date in data &amp;&amp; this.paths.time in data)</span><span class="statement "> &amp;&amp; item &amp;&amp;</span><span class="statement notok"><span class="offscreen"> not covered </span>item.get(this.path)</span><span class="statement "></span><span class="statement notok"><span class="offscreen"> not covered </span>return true;</span></td><td class="action"></td></tr><tr><td class="line">105</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">106</td><td class="hits">14</td><td class="statements">100%</td><td class="source"><span class="statement ">	var newValue = moment(this.getInputFromData(data), parseFormats);</span></td><td class="action"></td></tr><tr><td class="line">107</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit partial"><td class="line">108</td><td class="hits">14</td><td class="statements">29%</td><td class="source"><span class="statement ">	if (required &amp;&amp; </span><span class="statement notok"><span class="offscreen"> not covered </span>!newValue || !newValue.isValid()</span><span class="statement ">) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">109</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return false;</span></td><td class="action"></td></tr><tr class="hit partial"><td class="line">110</td><td class="hits">14</td><td class="statements">50%</td><td class="source"><span class="statement ">	} else if (this.getInputFromData(data) &amp;&amp;</span><span class="statement notok"><span class="offscreen"> not covered </span>newValue</span><span class="statement ">&amp;&amp;</span><span class="statement notok"><span class="offscreen"> not covered </span>!newValue.isValid()</span><span class="statement "> {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">111</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return false;</span></td><td class="action"></td></tr><tr><td class="line">112</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">113</td><td class="hits">14</td><td class="statements">100%</td><td class="source"><span class="statement ">		return true;</span></td><td class="action"></td></tr><tr><td class="line">114</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">115</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">116</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">117</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">118</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Updates the value for this field in the item from a data object</span></td><td class="action"></td></tr><tr><td class="line">119</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">120</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">121</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">122</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">123</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">datetime.prototype.updateItem = function(item, data) {
</span></td><td class="action"></td></tr><tr class="hit partial"><td class="line">124</td><td class="hits">14</td><td class="statements">78%</td><td class="source"><span class="statement ">	if (!(this.path in data || (this.paths.date in data &amp;&amp;</span><span class="statement notok"><span class="offscreen"> not covered </span>this.paths.time in data</span><span class="statement ">))</span></td><td class="action"></td></tr><tr class="hit "><td class="line">125</td><td class="hits">14</td><td class="statements">100%</td><td class="source"><span class="statement ">		return;</span></td><td class="action"></td></tr><tr><td class="line">126</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">127</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var newValue = moment(this.getInputFromData(data), parseFormats);</span></td><td class="action"></td></tr><tr><td class="line">128</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">129</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (newValue &amp;&amp; newValue.isValid()) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">130</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (!item.get(this.path) || !newValue.isSame(item.get(this.path))) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">131</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			item.set(this.path, newValue.toDate());</span></td><td class="action"></td></tr><tr><td class="line">132</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">133</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else if (item.get(this.path)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">134</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		item.set(this.path, null);</span></td><td class="action"></td></tr><tr><td class="line">135</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">136</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">137</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">138</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">139</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Export class</span></td><td class="action"></td></tr><tr><td class="line">140</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">141</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">142</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports = module.exports = datetime;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/fieldTypes/email.js">lib/fieldTypes/email.js</h2><div class="stats low"><div class="percentage">37% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">20% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">0% block coverage</div><div class="sloc">32 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Module dependencies.</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">5</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var util = require('util'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">6</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	utils = require('keystone-utils'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">7</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	super_ = require('../field'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">8</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	crypto = require('crypto');</span></td><td class="action"></td></tr><tr><td class="line">9</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Email FieldType Constructor</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @extends Field</span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">16</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function email(list, path, options) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">17</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._nativeType = String;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">18</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._underscoreMethods = ['gravatarUrl'];</span></td><td class="action"></td></tr><tr class="miss"><td class="line">19</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.typeDescription = 'email address';</span></td><td class="action"></td></tr><tr class="miss"><td class="line">20</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	email.super_.call(this, list, path, options);</span></td><td class="action"></td></tr><tr><td class="line">21</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">22</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">23</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">24</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Inherit from Field</span></td><td class="action"></td></tr><tr><td class="line">25</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">26</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">27</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">util.inherits(email, super_);</span></td><td class="action"></td></tr><tr><td class="line">28</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">29</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">30</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">31</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Validates that a valid email has been provided in a data object</span></td><td class="action"></td></tr><tr><td class="line">32</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">33</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">34</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">35</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">36</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">email.prototype.validateInput = function(data, required, item) {
	if (data[this.path]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return utils.isEmail(data[this.path]);</span></td><td class="action"></td></tr><tr><td class="line">38</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">39</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return (!required || (!(this.path in data) &amp;&amp; item &amp;&amp; item.get(this.path))) ? true : false;</span></td><td class="action"></td></tr><tr><td class="line">40</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">41</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">42</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">43</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">44</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Updates the value for this field in the item from a data object</span></td><td class="action"></td></tr><tr><td class="line">45</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Ensures that the email address is lowercase</span></td><td class="action"></td></tr><tr><td class="line">46</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">47</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">48</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">49</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">50</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">email.prototype.updateItem = function(item, data) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">51</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var newValue = data[this.path];</span></td><td class="action"></td></tr><tr><td class="line">52</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">53</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if ('string' === typeof newValue) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">54</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		newValue = newValue.toLowerCase();</span></td><td class="action"></td></tr><tr><td class="line">55</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">56</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (this.path in data &amp;&amp; data[this.path] !== item.get(this.path)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">57</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		item.set(this.path, data[this.path]);</span></td><td class="action"></td></tr><tr><td class="line">58</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">59</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">60</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">61</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">62</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Generate a gravatar image request url</span></td><td class="action"></td></tr><tr><td class="line">63</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">64</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">65</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr class="hit "><td class="line">66</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">email.prototype.gravatarUrl = function(item, size, defaultImage, rating) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">67</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var value = item.get(this.path);</span></td><td class="action"></td></tr><tr><td class="line">68</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">69</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if ('string' !== typeof value) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">70</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return '';</span></td><td class="action"></td></tr><tr><td class="line">71</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">72</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return [</span></td><td class="action"></td></tr><tr class="miss"><td class="line">73</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		crypto.createHash('md5').update(value.toLowerCase().trim()).digest('hex'),</span></td><td class="action"></td></tr><tr><td class="line">74</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">75</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		// size of images ranging from 1 to 2048 pixels, square</span></td><td class="action"></td></tr><tr class="miss"><td class="line">76</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		'?s=' + (/^(?:[1-9][0-9]{0,2}|1[0-9]{3}|20[0-3][0-9]|204[0-8])$/.test(size) ? size : 80),</span></td><td class="action"></td></tr><tr><td class="line">77</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">78</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		// default image url encoded href or one of the built in options: 404, mm, identicon, monsterid, wavatar, retro, blank</span></td><td class="action"></td></tr><tr class="miss"><td class="line">79</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		'&amp;d=' + (defaultImage ? encodeURIComponent(defaultImage) : 'identicon'),</span></td><td class="action"></td></tr><tr><td class="line">80</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">81</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		// rating, g, pg, r or x</span></td><td class="action"></td></tr><tr class="miss"><td class="line">82</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		'&amp;r=' + (/^(?:g|pg|r|x)$/i.test(rating) ? rating.toLowerCase() : 'g')</span></td><td class="action"></td></tr><tr><td class="line">83</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	].join('');</span></td><td class="action"></td></tr><tr><td class="line">84</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">85</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">86</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">87</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Export class</span></td><td class="action"></td></tr><tr><td class="line">88</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">89</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">90</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports = module.exports = email;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/fieldTypes/embedly.js">lib/fieldTypes/embedly.js</h2><div class="stats terrible"><div class="percentage">20% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">12% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">0% block coverage</div><div class="sloc">94 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Module dependencies.</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">5</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var _ = require('underscore'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">6</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	keystone = require('../../'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">7</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	util = require('util'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">8</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	EmbedlyAPI = require('embedly'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">9</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	super_ = require('../field');</span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Embedly FieldType Constructor</span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Reqires the option `from` to refer to another path in the schema</span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * that provides the url to expand</span></td><td class="action"></td></tr><tr><td class="line">16</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">17</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @extends Field</span></td><td class="action"></td></tr><tr><td class="line">18</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">19</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">20</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">21</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function embedly(list, path, options) {</span></td><td class="action"></td></tr><tr><td class="line">22</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._underscoreMethods = ['reset'];</span></td><td class="action"></td></tr><tr class="miss"><td class="line">24</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.fromPath = options.from;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">25</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.embedlyOptions = options.options || {};</span></td><td class="action"></td></tr><tr><td class="line">26</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// TODO: implement filtering, usage disabled for now</span></td><td class="action"></td></tr><tr class="miss"><td class="line">28</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	options.nofilter = true;</span></td><td class="action"></td></tr><tr><td class="line">29</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">30</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// check and api key has been set, or bail.</span></td><td class="action"></td></tr><tr class="miss"><td class="line">31</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!keystone.get('embedly api key')) {</span></td><td class="action"></td></tr><tr><td class="line">32</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('Invalid Configuration\n\n' +</span></td><td class="action"></td></tr><tr class="miss"><td class="line">33</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			'Embedly fields (' + list.key + '.' + this.path + ') require the &quot;embedly api key&quot; option to be set.\n\n' +</span></td><td class="action"></td></tr><tr class="miss"><td class="line">34</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			'See http://keystonejs.com/docs/configuration/#embedly for more information.\n');</span></td><td class="action"></td></tr><tr><td class="line">35</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">36</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">37</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// ensure a fromPath has been defined</span></td><td class="action"></td></tr><tr class="miss"><td class="line">38</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!options.from) {</span></td><td class="action"></td></tr><tr><td class="line">39</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('Invalid Configuration\n\n' +</span></td><td class="action"></td></tr><tr class="miss"><td class="line">40</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			'Embedly fields (' + list.key + '.' + path + ') require a fromPath option to be set.\n' +</span></td><td class="action"></td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			'See http://keystonejs.com/docs/database/#field_embedly for more information.\n');</span></td><td class="action"></td></tr><tr><td class="line">42</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">43</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">44</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// embedly fields cannot be set as initial fields</span></td><td class="action"></td></tr><tr><td class="line">45</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (options.initial) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">46</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('Invalid Configuration\n\n' +</span></td><td class="action"></td></tr><tr><td class="line">47</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">48</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">49</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	embedly.super_.call(this, list, path, options);</span></td><td class="action"></td></tr><tr><td class="line">50</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">51</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">52</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">53</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">54</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Inherit from Field</span></td><td class="action"></td></tr><tr><td class="line">55</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">56</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">57</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">util.inherits(embedly, super_);</span></td><td class="action"></td></tr><tr><td class="line">58</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">59</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">60</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">61</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Registers the field on the List's Mongoose Schema.</span></td><td class="action"></td></tr><tr><td class="line">62</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">63</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">64</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">65</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">66</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">embedly.prototype.addToSchema = function() {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">67</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var field = this,</span></td><td class="action"></td></tr><tr><td class="line">68</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">69</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.paths = {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">70</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		exists: 				this._path.append('.exists'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">71</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		type: 					this._path.append('.type'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">72</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		title: 					this._path.append('.title'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">73</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		url: 					this._path.append('.url'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">74</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		width: 					this._path.append('.width'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">75</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		height: 				this._path.append('.height'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">76</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		version: 				this._path.append('.version'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">77</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		description: 			this._path.append('.description'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">78</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		html: 					this._path.append('.html'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">79</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		authorName: 			this._path.append('.authorName'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">80</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		authorUrl: 				this._path.append('.authorUrl'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">81</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		providerName: 			this._path.append('.providerName'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">82</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		providerUrl: 			this._path.append('.providerUrl'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">83</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		thumbnailUrl: 			this._path.append('.thumbnailUrl'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">84</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		thumbnailWidth: 		this._path.append('.thumbnailWidth'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">85</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		thumbnailHeight: 		this._path.append('.thumbnailHeight')</span></td><td class="action"></td></tr><tr><td class="line">86</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">87</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">88</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	schema.nested[this.path] = true;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">89</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	schema.add({</span></td><td class="action"></td></tr><tr><td class="line">90</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		exists: 				Boolean,</span></td><td class="action"></td></tr><tr class="miss"><td class="line">91</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	schema.pre('save', function(next) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">92</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (!this.isModified(field.fromPath)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">93</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return next();</span></td><td class="action"></td></tr><tr><td class="line">94</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">95</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">96</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var fromValue = this.get(field.fromPath);</span></td><td class="action"></td></tr><tr><td class="line">97</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">98</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (!fromValue) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">99</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			field.reset(this);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">100</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return next();</span></td><td class="action"></td></tr><tr><td class="line">101</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">102</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var post = this;</span></td><td class="action"></td></tr><tr><td class="line">103</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">104</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		new EmbedlyAPI({ key: keystone.get('embedly api key') }, function(err, api) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">105</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (err) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">106</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				console.error('Error creating Embedly api:');</span></td><td class="action"></td></tr><tr class="miss"><td class="line">107</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				console.error(err, api);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">108</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				field.reset(this);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">109</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				return next();</span></td><td class="action"></td></tr><tr><td class="line">110</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">111</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var opts = _.defaults({ url: fromValue }, field.embedlyOptions);</span></td><td class="action"></td></tr><tr><td class="line">112</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">113</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			api.oembed(opts, function(err, objs) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">114</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (err) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">115</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					console.error('Embedly API Error:');</span></td><td class="action"></td></tr><tr class="miss"><td class="line">116</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					console.error(err, objs);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">117</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					field.reset(post);</span></td><td class="action"></td></tr><tr><td class="line">118</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">119</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					var data = objs[0];</span></td><td class="action"></td></tr><tr class="miss"><td class="line">120</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					if (data &amp;&amp; data.type !== 'error') {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">121</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						post.set(field.path, {</span></td><td class="action"></td></tr><tr><td class="line">122</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							exists: 			true,</span></td><td class="action"></td></tr><tr><td class="line">123</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							type: 				data.type,</span></td><td class="action"></td></tr><tr class="miss"><td class="line">124</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						field.reset(post);</span></td><td class="action"></td></tr><tr><td class="line">125</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">126</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				return next();</span></td><td class="action"></td></tr><tr><td class="line">127</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">128</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		});</span></td><td class="action"></td></tr><tr><td class="line">129</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">130</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">131</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.bindUnderscoreMethods();</span></td><td class="action"></td></tr><tr><td class="line">132</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">133</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">134</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">135</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">136</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Resets the value of the field</span></td><td class="action"></td></tr><tr><td class="line">137</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">138</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">139</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">140</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">141</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">embedly.prototype.reset = function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">142</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return item.set(item.set(this.path, {</span></td><td class="action"></td></tr><tr><td class="line">143</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">144</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">145</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">146</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">147</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Formats the field value</span></td><td class="action"></td></tr><tr><td class="line">148</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">149</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">150</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">151</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">152</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">embedly.prototype.format = function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">153</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return item.get(this.paths.html);</span></td><td class="action"></td></tr><tr><td class="line">154</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">155</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">156</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">157</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">158</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Detects whether the field has been modified</span></td><td class="action"></td></tr><tr><td class="line">159</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">160</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">161</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">162</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">163</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">embedly.prototype.isModified = function(item) {
	// Assume that it has changed if the url is different</span></td><td class="action"></td></tr><tr class="miss"><td class="line">164</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return item.isModified(this.paths.url);</span></td><td class="action"></td></tr><tr><td class="line">165</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">166</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">167</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">168</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">169</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Validates that a value for this field has been provided in a data object</span></td><td class="action"></td></tr><tr><td class="line">170</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">171</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">172</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">173</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">174</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">embedly.prototype.validateInput = function(data) {
	// TODO: I don't think embedly fields need to be validated...</span></td><td class="action"></td></tr><tr class="miss"><td class="line">175</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return true;</span></td><td class="action"></td></tr><tr><td class="line">176</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">177</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">178</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">179</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">180</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Updates the value for this field in the item from a data object</span></td><td class="action"></td></tr><tr><td class="line">181</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">182</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">183</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">184</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">185</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">embedly.prototype.updateItem = function(item, data) {
	// TODO: This could be more granular and check for actual changes to values,
	// see the Location field for an example</span></td><td class="action"></td></tr><tr class="miss"><td class="line">186</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return item.set(item.set(this.path, {</span></td><td class="action"></td></tr><tr><td class="line">187</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">188</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">189</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">190</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">191</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Export class</span></td><td class="action"></td></tr><tr><td class="line">192</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">193</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">194</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports = module.exports = embedly;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/fieldTypes/html.js">lib/fieldTypes/html.js</h2><div class="stats low"><div class="percentage">44% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">43% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">0% block coverage</div><div class="sloc">9 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Module dependencies.</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">5</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var util = require('util'),
	super_ = require('../field');</span></td><td class="action"></td></tr><tr><td class="line">6</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">7</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">8</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * HTML FieldType Constructor</span></td><td class="action"></td></tr><tr><td class="line">9</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @extends Field</span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function html(list, path, options) {</span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">15</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._nativeType = String;</span></td><td class="action"></td></tr><tr><td class="line">16</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">17</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// TODO: implement filtering, usage disabled for now</span></td><td class="action"></td></tr><tr class="miss"><td class="line">18</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	options.nofilter = true;</span></td><td class="action"></td></tr><tr><td class="line">19</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">20</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.wysiwyg = (options.wysiwyg) ? true : false;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.height = options.height || 180;</span></td><td class="action"></td></tr><tr><td class="line">22</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	html.super_.call(this, list, path, options);</span></td><td class="action"></td></tr><tr><td class="line">24</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">25</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">26</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">28</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Inherit from Field</span></td><td class="action"></td></tr><tr><td class="line">29</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">30</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">31</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">util.inherits(html, super_);</span></td><td class="action"></td></tr><tr><td class="line">32</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">33</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">34</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">35</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Export class</span></td><td class="action"></td></tr><tr><td class="line">36</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">37</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">38</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports = module.exports = html;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/fieldTypes/key.js">lib/fieldTypes/key.js</h2><div class="stats low"><div class="percentage">47% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">29% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">0% block coverage</div><div class="sloc">23 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Module dependencies.</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">5</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var util = require('util'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">6</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	utils = require('keystone-utils'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">7</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	super_ = require('../field');</span></td><td class="action"></td></tr><tr><td class="line">8</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">9</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Key FieldType Constructor</span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @extends Field</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function key(list, path, options) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">16</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._nativeType = String;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">17</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.separator = options.separator || '-';</span></td><td class="action"></td></tr><tr class="miss"><td class="line">18</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	key.super_.call(this, list, path, options);</span></td><td class="action"></td></tr><tr><td class="line">19</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">20</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">21</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">22</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Inherit from Field</span></td><td class="action"></td></tr><tr><td class="line">23</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">24</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">25</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">util.inherits(key, super_);</span></td><td class="action"></td></tr><tr><td class="line">26</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">28</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">29</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Generates a valid key from a string</span></td><td class="action"></td></tr><tr><td class="line">30</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">31</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">32</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">33</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">34</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">key.prototype.generateKey = function(str) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return utils.slug(String(str), this.separator);</span></td><td class="action"></td></tr><tr><td class="line">36</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">37</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">38</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">39</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">40</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Checks that a valid key has been provided in a data object</span></td><td class="action"></td></tr><tr><td class="line">41</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">42</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">43</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">44</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">45</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">key.prototype.validateInput = function(data, required, item) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">46</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!(this.path in data) &amp;&amp; item &amp;&amp; item.get(this.path)) return true;</span></td><td class="action"></td></tr><tr><td class="line">47</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">48</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var newValue = this.generateKey(data[this.path]);</span></td><td class="action"></td></tr><tr><td class="line">49</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">50</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return (newValue || !required);</span></td><td class="action"></td></tr><tr><td class="line">51</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">52</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">53</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">54</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">55</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Updates the value for this field in the item from a data object</span></td><td class="action"></td></tr><tr><td class="line">56</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">57</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">58</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">59</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">60</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">key.prototype.updateItem = function(item, data) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">61</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!(this.path in data)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">62</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return;</span></td><td class="action"></td></tr><tr><td class="line">63</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">64</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var newValue = this.generateKey(data[this.path]);</span></td><td class="action"></td></tr><tr><td class="line">65</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">66</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (item.get(this.path) !== newValue) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">67</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		item.set(this.path, newValue);</span></td><td class="action"></td></tr><tr><td class="line">68</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">69</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">70</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">71</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">72</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Export class</span></td><td class="action"></td></tr><tr><td class="line">73</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">74</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">75</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports = module.exports = key;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/fieldTypes/localfile.js">lib/fieldTypes/localfile.js</h2><div class="stats terrible"><div class="percentage">21% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">12% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">0% block coverage</div><div class="sloc">158 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Module dependencies.</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">5</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var fs = require('fs'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">6</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	path = require('path'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">7</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	_ = require('underscore'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">8</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	moment = require('moment'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">9</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	async = require('async'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">10</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	util = require('util'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">11</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	utils = require('keystone-utils'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">12</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	super_ = require('../field');</span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * localfile FieldType Constructor</span></td><td class="action"></td></tr><tr><td class="line">16</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @extends Field</span></td><td class="action"></td></tr><tr><td class="line">17</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">18</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">19</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">20</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function localfile(list, path, options) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._underscoreMethods = ['format', 'uploadFile'];</span></td><td class="action"></td></tr><tr><td class="line">22</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">23</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// event queues</span></td><td class="action"></td></tr><tr class="miss"><td class="line">24</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._pre = {</span></td><td class="action"></td></tr><tr><td class="line">25</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">26</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._post = {</span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">28</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// TODO: implement filtering, usage disabled for now</span></td><td class="action"></td></tr><tr class="miss"><td class="line">29</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	options.nofilter = true;</span></td><td class="action"></td></tr><tr><td class="line">30</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">31</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// TODO: implement initial form, usage disabled for now</span></td><td class="action"></td></tr><tr><td class="line">32</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (options.initial) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">33</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('Invalid Configuration\n\n' +</span></td><td class="action"></td></tr><tr><td class="line">34</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">35</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	localfile.super_.call(this, list, path, options);</span></td><td class="action"></td></tr><tr><td class="line">37</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">38</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// validate destination dir</span></td><td class="action"></td></tr><tr class="miss"><td class="line">39</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!options.dest) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">40</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('Invalid Configuration\n\n' +</span></td><td class="action"></td></tr><tr><td class="line">41</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">42</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">43</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Allow hook into before and after</span></td><td class="action"></td></tr><tr class="miss"><td class="line">44</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (options.pre &amp;&amp; options.pre.move) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">45</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		this._pre.move = this._pre.move.concat(options.pre.move);</span></td><td class="action"></td></tr><tr><td class="line">46</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">47</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">48</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (options.post &amp;&amp; options.post.move) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">49</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		this._post.move = this._post.move.concat(options.post.move);</span></td><td class="action"></td></tr><tr><td class="line">50</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">51</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">52</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">53</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">54</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Inherit from Field</span></td><td class="action"></td></tr><tr><td class="line">55</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">56</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">57</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">util.inherits(localfile, super_);</span></td><td class="action"></td></tr><tr><td class="line">58</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">59</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">60</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">61</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Allows you to add pre middleware after the field has been initialised</span></td><td class="action"></td></tr><tr><td class="line">62</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">63</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">64</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">65</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">66</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">localfile.prototype.pre = function(event, fn) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">67</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!this._pre[event]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">68</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('localfile (' + this.list.key + '.' + this.path + ') error: localfile.pre()\n\n' +</span></td><td class="action"></td></tr><tr><td class="line">69</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">70</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._pre[event].push(fn);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">71</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return this;</span></td><td class="action"></td></tr><tr><td class="line">72</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">73</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">74</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">75</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">76</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Allows you to add post middleware after the field has been initialised</span></td><td class="action"></td></tr><tr><td class="line">77</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">78</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">79</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">80</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">81</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">localfile.prototype.post = function(event, fn) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">82</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!this._post[event]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">83</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('localfile (' + this.list.key + '.' + this.path + ') error: localfile.post()\n\n' +</span></td><td class="action"></td></tr><tr><td class="line">84</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">85</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._post[event].push(fn);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">86</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return this;</span></td><td class="action"></td></tr><tr><td class="line">87</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">88</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">89</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">90</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">91</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Registers the field on the List's Mongoose Schema.</span></td><td class="action"></td></tr><tr><td class="line">92</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">93</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">94</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">95</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">96</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">localfile.prototype.addToSchema = function() {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">97</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var field = this,</span></td><td class="action"></td></tr><tr><td class="line">98</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">99</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var paths = this.paths = {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">100</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		filename:		this._path.append('.filename'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">101</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		path:			this._path.append('.path'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">102</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		size:			this._path.append('.size'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">103</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		filetype:		this._path.append('.filetype'),</span></td><td class="action"></td></tr><tr><td class="line">104</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		// virtuals</span></td><td class="action"></td></tr><tr class="miss"><td class="line">105</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		exists:			this._path.append('.exists'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">106</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		upload:			this._path.append('_upload'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">107</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		action:			this._path.append('_action')</span></td><td class="action"></td></tr><tr><td class="line">108</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">109</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">110</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var schemaPaths = this._path.addTo({}, {</span></td><td class="action"></td></tr><tr><td class="line">111</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">112</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	schema.add(schemaPaths);</span></td><td class="action"></td></tr><tr><td class="line">113</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">114</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var exists = function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">115</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var filepath = item.get(paths.path),</span></td><td class="action"></td></tr><tr><td class="line">116</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">117</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (!filepath || !filename) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">118</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return false;</span></td><td class="action"></td></tr><tr><td class="line">119</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">120</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return fs.existsSync(path.join(filepath, filename));</span></td><td class="action"></td></tr><tr><td class="line">121</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">122</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">123</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// The .exists virtual indicates whether a file is stored</span></td><td class="action"></td></tr><tr class="miss"><td class="line">124</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	schema.virtual(paths.exists).get(function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">125</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return schemaMethods.exists.apply(this);</span></td><td class="action"></td></tr><tr><td class="line">126</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">127</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">128</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var reset = function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">129</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		item.set(field.path, {</span></td><td class="action"></td></tr><tr><td class="line">130</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">131</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">132</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var schemaMethods = {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">133</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return exists(this);</span></td><td class="action"></td></tr><tr><td class="line">134</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		},</span></td><td class="action"></td></tr><tr class="miss"><td class="line">135</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			reset(this);</span></td><td class="action"></td></tr><tr><td class="line">136</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		},</span></td><td class="action"></td></tr><tr class="miss"><td class="line">137</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (exists(this)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">138</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				fs.unlinkSync(path.join(this.get(paths.path), this.get(paths.filename)));</span></td><td class="action"></td></tr><tr><td class="line">139</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">140</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			reset(this);</span></td><td class="action"></td></tr><tr><td class="line">141</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">142</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">143</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	_.each(schemaMethods, function(fn, key) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">144</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		field.underscoreMethod(key, fn);</span></td><td class="action"></td></tr><tr><td class="line">145</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">146</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">147</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// expose a method on the field to call schema methods</span></td><td class="action"></td></tr><tr class="miss"><td class="line">148</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.apply = function(item, method) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">149</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return schemaMethods[method].apply(item, Array.prototype.slice.call(arguments, 2));</span></td><td class="action"></td></tr><tr><td class="line">150</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">151</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">152</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.bindUnderscoreMethods();</span></td><td class="action"></td></tr><tr><td class="line">153</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">154</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">155</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">156</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">157</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Formats the field value</span></td><td class="action"></td></tr><tr><td class="line">158</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">159</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Delegates to the options.format function if it exists.</span></td><td class="action"></td></tr><tr><td class="line">160</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">161</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">162</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">163</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">localfile.prototype.format = function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">164</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (this.hasFormatter()) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">165</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return this.options.format(item, item[this.path]);</span></td><td class="action"></td></tr><tr><td class="line">166</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">167</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return this.href(item);</span></td><td class="action"></td></tr><tr><td class="line">168</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">169</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">170</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">171</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">172</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Detects the field have formatter function</span></td><td class="action"></td></tr><tr><td class="line">173</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">174</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">175</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">176</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">177</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">localfile.prototype.hasFormatter = function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">178</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return 'function' === typeof this.options.format;</span></td><td class="action"></td></tr><tr><td class="line">179</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">180</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">181</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">182</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">183</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Return objects href</span></td><td class="action"></td></tr><tr><td class="line">184</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">185</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">186</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">187</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">188</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">localfile.prototype.href = function(item) {
	if (this.options.prefix) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">189</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return this.options.prefix + '/' + item.get(this.paths.filename);</span></td><td class="action"></td></tr><tr><td class="line">190</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">191</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return path.join(item.get(this.paths.path), item.get(this.paths.filename));</span></td><td class="action"></td></tr><tr><td class="line">192</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">193</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">194</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">195</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">196</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Detects whether the field has been modified</span></td><td class="action"></td></tr><tr><td class="line">197</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">198</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">199</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">200</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">201</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">localfile.prototype.isModified = function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">202</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return item.isModified(this.paths.path);</span></td><td class="action"></td></tr><tr><td class="line">203</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">204</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">205</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">206</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">207</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Validates that a value for this field has been provided in a data object</span></td><td class="action"></td></tr><tr><td class="line">208</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">209</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">210</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">211</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">212</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">localfile.prototype.validateInput = function(data) {
	// TODO - how should file field input be validated?</span></td><td class="action"></td></tr><tr class="miss"><td class="line">213</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return true;</span></td><td class="action"></td></tr><tr><td class="line">214</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">215</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">216</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">217</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">218</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Updates the value for this field in the item from a data object</span></td><td class="action"></td></tr><tr><td class="line">219</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">220</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">221</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">222</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">223</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">localfile.prototype.updateItem = function(item, data) {
	// TODO - direct updating of data (not via upload)
};</span></td><td class="action"></td></tr><tr><td class="line">224</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">225</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">226</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">227</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Uploads the file for this field</span></td><td class="action"></td></tr><tr><td class="line">228</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">229</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">230</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">231</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">232</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">localfile.prototype.uploadFile = function(item, file, update, callback) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">233</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var field = this,</span></td><td class="action"></td></tr><tr class="miss"><td class="line">234</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		prefix = field.options.datePrefix ? moment().format(field.options.datePrefix) + '-' : '',</span></td><td class="action"></td></tr><tr class="miss"><td class="line">235</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		name = prefix + file.name;</span></td><td class="action"></td></tr><tr><td class="line">236</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">237</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (field.options.allowedTypes &amp;&amp; !_.contains(field.options.allowedTypes, file.type)){</span></td><td class="action"></td></tr><tr class="miss"><td class="line">238</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return callback(new Error('Unsupported File Type: '+file.type));</span></td><td class="action"></td></tr><tr><td class="line">239</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">240</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if ('function' === typeof update) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">241</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		callback = update;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">242</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		update = false;</span></td><td class="action"></td></tr><tr><td class="line">243</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">244</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var doMove = function(callback) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">245</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if ('function' === typeof field.options.filename) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">246</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			name = field.options.filename(item, name);</span></td><td class="action"></td></tr><tr><td class="line">247</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">248</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		fs.rename(file.path, path.join(field.options.dest, name), function(err) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">249</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (err) return callback(err);</span></td><td class="action"></td></tr><tr><td class="line">250</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">251</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var fileData = {</span></td><td class="action"></td></tr><tr><td class="line">252</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				filename: name,</span></td><td class="action"></td></tr><tr><td class="line">253</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">254</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (update) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">255</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				item.set(field.path, fileData);</span></td><td class="action"></td></tr><tr><td class="line">256</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">257</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			callback(null, fileData);</span></td><td class="action"></td></tr><tr><td class="line">258</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			</span></td><td class="action"></td></tr><tr><td class="line">259</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">260</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">261</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	async.eachSeries(this._pre.move, function(fn, next) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">262</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		fn(item, file, next);</span></td><td class="action"></td></tr><tr><td class="line">263</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}, function(err) {</span></td><td class="action"></td></tr><tr><td class="line">264</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">265</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (err) return callback(err);</span></td><td class="action"></td></tr><tr><td class="line">266</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">267</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		doMove(function(err, fileData) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">268</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (err) return callback(err);</span></td><td class="action"></td></tr><tr><td class="line">269</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">270</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			async.eachSeries(field._post.move, function(fn, next) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">271</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				fn(item, file, fileData, next);</span></td><td class="action"></td></tr><tr><td class="line">272</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}, function(err) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">273</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (err) return callback(err);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">274</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				callback(null, fileData);</span></td><td class="action"></td></tr><tr><td class="line">275</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			});</span></td><td class="action"></td></tr><tr><td class="line">276</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		});</span></td><td class="action"></td></tr><tr><td class="line">277</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr><td class="line">278</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">279</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">280</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">281</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">282</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Returns a callback that handles a standard form submission for the field</span></td><td class="action"></td></tr><tr><td class="line">283</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">284</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Expected form parts are</span></td><td class="action"></td></tr><tr><td class="line">285</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * - `field.paths.action` in `req.body` (`clear` or `delete`)</span></td><td class="action"></td></tr><tr><td class="line">286</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * - `field.paths.upload` in `req.files` (uploads the file to localfile)</span></td><td class="action"></td></tr><tr><td class="line">287</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">288</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">289</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">290</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">291</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">localfile.prototype.getRequestHandler = function(item, req, paths, callback) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">292</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var field = this;</span></td><td class="action"></td></tr><tr><td class="line">293</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">294</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (utils.isFunction(paths)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">295</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		callback = paths;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">296</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		paths = field.paths;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">297</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else if (!paths) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">298</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		paths = field.paths;</span></td><td class="action"></td></tr><tr><td class="line">299</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">300</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	callback = callback || function() {};</span></td><td class="action"></td></tr><tr><td class="line">301</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">302</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">303</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var action = req.body[paths.action];</span></td><td class="action"></td></tr><tr><td class="line">304</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">305</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (/^(delete|reset)$/.test(action)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">306</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				field.apply(item, action);</span></td><td class="action"></td></tr><tr><td class="line">307</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">308</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (req.files &amp;&amp; req.files[paths.upload] &amp;&amp; req.files[paths.upload].size) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">309</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return field.uploadFile(item, req.files[paths.upload], true, callback);</span></td><td class="action"></td></tr><tr><td class="line">310</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">311</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return callback();</span></td><td class="action"></td></tr><tr><td class="line">312</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">313</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">314</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">315</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">316</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">317</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Immediately handles a standard form submission for the field (see `getRequestHandler()`)</span></td><td class="action"></td></tr><tr><td class="line">318</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">319</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">320</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">321</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">322</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">localfile.prototype.handleRequest = function(item, req, paths, callback) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">323</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.getRequestHandler(item, req, paths, callback)();</span></td><td class="action"></td></tr><tr><td class="line">324</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">325</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">326</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">327</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">328</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Export class</span></td><td class="action"></td></tr><tr><td class="line">329</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">330</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">331</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports = module.exports = localfile;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/fieldTypes/location.js">lib/fieldTypes/location.js</h2><div class="stats low"><div class="percentage">47% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">38% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">27% block coverage</div><div class="sloc">249 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Module dependencies.</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">5</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var _ = require('underscore'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">6</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	keystone = require('../../'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">7</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	querystring = require('querystring'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">8</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	https = require('https'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">9</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	util = require('util'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">10</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	utils = require('keystone-utils'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">11</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	super_ = require('../field');</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">13</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var RADIUS_KM = 6371,
	RADIUS_MILES = 3959;</span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">16</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Location FieldType Constructor</span></td><td class="action"></td></tr><tr><td class="line">17</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @extends Field</span></td><td class="action"></td></tr><tr><td class="line">18</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">19</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">20</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">21</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function location(list, path, options) {</span></td><td class="action"></td></tr><tr><td class="line">22</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">23</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">	this._underscoreMethods = ['format', 'googleLookup', 'kmFrom', 'milesFrom'];</span></td><td class="action"></td></tr><tr><td class="line">24</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit partial"><td class="line">25</td><td class="hits">2</td><td class="statements">75%</td><td class="source"><span class="statement ">	this.enableMapsAPI = keystone.get('google api key') ?</span><span class="statement notok"><span class="offscreen"> not covered </span>true</span><span class="statement ">: false;</span></td><td class="action"></td></tr><tr><td class="line">26</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">27</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (!options.defaults) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">28</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		options.defaults = {};</span></td><td class="action"></td></tr><tr><td class="line">29</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">30</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">31</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (options.required) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">32</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">		if (Array.isArray(options.required)) {</span></td><td class="action"></td></tr><tr><td class="line">33</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			// required can be specified as an array of paths</span></td><td class="action"></td></tr><tr class="hit "><td class="line">34</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">			this.requiredPaths = options.required;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		} else if ('string' === typeof options.required) {</span></td><td class="action"></td></tr><tr><td class="line">36</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			// or it can be specified as a comma-delimited list</span></td><td class="action"></td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			this.requiredPaths = options.required.replace(/,/g, ' ').split(/\s+/);</span></td><td class="action"></td></tr><tr><td class="line">38</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">39</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		// options.required should always be simplified to a boolean</span></td><td class="action"></td></tr><tr class="hit "><td class="line">40</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">		options.required = true;</span></td><td class="action"></td></tr><tr><td class="line">41</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">42</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// default this.requiredPaths</span></td><td class="action"></td></tr><tr class="hit "><td class="line">43</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (!this.requiredPaths) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">44</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">		this.requiredPaths = ['street1', 'suburb'];</span></td><td class="action"></td></tr><tr><td class="line">45</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">46</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">47</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">	location.super_.call(this, list, path, options);</span></td><td class="action"></td></tr><tr><td class="line">48</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">49</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">50</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">51</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">52</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Inherit from Field</span></td><td class="action"></td></tr><tr><td class="line">53</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">54</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">55</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">util.inherits(location, super_);</span></td><td class="action"></td></tr><tr><td class="line">56</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">57</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">58</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">59</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Registers the field on the List's Mongoose Schema.</span></td><td class="action"></td></tr><tr><td class="line">60</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">61</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">62</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">63</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">64</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">location.prototype.addToSchema = function() {
</span></td><td class="action"></td></tr><tr class="hit "><td class="line">65</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">	var field = this,
		schema = this.list.schema,
		options = this.options;</span></td><td class="action"></td></tr><tr><td class="line">66</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">67</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">	var paths = this.paths = {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">68</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		number: this._path.append('.number'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">69</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		name: this._path.append('.name'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">70</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		street1: this._path.append('.street1'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">71</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		street2: this._path.append('.street2'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">72</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		suburb: this._path.append('.suburb'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">73</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		state: this._path.append('.state'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">74</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		postcode: this._path.append('.postcode'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">75</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		country: this._path.append('.country'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">76</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		geo: this._path.append('.geo'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">77</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		geo_lat: this._path.append('.geo_lat'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">78</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		geo_lng: this._path.append('.geo_lng'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">79</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		serialised: this._path.append('.serialised'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">80</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		improve: this._path.append('_improve'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">81</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		overwrite: this._path.append('_improve_overwrite')</span></td><td class="action"></td></tr><tr><td class="line">82</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">83</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">84</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">	var getFieldDef = function(type, key) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">85</td><td class="hits">18</td><td class="statements">100%</td><td class="source"><span class="statement ">		var def = { type: type };</span></td><td class="action"></td></tr><tr><td class="line">86</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (options.defaults[key]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">87</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			def.default = options.defaults[key];</span></td><td class="action"></td></tr><tr><td class="line">88</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">89</td><td class="hits">18</td><td class="statements">100%</td><td class="source"><span class="statement ">		return def;</span></td><td class="action"></td></tr><tr><td class="line">90</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">91</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">92</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">	schema.nested[this.path] = true;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">93</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">	schema.add({</span></td><td class="action"></td></tr><tr class="hit "><td class="line">94</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		number: getFieldDef(String, 'number'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">95</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		name: getFieldDef(String, 'name'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">96</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		street1: getFieldDef(String, 'street1'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">97</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		street2: getFieldDef(String, 'street2'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">98</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		street3: getFieldDef(String, 'street3'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">99</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		suburb: getFieldDef(String, 'suburb'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">100</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		state: getFieldDef(String, 'state'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">101</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		postcode: getFieldDef(String, 'postcode'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">102</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		country: getFieldDef(String, 'country'),</span></td><td class="action"></td></tr><tr><td class="line">103</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		geo: { type: [Number], index: '2dsphere' }</span></td><td class="action"></td></tr><tr class="hit "><td class="line">104</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">	}, this.path + '.');</span></td><td class="action"></td></tr><tr class="hit "><td class="line">105</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">	schema.virtual(paths.serialised).get(function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">106</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return _.compact([</span></td><td class="action"></td></tr><tr class="miss"><td class="line">107</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			this.get(paths.number),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">108</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			this.get(paths.name),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">109</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			this.get(paths.street1),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">110</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			this.get(paths.street2),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">111</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			this.get(paths.suburb),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">112</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			this.get(paths.state),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">113</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			this.get(paths.postcode),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">114</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			this.get(paths.country)</span></td><td class="action"></td></tr><tr><td class="line">115</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		]).join(', ');</span></td><td class="action"></td></tr><tr><td class="line">116</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">117</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">118</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// pre-save hook to fix blank geo fields</span></td><td class="action"></td></tr><tr><td class="line">119</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// see http://stackoverflow.com/questions/16388836/does-applying-a-2dsphere-index-on-a-mongoose-schema-force-the-location-field-to</span></td><td class="action"></td></tr><tr class="hit "><td class="line">120</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">	schema.pre('save', function(next) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">121</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var obj = field._path.get(this);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">122</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (Array.isArray(obj.geo) &amp;&amp; (obj.geo.length !== 2 || (obj.geo[0] === null &amp;&amp; obj.geo[1] === null))) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">123</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			obj.geo = undefined;</span></td><td class="action"></td></tr><tr><td class="line">124</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">125</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		next();</span></td><td class="action"></td></tr><tr><td class="line">126</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">127</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">128</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.bindUnderscoreMethods();</span></td><td class="action"></td></tr><tr><td class="line">129</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">130</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">131</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">132</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">133</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Formats a list of the values stored by the field. Only paths that</span></td><td class="action"></td></tr><tr><td class="line">134</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * have values will be included.</span></td><td class="action"></td></tr><tr><td class="line">135</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">136</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Optionally provide a space-separated list of values to include.</span></td><td class="action"></td></tr><tr><td class="line">137</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">138</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Delimiter defaults to `', '`.</span></td><td class="action"></td></tr><tr><td class="line">139</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">140</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">141</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">142</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">143</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">location.prototype.format = function(item, values, delimiter) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">144</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!values) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">145</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return item.get(this.paths.serialised);</span></td><td class="action"></td></tr><tr><td class="line">146</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">147</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var paths = this.paths;</span></td><td class="action"></td></tr><tr><td class="line">148</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">149</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	values = values.split(' ').map(function(i) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">150</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return item.get(paths[i]);</span></td><td class="action"></td></tr><tr><td class="line">151</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">152</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">153</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return _.compact(values).join(delimiter || ', ');</span></td><td class="action"></td></tr><tr><td class="line">154</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">155</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">156</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">157</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">158</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Detects whether the field has been modified</span></td><td class="action"></td></tr><tr><td class="line">159</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">160</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">161</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">162</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">163</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">location.prototype.isModified = function(item) {</span></td><td class="action"></td></tr><tr><td class="line">164</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return item.isModified(this.paths.number) ||</span></td><td class="action"></td></tr><tr class="miss"><td class="line">165</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		item.isModified(this.paths.name) ||</span></td><td class="action"></td></tr><tr class="miss"><td class="line">166</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		item.isModified(this.paths.street1) ||</span></td><td class="action"></td></tr><tr class="miss"><td class="line">167</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		item.isModified(this.paths.street2) ||</span></td><td class="action"></td></tr><tr class="miss"><td class="line">168</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		item.isModified(this.paths.suburb) ||</span></td><td class="action"></td></tr><tr class="miss"><td class="line">169</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		item.isModified(this.paths.state) ||</span></td><td class="action"></td></tr><tr class="miss"><td class="line">170</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		item.isModified(this.paths.postcode) ||</span></td><td class="action"></td></tr><tr class="miss"><td class="line">171</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		item.isModified(this.paths.country) ||</span></td><td class="action"></td></tr><tr class="miss"><td class="line">172</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		item.isModified(this.paths.geo);</span></td><td class="action"></td></tr><tr><td class="line">173</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">174</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">175</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">176</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">177</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Validates that a value for this field has been provided in a data object</span></td><td class="action"></td></tr><tr><td class="line">178</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">179</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * options.required specifies an array or space-delimited list of paths that</span></td><td class="action"></td></tr><tr><td class="line">180</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * are required (defaults to street1, suburb)</span></td><td class="action"></td></tr><tr><td class="line">181</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">182</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">183</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">184</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">185</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">location.prototype.validateInput = function(data, required, item) {
	</span></td><td class="action"></td></tr><tr class="hit "><td class="line">186</td><td class="hits">6</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (!required) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">187</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return true;</span></td><td class="action"></td></tr><tr><td class="line">188</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">189</td><td class="hits">6</td><td class="statements">100%</td><td class="source"><span class="statement ">	var paths = this.paths,</span></td><td class="action"></td></tr><tr class="hit "><td class="line">190</td><td class="hits">6</td><td class="statements">100%</td><td class="source"><span class="statement ">		nested = this._path.get(data),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">191</td><td class="hits">6</td><td class="statements">100%</td><td class="source"><span class="statement ">		values = nested || data,</span></td><td class="action"></td></tr><tr><td class="line">192</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		valid = true;</span></td><td class="action"></td></tr><tr><td class="line">193</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="hit "><td class="line">194</td><td class="hits">6</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.requiredPaths.forEach(function(path) {
		</span></td><td class="action"></td></tr><tr class="hit "><td class="line">195</td><td class="hits">12</td><td class="statements">100%</td><td class="source"><span class="statement ">		if (nested) {</span></td><td class="action"></td></tr><tr class="hit partial"><td class="line">196</td><td class="hits">2</td><td class="statements">75%</td><td class="source"><span class="statement ">			if (!(path in values) &amp;&amp;</span><span class="statement notok"><span class="offscreen"> not covered </span>item</span><span class="statement ">&amp;&amp;</span><span class="statement notok"><span class="offscreen"> not covered </span>item.get(paths[path])</span><span class="statement "> {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">197</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				return;</span></td><td class="action"></td></tr><tr><td class="line">198</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">199</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">			if (!values[path]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">200</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				valid = false;</span></td><td class="action"></td></tr><tr><td class="line">201</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr><td class="line">202</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		} else {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">203</td><td class="hits">10</td><td class="statements">100%</td><td class="source"><span class="statement ">			if (!(paths[path] in values) &amp;&amp; item &amp;&amp; item.get(paths[path])) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">204</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				return;</span></td><td class="action"></td></tr><tr><td class="line">205</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">206</td><td class="hits">10</td><td class="statements">100%</td><td class="source"><span class="statement ">			if (!values[paths[path]]) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">207</td><td class="hits">5</td><td class="statements">100%</td><td class="source"><span class="statement ">				valid = false;</span></td><td class="action"></td></tr><tr><td class="line">208</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr><td class="line">209</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="hit "><td class="line">210</td><td class="hits">6</td><td class="statements">100%</td><td class="source"><span class="statement ">	return valid;</span></td><td class="action"></td></tr><tr><td class="line">211</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">212</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">213</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">214</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">215</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Updates the value for this field in the item from a data object</span></td><td class="action"></td></tr><tr><td class="line">216</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">217</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">218</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">219</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">220</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">location.prototype.updateItem = function(item, data) {
</span></td><td class="action"></td></tr><tr class="hit "><td class="line">221</td><td class="hits">4</td><td class="statements">100%</td><td class="source"><span class="statement ">	var paths = this.paths,
		fieldKeys = ['number', 'name', 'street1', 'street2', 'suburb', 'state', 'postcode', 'country'],
		geoKeys = ['geo', 'geo_lat', 'geo_lng'],</span></td><td class="action"></td></tr><tr class="hit "><td class="line">222</td><td class="hits">4</td><td class="statements">100%</td><td class="source"><span class="statement ">		valueKeys = fieldKeys.concat(geoKeys),</span></td><td class="action"></td></tr><tr><td class="line">223</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		valuePaths = valueKeys,</span></td><td class="action"></td></tr><tr class="hit "><td class="line">224</td><td class="hits">4</td><td class="statements">100%</td><td class="source"><span class="statement ">		values = this._path.get(data);</span></td><td class="action"></td></tr><tr><td class="line">225</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="hit "><td class="line">226</td><td class="hits">4</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (!values) {</span></td><td class="action"></td></tr><tr><td class="line">227</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		// Handle flattened values</span></td><td class="action"></td></tr><tr class="hit "><td class="line">228</td><td class="hits">3</td><td class="statements">100%</td><td class="source"><span class="statement ">		valuePaths = valueKeys.map(function(i) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">229</td><td class="hits">33</td><td class="statements">100%</td><td class="source"><span class="statement ">			return paths[i];</span></td><td class="action"></td></tr><tr><td class="line">230</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		});</span></td><td class="action"></td></tr><tr class="hit "><td class="line">231</td><td class="hits">3</td><td class="statements">100%</td><td class="source"><span class="statement ">		values = _.pick(data, valuePaths);</span></td><td class="action"></td></tr><tr><td class="line">232</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">233</td><td class="hits">4</td><td class="statements">100%</td><td class="source"><span class="statement ">	valuePaths = _.object(valueKeys, valuePaths);</span></td><td class="action"></td></tr><tr><td class="line">234</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="hit "><td class="line">235</td><td class="hits">4</td><td class="statements">100%</td><td class="source"><span class="statement ">	var setValue = function(key) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">236</td><td class="hits">32</td><td class="statements">100%</td><td class="source"><span class="statement ">		if (valuePaths[key] in values &amp;&amp; values[valuePaths[key]] !== item.get(paths[key])) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">237</td><td class="hits">16</td><td class="statements">100%</td><td class="source"><span class="statement ">			item.set(paths[key], values[valuePaths[key]] || null);</span></td><td class="action"></td></tr><tr><td class="line">238</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">239</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">240</td><td class="hits">4</td><td class="statements">100%</td><td class="source"><span class="statement ">	_.each(fieldKeys, setValue);</span></td><td class="action"></td></tr><tr><td class="line">241</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">242</td><td class="hits">4</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (valuePaths.geo in values) {</span></td><td class="action"></td></tr><tr><td class="line">243</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">244</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		var oldGeo = item.get(paths.geo) || [],
			newGeo = values[valuePaths.geo];</span></td><td class="action"></td></tr><tr><td class="line">245</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">246</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		if (!Array.isArray(newGeo) || newGeo.length !== 2) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">247</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			newGeo = [];</span></td><td class="action"></td></tr><tr><td class="line">248</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="hit partial"><td class="line">249</td><td class="hits">2</td><td class="statements">67%</td><td class="source"><span class="statement ">		if (newGeo[0] !== oldGeo[0] ||</span><span class="statement notok"><span class="offscreen"> not covered </span>newGeo[1] !== oldGeo[1]</span><span class="statement "> {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">250</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">			item.set(paths.geo, newGeo);</span></td><td class="action"></td></tr><tr><td class="line">251</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">252</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">	} else if (valuePaths.geo_lat in values &amp;&amp; valuePaths.geo_lng in values) {</span></td><td class="action"></td></tr><tr><td class="line">253</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">254</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		var lat = utils.number(values[valuePaths.geo_lat]),
			lng = utils.number(values[valuePaths.geo_lng]);</span></td><td class="action"></td></tr><tr><td class="line">255</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">256</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		item.set(paths.geo, (lat &amp;&amp; lng) ? [lng, lat] : undefined);</span></td><td class="action"></td></tr><tr><td class="line">257</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">258</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">259</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">260</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">261</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Returns a callback that handles a standard form submission for the field</span></td><td class="action"></td></tr><tr><td class="line">262</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">263</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Handles:</span></td><td class="action"></td></tr><tr><td class="line">264</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * - `field.paths.improve` in `req.body` - improves data via `.googleLookup()`</span></td><td class="action"></td></tr><tr><td class="line">265</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * - `field.paths.overwrite` in `req.body` - in conjunction with `improve`, overwrites existing data</span></td><td class="action"></td></tr><tr><td class="line">266</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">267</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">268</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">269</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">270</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">location.prototype.getRequestHandler = function(item, req, paths, callback) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">271</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var field = this;</span></td><td class="action"></td></tr><tr><td class="line">272</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">273</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (utils.isFunction(paths)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">274</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		callback = paths;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">275</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		paths = field.paths;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">276</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else if (!paths) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">277</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		paths = field.paths;</span></td><td class="action"></td></tr><tr><td class="line">278</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">279</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	callback = callback || function() {};</span></td><td class="action"></td></tr><tr><td class="line">280</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">281</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">282</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var update = req.body[paths.overwrite] ? 'overwrite' : true;</span></td><td class="action"></td></tr><tr><td class="line">283</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">284</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (req.body &amp;&amp; req.body[paths.improve]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">285</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			field.googleLookup(item, false, update, function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">286</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				callback();</span></td><td class="action"></td></tr><tr><td class="line">287</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			});</span></td><td class="action"></td></tr><tr><td class="line">288</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">289</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			callback();</span></td><td class="action"></td></tr><tr><td class="line">290</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">291</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">292</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">293</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">294</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">295</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Immediately handles a standard form submission for the field (see `getRequestHandler()`)</span></td><td class="action"></td></tr><tr><td class="line">296</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">297</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">298</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">299</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">300</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">location.prototype.handleRequest = function(item, req, paths, callback) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">301</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.getRequestHandler(item, req, paths, callback)();</span></td><td class="action"></td></tr><tr><td class="line">302</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">303</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">304</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">305</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">306</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Internal Google geocode request method</span></td><td class="action"></td></tr><tr><td class="line">307</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">308</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api private</span></td><td class="action"></td></tr><tr><td class="line">309</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">310</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">311</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function doGoogleGeocodeRequest(address, region, callback) {</span></td><td class="action"></td></tr><tr><td class="line">312</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">313</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// https://developers.google.com/maps/documentation/geocoding/</span></td><td class="action"></td></tr><tr><td class="line">314</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Use of the Google Geocoding API is subject to a query limit of 2,500 geolocation requests per day, except with an enterprise license.</span></td><td class="action"></td></tr><tr><td class="line">315</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Note: the Geocoding API may only be used in conjunction with a Google map; geocoding results without displaying them on a map is prohibited.</span></td><td class="action"></td></tr><tr><td class="line">316</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Please make sure your Keystone app complies with the Google Maps API License.</span></td><td class="action"></td></tr><tr><td class="line">317</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">318</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var options = {</span></td><td class="action"></td></tr><tr><td class="line">319</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">320</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (arguments.length === 2 &amp;&amp; _.isFunction(region)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">321</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		callback = region;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">322</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		region = null;</span></td><td class="action"></td></tr><tr><td class="line">323</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">324</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">325</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (region) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">326</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		options.region = region;</span></td><td class="action"></td></tr><tr><td class="line">327</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">328</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">329</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var endpoint = 'https://maps.googleapis.com/maps/api/geocode/json?' + querystring.stringify(options);</span></td><td class="action"></td></tr><tr><td class="line">330</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">331</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	https.get(endpoint, function(res) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">332</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var data = [];</span></td><td class="action"></td></tr><tr class="miss"><td class="line">333</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		res.on('data', function(chunk) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">334</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				data.push(chunk);</span></td><td class="action"></td></tr><tr><td class="line">335</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			})</span></td><td class="action"></td></tr><tr><td class="line">336</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			.on('end', function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">337</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				var dataBuff = data.join('').trim();</span></td><td class="action"></td></tr><tr class="miss"><td class="line">338</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				var result;</span></td><td class="action"></td></tr><tr><td class="line">339</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				try {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">340</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					result = JSON.parse(dataBuff);</span></td><td class="action"></td></tr><tr><td class="line">341</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr><td class="line">342</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				catch (exp) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">343</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					result = {'status_code': 500, 'status_text': 'JSON Parse Failed', 'status': 'UNKNOWN_ERROR'};</span></td><td class="action"></td></tr><tr><td class="line">344</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">345</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				callback(null, result);</span></td><td class="action"></td></tr><tr><td class="line">346</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			});</span></td><td class="action"></td></tr><tr><td class="line">347</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	})</span></td><td class="action"></td></tr><tr class="miss"><td class="line">348</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		callback(err);</span></td><td class="action"></td></tr><tr><td class="line">349</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">350</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">351</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">352</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">353</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">354</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Autodetect the full address and lat, lng from the stored value.</span></td><td class="action"></td></tr><tr><td class="line">355</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">356</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Uses Google's Maps API and may only be used in conjunction with a Google map.</span></td><td class="action"></td></tr><tr><td class="line">357</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Geocoding results without displaying them on a map is prohibited.</span></td><td class="action"></td></tr><tr><td class="line">358</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Please make sure your Keystone app complies with the Google Maps API License.</span></td><td class="action"></td></tr><tr><td class="line">359</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">360</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Internal status codes mimic the Google API status codes.</span></td><td class="action"></td></tr><tr><td class="line">361</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">362</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api private</span></td><td class="action"></td></tr><tr><td class="line">363</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">364</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">365</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">location.prototype.googleLookup = function(item, region, update, callback) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">366</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (_.isFunction(update)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">367</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		callback = update;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">368</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		update = false;</span></td><td class="action"></td></tr><tr><td class="line">369</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">370</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var field = this,</span></td><td class="action"></td></tr><tr class="miss"><td class="line">371</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		stored = item.get(this.path),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">372</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		address = item.get(this.paths.serialised);</span></td><td class="action"></td></tr><tr><td class="line">373</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">374</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (address.length === 0) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">375</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return callback({'status_code': 500, 'status_text': 'No address to geocode', 'status': 'NO_ADDRESS'});</span></td><td class="action"></td></tr><tr><td class="line">376</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">377</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	doGoogleGeocodeRequest(address, region || keystone.get('default region'), function(err, geocode){</span></td><td class="action"></td></tr><tr class="miss"><td class="line">378</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (err || geocode.status !== 'OK') {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">379</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return callback(err);</span></td><td class="action"></td></tr><tr><td class="line">380</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">381</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">382</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		// use the first result</span></td><td class="action"></td></tr><tr><td class="line">383</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		// if there were no results in the array, status would be ZERO_RESULTS</span></td><td class="action"></td></tr><tr class="miss"><td class="line">384</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var result = geocode.results[0];</span></td><td class="action"></td></tr><tr><td class="line">385</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">386</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		// parse the address components into a location object</span></td><td class="action"></td></tr><tr><td class="line">387</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">388</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var location = {};</span></td><td class="action"></td></tr><tr><td class="line">389</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">390</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		_.each(result.address_components, function(val){</span></td><td class="action"></td></tr><tr class="miss"><td class="line">391</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if ( _.indexOf(val.types,'street_number') &gt;= 0 ) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">392</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				location.street1 = location.street1 || [];</span></td><td class="action"></td></tr><tr class="miss"><td class="line">393</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				location.street1.push(val.long_name);</span></td><td class="action"></td></tr><tr><td class="line">394</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">395</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if ( _.indexOf(val.types,'route') &gt;= 0 ) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">396</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				location.street1 = location.street1 || [];</span></td><td class="action"></td></tr><tr class="miss"><td class="line">397</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				location.street1.push(val.short_name);</span></td><td class="action"></td></tr><tr><td class="line">398</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr><td class="line">399</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			// in some cases, you get suburb, city as locality - so only use the first</span></td><td class="action"></td></tr><tr class="miss"><td class="line">400</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if ( _.indexOf(val.types,'locality') &gt;= 0 &amp;&amp; !location.suburb) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">401</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				location.suburb = val.long_name;</span></td><td class="action"></td></tr><tr><td class="line">402</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">403</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if ( _.indexOf(val.types,'administrative_area_level_1') &gt;= 0 ) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">404</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				location.state = val.short_name;</span></td><td class="action"></td></tr><tr><td class="line">405</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">406</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if ( _.indexOf(val.types,'country') &gt;= 0 ) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">407</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				location.country = val.long_name;</span></td><td class="action"></td></tr><tr><td class="line">408</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">409</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if ( _.indexOf(val.types,'postal_code') &gt;= 0 ) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">410</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				location.postcode = val.short_name;</span></td><td class="action"></td></tr><tr><td class="line">411</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr><td class="line">412</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">413</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (Array.isArray(location.street1)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">414</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			location.street1 = location.street1.join(' ');</span></td><td class="action"></td></tr><tr><td class="line">415</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">416</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		location.geo = [</span></td><td class="action"></td></tr><tr><td class="line">417</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">418</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		//console.log('------ Google Geocode Results ------');</span></td><td class="action"></td></tr><tr><td class="line">419</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		//console.log(address);</span></td><td class="action"></td></tr><tr><td class="line">420</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		//console.log(result);</span></td><td class="action"></td></tr><tr><td class="line">421</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		//console.log(location);</span></td><td class="action"></td></tr><tr><td class="line">422</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">423</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (update === 'overwrite') {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">424</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			item.set(field.path, location);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">425</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		} else if (update) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">426</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			_.each(location, function(value, key) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">427</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (key === 'geo') {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">428</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					return;</span></td><td class="action"></td></tr><tr><td class="line">429</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">430</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (!stored[key]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">431</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					item.set(field.paths[key], value);</span></td><td class="action"></td></tr><tr><td class="line">432</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr><td class="line">433</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			});</span></td><td class="action"></td></tr><tr class="miss"><td class="line">434</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (!Array.isArray(stored.geo) || !stored.geo[0] || !stored.geo[1]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">435</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				item.set(field.paths.geo, location.geo);</span></td><td class="action"></td></tr><tr><td class="line">436</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">437</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		callback(null, location, result);</span></td><td class="action"></td></tr><tr><td class="line">438</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">439</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">440</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">441</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">442</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">443</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Internal Distance calculation function</span></td><td class="action"></td></tr><tr><td class="line">444</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">445</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * See http://en.wikipedia.org/wiki/Haversine_formula</span></td><td class="action"></td></tr><tr><td class="line">446</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">447</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api private</span></td><td class="action"></td></tr><tr><td class="line">448</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">449</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">450</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function calculateDistance(point1, point2) {</span></td><td class="action"></td></tr><tr><td class="line">451</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">452</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var dLng = (point2[0] - point1[0]) * Math.PI / 180;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">453</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var dLat = (point2[1] - point1[1]) * Math.PI / 180;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">454</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var lat1 = (point1[1]) * Math.PI / 180;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">455</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var lat2 = (point2[1]) * Math.PI / 180;</span></td><td class="action"></td></tr><tr><td class="line">456</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">457</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.sin(dLng/2) * Math.sin(dLng/2) * Math.cos(lat1) * Math.cos(lat2);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">458</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));</span></td><td class="action"></td></tr><tr><td class="line">459</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">460</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return c;</span></td><td class="action"></td></tr><tr><td class="line">461</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">462</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">463</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">464</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">465</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">466</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Returns the distance from a [lat, lng] point in kilometres</span></td><td class="action"></td></tr><tr><td class="line">467</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">468</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">469</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">470</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">471</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">location.prototype.kmFrom = function(item, point) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">472</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return calculateDistance(this.get(this.paths.geo), point) * RADIUS_KM;</span></td><td class="action"></td></tr><tr><td class="line">473</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">474</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">475</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">476</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">477</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Returns the distance from a [lat, lng] point in miles</span></td><td class="action"></td></tr><tr><td class="line">478</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">479</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">480</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">481</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">482</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">location.prototype.milesFrom = function(item, point) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">483</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return calculateDistance(this.get(this.paths.geo), point) * RADIUS_MILES;</span></td><td class="action"></td></tr><tr><td class="line">484</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">485</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">486</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">487</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">488</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Export class</span></td><td class="action"></td></tr><tr><td class="line">489</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">490</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">491</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports = module.exports = location;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/fieldTypes/markdown.js">lib/fieldTypes/markdown.js</h2><div class="stats low"><div class="percentage">34% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">22% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">0% block coverage</div><div class="sloc">44 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Module dependencies.</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">5</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var util = require('util'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">6</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	marked = require('marked'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">7</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	super_ = require('../field');</span></td><td class="action"></td></tr><tr><td class="line">8</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">9</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Markdown FieldType Constructor</span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @extends Field</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function markdown(list, path, options) {</span></td><td class="action"></td></tr><tr><td class="line">16</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">17</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// TODO: implement filtering, usage disabled for now</span></td><td class="action"></td></tr><tr class="miss"><td class="line">18</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	options.nofilter = true;</span></td><td class="action"></td></tr><tr><td class="line">19</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">20</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.height = options.height || 90;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	markdown.super_.call(this, list, path, options);</span></td><td class="action"></td></tr><tr><td class="line">22</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">23</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">24</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">25</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">26</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Inherit from Field</span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">28</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">29</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">util.inherits(markdown, super_);</span></td><td class="action"></td></tr><tr><td class="line">30</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">31</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">32</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">33</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Registers the field on the List's Mongoose Schema.</span></td><td class="action"></td></tr><tr><td class="line">34</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">35</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Adds String properties for .markdown and .html markdown, and a setter</span></td><td class="action"></td></tr><tr><td class="line">36</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * for .markdown that generates html when it is updated.</span></td><td class="action"></td></tr><tr><td class="line">37</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">38</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">39</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">40</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">41</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">markdown.prototype.addToSchema = function() {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">42</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var schema = this.list.schema;</span></td><td class="action"></td></tr><tr><td class="line">43</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">44</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var paths = this.paths = {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">45</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		md: this._path.append('.md'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">46</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		html: this._path.append('.html')</span></td><td class="action"></td></tr><tr><td class="line">47</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">48</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">49</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var setMarkdown = function(value) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">50</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (value === this.get(paths.md)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">51</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return value;</span></td><td class="action"></td></tr><tr><td class="line">52</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">53</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (typeof value === 'string') {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">54</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			this.set(paths.html, marked(value));</span></td><td class="action"></td></tr><tr class="miss"><td class="line">55</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return value;</span></td><td class="action"></td></tr><tr><td class="line">56</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">57</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			this.set(paths.html, undefined);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">58</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return undefined;</span></td><td class="action"></td></tr><tr><td class="line">59</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">60</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">61</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	schema.nested[this.path] = true;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">62</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	schema.add({</span></td><td class="action"></td></tr><tr><td class="line">63</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		html: { type: String },</span></td><td class="action"></td></tr><tr class="miss"><td class="line">64</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.bindUnderscoreMethods();</span></td><td class="action"></td></tr><tr><td class="line">65</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">66</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">67</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">68</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">69</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Formats the field value</span></td><td class="action"></td></tr><tr><td class="line">70</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">71</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">72</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">73</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">74</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">markdown.prototype.format = function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">75</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return item.get(this.paths.html);</span></td><td class="action"></td></tr><tr><td class="line">76</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">77</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">78</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">79</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">80</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Validates that a value for this field has been provided in a data object</span></td><td class="action"></td></tr><tr><td class="line">81</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">82</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Will accept either the field path, or paths.md</span></td><td class="action"></td></tr><tr><td class="line">83</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">84</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">85</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">86</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">87</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">markdown.prototype.validateInput = function(data, required, item) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">88</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!(this.path in data || this.paths.md in data) &amp;&amp; item &amp;&amp; item.get(this.paths.md)) return true;</span></td><td class="action"></td></tr><tr><td class="line">89</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">90</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return (!required || data[this.path] || data[this.paths.md]) ? true : false;</span></td><td class="action"></td></tr><tr><td class="line">91</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">92</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">93</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">94</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">95</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Detects whether the field has been modified</span></td><td class="action"></td></tr><tr><td class="line">96</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">97</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">98</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">99</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">100</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">markdown.prototype.isModified = function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">101</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return item.isModified(this.paths.md);</span></td><td class="action"></td></tr><tr><td class="line">102</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">103</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">104</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">105</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">106</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Updates the value for this field in the item from a data object</span></td><td class="action"></td></tr><tr><td class="line">107</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">108</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Will accept either the field path, or paths.md</span></td><td class="action"></td></tr><tr><td class="line">109</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">110</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">111</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">112</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">113</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">markdown.prototype.updateItem = function(item, data) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">114</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (this.path in data) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">115</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		item.set(this.paths.md, data[this.path]);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">116</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else if (this.paths.md in data) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">117</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		item.set(this.paths.md, data[this.paths.md]);</span></td><td class="action"></td></tr><tr><td class="line">118</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">119</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">120</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">121</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">122</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Export class</span></td><td class="action"></td></tr><tr><td class="line">123</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">124</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">125</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports = module.exports = markdown;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/fieldTypes/money.js">lib/fieldTypes/money.js</h2><div class="stats low"><div class="percentage">36% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">18% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">0% block coverage</div><div class="sloc">33 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Module dependencies.</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">5</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var util = require('util'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">6</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	numeral = require('numeral'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">7</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	utils = require('keystone-utils'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">8</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	super_ = require('../field');</span></td><td class="action"></td></tr><tr><td class="line">9</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Money FieldType Constructor</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @extends Field</span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">16</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function money(list, path, options) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">17</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._nativeType = Number;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">18</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._underscoreMethods = ['format'];</span></td><td class="action"></td></tr><tr class="miss"><td class="line">19</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._formatString = (options.format === false) ? false : (options.format || '$0,0.00');</span></td><td class="action"></td></tr><tr class="miss"><td class="line">20</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (this._formatString &amp;&amp; 'string' !== typeof this._formatString) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('FieldType.Money: options.format must be a string.');</span></td><td class="action"></td></tr><tr><td class="line">22</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	money.super_.call(this, list, path, options);</span></td><td class="action"></td></tr><tr><td class="line">24</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">25</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">26</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Inherit from Field</span></td><td class="action"></td></tr><tr><td class="line">28</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">29</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">30</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">util.inherits(money, super_);</span></td><td class="action"></td></tr><tr><td class="line">31</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">32</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">33</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">34</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Formats the field value</span></td><td class="action"></td></tr><tr><td class="line">35</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">36</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">37</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">38</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">39</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">money.prototype.format = function(item, format) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">40</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (format || this._formatString) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return ('number' === typeof item.get(this.path)) ? numeral(item.get(this.path)).format(format || this._formatString) : '';</span></td><td class="action"></td></tr><tr><td class="line">42</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">43</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return item.get(this.path) || '';</span></td><td class="action"></td></tr><tr><td class="line">44</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">45</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">46</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">47</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">48</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Checks that a valid number has been provided in a data object</span></td><td class="action"></td></tr><tr><td class="line">49</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">50</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * An empty value clears the stored value and is considered valid</span></td><td class="action"></td></tr><tr><td class="line">51</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">52</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">53</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">54</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">55</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">money.prototype.validateInput = function(data, required, item) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">56</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!(this.path in data) &amp;&amp; item &amp;&amp; (item.get(this.path) || item.get(this.path) === 0)) return true;</span></td><td class="action"></td></tr><tr><td class="line">57</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">58</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (data[this.path]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">59</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var newValue = utils.number(data[this.path]);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">60</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return (!isNaN(newValue));</span></td><td class="action"></td></tr><tr><td class="line">61</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">62</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return (required) ? false : true;</span></td><td class="action"></td></tr><tr><td class="line">63</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">64</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">65</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">66</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">67</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Updates the value for this field in the item from a data object</span></td><td class="action"></td></tr><tr><td class="line">68</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">69</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">70</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">71</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">72</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">money.prototype.updateItem = function(item, data) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">73</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!(this.path in data))</span></td><td class="action"></td></tr><tr class="miss"><td class="line">74</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return;</span></td><td class="action"></td></tr><tr><td class="line">75</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">76</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var newValue = utils.number(data[this.path]);</span></td><td class="action"></td></tr><tr><td class="line">77</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">78</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!isNaN(newValue)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">79</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (newValue !== item.get(this.path)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">80</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			item.set(this.path, newValue);</span></td><td class="action"></td></tr><tr><td class="line">81</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">82</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else if ('number' === typeof item.get(this.path)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">83</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		item.set(this.path, null);</span></td><td class="action"></td></tr><tr><td class="line">84</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">85</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">86</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">87</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">88</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Export class</span></td><td class="action"></td></tr><tr><td class="line">89</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">90</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">91</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports = module.exports = money;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/fieldTypes/name.js">lib/fieldTypes/name.js</h2><div class="stats terrible"><div class="percentage">23% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">12% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">0% block coverage</div><div class="sloc">63 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Module dependencies.</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">5</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var _ = require('underscore'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">6</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	util = require('util'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">7</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	super_ = require('../field');</span></td><td class="action"></td></tr><tr><td class="line">8</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">9</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Name FieldType Constructor</span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @extends Field</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function name(list, path, options) {</span></td><td class="action"></td></tr><tr><td class="line">16</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// TODO: implement filtering, hard-coded as disabled for now</span></td><td class="action"></td></tr><tr class="miss"><td class="line">17</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	options.nofilter = true;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">18</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	name.super_.call(this, list, path, options);</span></td><td class="action"></td></tr><tr><td class="line">19</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">20</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">21</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">22</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Inherit from Field</span></td><td class="action"></td></tr><tr><td class="line">23</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">24</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">25</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">util.inherits(name, super_);</span></td><td class="action"></td></tr><tr><td class="line">26</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">28</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">29</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Registers the field on the List's Mongoose Schema.</span></td><td class="action"></td></tr><tr><td class="line">30</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">31</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Adds String properties for .first and .last name, and a virtual</span></td><td class="action"></td></tr><tr><td class="line">32</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * with get() and set() methods for .full</span></td><td class="action"></td></tr><tr><td class="line">33</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">34</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">35</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">36</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">37</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">name.prototype.addToSchema = function() {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">38</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var schema = this.list.schema;</span></td><td class="action"></td></tr><tr><td class="line">39</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">40</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var paths = this.paths = {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		first: this._path.append('.first'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">42</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		last: this._path.append('.last'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">43</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		full: this._path.append('.full')</span></td><td class="action"></td></tr><tr><td class="line">44</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">45</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">46</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	schema.nested[this.path] = true;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">47</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	schema.add({</span></td><td class="action"></td></tr><tr><td class="line">48</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		first: String,</span></td><td class="action"></td></tr><tr class="miss"><td class="line">49</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	schema.virtual(paths.full).get(function () {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">50</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return _.compact([this.get(paths.first), this.get(paths.last)]).join(' ');</span></td><td class="action"></td></tr><tr><td class="line">51</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">52</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">53</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	schema.virtual(paths.full).set(function(value) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">54</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (typeof value !== 'string') {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">55</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			this.set(paths.first, undefined);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">56</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			this.set(paths.last, undefined);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">57</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return;</span></td><td class="action"></td></tr><tr><td class="line">58</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">59</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">60</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var split = value.split(' ');</span></td><td class="action"></td></tr><tr class="miss"><td class="line">61</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		this.set(paths.first, split.shift());</span></td><td class="action"></td></tr><tr class="miss"><td class="line">62</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		this.set(paths.last, split.join(' ') || undefined);</span></td><td class="action"></td></tr><tr><td class="line">63</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">64</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">65</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.bindUnderscoreMethods();</span></td><td class="action"></td></tr><tr><td class="line">66</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">67</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">68</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">69</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">70</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Formats the field value</span></td><td class="action"></td></tr><tr><td class="line">71</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">72</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">73</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">74</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">75</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">name.prototype.format = function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">76</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return item.get(this.paths.full);</span></td><td class="action"></td></tr><tr><td class="line">77</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">78</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">79</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">80</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">81</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Validates that a value for this field has been provided in a data object</span></td><td class="action"></td></tr><tr><td class="line">82</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">83</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">84</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">85</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">86</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">name.prototype.validateInput = function(data, required, item) {
	
	// Input is valid if none was provided, but the item has data</span></td><td class="action"></td></tr><tr class="miss"><td class="line">87</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!(this.path in data || this.paths.first in data || this.paths.last in data || this.paths.full in data) &amp;&amp; item &amp;&amp; item.get(this.paths.full)) return true;</span></td><td class="action"></td></tr><tr><td class="line">88</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">89</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!required) return true;</span></td><td class="action"></td></tr><tr><td class="line">90</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">91</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (_.isObject(data[this.path])) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">92</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return (data[this.path].full || data[this.path].first || data[this.path].last) ? true : false;</span></td><td class="action"></td></tr><tr><td class="line">93</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">94</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return (data[this.paths.full] || data[this.paths.first] || data[this.paths.last]) ? true : false;</span></td><td class="action"></td></tr><tr><td class="line">95</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">96</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">97</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">98</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">99</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Detects whether the field has been modified</span></td><td class="action"></td></tr><tr><td class="line">100</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">101</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">102</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">103</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">104</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">name.prototype.isModified = function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">105</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return item.isModified(this.paths.first) || item.isModified(this.paths.last);</span></td><td class="action"></td></tr><tr><td class="line">106</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">107</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">108</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">109</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">110</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Updates the value for this field in the item from a data object</span></td><td class="action"></td></tr><tr><td class="line">111</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">112</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">113</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">114</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">115</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">name.prototype.updateItem = function(item, data) {
	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">116</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!_.isObject(data)) return;</span></td><td class="action"></td></tr><tr><td class="line">117</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">118</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var paths = this.paths,</span></td><td class="action"></td></tr><tr><td class="line">119</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">120</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (this.path in data &amp;&amp; _.isString(data[this.path])) {</span></td><td class="action"></td></tr><tr><td class="line">121</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">122</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		item.set(paths.full, data[this.path]);</span></td><td class="action"></td></tr><tr><td class="line">123</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">124</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else if (this.path in data &amp;&amp; _.isObject(data[this.path])) {</span></td><td class="action"></td></tr><tr><td class="line">125</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">126</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var valueObj = data[this.path];</span></td><td class="action"></td></tr><tr><td class="line">127</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">128</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		setValue = function(key) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">129</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (key in valueObj &amp;&amp; valueObj[key] !== item.get(paths[key])) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">130</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				item.set(paths[key], valueObj[key]);</span></td><td class="action"></td></tr><tr><td class="line">131</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr><td class="line">132</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">133</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		setValue = function(key) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">134</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (paths[key] in data &amp;&amp; data[paths[key]] !== item.get(paths[key])) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">135</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				item.set(paths[key], data[paths[key]]);</span></td><td class="action"></td></tr><tr><td class="line">136</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr><td class="line">137</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">138</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (setValue) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">139</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		_.each(['full', 'first', 'last'], setValue);</span></td><td class="action"></td></tr><tr><td class="line">140</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">141</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">142</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">143</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">144</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Export class</span></td><td class="action"></td></tr><tr><td class="line">145</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">146</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">147</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports = module.exports = name;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/fieldTypes/number.js">lib/fieldTypes/number.js</h2><div class="stats low"><div class="percentage">36% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">18% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">0% block coverage</div><div class="sloc">33 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Module dependencies.</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">5</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var util = require('util'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">6</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	numeral = require('numeral'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">7</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	utils = require('keystone-utils'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">8</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	super_ = require('../field');</span></td><td class="action"></td></tr><tr><td class="line">9</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Number FieldType Constructor</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @extends Field</span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">16</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function number(list, path, options) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">17</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._nativeType = Number;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">18</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._underscoreMethods = ['format'];</span></td><td class="action"></td></tr><tr class="miss"><td class="line">19</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._formatString = (options.format === false) ? false : (options.format || '0,0[.][000000000000]');</span></td><td class="action"></td></tr><tr class="miss"><td class="line">20</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (this._formatString &amp;&amp; 'string' !== typeof this._formatString) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('FieldType.Number: options.format must be a string.');</span></td><td class="action"></td></tr><tr><td class="line">22</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	number.super_.call(this, list, path, options);</span></td><td class="action"></td></tr><tr><td class="line">24</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">25</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">26</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Inherit from Field</span></td><td class="action"></td></tr><tr><td class="line">28</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">29</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">30</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">util.inherits(number, super_);</span></td><td class="action"></td></tr><tr><td class="line">31</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">32</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">33</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">34</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Formats the field value</span></td><td class="action"></td></tr><tr><td class="line">35</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">36</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">37</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">38</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">39</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">number.prototype.format = function(item, format) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">40</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (format || this._formatString) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return ('number' === typeof item.get(this.path)) ? numeral(item.get(this.path)).format(format || this._formatString) : '';</span></td><td class="action"></td></tr><tr><td class="line">42</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">43</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return item.get(this.path) || '';</span></td><td class="action"></td></tr><tr><td class="line">44</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">45</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">46</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">47</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">48</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Checks that a valid number has been provided in a data object</span></td><td class="action"></td></tr><tr><td class="line">49</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">50</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * An empty value clears the stored value and is considered valid</span></td><td class="action"></td></tr><tr><td class="line">51</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">52</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">53</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">54</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">55</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">number.prototype.validateInput = function(data, required, item) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">56</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!(this.path in data) &amp;&amp; item &amp;&amp; (item.get(this.path) || item.get(this.path) === 0)) return true;</span></td><td class="action"></td></tr><tr><td class="line">57</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">58</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (data[this.path]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">59</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var newValue = utils.number(data[this.path]);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">60</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return (!isNaN(newValue));</span></td><td class="action"></td></tr><tr><td class="line">61</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">62</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return (required) ? false : true;</span></td><td class="action"></td></tr><tr><td class="line">63</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">64</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">65</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">66</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">67</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Updates the value for this field in the item from a data object</span></td><td class="action"></td></tr><tr><td class="line">68</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">69</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">70</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">71</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">72</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">number.prototype.updateItem = function(item, data) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">73</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!(this.path in data))</span></td><td class="action"></td></tr><tr class="miss"><td class="line">74</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return;</span></td><td class="action"></td></tr><tr><td class="line">75</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">76</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var newValue = utils.number(data[this.path]);</span></td><td class="action"></td></tr><tr><td class="line">77</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">78</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!isNaN(newValue)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">79</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (newValue !== item.get(this.path)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">80</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			item.set(this.path, newValue);</span></td><td class="action"></td></tr><tr><td class="line">81</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">82</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else if ('number' === typeof item.get(this.path)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">83</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		item.set(this.path, null);</span></td><td class="action"></td></tr><tr><td class="line">84</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">85</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">86</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">87</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">88</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Export class</span></td><td class="action"></td></tr><tr><td class="line">89</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">90</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">91</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports = module.exports = number;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/fieldTypes/password.js">lib/fieldTypes/password.js</h2><div class="stats terrible"><div class="percentage">23% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">15% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">0% block coverage</div><div class="sloc">59 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Module dependencies.</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">5</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var _ = require('underscore'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">6</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	util = require('util'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">7</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	bcrypt = require('bcrypt-nodejs'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">8</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	super_ = require('../field');</span></td><td class="action"></td></tr><tr><td class="line">9</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * password FieldType Constructor</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @extends Field</span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">16</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function password(list, path, options) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">17</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.workFactor = options.workFactor || 10;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">18</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._nativeType = String;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">19</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._underscoreMethods = ['format', 'compare'];</span></td><td class="action"></td></tr><tr class="miss"><td class="line">20</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	options.nosort = true; // You can't sort on password fields</span></td><td class="action"></td></tr><tr><td class="line">21</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// TODO: implement filtering, hard-coded as disabled for now</span></td><td class="action"></td></tr><tr class="miss"><td class="line">22</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	options.nofilter = true;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	password.super_.call(this, list, path, options);</span></td><td class="action"></td></tr><tr><td class="line">24</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">25</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">26</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Inherit from Field</span></td><td class="action"></td></tr><tr><td class="line">28</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">29</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">30</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">util.inherits(password, super_);</span></td><td class="action"></td></tr><tr><td class="line">31</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">32</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">33</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Registers the field on the List's Mongoose Schema.</span></td><td class="action"></td></tr><tr><td class="line">34</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">35</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Adds ...</span></td><td class="action"></td></tr><tr><td class="line">36</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">37</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">38</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr class="hit "><td class="line">39</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">password.prototype.addToSchema = function() {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">40</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var field = this,</span></td><td class="action"></td></tr><tr><td class="line">41</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">42</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.paths = {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">43</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		confirm: this.options.confirmPath || this._path.append('_confirm')</span></td><td class="action"></td></tr><tr><td class="line">44</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">45</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">46</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	schema.path(this.path, _.defaults({ type: String }, this.options));</span></td><td class="action"></td></tr><tr><td class="line">47</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">48</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	schema.pre('save', function(next) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">49</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (!this.isModified(field.path))</span></td><td class="action"></td></tr><tr class="miss"><td class="line">50</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return next();</span></td><td class="action"></td></tr><tr><td class="line">51</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">52</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (!this.get(field.path)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">53</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			this.set(field.path, undefined);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">54</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return next();</span></td><td class="action"></td></tr><tr><td class="line">55</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">56</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">57</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var item = this;</span></td><td class="action"></td></tr><tr><td class="line">58</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">59</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		bcrypt.genSalt(field.workFactor, function(err, salt) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">60</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (err)</span></td><td class="action"></td></tr><tr class="miss"><td class="line">61</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				return next(err);</span></td><td class="action"></td></tr><tr><td class="line">62</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">63</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			bcrypt.hash(item.get(field.path), salt, function () {}, function(err, hash) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">64</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (err)</span></td><td class="action"></td></tr><tr class="miss"><td class="line">65</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					return next(err);</span></td><td class="action"></td></tr><tr><td class="line">66</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">67</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				// override the cleartext password with the hashed one</span></td><td class="action"></td></tr><tr class="miss"><td class="line">68</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				item.set(field.path, hash);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">69</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				next();</span></td><td class="action"></td></tr><tr><td class="line">70</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			});</span></td><td class="action"></td></tr><tr><td class="line">71</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		});</span></td><td class="action"></td></tr><tr><td class="line">72</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">73</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">74</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.bindUnderscoreMethods();</span></td><td class="action"></td></tr><tr><td class="line">75</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">76</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">77</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">78</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">79</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Formats the field value</span></td><td class="action"></td></tr><tr><td class="line">80</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">81</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Password fields are always formatted as a random no. of asterisks,</span></td><td class="action"></td></tr><tr><td class="line">82</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * because the saved hash should never be displayed nor the length</span></td><td class="action"></td></tr><tr><td class="line">83</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * of the actual password hinted at.</span></td><td class="action"></td></tr><tr><td class="line">84</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">85</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">86</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">87</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">88</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">password.prototype.format = function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">89</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!item.get(this.path)) return '';</span></td><td class="action"></td></tr><tr class="miss"><td class="line">90</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var len = Math.round(Math.random() * 4) + 6;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">91</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var stars = '';</span></td><td class="action"></td></tr><tr class="miss"><td class="line">92</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	for (var i = 0; i &lt; len; i++) stars += '*';</span></td><td class="action"></td></tr><tr class="miss"><td class="line">93</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return stars;</span></td><td class="action"></td></tr><tr><td class="line">94</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">95</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">96</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">97</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">98</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Compares</span></td><td class="action"></td></tr><tr><td class="line">99</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">100</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">101</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">102</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">103</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">password.prototype.compare = function(item, candidate, callback) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">104</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if ('function' !== typeof callback) throw new Error('Password.compare() requires a callback function.');</span></td><td class="action"></td></tr><tr class="miss"><td class="line">105</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var value = item.get(this.path);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">106</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!value) return callback(null, false);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">107</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	bcrypt.compare(candidate, item.get(this.path), callback);</span></td><td class="action"></td></tr><tr><td class="line">108</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">109</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">110</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">111</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">112</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * If password fields are required, check that either a value has been</span></td><td class="action"></td></tr><tr><td class="line">113</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * provided or already exists in the field.</span></td><td class="action"></td></tr><tr><td class="line">114</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">115</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Otherwise, input is always considered valid, as providing an empty</span></td><td class="action"></td></tr><tr><td class="line">116</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * value will not change the password.</span></td><td class="action"></td></tr><tr><td class="line">117</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">118</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">119</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">120</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">121</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">password.prototype.validateInput = function(data, required, item) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">122</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!required) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">123</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return true;</span></td><td class="action"></td></tr><tr><td class="line">124</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">125</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">126</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return (data[this.path] || item.get(this.path)) ? true : false;</span></td><td class="action"></td></tr><tr><td class="line">127</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">128</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return data[this.path] ? true : false;</span></td><td class="action"></td></tr><tr><td class="line">129</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">130</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">131</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">132</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">133</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Export class</span></td><td class="action"></td></tr><tr><td class="line">134</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">135</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">136</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports = module.exports = password;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/fieldTypes/relationship.js">lib/fieldTypes/relationship.js</h2><div class="stats low"><div class="percentage">46% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">33% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">17% block coverage</div><div class="sloc">91 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Module dependencies.</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">5</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var _ = require('underscore'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">6</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	keystone = require('../../'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">7</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	util = require('util'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">8</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	utils = require('keystone-utils'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">9</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	super_ = require('../field');</span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Relationship FieldType Constructor</span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @extends Field</span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">16</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">17</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function relationship(list, path, options) {</span></td><td class="action"></td></tr><tr><td class="line">18</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit partial"><td class="line">19</td><td class="hits">14</td><td class="statements">67%</td><td class="source"><span class="statement ">	this.many = (options.many) ?</span><span class="statement notok"><span class="offscreen"> not covered </span>true</span><span class="statement ">: false;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">20</td><td class="hits">14</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.filters = options.filters;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">21</td><td class="hits">14</td><td class="statements">100%</td><td class="source"><span class="statement ">	this._nativeType = keystone.mongoose.Schema.Types.ObjectId;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">22</td><td class="hits">14</td><td class="statements">100%</td><td class="source"><span class="statement ">	this._underscoreMethods = ['format'];</span></td><td class="action"></td></tr><tr><td class="line">23</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">24</td><td class="hits">14</td><td class="statements">100%</td><td class="source"><span class="statement ">	relationship.super_.call(this, list, path, options);</span></td><td class="action"></td></tr><tr><td class="line">25</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">26</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">28</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">29</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Inherit from Field</span></td><td class="action"></td></tr><tr><td class="line">30</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">31</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">32</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">util.inherits(relationship, super_);</span></td><td class="action"></td></tr><tr><td class="line">33</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">34</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">35</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">36</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Registers the field on the List's Mongoose Schema.</span></td><td class="action"></td></tr><tr><td class="line">37</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">38</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">39</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">40</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">41</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">relationship.prototype.addToSchema = function() {
</span></td><td class="action"></td></tr><tr class="hit "><td class="line">42</td><td class="hits">14</td><td class="statements">100%</td><td class="source"><span class="statement ">	var field = this,
		schema = this.list.schema;</span></td><td class="action"></td></tr><tr><td class="line">43</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">44</td><td class="hits">14</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.paths = {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">45</td><td class="hits">14</td><td class="statements">100%</td><td class="source"><span class="statement ">		refList: this.options.refListPath || this._path.append('RefList')</span></td><td class="action"></td></tr><tr><td class="line">46</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">47</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">48</td><td class="hits">14</td><td class="statements">100%</td><td class="source"><span class="statement ">	var def = {
		type: this._nativeType,
		ref: this.options.ref
	};</span></td><td class="action"></td></tr><tr><td class="line">49</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit partial"><td class="line">50</td><td class="hits">14</td><td class="statements">75%</td><td class="source"><span class="statement ">	schema.path(this.path, this.many ?</span><span class="statement notok"><span class="offscreen"> not covered </span>[def]</span><span class="statement ">: def);</span></td><td class="action"></td></tr><tr><td class="line">51</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">52</td><td class="hits">14</td><td class="statements">100%</td><td class="source"><span class="statement ">	schema.virtual(this.paths.refList).get(function () {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">53</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return keystone.list(field.options.ref);</span></td><td class="action"></td></tr><tr><td class="line">54</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">55</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">56</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (this.many) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">57</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		this.underscoreMethod('contains', function(find) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">58</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var value = this.populated(field.path) || this.get(field.path);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">59</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if ('object' === typeof find) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">60</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				find = find.id;</span></td><td class="action"></td></tr><tr><td class="line">61</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">62</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var result = _.some(value, function(value) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">63</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				return (value + '' === find);</span></td><td class="action"></td></tr><tr><td class="line">64</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			});</span></td><td class="action"></td></tr><tr class="miss"><td class="line">65</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return result;</span></td><td class="action"></td></tr><tr><td class="line">66</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		});</span></td><td class="action"></td></tr><tr><td class="line">67</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">68</td><td class="hits">14</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.bindUnderscoreMethods();</span></td><td class="action"></td></tr><tr><td class="line">69</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">70</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">71</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">72</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Formats the field value</span></td><td class="action"></td></tr><tr><td class="line">73</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">74</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">75</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr class="hit "><td class="line">76</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">relationship.prototype.format = function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">77</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var value = item.get(this.path);</span></td><td class="action"></td></tr><tr><td class="line">78</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// force the formatted value to be a - unexpected things happen with ObjectIds.</span></td><td class="action"></td></tr><tr class="miss"><td class="line">79</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return this.many ? value.join(', ') : (value || '') + '';</span></td><td class="action"></td></tr><tr><td class="line">80</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">81</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">82</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">83</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">84</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Validates that a value for this field has been provided in a data object</span></td><td class="action"></td></tr><tr><td class="line">85</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">86</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">87</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">88</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">89</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">relationship.prototype.validateInput = function(data, required, item) {
</span></td><td class="action"></td></tr><tr class="hit "><td class="line">90</td><td class="hits">14</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (!required) return true;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">91</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!(this.path in data) &amp;&amp; item &amp;&amp; ((this.many &amp;&amp; item.get(this.path).length) || item.get(this.path))) return true;</span></td><td class="action"></td></tr><tr><td class="line">92</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">93</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if ('string' === typeof data[this.path]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">94</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return (data[this.path].trim()) ? true : false;</span></td><td class="action"></td></tr><tr><td class="line">95</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">96</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return (data[this.path]) ? true : false;</span></td><td class="action"></td></tr><tr><td class="line">97</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">98</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">99</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">100</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">101</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Updates the value for this field in the item from a data object.</span></td><td class="action"></td></tr><tr><td class="line">102</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Only updates the value if it has changed.</span></td><td class="action"></td></tr><tr><td class="line">103</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Treats an empty string as a null value.</span></td><td class="action"></td></tr><tr><td class="line">104</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">105</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">106</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">107</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">108</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">relationship.prototype.updateItem = function(item, data) {
</span></td><td class="action"></td></tr><tr class="hit "><td class="line">109</td><td class="hits">14</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (!(this.path in data)) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">110</td><td class="hits">14</td><td class="statements">100%</td><td class="source"><span class="statement ">		return;</span></td><td class="action"></td></tr><tr><td class="line">111</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">112</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (item.populated(this.path)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">113</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('fieldTypes.relationship.updateItem() Error - You cannot update populated relationships.');</span></td><td class="action"></td></tr><tr><td class="line">114</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">115</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var arr = item.get(this.path),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">116</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			_old = arr.map(function(i) { return String(i); }),</span></td><td class="action"></td></tr><tr><td class="line">117</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			_new = data[this.path];</span></td><td class="action"></td></tr><tr><td class="line">118</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">119</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (!utils.isArray(_new)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">120</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			_new = String(_new || '').split(',');</span></td><td class="action"></td></tr><tr><td class="line">121</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">122</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		_new = _.compact(_new);</span></td><td class="action"></td></tr><tr><td class="line">123</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">124</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		// remove ids</span></td><td class="action"></td></tr><tr class="miss"><td class="line">125</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		_.difference(_old, _new).forEach(function(val) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">126</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			arr.pull(val);</span></td><td class="action"></td></tr><tr><td class="line">127</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		});</span></td><td class="action"></td></tr><tr><td class="line">128</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		// add new ids</span></td><td class="action"></td></tr><tr class="miss"><td class="line">129</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		_.difference(_new, _old).forEach(function(val) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">130</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			arr.push(val);</span></td><td class="action"></td></tr><tr><td class="line">131</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		});</span></td><td class="action"></td></tr><tr><td class="line">132</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">133</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else {</span></td><td class="action"></td></tr><tr><td class="line">134</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (data[this.path]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">135</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (data[this.path] !== item.get(this.path)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">136</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				item.set(this.path, data[this.path]);</span></td><td class="action"></td></tr><tr><td class="line">137</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">138</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		} else if (item.get(this.path)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">139</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			item.set(this.path, null);</span></td><td class="action"></td></tr><tr><td class="line">140</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">141</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">142</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">143</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">144</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Returns true if the relationship configuration is valid</span></td><td class="action"></td></tr><tr><td class="line">145</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">146</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">147</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">148</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">149</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Object.defineProperty(relationship.prototype, 'isValid', {
	get: function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">150</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return keystone.list(this.options.ref) ? true : false;</span></td><td class="action"></td></tr><tr><td class="line">151</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">152</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">153</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">154</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">155</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Returns the Related List</span></td><td class="action"></td></tr><tr><td class="line">156</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">157</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">158</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">159</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">160</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Object.defineProperty(relationship.prototype, 'refList', {
	get: function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">161</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return keystone.list(this.options.ref);</span></td><td class="action"></td></tr><tr><td class="line">162</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">163</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">164</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">165</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">166</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Whether the field has any filters defined</span></td><td class="action"></td></tr><tr><td class="line">167</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">168</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">169</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">170</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">171</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Object.defineProperty(relationship.prototype, 'hasFilters', {
	get: function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">172</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return (this.filters &amp;&amp; _.keys(this.filters).length);</span></td><td class="action"></td></tr><tr><td class="line">173</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">174</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">175</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">176</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">177</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Adds relationship filters to a query</span></td><td class="action"></td></tr><tr><td class="line">178</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">179</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">180</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">181</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">182</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">relationship.prototype.addFilters = function(query, item) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">183</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	_.each(this.filters, function(filters, path) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">184</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (!utils.isObject(filters)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">185</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			filters = { equals: filters };</span></td><td class="action"></td></tr><tr><td class="line">186</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">187</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		query.where(path);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">188</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		_.each(filters, function(value, method) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">189</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if ('string' === typeof value &amp;&amp; value.substr(0,1) === ':') {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">190</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (!item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">191</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					return;</span></td><td class="action"></td></tr><tr><td class="line">192</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">193</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				value = item.get(value.substr(1));</span></td><td class="action"></td></tr><tr><td class="line">194</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">195</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			query[method](value);</span></td><td class="action"></td></tr><tr><td class="line">196</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		});</span></td><td class="action"></td></tr><tr><td class="line">197</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">198</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">199</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">200</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">201</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">202</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Export class</span></td><td class="action"></td></tr><tr><td class="line">203</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">204</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">205</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports = module.exports = relationship;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/fieldTypes/s3file.js">lib/fieldTypes/s3file.js</h2><div class="stats terrible"><div class="percentage">22% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">13% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">0% block coverage</div><div class="sloc">134 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Module dependencies.</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">5</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var _ = require('underscore'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">6</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	moment = require('moment'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">7</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	keystone = require('../../'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">8</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	async = require('async'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">9</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	util = require('util'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">10</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	knox = require('knox'),</span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// s3 = require('s3'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">12</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	utils = require('keystone-utils'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">13</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	super_ = require('../field');</span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">16</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * S3File FieldType Constructor</span></td><td class="action"></td></tr><tr><td class="line">17</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @extends Field</span></td><td class="action"></td></tr><tr><td class="line">18</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">19</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">20</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">21</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function s3file(list, path, options) {</span></td><td class="action"></td></tr><tr><td class="line">22</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._underscoreMethods = ['format', 'uploadFile'];</span></td><td class="action"></td></tr><tr><td class="line">24</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">25</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// event queues</span></td><td class="action"></td></tr><tr class="miss"><td class="line">26</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._pre = {</span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">28</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// TODO: implement filtering, usage disabled for now</span></td><td class="action"></td></tr><tr class="miss"><td class="line">29</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	options.nofilter = true;</span></td><td class="action"></td></tr><tr><td class="line">30</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">31</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// TODO: implement initial form, usage disabled for now</span></td><td class="action"></td></tr><tr><td class="line">32</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (options.initial) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">33</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('Invalid Configuration\n\n' +</span></td><td class="action"></td></tr><tr><td class="line">34</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">35</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	s3file.super_.call(this, list, path, options);</span></td><td class="action"></td></tr><tr><td class="line">37</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">38</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// validate s3 config (has to happen after super_.call)</span></td><td class="action"></td></tr><tr class="miss"><td class="line">39</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!this.s3config) {</span></td><td class="action"></td></tr><tr><td class="line">40</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('Invalid Configuration\n\n' +</span></td><td class="action"></td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			'S3File fields (' + list.key + '.' + path + ') require the &quot;s3 config&quot; option to be set.\n\n' +</span></td><td class="action"></td></tr><tr class="miss"><td class="line">42</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			'See http://keystonejs.com/docs/configuration/#services-amazons3 for more information.\n');</span></td><td class="action"></td></tr><tr><td class="line">43</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">44</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">45</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Could be more pre- hooks, just upload for now</span></td><td class="action"></td></tr><tr class="miss"><td class="line">46</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (options.pre &amp;&amp; options.pre.upload) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">47</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		this._pre.upload = this._pre.upload.concat(options.pre.upload);</span></td><td class="action"></td></tr><tr><td class="line">48</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">49</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">50</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">51</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">52</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">53</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Inherit from Field</span></td><td class="action"></td></tr><tr><td class="line">54</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">55</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">56</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">util.inherits(s3file, super_);</span></td><td class="action"></td></tr><tr><td class="line">57</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">58</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">59</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Exposes the custom or keystone s3 config settings</span></td><td class="action"></td></tr><tr><td class="line">60</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">61</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">62</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Object.defineProperty(s3file.prototype, 's3config', { get: function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">63</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return this.options.s3config || keystone.get('s3 config');</span></td><td class="action"></td></tr><tr><td class="line">64</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}});</span></td><td class="action"></td></tr><tr><td class="line">65</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">66</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">67</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">68</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Allows you to add pre middleware after the field has been initialised</span></td><td class="action"></td></tr><tr><td class="line">69</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">70</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">71</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">72</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">73</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">s3file.prototype.pre = function(event, fn) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">74</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!this._pre[event]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">75</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('S3File (' + this.list.key + '.' + this.path + ') error: s3field.pre()\n\n' +</span></td><td class="action"></td></tr><tr><td class="line">76</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">77</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._pre[event].push(fn);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">78</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return this;</span></td><td class="action"></td></tr><tr><td class="line">79</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">80</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">81</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">82</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">83</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Registers the field on the List's Mongoose Schema.</span></td><td class="action"></td></tr><tr><td class="line">84</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">85</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">86</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">87</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">88</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">s3file.prototype.addToSchema = function() {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">89</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var field = this,</span></td><td class="action"></td></tr><tr><td class="line">90</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">91</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var paths = this.paths = {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">92</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		filename:		this._path.append('.filename'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">93</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		path:			this._path.append('.path'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">94</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		size:			this._path.append('.size'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">95</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		filetype:		this._path.append('.filetype'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">96</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		url:			this._path.append('.url'),</span></td><td class="action"></td></tr><tr><td class="line">97</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		// virtuals</span></td><td class="action"></td></tr><tr class="miss"><td class="line">98</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		exists:			this._path.append('.exists'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">99</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		upload:			this._path.append('_upload'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">100</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		action:			this._path.append('_action')</span></td><td class="action"></td></tr><tr><td class="line">101</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">102</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">103</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var schemaPaths = this._path.addTo({}, {</span></td><td class="action"></td></tr><tr><td class="line">104</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">105</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	schema.add(schemaPaths);</span></td><td class="action"></td></tr><tr><td class="line">106</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">107</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var exists = function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">108</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return (item.get(paths.url) ? true : false);</span></td><td class="action"></td></tr><tr><td class="line">109</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">110</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">111</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// The .exists virtual indicates whether a file is stored</span></td><td class="action"></td></tr><tr class="miss"><td class="line">112</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	schema.virtual(paths.exists).get(function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">113</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return schemaMethods.exists.apply(this);</span></td><td class="action"></td></tr><tr><td class="line">114</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">115</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">116</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var reset = function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">117</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		item.set(field.path, {</span></td><td class="action"></td></tr><tr><td class="line">118</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">119</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">120</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var schemaMethods = {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">121</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return exists(this);</span></td><td class="action"></td></tr><tr><td class="line">122</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		},</span></td><td class="action"></td></tr><tr class="miss"><td class="line">123</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			reset(this);</span></td><td class="action"></td></tr><tr><td class="line">124</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		},</span></td><td class="action"></td></tr><tr class="miss"><td class="line">125</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				var client = knox.createClient(field.s3config);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">126</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				client.deleteFile(this.get(paths.path) + this.get(paths.filename), function(err, res){ res ? res.resume() : false; });</span></td><td class="action"></td></tr><tr><td class="line">127</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			} catch(e) {}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">128</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			reset(this);</span></td><td class="action"></td></tr><tr><td class="line">129</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">130</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">131</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	_.each(schemaMethods, function(fn, key) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">132</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		field.underscoreMethod(key, fn);</span></td><td class="action"></td></tr><tr><td class="line">133</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">134</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">135</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// expose a method on the field to call schema methods</span></td><td class="action"></td></tr><tr class="miss"><td class="line">136</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.apply = function(item, method) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">137</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return schemaMethods[method].apply(item, Array.prototype.slice.call(arguments, 2));</span></td><td class="action"></td></tr><tr><td class="line">138</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">139</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">140</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.bindUnderscoreMethods();</span></td><td class="action"></td></tr><tr><td class="line">141</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">142</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">143</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">144</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">145</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Formats the field value</span></td><td class="action"></td></tr><tr><td class="line">146</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">147</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">148</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">149</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">150</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">s3file.prototype.format = function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">151</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return item.get(this.paths.url);</span></td><td class="action"></td></tr><tr><td class="line">152</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">153</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">154</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">155</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">156</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Detects whether the field has been modified</span></td><td class="action"></td></tr><tr><td class="line">157</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">158</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">159</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">160</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">161</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">s3file.prototype.isModified = function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">162</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return item.isModified(this.paths.url);</span></td><td class="action"></td></tr><tr><td class="line">163</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">164</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">165</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">166</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">167</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Validates that a value for this field has been provided in a data object</span></td><td class="action"></td></tr><tr><td class="line">168</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">169</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">170</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">171</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">172</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">s3file.prototype.validateInput = function(data) {
	// TODO - how should file field input be validated?</span></td><td class="action"></td></tr><tr class="miss"><td class="line">173</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return true;</span></td><td class="action"></td></tr><tr><td class="line">174</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">175</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">176</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">177</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">178</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Updates the value for this field in the item from a data object</span></td><td class="action"></td></tr><tr><td class="line">179</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">180</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">181</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">182</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">183</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">s3file.prototype.updateItem = function(item, data) {
	// TODO - direct updating of data (not via upload)
};</span></td><td class="action"></td></tr><tr><td class="line">184</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">185</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">186</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">187</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Uploads the file for this field</span></td><td class="action"></td></tr><tr><td class="line">188</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">189</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">190</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">191</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">192</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">s3file.prototype.uploadFile = function(item, file, update, callback) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">193</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var field = this,</span></td><td class="action"></td></tr><tr class="miss"><td class="line">194</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		path = field.options.s3path ? field.options.s3path + '/' : '',</span></td><td class="action"></td></tr><tr class="miss"><td class="line">195</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		prefix = field.options.datePrefix ? moment().format(field.options.datePrefix) + '-' : '',</span></td><td class="action"></td></tr><tr class="miss"><td class="line">196</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		name = prefix + file.name;</span></td><td class="action"></td></tr><tr><td class="line">197</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">198</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (field.options.allowedTypes &amp;&amp; !_.contains(field.options.allowedTypes, file.type)){</span></td><td class="action"></td></tr><tr class="miss"><td class="line">199</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return callback(new Error('Unsupported File Type: '+file.type));</span></td><td class="action"></td></tr><tr><td class="line">200</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">201</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if ('function' == typeof update) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">202</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		callback = update;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">203</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		update = false;</span></td><td class="action"></td></tr><tr><td class="line">204</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">205</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var doUpload = function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">206</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		knox.createClient(field.s3config).putFile(file.path, path + name, {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">207</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (res) res.resume();</span></td><td class="action"></td></tr><tr class="miss"><td class="line">208</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (err) return callback(err);</span></td><td class="action"></td></tr><tr><td class="line">209</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">210</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var protocol = (field.s3config.protocol &amp;&amp; field.s3config.protocol + ':') || '',</span></td><td class="action"></td></tr><tr><td class="line">211</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">212</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var fileData = {</span></td><td class="action"></td></tr><tr><td class="line">213</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				filename: name,</span></td><td class="action"></td></tr><tr><td class="line">214</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">215</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (update) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">216</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				item.set(field.path, fileData);</span></td><td class="action"></td></tr><tr><td class="line">217</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">218</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			callback(null, fileData);</span></td><td class="action"></td></tr><tr><td class="line">219</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">220</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">221</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">222</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	async.eachSeries(this._pre.upload, function(fn, next) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">223</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		fn(item, file, next);</span></td><td class="action"></td></tr><tr><td class="line">224</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}, function(err) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">225</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (err) return callback(err);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">226</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		doUpload();</span></td><td class="action"></td></tr><tr><td class="line">227</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">228</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">229</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">230</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">231</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">232</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Returns a callback that handles a standard form submission for the field</span></td><td class="action"></td></tr><tr><td class="line">233</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">234</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Expected form parts are</span></td><td class="action"></td></tr><tr><td class="line">235</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * - `field.paths.action` in `req.body` (`clear` or `delete`)</span></td><td class="action"></td></tr><tr><td class="line">236</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * - `field.paths.upload` in `req.files` (uploads the file to s3file)</span></td><td class="action"></td></tr><tr><td class="line">237</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">238</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">239</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">240</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">241</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">s3file.prototype.getRequestHandler = function(item, req, paths, callback) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">242</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var field = this;</span></td><td class="action"></td></tr><tr><td class="line">243</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">244</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (utils.isFunction(paths)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">245</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		callback = paths;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">246</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		paths = field.paths;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">247</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else if (!paths) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">248</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		paths = field.paths;</span></td><td class="action"></td></tr><tr><td class="line">249</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">250</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	callback = callback || function() {};</span></td><td class="action"></td></tr><tr><td class="line">251</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">252</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">253</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var action = req.body[paths.action];</span></td><td class="action"></td></tr><tr><td class="line">254</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">255</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (/^(delete|reset)$/.test(action))</span></td><td class="action"></td></tr><tr class="miss"><td class="line">256</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				field.apply(item, action);</span></td><td class="action"></td></tr><tr><td class="line">257</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">258</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (req.files &amp;&amp; req.files[paths.upload] &amp;&amp; req.files[paths.upload].size) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">259</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return field.uploadFile(item, req.files[paths.upload], true, callback);</span></td><td class="action"></td></tr><tr><td class="line">260</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">261</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return callback();</span></td><td class="action"></td></tr><tr><td class="line">262</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">263</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">264</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">265</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">266</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">267</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Immediately handles a standard form submission for the field (see `getRequestHandler()`)</span></td><td class="action"></td></tr><tr><td class="line">268</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">269</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">270</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">271</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">272</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">s3file.prototype.handleRequest = function(item, req, paths, callback) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">273</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.getRequestHandler(item, req, paths, callback)();</span></td><td class="action"></td></tr><tr><td class="line">274</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">275</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">276</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">277</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">278</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Export class</span></td><td class="action"></td></tr><tr><td class="line">279</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">280</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">281</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports = module.exports = s3file;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/fieldTypes/select.js">lib/fieldTypes/select.js</h2><div class="stats terrible"><div class="percentage">22% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">12% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">0% block coverage</div><div class="sloc">71 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Module dependencies.</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">5</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var _ = require('underscore'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">6</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	util = require('util'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">7</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	utils = require('keystone-utils'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">8</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	super_ = require('../field');</span></td><td class="action"></td></tr><tr><td class="line">9</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Select FieldType Constructor</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @extends Field</span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">16</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function select(list, path, options) {</span></td><td class="action"></td></tr><tr><td class="line">17</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">18</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._nativeType = (options.numeric) ? Number : String;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">19</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._underscoreMethods = ['format'];</span></td><td class="action"></td></tr><tr><td class="line">20</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.ui = options.ui || 'select';</span></td><td class="action"></td></tr><tr><td class="line">22</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (typeof options.options === 'string') {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">24</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		options.options = options.options.split(',');</span></td><td class="action"></td></tr><tr><td class="line">25</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">26</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">27</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!Array.isArray(options.options)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">28</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('Select fields require an options array.');</span></td><td class="action"></td></tr><tr><td class="line">29</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">30</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">31</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.ops = options.options.map(function(i) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var op = _.isString(i) ? { value: i.trim(), label: utils.keyToLabel(i) } : i;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">33</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (!_.isObject(op)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">34</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			op = { label: ''+i, value: ''+i };</span></td><td class="action"></td></tr><tr><td class="line">35</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (options.numeric &amp;&amp; !_.isNumber(op.value)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			op.value = Number(op.value);</span></td><td class="action"></td></tr><tr><td class="line">38</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">39</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return op;</span></td><td class="action"></td></tr><tr><td class="line">40</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">41</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">42</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// undefined options.emptyOption defaults to true</span></td><td class="action"></td></tr><tr class="miss"><td class="line">43</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (options.emptyOption === undefined) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">44</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		options.emptyOption = true;</span></td><td class="action"></td></tr><tr><td class="line">45</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">46</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">47</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// ensure this.emptyOption is a boolean</span></td><td class="action"></td></tr><tr class="miss"><td class="line">48</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.emptyOption = options.emptyOption ? true : false;</span></td><td class="action"></td></tr><tr><td class="line">49</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">50</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// cached maps for options, labels and values</span></td><td class="action"></td></tr><tr class="miss"><td class="line">51</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.map = utils.optionsMap(this.ops);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">52</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.labels = utils.optionsMap(this.ops, 'label');</span></td><td class="action"></td></tr><tr class="miss"><td class="line">53</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.values = _.pluck(this.ops, 'value');</span></td><td class="action"></td></tr><tr><td class="line">54</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">55</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	select.super_.call(this, list, path, options);</span></td><td class="action"></td></tr><tr><td class="line">56</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">57</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">58</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">59</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Inherit from Field</span></td><td class="action"></td></tr><tr><td class="line">60</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">61</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">62</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">util.inherits(select, super_);</span></td><td class="action"></td></tr><tr><td class="line">63</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">64</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">65</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Registers the field on the List's Mongoose Schema.</span></td><td class="action"></td></tr><tr><td class="line">66</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">67</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Adds a virtual for accessing the label of the selected value,</span></td><td class="action"></td></tr><tr><td class="line">68</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * and statics to the Schema for converting a value to a label,</span></td><td class="action"></td></tr><tr><td class="line">69</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * and retrieving all of the defined options.</span></td><td class="action"></td></tr><tr><td class="line">70</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">71</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">72</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">73</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">74</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">select.prototype.addToSchema = function() {
	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">75</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var field = this,</span></td><td class="action"></td></tr><tr><td class="line">76</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">77</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.paths = {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">78</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		data: this.options.dataPath || this._path.append('Data'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">79</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		label: this.options.labelPath || this._path.append('Label'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">80</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		options: this.options.optionsPath || this._path.append('Options'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">81</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		map: this.options.optionsMapPath || this._path.append('OptionsMap')</span></td><td class="action"></td></tr><tr><td class="line">82</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">83</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">84</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	schema.path(this.path, _.defaults({</span></td><td class="action"></td></tr><tr class="miss"><td class="line">85</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return (val === '') ? undefined : val;</span></td><td class="action"></td></tr><tr><td class="line">86</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">87</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">88</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	schema.virtual(this.paths.data).get(function () {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">89</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return field.map[this.get(field.path)];</span></td><td class="action"></td></tr><tr><td class="line">90</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">91</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">92</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	schema.virtual(this.paths.label).get(function () {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">93</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return field.labels[this.get(field.path)];</span></td><td class="action"></td></tr><tr><td class="line">94</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">95</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">96</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	schema.virtual(this.paths.options).get(function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">97</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return field.ops;</span></td><td class="action"></td></tr><tr><td class="line">98</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">99</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">100</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	schema.virtual(this.paths.map).get(function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">101</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return field.map;</span></td><td class="action"></td></tr><tr><td class="line">102</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">103</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">104</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.underscoreMethod('pluck', function(property, d) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">105</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var option = this.get(field.paths.data);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">106</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return (option) ? option[property] : d;</span></td><td class="action"></td></tr><tr><td class="line">107</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">108</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">109</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.bindUnderscoreMethods();</span></td><td class="action"></td></tr><tr><td class="line">110</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">111</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">112</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">113</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Retrieves a shallow clone of the options array</span></td><td class="action"></td></tr><tr><td class="line">114</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">115</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">116</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">117</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">118</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">select.prototype.cloneOps = function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">119</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return _.map(this.ops, _.clone);</span></td><td class="action"></td></tr><tr><td class="line">120</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">121</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">122</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">123</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">124</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Retrieves a shallow clone of the options map</span></td><td class="action"></td></tr><tr><td class="line">125</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">126</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">127</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">128</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">129</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">select.prototype.cloneMap = function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">130</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return utils.optionsMap(this.ops, true);</span></td><td class="action"></td></tr><tr><td class="line">131</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">132</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">133</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">134</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">135</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Validates that a valid option has been provided in a data object</span></td><td class="action"></td></tr><tr><td class="line">136</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">137</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">138</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">139</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">140</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">select.prototype.validateInput = function(data, required, item) {
	
	if (data[this.path]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">141</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return (data[this.path] in this.map) ? true : false;</span></td><td class="action"></td></tr><tr><td class="line">142</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">143</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return (!required || (!(this.path in data) &amp;&amp; item &amp;&amp; item.get(this.path))) ? true : false;</span></td><td class="action"></td></tr><tr><td class="line">144</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">145</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">146</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">147</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">148</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Formats the field value</span></td><td class="action"></td></tr><tr><td class="line">149</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">150</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">151</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">152</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">153</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">select.prototype.format = function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">154</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return this.labels[item.get(this.path)];</span></td><td class="action"></td></tr><tr><td class="line">155</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">156</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">157</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">158</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">159</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Export class</span></td><td class="action"></td></tr><tr><td class="line">160</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">161</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">162</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports = module.exports = select;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/fieldTypes/text.js">lib/fieldTypes/text.js</h2><div class="stats high"><div class="percentage">90% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">82% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">50% block coverage</div><div class="sloc">11 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Module dependencies.</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">5</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var util = require('util'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">6</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	utils = require('keystone-utils'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">7</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	super_ = require('../field');</span></td><td class="action"></td></tr><tr><td class="line">8</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">9</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Text FieldType Constructor</span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @extends Field</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function text(list, path, options) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">16</td><td class="hits">16</td><td class="statements">100%</td><td class="source"><span class="statement ">	this._nativeType = String;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">17</td><td class="hits">16</td><td class="statements">100%</td><td class="source"><span class="statement ">	this._underscoreMethods = ['crop'];</span></td><td class="action"></td></tr><tr class="hit "><td class="line">18</td><td class="hits">16</td><td class="statements">100%</td><td class="source"><span class="statement ">	text.super_.call(this, list, path, options);</span></td><td class="action"></td></tr><tr><td class="line">19</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">20</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">21</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">22</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Inherit from Field</span></td><td class="action"></td></tr><tr><td class="line">23</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">24</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">25</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">util.inherits(text, super_);</span></td><td class="action"></td></tr><tr><td class="line">26</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">28</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">29</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Crops the string to the specifed length.</span></td><td class="action"></td></tr><tr><td class="line">30</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">31</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">32</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">33</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">34</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">text.prototype.crop = function(item, length, append, preserveWords) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return utils.cropString(item.get(this.path), length, append, preserveWords);</span></td><td class="action"></td></tr><tr><td class="line">36</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">37</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">38</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">39</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">40</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Export class</span></td><td class="action"></td></tr><tr><td class="line">41</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">42</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">43</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports = module.exports = text;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/fieldTypes/textarea.js">lib/fieldTypes/textarea.js</h2><div class="stats medium"><div class="percentage">60% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">50% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">0% block coverage</div><div class="sloc">15 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Module dependencies.</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">5</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var util = require('util'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">6</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	utils = require('keystone-utils'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">7</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	super_ = require('../field');</span></td><td class="action"></td></tr><tr><td class="line">8</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">9</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Text FieldType Constructor</span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @extends Field</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function textarea(list, path, options) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">16</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._nativeType = String;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">17</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._underscoreMethods = ['format', 'crop'];</span></td><td class="action"></td></tr><tr class="miss"><td class="line">18</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.height = options.height || 90;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">19</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	textarea.super_.call(this, list, path, options);</span></td><td class="action"></td></tr><tr><td class="line">20</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">21</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">22</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">23</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Inherit from Field</span></td><td class="action"></td></tr><tr><td class="line">24</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">25</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">26</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">util.inherits(textarea, super_);</span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">28</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">29</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">30</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Formats the field value</span></td><td class="action"></td></tr><tr><td class="line">31</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">32</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">33</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">34</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">35</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">textarea.prototype.format = function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return utils.textToHTML(item.get(this.path));</span></td><td class="action"></td></tr><tr><td class="line">37</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">38</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">39</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">40</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">41</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Crops the string to the specifed length.</span></td><td class="action"></td></tr><tr><td class="line">42</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">43</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">44</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">45</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">46</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">textarea.prototype.crop = function(item, length, append, preserveWords) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">47</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return utils.cropString(item.get(this.path), length, append, preserveWords);</span></td><td class="action"></td></tr><tr><td class="line">48</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">49</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">50</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">51</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">52</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Export class</span></td><td class="action"></td></tr><tr><td class="line">53</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">54</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">55</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports = module.exports = textarea;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/fieldTypes/url.js">lib/fieldTypes/url.js</h2><div class="stats medium"><div class="percentage">60% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">52% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">0% block coverage</div><div class="sloc">10 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Module dependencies.</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">5</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var util = require('util'),
	super_ = require('../field');</span></td><td class="action"></td></tr><tr><td class="line">6</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">7</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">8</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * URL FieldType Constructor</span></td><td class="action"></td></tr><tr><td class="line">9</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @extends Field</span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function url(list, path, options) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">14</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._nativeType = String;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">15</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._underscoreMethods = ['format'];</span></td><td class="action"></td></tr><tr class="miss"><td class="line">16</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	url.super_.call(this, list, path, options);</span></td><td class="action"></td></tr><tr><td class="line">17</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">18</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">19</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">20</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Inherit from Field</span></td><td class="action"></td></tr><tr><td class="line">21</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">22</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">23</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">util.inherits(url, super_);</span></td><td class="action"></td></tr><tr><td class="line">24</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">25</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">26</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Formats the field value</span></td><td class="action"></td></tr><tr><td class="line">28</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">29</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Strips the leading protocol from the value for simpler display</span></td><td class="action"></td></tr><tr><td class="line">30</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">31</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">32</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">33</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">34</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">url.prototype.format = function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return (item.get(this.path) || '').replace(/^[a-zA-Z]\:\/\//, '');</span></td><td class="action"></td></tr><tr><td class="line">36</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">37</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">38</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">39</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>// TODO: Proper url validation</span></td><td class="action"></td></tr><tr><td class="line">40</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">41</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">42</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">43</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Export class</span></td><td class="action"></td></tr><tr><td class="line">44</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">45</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">46</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports = module.exports = url;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/fieldTypes/localfiles.js">lib/fieldTypes/localfiles.js</h2><div class="stats terrible"><div class="percentage">18% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">10% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">0% block coverage</div><div class="sloc">172 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Module dependencies.</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">5</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var fs = require('fs'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">6</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	path = require('path'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">7</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	_ = require('underscore'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">8</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	moment = require('moment'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">9</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	keystone = require('../../'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">10</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	async = require('async'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">11</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	util = require('util'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">12</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	utils = require('keystone-utils'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">13</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	super_ = require('../field'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">14</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	async = require('async');</span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">16</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">17</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * localfiles FieldType Constructor</span></td><td class="action"></td></tr><tr><td class="line">18</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @extends Field</span></td><td class="action"></td></tr><tr><td class="line">19</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">20</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">21</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">22</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function localfiles(list, path, options) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._underscoreMethods = ['format', 'uploadFiles'];</span></td><td class="action"></td></tr><tr><td class="line">24</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">25</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// event queues</span></td><td class="action"></td></tr><tr class="miss"><td class="line">26</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._pre = {</span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">28</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._post = {</span></td><td class="action"></td></tr><tr><td class="line">29</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">30</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// TODO: implement filtering, usage disabled for now</span></td><td class="action"></td></tr><tr class="miss"><td class="line">31</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	options.nofilter = true;</span></td><td class="action"></td></tr><tr><td class="line">32</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">33</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// TODO: implement initial form, usage disabled for now</span></td><td class="action"></td></tr><tr><td class="line">34</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (options.initial) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('Invalid Configuration\n\n' +</span></td><td class="action"></td></tr><tr><td class="line">36</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">37</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">38</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	localfiles.super_.call(this, list, path, options);</span></td><td class="action"></td></tr><tr><td class="line">39</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">40</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// validate destination dir</span></td><td class="action"></td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!options.dest) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">42</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('Invalid Configuration\n\n' +</span></td><td class="action"></td></tr><tr><td class="line">43</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">44</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">45</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Allow hook into before and after</span></td><td class="action"></td></tr><tr class="miss"><td class="line">46</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (options.pre &amp;&amp; options.pre.move) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">47</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		this._pre.move = this._pre.move.concat(options.pre.move);</span></td><td class="action"></td></tr><tr><td class="line">48</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">49</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">50</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (options.post &amp;&amp; options.post.move) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">51</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		this._post.move = this._post.move.concat(options.post.move);</span></td><td class="action"></td></tr><tr><td class="line">52</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">53</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">54</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">55</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">56</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Inherit from Field</span></td><td class="action"></td></tr><tr><td class="line">57</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">58</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">59</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">util.inherits(localfiles, super_);</span></td><td class="action"></td></tr><tr><td class="line">60</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">61</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">62</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">63</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Allows you to add pre middleware after the field has been initialised</span></td><td class="action"></td></tr><tr><td class="line">64</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">65</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">66</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">67</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">68</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">localfiles.prototype.pre = function(event, fn) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">69</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!this._pre[event]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">70</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('localfiles (' + this.list.key + '.' + this.path + ') error: localfiles.pre()\n\n' +</span></td><td class="action"></td></tr><tr><td class="line">71</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">72</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._pre[event].push(fn);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">73</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return this;</span></td><td class="action"></td></tr><tr><td class="line">74</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">75</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">76</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">77</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">78</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Allows you to add post middleware after the field has been initialised</span></td><td class="action"></td></tr><tr><td class="line">79</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">80</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">81</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">82</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">83</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">localfiles.prototype.post = function(event, fn) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">84</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!this._post[event]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">85</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('localfiles (' + this.list.key + '.' + this.path + ') error: localfiles.post()\n\n' +</span></td><td class="action"></td></tr><tr><td class="line">86</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">87</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this._post[event].push(fn);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">88</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return this;</span></td><td class="action"></td></tr><tr><td class="line">89</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">90</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">91</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">92</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">93</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Registers the field on the List's Mongoose Schema.</span></td><td class="action"></td></tr><tr><td class="line">94</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">95</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">96</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">97</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">98</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">localfiles.prototype.addToSchema = function() {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">99</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var field = this,</span></td><td class="action"></td></tr><tr class="miss"><td class="line">100</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var mongoose = keystone.mongoose;</span></td><td class="action"></td></tr><tr><td class="line">101</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">102</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var paths = this.paths = {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">103</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		filename:		this._path.append('.filename'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">104</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		path:			  this._path.append('.path'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">105</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		size:			  this._path.append('.size'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">106</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		filetype:		this._path.append('.filetype'),</span></td><td class="action"></td></tr><tr><td class="line">107</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		// virtuals</span></td><td class="action"></td></tr><tr class="miss"><td class="line">108</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		exists:			this._path.append('.exists'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">109</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		upload:			this._path.append('_upload'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">110</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		action:			this._path.append('_action'),</span></td><td class="action"></td></tr><tr class="miss"><td class="line">111</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		order: 			this._path.append('_order'),</span></td><td class="action"></td></tr><tr><td class="line">112</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">113</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">114</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var schemaPaths = new mongoose.Schema({</span></td><td class="action"></td></tr><tr><td class="line">115</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">116</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// var schemaPaths = this._path.addTo({}, {</span></td><td class="action"></td></tr><tr><td class="line">117</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// 	filename:		String,</span></td><td class="action"></td></tr><tr><td class="line">118</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// 	path:			String,</span></td><td class="action"></td></tr><tr><td class="line">119</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// 	size:			Number,</span></td><td class="action"></td></tr><tr><td class="line">120</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// 	filetype:		String</span></td><td class="action"></td></tr><tr><td class="line">121</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// });</span></td><td class="action"></td></tr><tr><td class="line">122</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">123</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	schema.add(this._path.addTo({}, [schemaPaths]));</span></td><td class="action"></td></tr><tr><td class="line">124</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">125</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var exists = function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">126</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var filepaths = item.get(paths.path),</span></td><td class="action"></td></tr><tr><td class="line">127</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">128</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (!filepaths || !filename) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">129</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return false;</span></td><td class="action"></td></tr><tr><td class="line">130</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">131</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return fs.existsSync(path.join(filepaths, filename));</span></td><td class="action"></td></tr><tr><td class="line">132</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">133</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">134</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// The .exists virtual indicates whether a file is stored</span></td><td class="action"></td></tr><tr class="miss"><td class="line">135</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	schema.virtual(paths.exists).get(function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">136</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return schemaMethods.exists.apply(this);</span></td><td class="action"></td></tr><tr><td class="line">137</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">138</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">139</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var reset = function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">140</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		item.set(field.path, {</span></td><td class="action"></td></tr><tr><td class="line">141</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">142</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">143</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var schemaMethods = {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">144</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return exists(this);</span></td><td class="action"></td></tr><tr><td class="line">145</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		},</span></td><td class="action"></td></tr><tr class="miss"><td class="line">146</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			reset(this);</span></td><td class="action"></td></tr><tr><td class="line">147</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		},</span></td><td class="action"></td></tr><tr class="miss"><td class="line">148</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (exists(this)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">149</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				fs.unlinkSync(path.join(this.get(paths.path), this.get(paths.filename)));</span></td><td class="action"></td></tr><tr><td class="line">150</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">151</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			reset(this);</span></td><td class="action"></td></tr><tr><td class="line">152</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">153</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">154</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	_.each(schemaMethods, function(fn, key) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">155</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		field.underscoreMethod(key, fn);</span></td><td class="action"></td></tr><tr><td class="line">156</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">157</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">158</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// expose a method on the field to call schema methods</span></td><td class="action"></td></tr><tr class="miss"><td class="line">159</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.apply = function(item, method) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">160</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return schemaMethods[method].apply(item, Array.prototype.slice.call(arguments, 2));</span></td><td class="action"></td></tr><tr><td class="line">161</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">162</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">163</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.bindUnderscoreMethods();</span></td><td class="action"></td></tr><tr><td class="line">164</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">165</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">166</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">167</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">168</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Formats the field value</span></td><td class="action"></td></tr><tr><td class="line">169</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">170</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">171</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">172</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">173</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">localfiles.prototype.format = function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">174</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return path.join(item.get(this.paths.path), item.get(this.paths.filename));</span></td><td class="action"></td></tr><tr><td class="line">175</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">176</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">177</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">178</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">179</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Detects whether the field has been modified</span></td><td class="action"></td></tr><tr><td class="line">180</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">181</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">182</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">183</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">184</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">localfiles.prototype.isModified = function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">185</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return item.isModified(this.paths.path);</span></td><td class="action"></td></tr><tr><td class="line">186</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">187</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">188</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">189</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">190</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Validates that a value for this field has been provided in a data object</span></td><td class="action"></td></tr><tr><td class="line">191</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">192</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">193</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">194</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">195</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">localfiles.prototype.validateInput = function(data) {
	// TODO - how should file field input be validated?</span></td><td class="action"></td></tr><tr class="miss"><td class="line">196</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return true;</span></td><td class="action"></td></tr><tr><td class="line">197</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">198</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">199</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">200</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">201</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Updates the value for this field in the item from a data object</span></td><td class="action"></td></tr><tr><td class="line">202</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">203</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">204</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">205</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">206</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">localfiles.prototype.updateItem = function(item, data) {
	// TODO - direct updating of data (not via upload)
};</span></td><td class="action"></td></tr><tr><td class="line">207</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">208</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">209</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">210</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Uploads the file for this field</span></td><td class="action"></td></tr><tr><td class="line">211</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">212</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">213</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">214</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">215</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">localfiles.prototype.uploadFiles = function(item, files, update, callback) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">216</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var field = this;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">217</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var fileDatas = [];</span></td><td class="action"></td></tr><tr><td class="line">218</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">219</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	_.each(files, function(file){</span></td><td class="action"></td></tr><tr class="miss"><td class="line">220</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var prefix = field.options.datePrefix ? moment().format(field.options.datePrefix) + '-' : '',</span></td><td class="action"></td></tr><tr><td class="line">221</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">222</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (field.options.allowedTypes &amp;&amp; !_.contains(field.options.allowedTypes, file.type)){</span></td><td class="action"></td></tr><tr class="miss"><td class="line">223</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return callback(new Error('Unsupported File Type: '+file.type));</span></td><td class="action"></td></tr><tr><td class="line">224</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">225</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">226</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if ('function' === typeof update) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">227</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			callback = update;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">228</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			update = false;</span></td><td class="action"></td></tr><tr><td class="line">229</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">230</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var doMove = function(callback) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">231</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if ('function' === typeof field.options.filename) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">232</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				name = field.options.filename(item, name);</span></td><td class="action"></td></tr><tr><td class="line">233</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">234</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			fs.rename(file.path, path.join(field.options.dest, name), function(err) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">235</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (err) return callback(err);</span></td><td class="action"></td></tr><tr><td class="line">236</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">237</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				var fileData = {</span></td><td class="action"></td></tr><tr><td class="line">238</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					filename: name,</span></td><td class="action"></td></tr><tr><td class="line">239</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">240</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (update) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">241</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					item.set(field.path, fileData);</span></td><td class="action"></td></tr><tr><td class="line">242</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">243</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					item.get(field.path).push(fileData);</span></td><td class="action"></td></tr><tr><td class="line">244</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">245</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				fileDatas.push(fileData);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">246</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				callback(null, fileData);</span></td><td class="action"></td></tr><tr><td class="line">247</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			});</span></td><td class="action"></td></tr><tr><td class="line">248</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			</span></td><td class="action"></td></tr><tr><td class="line">249</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">250</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		async.eachSeries(this._pre.move, function(fn, next) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">251</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			fn(item, file, next);</span></td><td class="action"></td></tr><tr><td class="line">252</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}, function(err) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">253</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (err) return callback(err);</span></td><td class="action"></td></tr><tr><td class="line">254</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">255</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			doMove(function(err, fileData) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">256</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (err) return callback(err);</span></td><td class="action"></td></tr><tr><td class="line">257</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">258</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				async.eachSeries(field._post.move, function(fn, next) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">259</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					fn(item, file, fileData, next);</span></td><td class="action"></td></tr><tr><td class="line">260</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}, function(err) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">261</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					if (err) return callback(err);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">262</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					if (fileDatas.length === files.length) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">263</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						callback(null, fileDatas);</span></td><td class="action"></td></tr><tr><td class="line">264</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					}</span></td><td class="action"></td></tr><tr><td class="line">265</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				});</span></td><td class="action"></td></tr><tr><td class="line">266</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			});</span></td><td class="action"></td></tr><tr><td class="line">267</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		});</span></td><td class="action"></td></tr><tr><td class="line">268</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">269</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">270</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">271</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">272</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">273</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Returns a callback that handles a standard form submission for the field</span></td><td class="action"></td></tr><tr><td class="line">274</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">275</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Expected form parts are</span></td><td class="action"></td></tr><tr><td class="line">276</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * - `field.paths.action` in `req.body` (`clear` or `delete`)</span></td><td class="action"></td></tr><tr><td class="line">277</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * - `field.paths.upload` in `req.files` (uploads the file to localfiles)</span></td><td class="action"></td></tr><tr><td class="line">278</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">279</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">280</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">281</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">282</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">localfiles.prototype.getRequestHandler = function(item, req, paths, callback) {
	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">283</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var field = this;</span></td><td class="action"></td></tr><tr><td class="line">284</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">285</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (utils.isFunction(paths)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">286</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		callback = paths;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">287</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		paths = field.paths;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">288</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else if (!paths) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">289</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		paths = field.paths;</span></td><td class="action"></td></tr><tr><td class="line">290</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">291</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	callback = callback || function() {};</span></td><td class="action"></td></tr><tr><td class="line">292</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">293</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">294</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var files = item.get(field.path),</span></td><td class="action"></td></tr><tr><td class="line">295</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">296</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			files.sort(function(a, b) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">297</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				return (newOrder.indexOf(a._id.toString()) &gt; newOrder.indexOf(b._id.toString())) ? 1 : -1;</span></td><td class="action"></td></tr><tr><td class="line">298</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			});</span></td><td class="action"></td></tr><tr><td class="line">299</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">300</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (req.body &amp;&amp; req.body[paths.action]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">301</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var actions = req.body[paths.action].split('|');</span></td><td class="action"></td></tr><tr><td class="line">302</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			</span></td><td class="action"></td></tr><tr class="miss"><td class="line">303</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			actions.forEach(function(action) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">304</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				action = action.split(':');</span></td><td class="action"></td></tr><tr><td class="line">305</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				</span></td><td class="action"></td></tr><tr class="miss"><td class="line">306</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				var method = action[0],</span></td><td class="action"></td></tr><tr><td class="line">307</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				</span></td><td class="action"></td></tr><tr class="miss"><td class="line">308</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (!(/^(delete|reset)$/.test(method)) || !ids) return;</span></td><td class="action"></td></tr><tr><td class="line">309</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				</span></td><td class="action"></td></tr><tr class="miss"><td class="line">310</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				ids.split(',').forEach(function(id) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">311</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					field.apply(item, action);</span></td><td class="action"></td></tr><tr><td class="line">312</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				});</span></td><td class="action"></td></tr><tr><td class="line">313</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				</span></td><td class="action"></td></tr><tr><td class="line">314</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			});</span></td><td class="action"></td></tr><tr><td class="line">315</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">316</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (req.files &amp;&amp; req.files[paths.upload] &amp;&amp; (req.files[paths.upload].length &gt; 0)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">317</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return field.uploadFiles(item, req.files[paths.upload], false, callback);</span></td><td class="action"></td></tr><tr><td class="line">318</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">319</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return callback();</span></td><td class="action"></td></tr><tr><td class="line">320</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr><td class="line">321</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">322</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">323</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">324</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">325</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Immediately handles a standard form submission for the field (see `getRequestHandler()`)</span></td><td class="action"></td></tr><tr><td class="line">326</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">327</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">328</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">329</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">330</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">localfiles.prototype.handleRequest = function(item, req, paths, callback) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">331</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.getRequestHandler(item, req, paths, callback)();</span></td><td class="action"></td></tr><tr><td class="line">332</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">333</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">334</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">335</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">336</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Export class</span></td><td class="action"></td></tr><tr><td class="line">337</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">338</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">339</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports = module.exports = localfiles;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/updateHandler.js">lib/updateHandler.js</h2><div class="stats medium"><div class="percentage">51% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">42% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">24% block coverage</div><div class="sloc">126 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr class="hit "><td class="line">1</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var _ = require('underscore'),
	keystone = require('../');</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * UpdateHandler Class</span></td><td class="action"></td></tr><tr><td class="line">5</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">6</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Object} item to update</span></td><td class="action"></td></tr><tr><td class="line">7</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">8</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">9</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function UpdateHandler(list, item, req, res, options) {</span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">12</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (!(this instanceof UpdateHandler))</span></td><td class="action"></td></tr><tr class="miss"><td class="line">13</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return new UpdateHandler(list, item);</span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">15</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.list = list;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">16</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.item = item;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">17</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.req = req;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">18</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.res = res;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">19</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.user = req.user;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">20</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.options = options || {};</span></td><td class="action"></td></tr><tr><td class="line">21</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">22</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (!this.options.errorMessage) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">23</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">		this.options.errorMessage = 'There was a problem saving your changes:';</span></td><td class="action"></td></tr><tr><td class="line">24</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">25</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">26</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (this.options.user) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">27</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		this.user = this.options.user;</span></td><td class="action"></td></tr><tr><td class="line">28</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">29</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">30</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.validationMethods = {};</span></td><td class="action"></td></tr><tr class="hit "><td class="line">31</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.validationErrors = {};</span></td><td class="action"></td></tr><tr><td class="line">32</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">33</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">34</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">35</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">36</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">37</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Adds a custom validation method for a given path</span></td><td class="action"></td></tr><tr><td class="line">38</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">39</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {string} path to call method for</span></td><td class="action"></td></tr><tr><td class="line">40</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {function} method to call</span></td><td class="action"></td></tr><tr><td class="line">41</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">42</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">43</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">44</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">UpdateHandler.prototype.validate = function(path, fn) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">45</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.validationMethods[path] = fn;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">46</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return this;</span></td><td class="action"></td></tr><tr><td class="line">47</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">48</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">49</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">50</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">51</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Adds a validationError to the updateHandler; can be used before</span></td><td class="action"></td></tr><tr><td class="line">52</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * `.process()` is called to handle errors generated by custom pre-</span></td><td class="action"></td></tr><tr><td class="line">53</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * processing.</span></td><td class="action"></td></tr><tr><td class="line">54</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">55</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {string} path that failed validation</span></td><td class="action"></td></tr><tr><td class="line">56</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {string} message to display</span></td><td class="action"></td></tr><tr><td class="line">57</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {string} error type (defaults to 'required')</span></td><td class="action"></td></tr><tr><td class="line">58</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">59</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">60</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">61</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">UpdateHandler.prototype.addValidationError = function(path, msg, type) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">62</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.validationErrors[path] = {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">63</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		type: type || 'required'</span></td><td class="action"></td></tr><tr><td class="line">64</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr class="miss"><td class="line">65</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return this;</span></td><td class="action"></td></tr><tr><td class="line">66</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">67</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">68</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">69</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">70</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Processes data from req.body, req.query, or any data source.</span></td><td class="action"></td></tr><tr><td class="line">71</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">72</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Options:</span></td><td class="action"></td></tr><tr><td class="line">73</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * - fields (comma-delimited list or array of field paths)</span></td><td class="action"></td></tr><tr><td class="line">74</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * - flashErrors (boolean, default false; whether to push validation errors to req.flash)</span></td><td class="action"></td></tr><tr><td class="line">75</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * - ignoreNoedit (boolean, default false; whether to ignore noedit settings on fields)</span></td><td class="action"></td></tr><tr><td class="line">76</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * - validationErrors (object; validation errors from previous form handling that should be included)</span></td><td class="action"></td></tr><tr><td class="line">77</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">78</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Object} data</span></td><td class="action"></td></tr><tr><td class="line">79</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Object} options (can be comma-delimited list of fields) (optional)</span></td><td class="action"></td></tr><tr><td class="line">80</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Function} callback (optional)</span></td><td class="action"></td></tr><tr><td class="line">81</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">82</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">83</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">84</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">UpdateHandler.prototype.process = function(data, options, callback) {
</span></td><td class="action"></td></tr><tr class="hit "><td class="line">85</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">	var usingDefaultFields = false;</span></td><td class="action"></td></tr><tr><td class="line">86</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">87</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">	if ('function' === typeof options) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">88</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">		callback = options;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">89</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">		options = null;</span></td><td class="action"></td></tr><tr><td class="line">90</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">91</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (!options) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">92</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">		options = {};</span></td><td class="action"></td></tr><tr class="miss"><td class="line">93</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else if ('string' === typeof options) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">94</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		options = { fields: options };</span></td><td class="action"></td></tr><tr><td class="line">95</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">96</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (!options.fields) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">97</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">		options.fields = _.keys(this.list.fields);</span></td><td class="action"></td></tr><tr class="hit "><td class="line">98</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">		usingDefaultFields = true;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">99</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else if ('string' === typeof options.fields) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">100</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		options.fields = options.fields.split(',').map(function(i) { return i.trim(); });</span></td><td class="action"></td></tr><tr><td class="line">101</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">102</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">	options.required = options.required || {};</span></td><td class="action"></td></tr><tr class="hit "><td class="line">103</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">	options.errorMessage = options.errorMessage || this.options.errorMessage;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">104</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">	options.invalidMessages = options.invalidMessages || {};</span></td><td class="action"></td></tr><tr class="hit "><td class="line">105</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">	options.requiredMessages = options.requiredMessages || {};</span></td><td class="action"></td></tr><tr><td class="line">106</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">107</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Parse a string of required fields into field paths</span></td><td class="action"></td></tr><tr class="hit "><td class="line">108</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">	if ('string' === typeof options.required) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">109</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var requiredFields = options.required.split(',').map(function(i) { return i.trim(); });</span></td><td class="action"></td></tr><tr class="miss"><td class="line">110</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		options.required = {};</span></td><td class="action"></td></tr><tr class="miss"><td class="line">111</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		requiredFields.forEach(function(path) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">112</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			options.required[path] = true;</span></td><td class="action"></td></tr><tr><td class="line">113</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		});</span></td><td class="action"></td></tr><tr><td class="line">114</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">115</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">	options.fields.forEach(function(path) {</span></td><td class="action"></td></tr><tr class="hit partial"><td class="line">116</td><td class="hits">37</td><td class="statements">80%</td><td class="source"><span class="statement ">		var field = (path instanceof keystone.Field) ?</span><span class="statement notok"><span class="offscreen"> not covered </span>path</span><span class="statement ">: this.list.field(path);</span></td><td class="action"></td></tr><tr class="hit "><td class="line">117</td><td class="hits">37</td><td class="statements">100%</td><td class="source"><span class="statement ">		if (field &amp;&amp; field.required) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">118</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			options.required[path] = true;</span></td><td class="action"></td></tr><tr><td class="line">119</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">120</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">121</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// TODO: The whole progress queue management code could be a lot neater...</span></td><td class="action"></td></tr><tr><td class="line">122</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">123</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">	var actionQueue = [],</span></td><td class="action"></td></tr><tr class="hit "><td class="line">124</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">		addValidationError = this.addValidationError.bind(this),</span></td><td class="action"></td></tr><tr><td class="line">125</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		validationErrors = this.validationErrors;</span></td><td class="action"></td></tr><tr><td class="line">126</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">127</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">	var progress = function(err) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">128</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">		if (err) {</span></td><td class="action"></td></tr><tr><td class="line">129</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (options.logErrors) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">130</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				console.log('Error saving changes to ' + this.item.list.singular + ' ' + this.item.id + ':');</span></td><td class="action"></td></tr><tr class="miss"><td class="line">131</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				console.log(err);</span></td><td class="action"></td></tr><tr><td class="line">132</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">133</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			callback(err, this);</span></td><td class="action"></td></tr><tr class="hit "><td class="line">134</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">		} else if (_.size(validationErrors)) {</span></td><td class="action"></td></tr><tr><td class="line">135</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (options.flashErrors) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">136</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				this.req.flash('error', {</span></td><td class="action"></td></tr><tr><td class="line">137</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					type: 'ValidationError',</span></td><td class="action"></td></tr><tr class="miss"><td class="line">138</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					list: _.pluck(validationErrors, 'message')</span></td><td class="action"></td></tr><tr><td class="line">139</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				});</span></td><td class="action"></td></tr><tr><td class="line">140</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">141</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			callback({</span></td><td class="action"></td></tr><tr><td class="line">142</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		} else if (actionQueue.length) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">143</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			actionQueue.pop()();</span></td><td class="action"></td></tr><tr><td class="line">144</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		} else {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">145</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">			saveItem();</span></td><td class="action"></td></tr><tr><td class="line">146</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">147</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">148</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">	var saveItem = function() {
		
		// Make current user available to pre/post save events</span></td><td class="action"></td></tr><tr class="hit "><td class="line">149</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">		this.item._req_user = this.user;</span></td><td class="action"></td></tr><tr><td class="line">150</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="hit "><td class="line">151</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">		this.item.save(function(err) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">152</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">			if (err) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">153</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (err.name === 'ValidationError') {</span></td><td class="action"></td></tr><tr><td class="line">154</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					// don't log simple validation errors</span></td><td class="action"></td></tr><tr><td class="line">155</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					if (options.flashErrors) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">156</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						this.req.flash('error', {</span></td><td class="action"></td></tr><tr><td class="line">157</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							type: 'ValidationError',</span></td><td class="action"></td></tr><tr><td class="line">158</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							title: options.errorMessage,</span></td><td class="action"></td></tr><tr class="miss"><td class="line">159</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>							list: _.pluck(err.errors, 'message')</span></td><td class="action"></td></tr><tr><td class="line">160</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						});</span></td><td class="action"></td></tr><tr><td class="line">161</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">162</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						console.log('Error saving changes to ' + this.item.list.singular + ' ' + this.item.id + ':');</span></td><td class="action"></td></tr><tr class="miss"><td class="line">163</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						console.log(err);</span></td><td class="action"></td></tr><tr><td class="line">164</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">165</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						this.req.flash('error', 'There was an error saving your changes: ' + err.message + ' (' + err.name + (err.type ? ': ' + err.type : '') + ')');</span></td><td class="action"></td></tr><tr><td class="line">166</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">167</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">			return callback(err, this);</span></td><td class="action"></td></tr><tr><td class="line">168</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}.bind(this));</span></td><td class="action"></td></tr><tr><td class="line">169</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}.bind(this);</span></td><td class="action"></td></tr><tr><td class="line">170</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">171</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">	options.fields.forEach(function(path) {

		// console.log('Processing field ' + path);</span></td><td class="action"></td></tr><tr class="hit "><td class="line">172</td><td class="hits">37</td><td class="statements">100%</td><td class="source"><span class="statement ">		var message;</span></td><td class="action"></td></tr><tr><td class="line">173</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit partial"><td class="line">174</td><td class="hits">37</td><td class="statements">80%</td><td class="source"><span class="statement ">		var field = (path instanceof keystone.Field) ?</span><span class="statement notok"><span class="offscreen"> not covered </span>path</span><span class="statement ">: this.list.field(path),
			invalidated = false;</span></td><td class="action"></td></tr><tr><td class="line">175</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">176</td><td class="hits">37</td><td class="statements">100%</td><td class="source"><span class="statement ">		if (!field) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">177</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			throw new Error('UpdateHandler.process called with invalid field path: ' + path);</span></td><td class="action"></td></tr><tr><td class="line">178</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">179</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">180</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		// skip uneditable fields</span></td><td class="action"></td></tr><tr class="hit partial"><td class="line">181</td><td class="hits">37</td><td class="statements">75%</td><td class="source"><span class="statement ">		if (usingDefaultFields &amp;&amp; field.noedit &amp;&amp;</span><span class="statement notok"><span class="offscreen"> not covered </span>!options.ignoreNoedit</span><span class="statement "> {</span></td><td class="action"></td></tr><tr><td class="line">182</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			// console.log('Skipping field ' + path + ' (noedit: true)');</span></td><td class="action"></td></tr><tr class="miss"><td class="line">183</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return;</span></td><td class="action"></td></tr><tr><td class="line">184</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">185</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				actionQueue.push(field.getRequestHandler(this.item, this.req, options.paths, function(err) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">186</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				    if (err &amp;&amp; options.flashErrors) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">187</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				        this.req.flash('error', field.label + ' upload failed - ' + err.message);</span></td><td class="action"></td></tr><tr><td class="line">188</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				    }</span></td><td class="action"></td></tr><tr class="miss"><td class="line">189</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				    progress(err);</span></td><td class="action"></td></tr><tr><td class="line">190</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}.bind(this)));</span></td><td class="action"></td></tr><tr><td class="line">191</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			break;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">192</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				actionQueue.push(field.getRequestHandler(this.item, this.req, options.paths, function(err) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">193</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					if (err &amp;&amp; options.flashErrors) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">194</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						this.req.flash('error', field.label + ' improve failed - ' + (err.status_text || err.status));</span></td><td class="action"></td></tr><tr><td class="line">195</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">196</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					progress(err);</span></td><td class="action"></td></tr><tr><td class="line">197</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}.bind(this)));</span></td><td class="action"></td></tr><tr><td class="line">198</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			break;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">199</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (!data[field.path] &amp;&amp; (!options.required[field.path] || this.item.get(field.path))) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">200</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					return;</span></td><td class="action"></td></tr><tr><td class="line">201</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">202</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (data[field.path] !== data[field.paths.confirm]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">203</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					message = options.invalidMessages[field.path + '_match'] || 'Passwords must match';</span></td><td class="action"></td></tr><tr class="miss"><td class="line">204</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					addValidationError(field.path, message);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">205</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					invalidated = true;</span></td><td class="action"></td></tr><tr><td class="line">206</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">207</td><td class="hits">37</td><td class="statements">100%</td><td class="source"><span class="statement ">		if (!invalidated &amp;&amp; !field.validateInput(data)) {</span></td><td class="action"></td></tr><tr><td class="line">208</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			// console.log('Field ' + field.path + ' is invalid');</span></td><td class="action"></td></tr><tr class="miss"><td class="line">209</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			message = options.invalidMessages[field.path] || field.options.invalidMessage || 'Please enter a valid ' + field.typeDescription + ' in the ' + field.label + ' field';</span></td><td class="action"></td></tr><tr class="miss"><td class="line">210</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			addValidationError(field.path, message);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">211</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			invalidated = true;</span></td><td class="action"></td></tr><tr><td class="line">212</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="hit partial"><td class="line">213</td><td class="hits">37</td><td class="statements">67%</td><td class="source"><span class="statement ">		if (!invalidated &amp;&amp; options.required[field.path] &amp;&amp;</span><span class="statement notok"><span class="offscreen"> not covered </span>!field.validateInput(data, true, this.item)</span><span class="statement "> {</span></td><td class="action"></td></tr><tr><td class="line">214</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			// console.log('Field ' + field.path + ' is required, but not provided.');</span></td><td class="action"></td></tr><tr class="miss"><td class="line">215</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			message = options.requiredMessages[field.path] || field.options.requiredMessage || field.label + ' is required';</span></td><td class="action"></td></tr><tr class="miss"><td class="line">216</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			addValidationError(field.path, message);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">217</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			invalidated = true;</span></td><td class="action"></td></tr><tr><td class="line">218</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">219</td><td class="hits">37</td><td class="statements">100%</td><td class="source"><span class="statement ">		if (!invalidated &amp;&amp; this.validationMethods[field.path]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">220</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			message = this.validationMethods[field.path](data);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">221</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (message) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">222</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				addValidationError(field.path, message);</span></td><td class="action"></td></tr><tr><td class="line">223</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">224</td><td class="hits">37</td><td class="statements">100%</td><td class="source"><span class="statement ">		field.updateItem(this.item, data);</span></td><td class="action"></td></tr><tr><td class="line">225</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">226</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">227</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">	progress();</span></td><td class="action"></td></tr><tr><td class="line">228</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">229</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">230</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">231</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">232</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Export class</span></td><td class="action"></td></tr><tr><td class="line">233</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">234</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">235</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports = module.exports = UpdateHandler;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/view.js">lib/view.js</h2><div class="stats medium"><div class="percentage">58% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">58% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">34% block coverage</div><div class="sloc">127 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr><td class="line">1</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/*!</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Module dependencies.</span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">5</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var _ = require('underscore'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">6</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	keystone = require('../'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">7</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	async = require('async'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">8</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	utils = require('keystone-utils');</span></td><td class="action"></td></tr><tr><td class="line">9</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * View Constructor</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * =================</span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Helper to simplify view logic in a Keystone application</span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">16</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">17</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">18</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">19</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function View(req, res) {</span></td><td class="action"></td></tr><tr><td class="line">20</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">21</td><td class="hits">13</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (!req || req.constructor.name !== 'IncomingMessage') {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">22</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('Keystone.View Error: Express request object is required.');</span></td><td class="action"></td></tr><tr><td class="line">23</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">24</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">25</td><td class="hits">13</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (!res || res.constructor.name !== 'ServerResponse') {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">26</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('Keystone.View Error: Express response object is required.');</span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">28</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">29</td><td class="hits">13</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.req = req;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">30</td><td class="hits">13</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.res = res;</span></td><td class="action"></td></tr><tr><td class="line">31</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">32</td><td class="hits">13</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.initQueue = [];	// executed first in series</span></td><td class="action"></td></tr><tr class="hit "><td class="line">33</td><td class="hits">13</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.actionQueue = [];	// executed second in parallel, if optional conditions are met</span></td><td class="action"></td></tr><tr class="hit "><td class="line">34</td><td class="hits">13</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.queryQueue = [];	// executed third in parallel</span></td><td class="action"></td></tr><tr class="hit "><td class="line">35</td><td class="hits">13</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.renderQueue = [];	// executed fourth in parallel</span></td><td class="action"></td></tr><tr><td class="line">36</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">37</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">38</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">39</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">module.exports = exports = View;</span></td><td class="action"></td></tr><tr><td class="line">40</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">41</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">42</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">43</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Adds a method (or array of methods) to be executed in parallel</span></td><td class="action"></td></tr><tr><td class="line">44</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * to the `init`, `action` or `render` queue.</span></td><td class="action"></td></tr><tr><td class="line">45</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">46</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">47</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">48</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">49</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">View.prototype.on = function(on) {
	</span></td><td class="action"></td></tr><tr class="hit "><td class="line">50</td><td class="hits">12</td><td class="statements">100%</td><td class="source"><span class="statement ">	var req = this.req,
		callback = arguments[1],
		values;</span></td><td class="action"></td></tr><tr><td class="line">51</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="hit "><td class="line">52</td><td class="hits">12</td><td class="statements">100%</td><td class="source"><span class="statement ">	if ('function' === typeof on) {</span></td><td class="action"></td></tr><tr><td class="line">53</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">54</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (on()) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">55</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			this.actionQueue.push(callback);</span></td><td class="action"></td></tr><tr><td class="line">56</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">57</td><td class="hits">12</td><td class="statements">100%</td><td class="source"><span class="statement ">	} else if (utils.isObject(on)) {</span></td><td class="action"></td></tr><tr><td class="line">58</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="hit "><td class="line">59</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">		var check = function(value, path) {
</span></td><td class="action"></td></tr><tr class="hit "><td class="line">60</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">			var ctx = req,
				parts = path.split('.');</span></td><td class="action"></td></tr><tr><td class="line">61</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">62</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">			for (var i = 0; i &lt; parts.length - 1; i++) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">63</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">				if (!ctx[parts[i]]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">64</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					return false;</span></td><td class="action"></td></tr><tr><td class="line">65</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">66</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">				ctx = ctx[parts[i]];</span></td><td class="action"></td></tr><tr><td class="line">67</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">68</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">			path = _.last(parts);</span></td><td class="action"></td></tr><tr><td class="line">69</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			</span></td><td class="action"></td></tr><tr class="hit partial"><td class="line">70</td><td class="hits">1</td><td class="statements">60%</td><td class="source"><span class="statement ">			return (value === true &amp;&amp;</span><span class="statement notok"><span class="offscreen"> not covered </span>path in ctx</span><span class="statement "> ?</span><span class="statement notok"><span class="offscreen"> not covered </span>true</span><span class="statement ">: (ctx[path] === value);</span></td><td class="action"></td></tr><tr><td class="line">71</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">72</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">73</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">		if (_.every(on, check)) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">74</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">			this.actionQueue.push(callback);</span></td><td class="action"></td></tr><tr><td class="line">75</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">76</td><td class="hits">11</td><td class="statements">100%</td><td class="source"><span class="statement ">	} else if (on === 'get' || on === 'post' || on === 'put' || on === 'delete') {</span></td><td class="action"></td></tr><tr><td class="line">77</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="hit "><td class="line">78</td><td class="hits">10</td><td class="statements">100%</td><td class="source"><span class="statement ">		if (req.method !== on.toUpperCase()) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">79</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">			return;</span></td><td class="action"></td></tr><tr><td class="line">80</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">81</td><td class="hits">8</td><td class="statements">100%</td><td class="source"><span class="statement ">		if (arguments.length === 3) {</span></td><td class="action"></td></tr><tr><td class="line">82</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			</span></td><td class="action"></td></tr><tr class="hit "><td class="line">83</td><td class="hits">6</td><td class="statements">100%</td><td class="source"><span class="statement ">			if (utils.isString(arguments[1])) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">84</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				values = {};</span></td><td class="action"></td></tr><tr class="miss"><td class="line">85</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				values[arguments[1]] = true;</span></td><td class="action"></td></tr><tr><td class="line">86</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			} else {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">87</td><td class="hits">6</td><td class="statements">100%</td><td class="source"><span class="statement ">				values = arguments[1];</span></td><td class="action"></td></tr><tr><td class="line">88</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">89</td><td class="hits">6</td><td class="statements">100%</td><td class="source"><span class="statement ">			callback = arguments[2];</span></td><td class="action"></td></tr><tr><td class="line">90</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			</span></td><td class="action"></td></tr><tr class="hit "><td class="line">91</td><td class="hits">6</td><td class="statements">100%</td><td class="source"><span class="statement ">			var ctx = (on === 'post' || on === 'put') ? req.body : req.query;</span></td><td class="action"></td></tr><tr><td class="line">92</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			</span></td><td class="action"></td></tr><tr class="hit "><td class="line">93</td><td class="hits">6</td><td class="statements">100%</td><td class="source"><span class="statement ">			if (_.every(values || {}, function(value, path) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">94</td><td class="hits">6</td><td class="statements">100%</td><td class="source"><span class="statement ">				return (value === true &amp;&amp; path in ctx) ? true : (ctx[path] === value);</span></td><td class="action"></td></tr><tr><td class="line">95</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			})) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">96</td><td class="hits">3</td><td class="statements">100%</td><td class="source"><span class="statement ">				this.actionQueue.push(callback);</span></td><td class="action"></td></tr><tr><td class="line">97</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">98</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">			this.actionQueue.push(callback);</span></td><td class="action"></td></tr><tr><td class="line">99</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">100</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	} else if (on === 'init') {</span></td><td class="action"></td></tr><tr><td class="line">101</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="hit "><td class="line">102</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">		this.initQueue.push(callback);</span></td><td class="action"></td></tr><tr><td class="line">103</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">104</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else if (on === 'render') {</span></td><td class="action"></td></tr><tr><td class="line">105</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">106</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		this.renderQueue.push(callback);</span></td><td class="action"></td></tr><tr><td class="line">107</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="hit "><td class="line">108</td><td class="hits">10</td><td class="statements">100%</td><td class="source"><span class="statement ">	return this;</span></td><td class="action"></td></tr><tr><td class="line">109</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">110</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">111</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var QueryCallbacks = function(options) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">112</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (utils.isString(options)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">113</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		options = { then: options };</span></td><td class="action"></td></tr><tr><td class="line">114</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">115</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		options = options || {};</span></td><td class="action"></td></tr><tr><td class="line">116</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">117</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.callbacks = {};</span></td><td class="action"></td></tr><tr class="miss"><td class="line">118</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (options.err) this.callbacks.err = options.err;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">119</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (options.none) this.callbacks.none = options.none;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">120</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (options.then) this.callbacks.then = options.then;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">121</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return this;</span></td><td class="action"></td></tr><tr><td class="line">122</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">123</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit partial"><td class="line">124</td><td class="hits">1</td><td class="statements">25%</td><td class="source"><span class="statement ">QueryCallbacks.prototype.has = function(fn) {</span><span class="statement notok"><span class="offscreen"> not covered </span>return (fn in this.callbacks);</span><span class="statement ">};</span></td><td class="action"></td></tr><tr class="hit partial"><td class="line">125</td><td class="hits">1</td><td class="statements">33%</td><td class="source"><span class="statement ">QueryCallbacks.prototype.err = function(fn) {</span><span class="statement notok"><span class="offscreen"> not covered </span>this.callbacks.err = fn; return this;</span><span class="statement ">};</span></td><td class="action"></td></tr><tr class="hit partial"><td class="line">126</td><td class="hits">1</td><td class="statements">33%</td><td class="source"><span class="statement ">QueryCallbacks.prototype.none = function(fn) {</span><span class="statement notok"><span class="offscreen"> not covered </span>this.callbacks.none = fn; return this;</span><span class="statement ">};</span></td><td class="action"></td></tr><tr class="hit partial"><td class="line">127</td><td class="hits">1</td><td class="statements">33%</td><td class="source"><span class="statement ">QueryCallbacks.prototype.then = function(fn) {</span><span class="statement notok"><span class="offscreen"> not covered </span>this.callbacks.then = fn; return this;</span><span class="statement ">};</span></td><td class="action"></td></tr><tr><td class="line">128</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">129</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">130</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">131</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Queues a mongoose query for execution before the view is rendered.</span></td><td class="action"></td></tr><tr><td class="line">132</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * The results of the query are set in `locals[key]`.</span></td><td class="action"></td></tr><tr><td class="line">133</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">134</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Keys can be nested paths, containing objects will be created as required.</span></td><td class="action"></td></tr><tr><td class="line">135</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">136</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * The third argument `then` can be a method to call after the query is completed</span></td><td class="action"></td></tr><tr><td class="line">137</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * like function(err, results, callback), or a `populatedRelated` definition</span></td><td class="action"></td></tr><tr><td class="line">138</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * (string or array).</span></td><td class="action"></td></tr><tr><td class="line">139</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * </span></td><td class="action"></td></tr><tr><td class="line">140</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Examples:</span></td><td class="action"></td></tr><tr><td class="line">141</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * </span></td><td class="action"></td></tr><tr><td class="line">142</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * view.query('books', keystone.list('Book').model.find());</span></td><td class="action"></td></tr><tr><td class="line">143</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * </span></td><td class="action"></td></tr><tr><td class="line">144</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *     an array of books from the database will be added to locals.books. You can</span></td><td class="action"></td></tr><tr><td class="line">145</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *     also nest properties on the locals variable.</span></td><td class="action"></td></tr><tr><td class="line">146</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * </span></td><td class="action"></td></tr><tr><td class="line">147</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * view.query(</span></td><td class="action"></td></tr><tr><td class="line">148</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *     'admin.books',</span></td><td class="action"></td></tr><tr><td class="line">149</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *      keystone.list('Book').model.find().where('user', 'Admin')</span></td><td class="action"></td></tr><tr><td class="line">150</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * );</span></td><td class="action"></td></tr><tr><td class="line">151</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * </span></td><td class="action"></td></tr><tr><td class="line">152</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *     locals.admin.books will be the result of the query</span></td><td class="action"></td></tr><tr><td class="line">153</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *     views.query().then is always called if it is available</span></td><td class="action"></td></tr><tr><td class="line">154</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * </span></td><td class="action"></td></tr><tr><td class="line">155</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * view.query('books', keystone.list('Book').model.find())</span></td><td class="action"></td></tr><tr><td class="line">156</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *     .then(function (err, results, next) {</span></td><td class="action"></td></tr><tr><td class="line">157</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *         if (err) return next(err);</span></td><td class="action"></td></tr><tr><td class="line">158</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *         console.log(results);</span></td><td class="action"></td></tr><tr><td class="line">159</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *         next();</span></td><td class="action"></td></tr><tr><td class="line">160</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *     });</span></td><td class="action"></td></tr><tr><td class="line">161</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">162</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">163</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">164</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">165</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">View.prototype.query = function(key, query, options) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">166</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var locals = this.res.locals,</span></td><td class="action"></td></tr><tr class="miss"><td class="line">167</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		parts = key.split('.'),</span></td><td class="action"></td></tr><tr><td class="line">168</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		chain = new QueryCallbacks(options);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">169</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>    key = parts.pop();</span></td><td class="action"></td></tr><tr><td class="line">170</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">171</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	for (var i = 0; i &lt; parts.length; i++) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">172</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (!locals[parts[i]]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">173</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			locals[parts[i]] = {};</span></td><td class="action"></td></tr><tr><td class="line">174</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">175</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		locals = locals[parts[i]];</span></td><td class="action"></td></tr><tr><td class="line">176</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">177</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.queryQueue.push(function(next) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">178</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		query.exec(function(err, results) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">179</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			locals[key] = results;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">180</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var callbacks = chain.callbacks;</span></td><td class="action"></td></tr><tr><td class="line">181</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">182</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (err) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">183</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if ('err' in callbacks) {</span></td><td class="action"></td></tr><tr><td class="line">184</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					/* Will pass errors into the err callback</span></td><td class="action"></td></tr><tr><td class="line">185</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					 * </span></td><td class="action"></td></tr><tr class="miss"><td class="line">186</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					return callbacks.err(err, next);</span></td><td class="action"></td></tr><tr><td class="line">187</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">188</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if ((!results || (utils.isArray(results) &amp;&amp; !results.length)) &amp;&amp; 'none' in callbacks) {</span></td><td class="action"></td></tr><tr><td class="line">189</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					/* If there are no results view.query().none will be called</span></td><td class="action"></td></tr><tr class="miss"><td class="line">190</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					return callbacks.none(next);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">191</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				} else if ('then' in callbacks) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">192</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					if (utils.isFunction(callbacks.then)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">193</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						return callbacks.then(err, results, next);</span></td><td class="action"></td></tr><tr><td class="line">194</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">195</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						return keystone.populateRelated(results, callbacks.then, next);</span></td><td class="action"></td></tr><tr><td class="line">196</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">197</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return next(err);</span></td><td class="action"></td></tr><tr><td class="line">198</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">199</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">200</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">201</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return chain;</span></td><td class="action"></td></tr><tr><td class="line">202</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">203</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">204</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">205</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">206</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Executes the current queue of init and action methods in series, and</span></td><td class="action"></td></tr><tr><td class="line">207</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * then executes the render function. If renderFn is a string, it is provided</span></td><td class="action"></td></tr><tr><td class="line">208</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * to `res.render`.</span></td><td class="action"></td></tr><tr><td class="line">209</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">210</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * It is expected that *most* init stacks require processing in series,</span></td><td class="action"></td></tr><tr><td class="line">211</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * but it is safe to execute actions in parallel.</span></td><td class="action"></td></tr><tr><td class="line">212</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">213</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * If there are several init methods that should be run in parallel, queue</span></td><td class="action"></td></tr><tr><td class="line">214</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * them as an array, e.g. `view.on('init', [first, second])`.</span></td><td class="action"></td></tr><tr><td class="line">215</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">216</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">217</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr class="hit "><td class="line">218</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">View.prototype.render = function(renderFn, locals, callback) {
</span></td><td class="action"></td></tr><tr class="hit "><td class="line">219</td><td class="hits">12</td><td class="statements">100%</td><td class="source"><span class="statement ">	var req = this.req,
		res = this.res;</span></td><td class="action"></td></tr><tr><td class="line">220</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">221</td><td class="hits">12</td><td class="statements">100%</td><td class="source"><span class="statement ">	if ('string' === typeof renderFn) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">222</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var viewPath = renderFn;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">223</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		renderFn = function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">224</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if ('function' === typeof locals) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">225</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				locals = locals();</span></td><td class="action"></td></tr><tr><td class="line">226</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">227</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			this.res.render(viewPath, locals, callback);</span></td><td class="action"></td></tr><tr><td class="line">228</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}.bind(this);</span></td><td class="action"></td></tr><tr class="hit "><td class="line">229</td><td class="hits">12</td><td class="statements">100%</td><td class="source"><span class="statement ">	if ('function' !== typeof renderFn) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">230</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('Keystone.View.render() renderFn must be a templatePath (string) or a function.');</span></td><td class="action"></td></tr><tr><td class="line">231</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">232</td><td class="hits">12</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.initQueue.push(this.actionQueue);</span></td><td class="action"></td></tr><tr class="hit "><td class="line">233</td><td class="hits">12</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.initQueue.push(this.queryQueue);</span></td><td class="action"></td></tr><tr><td class="line">234</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">235</td><td class="hits">12</td><td class="statements">100%</td><td class="source"><span class="statement ">	var preRenderQueue = [];</span></td><td class="action"></td></tr><tr><td class="line">236</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">237</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// Add Keystone's global pre('render') queue</span></td><td class="action"></td></tr><tr class="hit "><td class="line">238</td><td class="hits">12</td><td class="statements">100%</td><td class="source"><span class="statement ">	keystone._pre.render.forEach(function(fn) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">239</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		preRenderQueue.push(function(next) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">240</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			fn(req, res, next);</span></td><td class="action"></td></tr><tr><td class="line">241</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		});</span></td><td class="action"></td></tr><tr><td class="line">242</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">243</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">244</td><td class="hits">12</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.initQueue.push(preRenderQueue);</span></td><td class="action"></td></tr><tr class="hit "><td class="line">245</td><td class="hits">12</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.initQueue.push(this.renderQueue);</span></td><td class="action"></td></tr><tr><td class="line">246</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">247</td><td class="hits">12</td><td class="statements">100%</td><td class="source"><span class="statement ">	async.eachSeries(this.initQueue, function(i, next) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">248</td><td class="hits">49</td><td class="statements">100%</td><td class="source"><span class="statement ">		if (Array.isArray(i)) {</span></td><td class="action"></td></tr><tr><td class="line">249</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			// process nested arrays in parallel</span></td><td class="action"></td></tr><tr class="hit "><td class="line">250</td><td class="hits">48</td><td class="statements">100%</td><td class="source"><span class="statement ">			async.parallel(i, next);</span></td><td class="action"></td></tr><tr class="hit "><td class="line">251</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">		} else if ('function' === typeof i) {</span></td><td class="action"></td></tr><tr><td class="line">252</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			// process single methods in series</span></td><td class="action"></td></tr><tr class="hit "><td class="line">253</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">			i(next);</span></td><td class="action"></td></tr><tr><td class="line">254</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">255</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			throw new Error('Keystone.View.render() events must be functions.');</span></td><td class="action"></td></tr><tr><td class="line">256</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">257</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}, function(err) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">258</td><td class="hits">12</td><td class="statements">100%</td><td class="source"><span class="statement ">		renderFn(err, req, res);</span></td><td class="action"></td></tr><tr><td class="line">259</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	});</span></td><td class="action"></td></tr><tr><td class="line">260</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/email.js">lib/email.js</h2><div class="stats terrible"><div class="percentage">20% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">11% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">0% block coverage</div><div class="sloc">196 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr class="hit "><td class="line">1</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var _ = require('underscore'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">2</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	keystone = require('../'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">3</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	fs = require('fs'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">4</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	util = require('util'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">5</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	path = require('path'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">6</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	moment = require('moment'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">7</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	utils = require('keystone-utils'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">8</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	mandrillapi = require('mandrill-api');</span></td><td class="action"></td></tr><tr><td class="line">9</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">10</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var templateCache = {};</span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">12</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var defaultConfig = {
	templateExt: 'jade',</span></td><td class="action"></td></tr><tr class="hit "><td class="line">13</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	templateEngine: require('jade'),</span></td><td class="action"></td></tr><tr class="hit "><td class="line">14</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">	templateBasePath: path.normalize(path.join(__dirname, '..', 'templates', 'helpers', 'emails')),</span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	mandrill: {</span></td><td class="action"></td></tr><tr><td class="line">16</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">17</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">18</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/** Custom Errors */</span></td><td class="action"></td></tr><tr><td class="line">19</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">20</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var ErrorNoEmailTemplateName = function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> 	Error.apply(this, arguments);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">22</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	Error.captureStackTrace(this, arguments.callee);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.message = 'No email templateName specified.';</span></td><td class="action"></td></tr><tr class="miss"><td class="line">24</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.name = 'ErrorNoEmailTemplateName';</span></td><td class="action"></td></tr><tr><td class="line">25</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr class="hit "><td class="line">26</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">util.inherits(ErrorNoEmailTemplateName, Error);</span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">28</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var ErrorEmailsPathNotSet = function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">29</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	Error.apply(this, arguments);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">30</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	Error.captureStackTrace(this, arguments.callee);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">31</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.message = 'Keystone has not been configured for email support. Set the `emails` option in your configuration.';</span></td><td class="action"></td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.name = 'ErrorEmailsPathNotSet';</span></td><td class="action"></td></tr><tr><td class="line">33</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr class="hit "><td class="line">34</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">util.inherits(ErrorEmailsPathNotSet, Error);</span></td><td class="action"></td></tr><tr><td class="line">35</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">36</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var ErrorEmailOptionsRequired = function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	Error.apply(this, arguments);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">38</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	Error.captureStackTrace(this, arguments.callee);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">39</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.message = 'The keystone.Email class requires a templateName or options argument to be provided.';</span></td><td class="action"></td></tr><tr class="miss"><td class="line">40</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.name = 'ErrorEmailOptionsRequired';</span></td><td class="action"></td></tr><tr><td class="line">41</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr class="hit "><td class="line">42</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">util.inherits(ErrorEmailsPathNotSet, Error);</span></td><td class="action"></td></tr><tr><td class="line">43</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">44</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">45</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/** Helper methods */</span></td><td class="action"></td></tr><tr><td class="line">46</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">47</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var getEmailsPath = function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">48</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var path = keystone.getPath('emails');</span></td><td class="action"></td></tr><tr class="miss"><td class="line">49</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (path) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">50</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return path;</span></td><td class="action"></td></tr><tr><td class="line">51</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">52</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	throw new ErrorEmailsPathNotSet();</span></td><td class="action"></td></tr><tr><td class="line">53</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">54</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">55</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">56</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/** CSS Helper methods */</span></td><td class="action"></td></tr><tr><td class="line">57</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">58</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var templateCSSMethods = {
	shadeColor: function(color, percent) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">59</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>    	var num = parseInt(color.slice(1),16), amt = Math.round(2.55 * percent), R = (num &gt;&gt; 16) + amt, G = (num &gt;&gt; 8 &amp; 0x00FF) + amt, B = (num &amp; 0x0000FF) + amt;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">60</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>    	return '#' + (0x1000000 + (R&lt;255?R&lt;1?0:R:255)*0x10000 + (G&lt;255?G&lt;1?0:G:255)*0x100 + (B&lt;255?B&lt;1?0:B:255)).toString(16).slice(1);</span></td><td class="action"></td></tr><tr><td class="line">61</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">62</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">63</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">64</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">65</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Email Class</span></td><td class="action"></td></tr><tr><td class="line">66</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * ===========</span></td><td class="action"></td></tr><tr><td class="line">67</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">68</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Helper class for sending emails with Mandrill.</span></td><td class="action"></td></tr><tr><td class="line">69</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">70</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * New instances take a `templatePath` string which must be a folder in the</span></td><td class="action"></td></tr><tr><td class="line">71</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * emails path, and must contain either `templateName/email.templateExt` or `templateName.templateExt`</span></td><td class="action"></td></tr><tr><td class="line">72</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * which is used as the template for the HTML part of the email.</span></td><td class="action"></td></tr><tr><td class="line">73</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">74</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Once created, emails can be rendered or sent.</span></td><td class="action"></td></tr><tr><td class="line">75</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">76</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Requires the `emails` path option and the `mandrill api key` option to be</span></td><td class="action"></td></tr><tr><td class="line">77</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * set on Keystone.</span></td><td class="action"></td></tr><tr><td class="line">78</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">79</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">80</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">81</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">82</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var Email = function(options) {

	// Passing a string will use Email.defaults for everything but template name</span></td><td class="action"></td></tr><tr class="miss"><td class="line">83</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if ('string' === typeof(options)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">84</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		options = {</span></td><td class="action"></td></tr><tr><td class="line">85</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			templateName: options</span></td><td class="action"></td></tr><tr class="miss"><td class="line">86</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else if (!utils.isObject(options)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">87</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new ErrorEmailOptionsRequired();</span></td><td class="action"></td></tr><tr><td class="line">88</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">89</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.templateName = options.templateName;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">90</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.templateExt = options.templateExt || Email.defaults.templateExt;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">91</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.templateEngine = options.templateEngine || Email.defaults.templateEngine;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">92</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.templateBasePath = options.templateBasePath || Email.defaults.templateBasePath;</span></td><td class="action"></td></tr><tr><td class="line">93</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">94</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!this.templateName) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">95</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new ErrorNoEmailTemplateName();</span></td><td class="action"></td></tr><tr><td class="line">96</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">97</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return this;</span></td><td class="action"></td></tr><tr><td class="line">98</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">99</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">100</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">101</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Renders the email and passes it to the callback. Used by `email.send()` but</span></td><td class="action"></td></tr><tr><td class="line">102</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * can also be called directly to generate a preview.</span></td><td class="action"></td></tr><tr><td class="line">103</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">104</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Object} locals - object of local variables provided to the template</span></td><td class="action"></td></tr><tr><td class="line">105</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Function} callback(err, email)</span></td><td class="action"></td></tr><tr><td class="line">106</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">107</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api public</span></td><td class="action"></td></tr><tr><td class="line">108</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">109</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">110</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Email.prototype.render = function(locals, callback) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">111</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if ('function' === typeof locals &amp;&amp; !callback) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">112</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		callback = locals;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">113</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		locals = {};</span></td><td class="action"></td></tr><tr><td class="line">114</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">115</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	locals = ('object' === typeof locals) ? locals : {};</span></td><td class="action"></td></tr><tr class="miss"><td class="line">116</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	callback = ('function' === typeof callback) ? callback : function() {};</span></td><td class="action"></td></tr><tr><td class="line">117</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">118</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (keystone.get('email locals')) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">119</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		_.defaults(locals, keystone.get('email locals'));</span></td><td class="action"></td></tr><tr><td class="line">120</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">121</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	_.defaults(locals, {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">122</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		brand: keystone.get('brand'),</span></td><td class="action"></td></tr><tr><td class="line">123</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		theme: {},</span></td><td class="action"></td></tr><tr><td class="line">124</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		css: templateCSSMethods</span></td><td class="action"></td></tr><tr><td class="line">125</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">126</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!locals.theme.buttons) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">127</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		locals.theme.buttons = {};</span></td><td class="action"></td></tr><tr><td class="line">128</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">129</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.compileTemplate(function(err) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">130</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (err) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">131</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return callback(err);</span></td><td class="action"></td></tr><tr><td class="line">132</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">133</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">134</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var html = templateCache[this.templateName](locals);</span></td><td class="action"></td></tr><tr><td class="line">135</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">136</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		// ensure extended characters are replaced</span></td><td class="action"></td></tr><tr class="miss"><td class="line">137</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		html = html.replace(/[\u007f-\uffff]/g, function(c) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">138</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return '&amp;#x'+('0000'+c.charCodeAt(0).toString(16)).slice(-4)+';';</span></td><td class="action"></td></tr><tr><td class="line">139</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		});</span></td><td class="action"></td></tr><tr><td class="line">140</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">141</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		// process email rules</span></td><td class="action"></td></tr><tr class="miss"><td class="line">142</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var rules = keystone.get('email rules');</span></td><td class="action"></td></tr><tr><td class="line">143</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">144</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (rules) {</span></td><td class="action"></td></tr><tr><td class="line">145</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">146</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (!Array.isArray(rules)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">147</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				rules = [rules];</span></td><td class="action"></td></tr><tr><td class="line">148</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">149</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			_.each(rules, function(rule) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">150</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (rule.find &amp;&amp; rule.replace) {</span></td><td class="action"></td></tr><tr><td class="line">151</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">152</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					var find = rule.find,</span></td><td class="action"></td></tr><tr><td class="line">153</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">154</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					if ('string' === typeof find) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">155</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						find = new RegExp(find, 'gi');</span></td><td class="action"></td></tr><tr><td class="line">156</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					}</span></td><td class="action"></td></tr><tr><td class="line">157</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">158</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					html = html.replace(find, replace);</span></td><td class="action"></td></tr><tr><td class="line">159</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				}</span></td><td class="action"></td></tr><tr><td class="line">160</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">161</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">162</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">163</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		callback(null, {</span></td><td class="action"></td></tr><tr><td class="line">164</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">165</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">166</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">167</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">168</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">169</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Loads the template. Looks for `templateName.templateExt`, followed by `templateName/email.templateExt`</span></td><td class="action"></td></tr><tr><td class="line">170</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">171</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Function} callback(err)</span></td><td class="action"></td></tr><tr><td class="line">172</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">173</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api private</span></td><td class="action"></td></tr><tr><td class="line">174</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">175</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">176</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Email.prototype.loadTemplate = function(callback) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">177</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var fsTemplatePath = path.join(Email.getEmailsPath(), this.templateName + '.' + this.templateExt);</span></td><td class="action"></td></tr><tr><td class="line">178</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">179</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	fs.readFile(fsTemplatePath, function(err, contents) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">180</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (err) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">181</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (err.code === 'ENOENT') {</span></td><td class="action"></td></tr><tr><td class="line">182</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">183</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				fsTemplatePath = path.join(Email.getEmailsPath(), this.templateName, 'email.' + this.templateExt);</span></td><td class="action"></td></tr><tr><td class="line">184</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">185</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				fs.readFile(fsTemplatePath, function(err, contents) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">186</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					callback(err, fsTemplatePath, contents);</span></td><td class="action"></td></tr><tr><td class="line">187</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				});</span></td><td class="action"></td></tr><tr><td class="line">188</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">189</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">190</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				return callback(err);</span></td><td class="action"></td></tr><tr><td class="line">191</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr><td class="line">192</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">193</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return callback(err, fsTemplatePath, contents);</span></td><td class="action"></td></tr><tr><td class="line">194</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">195</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">196</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">197</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">198</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Ensures the template for the email has been compiled</span></td><td class="action"></td></tr><tr><td class="line">199</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">200</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Function} callback(err)</span></td><td class="action"></td></tr><tr><td class="line">201</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">202</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api private</span></td><td class="action"></td></tr><tr><td class="line">203</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">204</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">205</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Email.prototype.compileTemplate = function(callback) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">206</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (keystone.get('env') === 'production' &amp;&amp; templateCache[this.templateName]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">207</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return process.nextTick(callback);</span></td><td class="action"></td></tr><tr><td class="line">208</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">209</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.loadTemplate(function(err, filename, contents) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">210</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (err) return callback(err);</span></td><td class="action"></td></tr><tr><td class="line">211</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">212</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var template = this.templateEngine.compile(contents.toString(), Email.defaults.compilerOptions || { filename: fs.realpathSync(filename), basedir: this.templateBasePath });</span></td><td class="action"></td></tr><tr><td class="line">213</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">214</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		templateCache[this.templateName] = template;</span></td><td class="action"></td></tr><tr><td class="line">215</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">216</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		callback();</span></td><td class="action"></td></tr><tr><td class="line">217</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">218</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}.bind(this));</span></td><td class="action"></td></tr><tr><td class="line">219</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">220</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">221</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">222</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Prepares the email and sends it</span></td><td class="action"></td></tr><tr><td class="line">223</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">224</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Options:</span></td><td class="action"></td></tr><tr><td class="line">225</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">226</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * - mandrill</span></td><td class="action"></td></tr><tr><td class="line">227</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   Initialised Mandrill API instance</span></td><td class="action"></td></tr><tr><td class="line">228</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">229</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * - tags</span></td><td class="action"></td></tr><tr><td class="line">230</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   Array of tags to send to Mandrill</span></td><td class="action"></td></tr><tr><td class="line">231</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">232</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * - to</span></td><td class="action"></td></tr><tr><td class="line">233</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   Object / String or Array of Objects / Strings to send to, e.g.</span></td><td class="action"></td></tr><tr><td class="line">234</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   ['jed@team9.com.au', { email: 'jed.watson@gmail.com' }]</span></td><td class="action"></td></tr><tr><td class="line">235</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   { email: 'jed@team9.com.au' }</span></td><td class="action"></td></tr><tr><td class="line">236</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   'jed@team9.com.au'</span></td><td class="action"></td></tr><tr><td class="line">237</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">238</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * - fromName</span></td><td class="action"></td></tr><tr><td class="line">239</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   Name to send from</span></td><td class="action"></td></tr><tr><td class="line">240</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">241</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * - fromEmail</span></td><td class="action"></td></tr><tr><td class="line">242</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *   Email address to send from</span></td><td class="action"></td></tr><tr><td class="line">243</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">244</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * For compatibility with older implementations, send supports providing</span></td><td class="action"></td></tr><tr><td class="line">245</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * locals and options objects as the first and second arguments, and the</span></td><td class="action"></td></tr><tr><td class="line">246</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * callback as the third.</span></td><td class="action"></td></tr><tr><td class="line">247</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">248</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Object} options (passed to `email.render()`)</span></td><td class="action"></td></tr><tr><td class="line">249</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Function} callback(err, info)</span></td><td class="action"></td></tr><tr><td class="line">250</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">251</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @api private</span></td><td class="action"></td></tr><tr><td class="line">252</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">253</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">254</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Email.prototype.send = function(options, callback) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">255</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var locals = options;</span></td><td class="action"></td></tr><tr><td class="line">256</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">257</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (arguments.length === 3 || !utils.isFunction(callback)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">258</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		callback = arguments[2];</span></td><td class="action"></td></tr><tr class="miss"><td class="line">259</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		options = arguments[1] || arguments[0];</span></td><td class="action"></td></tr><tr><td class="line">260</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">261</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	this.render(locals, function(err, email) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">262</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		callback = ('function' === typeof callback) ? callback : function() {};</span></td><td class="action"></td></tr><tr><td class="line">263</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">264</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (err) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">265</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return callback(err);</span></td><td class="action"></td></tr><tr><td class="line">266</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr><td class="line">267</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">268</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (!utils.isObject(options)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">269</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return callback({</span></td><td class="action"></td></tr><tr><td class="line">270</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				from: 'Email.send',</span></td><td class="action"></td></tr><tr><td class="line">271</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				key: 'invalid options',</span></td><td class="action"></td></tr><tr class="miss"><td class="line">272</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if ('string' === typeof options.from) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">273</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			options.fromName = options.from;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">274</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			options.fromEmail = options.from;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">275</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		} else if (utils.isObject(options.from)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">276</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			options.fromName = utils.isObject(options.from.name) ? options.from.name.full : options.from.name;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">277</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			options.fromEmail = options.from.email;</span></td><td class="action"></td></tr><tr><td class="line">278</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">279</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (!options.fromName || !options.fromEmail) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">280</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return callback({</span></td><td class="action"></td></tr><tr><td class="line">281</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				from: 'Email.send',</span></td><td class="action"></td></tr><tr class="miss"><td class="line">282</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (!options.mandrill) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">283</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (!keystone.get('mandrill api key'))</span></td><td class="action"></td></tr><tr class="miss"><td class="line">284</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				return callback({</span></td><td class="action"></td></tr><tr><td class="line">285</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					from: 'Email.send',</span></td><td class="action"></td></tr><tr class="miss"><td class="line">286</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			options.mandrill = new mandrillapi.Mandrill(keystone.get('mandrill api key'));</span></td><td class="action"></td></tr><tr><td class="line">287</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">288</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		options.tags = utils.isArray(options.tags) ? options.tags : [];</span></td><td class="action"></td></tr><tr class="miss"><td class="line">289</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		options.tags.push('sent:' + moment().format('YYYY-MM-DD'));</span></td><td class="action"></td></tr><tr class="miss"><td class="line">290</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		options.tags.push(this.templateName);</span></td><td class="action"></td></tr><tr><td class="line">291</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">292</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (keystone.get('env') === 'development') {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">293</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			options.tags.push('development');</span></td><td class="action"></td></tr><tr><td class="line">294</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">295</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var recipients = [],</span></td><td class="action"></td></tr><tr><td class="line">296</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">297</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		options.to = Array.isArray(options.to) ? options.to : [options.to];</span></td><td class="action"></td></tr><tr><td class="line">298</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">299</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		for (var i = 0; i &lt; options.to.length; i++) {</span></td><td class="action"></td></tr><tr><td class="line">300</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">301</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if ('string' === typeof options.to[i]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">302</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				options.to[i] = { email: options.to[i] };</span></td><td class="action"></td></tr><tr class="miss"><td class="line">303</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			} else if ('object' === typeof options.to[i]) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">304</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				if (!options.to[i].email) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">305</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					return callback({</span></td><td class="action"></td></tr><tr><td class="line">306</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						from: 'Email.send',</span></td><td class="action"></td></tr><tr class="miss"><td class="line">307</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						message: 'Recipient ' + (i + 1) + ' does not have a valid email address.'</span></td><td class="action"></td></tr><tr><td class="line">308</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					});</span></td><td class="action"></td></tr><tr class="miss"><td class="line">309</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				return callback({</span></td><td class="action"></td></tr><tr class="miss"><td class="line">310</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					message: 'Recipient ' + (i + 1) + ' is not a string or an object.'</span></td><td class="action"></td></tr><tr><td class="line">311</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				});</span></td><td class="action"></td></tr><tr><td class="line">312</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">313</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			var recipient = { email: options.to[i].email },</span></td><td class="action"></td></tr><tr><td class="line">314</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">315</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if ('string' === typeof options.to[i].name) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">316</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				recipient.name = options.to[i].name;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">317</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				vars.push({ name: 'name', content: options.to[i].name });</span></td><td class="action"></td></tr><tr class="miss"><td class="line">318</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			} else if ('object' === typeof options.to[i].name) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">319</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				recipient.name = options.to[i].name.full || '';</span></td><td class="action"></td></tr><tr class="miss"><td class="line">320</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				vars.push({ name: 'name', content: options.to[i].name.full || '' });</span></td><td class="action"></td></tr><tr class="miss"><td class="line">321</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				vars.push({ name: 'first_name', content: options.to[i].name.first || '' });</span></td><td class="action"></td></tr><tr class="miss"><td class="line">322</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				vars.push({ name: 'last_name', content: options.to[i].name.last || '' });</span></td><td class="action"></td></tr><tr><td class="line">323</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">324</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			recipients.push(recipient);</span></td><td class="action"></td></tr><tr><td class="line">325</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">326</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			mergeVars.push({</span></td><td class="action"></td></tr><tr><td class="line">327</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">328</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var onSuccess = function(info) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">329</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			callback(null, info);</span></td><td class="action"></td></tr><tr><td class="line">330</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		};</span></td><td class="action"></td></tr><tr><td class="line">331</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">332</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var onFail = function(info) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">333</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			callback({</span></td><td class="action"></td></tr><tr><td class="line">334</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		};</span></td><td class="action"></td></tr><tr><td class="line">335</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">336</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var message = {</span></td><td class="action"></td></tr><tr><td class="line">337</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">338</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		_.defaults(message, options.mandrillOptions);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">339</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		_.defaults(message, Email.defaults.mandrill);</span></td><td class="action"></td></tr><tr><td class="line">340</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">341</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return process.nextTick(function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">342</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			options.mandrill.messages.send({ message: message }, onSuccess, onFail);</span></td><td class="action"></td></tr><tr><td class="line">343</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		});</span></td><td class="action"></td></tr><tr><td class="line">344</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">345</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">346</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">347</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Email.getEmailsPath = getEmailsPath;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">348</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Email.templateCache = templateCache;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">349</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Email.templateCSSMethods = templateCSSMethods;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">350</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">Email.defaults = defaultConfig;</span></td><td class="action"></td></tr><tr><td class="line">351</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">352</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports = module.exports = Email;</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/security/csrf.js">lib/security/csrf.js</h2><div class="stats high"><div class="percentage">97% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">98% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">93% block coverage</div><div class="sloc">45 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr class="hit "><td class="line">1</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var crypto = require('crypto'),
	utils = require('keystone-utils');</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">3</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.TOKEN_KEY = '_csrf';</span></td><td class="action"></td></tr><tr class="hit "><td class="line">4</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.LOCAL_KEY = 'csrf_token_key';</span></td><td class="action"></td></tr><tr class="hit "><td class="line">5</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.LOCAL_VALUE = 'csrf_token_value';</span></td><td class="action"></td></tr><tr class="hit "><td class="line">6</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.SECRET_KEY = exports.TOKEN_KEY + '_secret';</span></td><td class="action"></td></tr><tr class="hit "><td class="line">7</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.SECRET_LENGTH = 10;</span></td><td class="action"></td></tr><tr><td class="line">8</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">9</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>function tokenize(salt, secret) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">10</td><td class="hits">10</td><td class="statements">100%</td><td class="source"><span class="statement ">	return salt + crypto.createHash('sha1').update(salt + secret).digest('base64');</span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>}</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">13</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.createSecret = function() {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">14</td><td class="hits">5</td><td class="statements">100%</td><td class="source"><span class="statement ">	return crypto.pseudoRandomBytes(exports.SECRET_LENGTH).toString('base64');</span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">16</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">17</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.getSecret = function(req) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">18</td><td class="hits">7</td><td class="statements">100%</td><td class="source"><span class="statement ">	return req.session[exports.SECRET_KEY] || (req.session[exports.SECRET_KEY] = exports.createSecret());</span></td><td class="action"></td></tr><tr><td class="line">19</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">20</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">21</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.createToken = function(req) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">22</td><td class="hits">5</td><td class="statements">100%</td><td class="source"><span class="statement ">	return tokenize(utils.randomString(exports.SECRET_LENGTH), exports.getSecret(req));</span></td><td class="action"></td></tr><tr><td class="line">23</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">24</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">25</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.getToken = function(req, res) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">26</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">	return res.locals[exports.LOCAL_VALUE] || (res.locals[exports.LOCAL_VALUE] = exports.createToken(req));</span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">28</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">29</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.requestToken = function(req) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">30</td><td class="hits">6</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (req.body &amp;&amp; req.body[exports.TOKEN_KEY]) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">31</td><td class="hits">3</td><td class="statements">100%</td><td class="source"><span class="statement ">		return req.body[exports.TOKEN_KEY];</span></td><td class="action"></td></tr><tr class="hit "><td class="line">32</td><td class="hits">3</td><td class="statements">100%</td><td class="source"><span class="statement ">	} else if (req.query &amp;&amp; req.query[exports.TOKEN_KEY]) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">33</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">		return req.query[exports.TOKEN_KEY];</span></td><td class="action"></td></tr><tr><td class="line">34</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">35</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">	return '';</span></td><td class="action"></td></tr><tr><td class="line">36</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">37</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">38</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.validate = function(req, token) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">39</td><td class="hits">5</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (arguments.length === 1) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">40</td><td class="hits">3</td><td class="statements">100%</td><td class="source"><span class="statement ">		token = exports.requestToken(req);</span></td><td class="action"></td></tr><tr><td class="line">41</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">42</td><td class="hits">5</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (typeof token !== 'string') {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">43</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return false;</span></td><td class="action"></td></tr><tr><td class="line">44</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">45</td><td class="hits">5</td><td class="statements">100%</td><td class="source"><span class="statement ">	return token === tokenize(token.slice(0, exports.SECRET_LENGTH), req.session[exports.SECRET_KEY]);</span></td><td class="action"></td></tr><tr><td class="line">46</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">47</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">48</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.middleware = {
	
	init: function(req, res, next) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">49</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">		res.locals[exports.LOCAL_KEY] = exports.LOCAL_VALUE;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">50</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">		exports.getToken(req, res);</span></td><td class="action"></td></tr><tr class="hit "><td class="line">51</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">		next();</span></td><td class="action"></td></tr><tr><td class="line">52</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	},</span></td><td class="action"></td></tr><tr class="hit "><td class="line">53</td><td class="hits">3</td><td class="statements">100%</td><td class="source"><span class="statement ">		if (req.method === 'GET' || req.method === 'HEAD' || req.method === 'OPTIONS') {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">54</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">			return next();</span></td><td class="action"></td></tr><tr><td class="line">55</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">56</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		if (exports.validate(req)) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">57</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">			next();</span></td><td class="action"></td></tr><tr><td class="line">58</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		} else {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">59</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">			res.statusCode = 403;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">60</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">			next(new Error('CSRF token mismatch'));</span></td><td class="action"></td></tr><tr><td class="line">61</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/session.js">lib/session.js</h2><div class="stats terrible"><div class="percentage">17% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">8% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">0% block coverage</div><div class="sloc">68 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr class="hit "><td class="line">1</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var keystone = require('../'),
	crypto = require('crypto');</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Creates a hash of str with Keystone's cookie secret.</span></td><td class="action"></td></tr><tr><td class="line">5</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Only hashes the first half of the string.</span></td><td class="action"></td></tr><tr><td class="line">6</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr class="hit "><td class="line">7</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var hash = function(str) {
	// force type</span></td><td class="action"></td></tr><tr class="miss"><td class="line">8</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	str = '' + str;</span></td><td class="action"></td></tr><tr><td class="line">9</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// get the first half</span></td><td class="action"></td></tr><tr class="miss"><td class="line">10</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	str = str.substr(0, Math.round(str.length / 2));</span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	// hash using sha256</span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	return crypto</span></td><td class="action"></td></tr><tr class="miss"><td class="line">13</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	    .createHmac('sha256', keystone.get('cookie secret'))</span></td><td class="action"></td></tr><tr class="miss"><td class="line">14</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	    .update(str)</span></td><td class="action"></td></tr><tr class="miss"><td class="line">15</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	    .digest('base64')</span></td><td class="action"></td></tr><tr class="miss"><td class="line">16</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	    .replace(/\=+$/, '');</span></td><td class="action"></td></tr><tr><td class="line">17</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">18</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">19</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">20</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Signs in a user user matching the lookup filters</span></td><td class="action"></td></tr><tr><td class="line">21</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">22</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Object} lookup - must contain email and password</span></td><td class="action"></td></tr><tr><td class="line">23</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Object} req - express request object</span></td><td class="action"></td></tr><tr><td class="line">24</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Object} res - express response object</span></td><td class="action"></td></tr><tr><td class="line">25</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {function()} onSuccess callback, is passed the User instance</span></td><td class="action"></td></tr><tr><td class="line">26</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {function()} onFail callback</span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">28</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">29</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.signin = function(lookup, req, res, onSuccess, onFail) {
	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">30</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!lookup) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">31</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return onFail(new Error('session.signin requires a User ID or Object as the first argument'));</span></td><td class="action"></td></tr><tr><td class="line">32</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">33</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var User = keystone.list(keystone.get('user model'));</span></td><td class="action"></td></tr><tr><td class="line">34</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var doSignin = function(user) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		req.session.regenerate(function() {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			req.user = user;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">38</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			req.session.userId = user.id;</span></td><td class="action"></td></tr><tr><td class="line">39</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			</span></td><td class="action"></td></tr><tr><td class="line">40</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			// if the user has a password set, store a persistence cookie to resume sessions</span></td><td class="action"></td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (keystone.get('cookie signin') &amp;&amp; user.password) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">42</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				var userToken = user.id + ':' + hash(user.password);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">43</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				res.cookie('keystone.uid', userToken, { signed: true, httpOnly: true });</span></td><td class="action"></td></tr><tr><td class="line">44</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">45</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			onSuccess(user);</span></td><td class="action"></td></tr><tr><td class="line">46</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			</span></td><td class="action"></td></tr><tr><td class="line">47</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	};</span></td><td class="action"></td></tr><tr><td class="line">48</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">49</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if ('string' === typeof lookup.email &amp;&amp; 'string' === typeof lookup.password) {</span></td><td class="action"></td></tr><tr><td class="line">50</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">51</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		User.model.findOne({ email: lookup.email }).exec(function(err, user) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">52</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (user) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">53</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				user._.password.compare(lookup.password, function(err, isMatch) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">54</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					if (!err &amp;&amp; isMatch) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">55</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						doSignin(user);</span></td><td class="action"></td></tr><tr><td class="line">56</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					}</span></td><td class="action"></td></tr><tr><td class="line">57</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">58</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>						onFail(err);</span></td><td class="action"></td></tr><tr><td class="line">59</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>					}</span></td><td class="action"></td></tr><tr><td class="line">60</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				});</span></td><td class="action"></td></tr><tr class="miss"><td class="line">61</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				onFail(err);</span></td><td class="action"></td></tr><tr><td class="line">62</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr><td class="line">63</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">64</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		lookup = '' + lookup;</span></td><td class="action"></td></tr><tr><td class="line">65</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">66</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var userId = (lookup.indexOf(':') &gt; 0) ? lookup.substr(0, lookup.indexOf(':')) : lookup,</span></td><td class="action"></td></tr><tr><td class="line">67</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">68</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		User.model.findById(userId).exec(function(err, user) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">69</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (user &amp;&amp; (!passwordCheck || passwordCheck === hash(user.password))) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">70</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				doSignin(user);</span></td><td class="action"></td></tr><tr><td class="line">71</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">72</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				onFail(err);</span></td><td class="action"></td></tr><tr><td class="line">73</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr><td class="line">74</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		});</span></td><td class="action"></td></tr><tr><td class="line">75</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">76</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">77</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">78</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">79</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Signs the current user out and resets the session</span></td><td class="action"></td></tr><tr><td class="line">80</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">81</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Object} req - express request object</span></td><td class="action"></td></tr><tr><td class="line">82</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Object} res - express response object</span></td><td class="action"></td></tr><tr><td class="line">83</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {function()} next callback</span></td><td class="action"></td></tr><tr><td class="line">84</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">85</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">86</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.signout = function(req, res, next) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">87</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	res.clearCookie('keystone.uid');</span></td><td class="action"></td></tr><tr class="miss"><td class="line">88</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	req.user = null;</span></td><td class="action"></td></tr><tr><td class="line">89</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">90</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	req.session.regenerate(next);</span></td><td class="action"></td></tr><tr><td class="line">91</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">92</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">93</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">94</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">95</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Middleware to ensure session persistence across server restarts</span></td><td class="action"></td></tr><tr><td class="line">96</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">97</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Looks for a userId cookie, and if present, and there is no user signed in,</span></td><td class="action"></td></tr><tr><td class="line">98</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * automatically signs the user in.</span></td><td class="action"></td></tr><tr><td class="line">99</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">100</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Object} req - express request object</span></td><td class="action"></td></tr><tr><td class="line">101</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Object} res - express response object</span></td><td class="action"></td></tr><tr><td class="line">102</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {function()} next callback</span></td><td class="action"></td></tr><tr><td class="line">103</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">104</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">105</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.persist = function(req, res, next) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">106</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	var User = keystone.list(keystone.get('user model'));</span></td><td class="action"></td></tr><tr><td class="line">107</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">108</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (keystone.get('cookie signin') &amp;&amp; !req.session.userId &amp;&amp; req.signedCookies['keystone.uid'] &amp;&amp; req.signedCookies['keystone.uid'].indexOf(':') &gt; 0) {</span></td><td class="action"></td></tr><tr><td class="line">109</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		</span></td><td class="action"></td></tr><tr class="miss"><td class="line">110</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var _next = function() { next(); }; // otherwise the matching user is passed to next() which messes with the middleware signature</span></td><td class="action"></td></tr><tr class="miss"><td class="line">111</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		exports.signin(req.signedCookies['keystone.uid'], req, res, _next, _next);</span></td><td class="action"></td></tr><tr><td class="line">112</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">113</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	} else if (req.session.userId) {</span></td><td class="action"></td></tr><tr><td class="line">114</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">115</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		User.model.findById(req.session.userId).exec(function(err, user) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">116</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (err) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">117</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				return next(err);</span></td><td class="action"></td></tr><tr><td class="line">118</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr><td class="line">119</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="miss"><td class="line">120</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			req.user = user;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">121</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			next();</span></td><td class="action"></td></tr><tr><td class="line">122</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">123</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">124</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">125</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">126</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		next();</span></td><td class="action"></td></tr><tr><td class="line">127</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr><td class="line">128</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">129</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">130</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">131</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Middleware to enable access to Keystone</span></td><td class="action"></td></tr><tr><td class="line">132</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">133</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Bounces the user to the signin screen if they are not signed in or do not have permission.</span></td><td class="action"></td></tr><tr><td class="line">134</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> *</span></td><td class="action"></td></tr><tr><td class="line">135</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Object} req - express request object</span></td><td class="action"></td></tr><tr><td class="line">136</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Object} res - express response object</span></td><td class="action"></td></tr><tr><td class="line">137</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {function()} next callback</span></td><td class="action"></td></tr><tr><td class="line">138</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">139</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">140</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports.keystoneAuth = function(req, res, next) {
</span></td><td class="action"></td></tr><tr class="miss"><td class="line">141</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	if (!req.user || !req.user.canAccessKeystone) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">142</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var from = new RegExp('^\/keystone\/?$', 'i').test(req.url) ? '' : '?from=' + req.url;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">143</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return res.redirect(keystone.get('signin url') + from);</span></td><td class="action"></td></tr><tr><td class="line">144</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">145</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	next();</span></td><td class="action"></td></tr><tr><td class="line">146</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/asyncdi.js">lib/asyncdi.js</h2><div class="stats medium"><div class="percentage">57% line coverage<a href="#miss0"> go <span class="offscreen">jump to first missed line</span></a></div><div class="statements">56% statement coverage<a href="#partial0"> go <span class="offscreen">jump to first missed statement</span></a></div><div class="blocks">40% block coverage</div><div class="sloc">57 SLOC</div><div class="hits"></div><div class="misses"></div></div><div class="table"><table class="source"><thead><tr><th>Line</th><th>Hits</th><th>Statements</th><th>Source</th><th>Action</th></tr></thead><tbody><tr class="hit "><td class="line">1</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var _ = require('underscore'),
	async = require('async');</span></td><td class="action"></td></tr><tr><td class="line">2</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">3</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">4</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Asynchronous Dependency Injection Library</span></td><td class="action"></td></tr><tr><td class="line">5</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr><td class="line">6</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">7</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>// This regex detects the arguments portion of a function definition</span></td><td class="action"></td></tr><tr><td class="line">8</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>// Thanks to Angular for the regex</span></td><td class="action"></td></tr><tr class="hit "><td class="line">9</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var FN_ARGS = /^function\s*[^\(]*\(\s*([^\)]*)\)/m;</span></td><td class="action"></td></tr><tr><td class="line">10</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">11</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">12</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">13</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Calling the module directly returns a new Wrapper instance</span></td><td class="action"></td></tr><tr><td class="line">14</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * </span></td><td class="action"></td></tr><tr><td class="line">15</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param  {Function} fn</span></td><td class="action"></td></tr><tr><td class="line">16</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @return {Wrapper}</span></td><td class="action"></td></tr><tr><td class="line">17</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr class="hit "><td class="line">18</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">exports = module.exports = function(fn) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">19</td><td class="hits">8</td><td class="statements">100%</td><td class="source"><span class="statement ">	return new Wrapper(fn);</span></td><td class="action"></td></tr><tr><td class="line">20</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>};</span></td><td class="action"></td></tr><tr><td class="line">21</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr><td class="line">22</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>/**</span></td><td class="action"></td></tr><tr><td class="line">23</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * Wrapper Class</span></td><td class="action"></td></tr><tr><td class="line">24</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * </span></td><td class="action"></td></tr><tr><td class="line">25</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Function} fn</span></td><td class="action"></td></tr><tr><td class="line">26</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> * @param {Object} context</span></td><td class="action"></td></tr><tr><td class="line">27</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span> */</span></td><td class="action"></td></tr><tr class="hit "><td class="line">28</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">var Wrapper = exports.Wrapper = function Wrapper(fn, context) {
	
	// Ensure a new instance has been created.
	// Calling Wrapper as a function will return a new instance instead.</span></td><td class="action"></td></tr><tr class="hit "><td class="line">29</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (!(this instanceof Wrapper)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">30</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return new Wrapper(fn, context);</span></td><td class="action"></td></tr><tr><td class="line">31</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">32</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (!_.isFunction(fn)) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">33</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		throw new Error('AsyncDI Wrapper must be initialised with a function');</span></td><td class="action"></td></tr><tr><td class="line">34</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">35</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.fn = fn;</span></td><td class="action"></td></tr><tr><td class="line">36</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="hit "><td class="line">37</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.deps = fn.toString().match(FN_ARGS)[1].split(',').map(function(i) { return i.trim(); });</span></td><td class="action"></td></tr><tr><td class="line">38</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="hit "><td class="line">39</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.requires = {};</span></td><td class="action"></td></tr><tr class="hit "><td class="line">40</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">	this.deps.forEach(function(i) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">41</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">		this.requires[i] = true;</span></td><td class="action"></td></tr><tr><td class="line">42</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}, this);</span></td><td class="action"></td></tr><tr><td class="line">43</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="hit "><td class="line">44</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">	if (_.last(this.deps) === 'callback') {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">45</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		this.isAsync = true;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">46</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">		this.deps.pop();</span></td><td class="action"></td></tr><tr><td class="line">47</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">48</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">	this._context = context;</span></td><td class="action"></td></tr><tr><td class="line">49</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="hit "><td class="line">50</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">	this._provides = {};</span></td><td class="action"></td></tr><tr><td class="line">51</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="hit "><td class="line">52</td><td class="hits">9</td><td class="statements">100%</td><td class="source"><span class="statement ">	this._arguments = [];</span></td><td class="action"></td></tr><tr><td class="line">53</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr><td class="line">54</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span></span></td><td class="action"></td></tr><tr class="hit "><td class="line">55</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">_.extend(Wrapper.prototype, {
	
	/**
	 * Registers dependencies that can be provided to the function
	 * @param  {Object} provides map of key: value pairs
	 * @return {Wrapper} this instance
	 */
	provides: function(provides) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">56</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		_.extend(this._provides, provides);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">57</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		this._arguments = _.map(this.deps, function(key) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">58</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return this._provides[key];</span></td><td class="action"></td></tr><tr><td class="line">59</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}, this);</span></td><td class="action"></td></tr><tr class="miss"><td class="line">60</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return this;</span></td><td class="action"></td></tr><tr><td class="line">61</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	},</span></td><td class="action"></td></tr><tr><td class="line">62</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	</span></td><td class="action"></td></tr><tr class="miss"><td class="line">63</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		this._context = context;</span></td><td class="action"></td></tr><tr class="miss"><td class="line">64</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		return this;</span></td><td class="action"></td></tr><tr><td class="line">65</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>	},</span></td><td class="action"></td></tr><tr class="hit "><td class="line">66</td><td class="hits">3</td><td class="statements">100%</td><td class="source"><span class="statement ">		if (arguments.length === 1) {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">67</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">			callback = context;</span></td><td class="action"></td></tr><tr class="hit "><td class="line">68</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">			context = this._context;</span></td><td class="action"></td></tr><tr><td class="line">69</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="hit "><td class="line">70</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">			var asyncArgs = this._arguments.slice();</span></td><td class="action"></td></tr><tr><td class="line">71</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			// push the callback onto the new arguments array</span></td><td class="action"></td></tr><tr class="hit "><td class="line">72</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">			asyncArgs.push(callback);</span></td><td class="action"></td></tr><tr><td class="line">73</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			// call the function</span></td><td class="action"></td></tr><tr class="hit "><td class="line">74</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">			this.fn.apply(context, asyncArgs);</span></td><td class="action"></td></tr><tr><td class="line">75</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		} else {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">76</td><td class="hits">2</td><td class="statements">100%</td><td class="source"><span class="statement ">			if (callback) {</span></td><td class="action"></td></tr><tr><td class="line">77</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				// If a callback is provided, it must use the error-first arguments pattern.</span></td><td class="action"></td></tr><tr class="hit "><td class="line">78</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">				callback(null, this.fn.apply(context, this._arguments));</span></td><td class="action"></td></tr><tr><td class="line">79</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			} else {</span></td><td class="action"></td></tr><tr class="hit "><td class="line">80</td><td class="hits">1</td><td class="statements">100%</td><td class="source"><span class="statement ">				return this.fn.apply(context, this._arguments);</span></td><td class="action"></td></tr><tr><td class="line">81</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">82</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var wrapper = this;</span></td><td class="action"></td></tr><tr><td class="line">83</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (this.isAsync) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">84</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			return async.each(arr, function(item, cb) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">85</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				wrapper.call(item, cb);</span></td><td class="action"></td></tr><tr><td class="line">86</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}, callback);</span></td><td class="action"></td></tr><tr><td class="line">87</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">88</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			arr.each(function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">89</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				wrapper.call(item);</span></td><td class="action"></td></tr><tr><td class="line">90</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			});</span></td><td class="action"></td></tr><tr class="miss"><td class="line">91</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			if (callback) { callback(); }</span></td><td class="action"></td></tr><tr><td class="line">92</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr><tr class="miss"><td class="line">93</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		var wrapper = this;</span></td><td class="action"></td></tr><tr><td class="line">94</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		if (this.isAsync) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">95</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			async.map(arr, function(item, cb) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">96</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				wrapper.call(item, cb);</span></td><td class="action"></td></tr><tr><td class="line">97</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}, callback);</span></td><td class="action"></td></tr><tr><td class="line">98</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		} else {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">99</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			callback(null, arr.map(function(item) {</span></td><td class="action"></td></tr><tr class="miss"><td class="line">100</td><td class="hits">0</td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>				return wrapper.call(item);</span></td><td class="action"></td></tr><tr><td class="line">101</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>			}));</span></td><td class="action"></td></tr><tr><td class="line">102</td><td class="hits"></td><td class="statements"></td><td class="source"><span class="statement notok"><span class="offscreen"> not covered </span>		}</span></td><td class="action"></td></tr></tbody></table></div></div><div class="file"><h2 id="lib/security/ipRangeRestrict.js">lib/security/ipRangeRestrict.js</h2><div class="stats terrible"><div class="percentage">0% line coverage</div><div class="statements">0% statement coverage</div><div class="blocks">0% block coverage</div></div></div><div class="file"><h2 id="lib/updates.js">lib/updates.js</h2><div class="stats terrible"><div class="percentage">0% line coverage</div><div class="statements">0% statement coverage</div><div class="blocks">0% block coverage</div></div></div><div class="file"><h2 id="routes/api/cloudinary.js">routes/api/cloudinary.js</h2><div class="stats terrible"><div class="percentage">0% line coverage</div><div class="statements">0% statement coverage</div><div class="blocks">0% block coverage</div></div></div><div class="file"><h2 id="routes/api/list.js">routes/api/list.js</h2><div class="stats terrible"><div class="percentage">0% line coverage</div><div class="statements">0% statement coverage</div><div class="blocks">0% block coverage</div></div></div><div class="file"><h2 id="routes/download/list.js">routes/download/list.js</h2><div class="stats terrible"><div class="percentage">0% line coverage</div><div class="statements">0% statement coverage</div><div class="blocks">0% block coverage</div></div></div><div class="file"><h2 id="routes/views/home.js">routes/views/home.js</h2><div class="stats terrible"><div class="percentage">0% line coverage</div><div class="statements">0% statement coverage</div><div class="blocks">0% block coverage</div></div></div><div class="file"><h2 id="routes/views/item.js">routes/views/item.js</h2><div class="stats terrible"><div class="percentage">0% line coverage</div><div class="statements">0% statement coverage</div><div class="blocks">0% block coverage</div></div></div><div class="file"><h2 id="routes/views/list.js">routes/views/list.js</h2><div class="stats terrible"><div class="percentage">0% line coverage</div><div class="statements">0% statement coverage</div><div class="blocks">0% block coverage</div></div></div><div class="file"><h2 id="routes/views/signin.js">routes/views/signin.js</h2><div class="stats terrible"><div class="percentage">0% line coverage</div><div class="statements">0% statement coverage</div><div class="blocks">0% block coverage</div></div></div><div class="file"><h2 id="routes/views/signout.js">routes/views/signout.js</h2><div class="stats terrible"><div class="percentage">0% line coverage</div><div class="statements">0% statement coverage</div><div class="blocks">0% block coverage</div></div></div></div></div></body></html>